import{app as _,BrowserWindow as xt,ipcMain as x,dialog as it,protocol as kt,shell as J}from"electron";import{createRequire as Vt}from"node:module";import y from"node:path";import{fileURLToPath as zt,pathToFileURL as le}from"node:url";import q from"node:https";import m from"node:fs";import Bt from"node:zlib";import{spawn as G}from"node:child_process";import jt from"node:os";import A from"node:fs";import z from"node:path";import bt from"node:crypto";import{pipeline as _t}from"node:stream";import{promisify as Lt}from"node:util";import tt from"node:https";var $t=Lt(_t);function Z(n){return String(n||"").replace(/\\/g,"/").replace(/^\/+/,"")}function ht(n){return String(n||"").replace(/\\/g,"/").toLowerCase()}var B=new Map,Rt=new tt.Agent({keepAlive:!0,maxSockets:32,maxFreeSockets:16,keepAliveMsecs:3e4});function j(n){return new Promise((e,r)=>{let t=bt.createHash("sha256"),s=A.createReadStream(n);s.on("error",r),s.on("end",()=>e(t.digest("hex"))),s.on("data",o=>t.update(o))})}function ut(n){A.mkdirSync(n,{recursive:!0})}function Dt(n){return new Promise((e,r)=>{tt.get(n,t=>{if(t.statusCode!==200){r(new Error(`HTTP ${t.statusCode} for ${n}`)),t.resume();return}let s="";t.setEncoding("utf8"),t.on("data",o=>s+=o),t.on("end",()=>{try{e(JSON.parse(s))}catch(o){r(o)}})}).on("error",r)})}function N(n){return new Promise(e=>setTimeout(e,n))}function pt(){return{cancelled:!1,requests:new Set}}function et(n){if(n){n.cancelled=!0;for(let e of n.requests)try{e.destroy(new Error("cancelled"))}catch{}n.requests.clear()}}var Tt=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE"]);async function V(n,e,r,t=1,s,o=0,a=0){return new Promise((c,u)=>{ut(z.dirname(e));let i=A.createWriteStream(e,{flags:o>0?"a":"w"});if(s?.cancelled)return i.close(()=>{}),u(new Error("cancelled"));let l={agent:Rt};o>0&&(l.headers={Range:`bytes=${o}-`});let d=tt.get(n,l,p=>{if(p.statusCode!==200&&!(o>0&&p.statusCode===206)){if(i.close(()=>{}),o>0&&p.statusCode===200){try{A.unlinkSync(e)}catch{}let C=Math.min(2e3*t,1e4);p.resume();try{d.destroy(new Error("restart:range-ignored"))}catch{}return N(C).then(()=>c(V(n,e,r,t+1,s,0,a)))}if(A.unlink(e,()=>{}),p.statusCode&&[429,500,502,503,504].includes(p.statusCode)&&t<5){let C=Math.min(2e3*t,1e4);return p.resume(),N(C).then(()=>c(V(n,e,r,t+1,s,o,a)))}u(new Error(`HTTP ${p.statusCode} for ${n}`)),p.resume();return}let S=Number(p.headers["content-length"]||0),g=a>0?a:o>0?o+S:S,w=0,f=Date.now(),h=t<=2?6e4:9e4,k=setInterval(()=>{if(!s?.cancelled&&Date.now()-f>h)try{let C=new Error("stalled");C.code="ETIMEDOUT",d.destroy(C)}catch{}},1e4);p.on("data",C=>{w+=C.length,f=Date.now(),r&&r(Math.min(o+w,g||o+w),g||0)}),p.on("aborted",async()=>{let C=new Promise(E=>i.close(()=>E()));try{clearInterval(k)}catch{}try{await C}catch{}if(t<5){let E=Math.min(2e3*t,1e4);return N(E).then(()=>c(V(n,e,r,t+1,s,o+w,a)))}u(new Error("response aborted"))}),$t(p,i).then(()=>{try{clearInterval(k)}catch{}c()}).catch(C=>{try{clearInterval(k)}catch{}u(C)})});if(s?.requests.add(d),d.on("socket",p=>{try{p.setKeepAlive(!0,6e4),p.setNoDelay(!0)}catch{}}),d.on("close",()=>s?.requests.delete(d)),d.setTimeout(45e3,()=>{try{let p=new Error("Request timeout");p.code="ETIMEDOUT",d.destroy(p)}catch{}}),s?.cancelled)try{d.destroy(new Error("cancelled"))}catch{}d.on("error",async p=>{let S=p?.code,g=t<5&&S&&Tt.has(String(S)),w=new Promise(f=>{try{i.close(()=>f())}catch{f()}});try{await w}catch{}if(g){let f=Math.min(2e3*t,1e4),h=o;try{h=A.statSync(e).size}catch{}return N(f).then(()=>c(V(n,e,r,t+1,s,h,a)))}u(p)})})}async function Mt(n,e,r){try{let t=A.statSync(n);return r&&Number(r)>0&&t.size!==Number(r)?!1:(await j(n)).toLowerCase()===String(e).toLowerCase()}catch{return!1}}async function ft(n){let e=`${n.replace(/\/$/,"")}/checksums.json`;return Dt(e)}async function Ut(n,e,r,t,s=4,o){let a=Z(e.path).split("/").join(z.sep),c=z.join(r,a);if(ut(z.dirname(c)),await Mt(c,e.checksum,e.size)){t("progress:skip",{path:e.path});return}if(o?.cancelled)throw new Error("cancelled");if(Array.isArray(e.parts)&&e.parts.length>0){let i=e.parts.length,l=new Array(i),d=0,p=new Set;async function S(){for(;;){let f=d++;if(f>=i)return;if(p.has(f))continue;p.add(f);let h=e.parts[f],k=Z(h.path),C=`${n.replace(/\/$/,"")}/${k}`,E=`${c}.part${f}`;try{if(A.existsSync(E))if((await j(E)).toLowerCase()===String(h.checksum).toLowerCase()){t("progress:part",{path:e.path,part:f,totalParts:i,received:Number(h.size||0),total:Number(h.size||0)}),l[f]=E;continue}else try{A.unlinkSync(E)}catch{}}catch{}let L=0;for(;;){if(o?.cancelled)throw new Error("cancelled");L+=1;let b=0,P=0;try{let D=0;try{D=A.statSync(E).size}catch{}let T=Number(h.size||0);if(T>0&&D>T)try{A.unlinkSync(E),D=0}catch{}await V(C,E,(M,F)=>{let U=Math.max(0,M-P);P=M;try{U>0&&t("progress:bytes",{delta:U})}catch{}b+=U;let Y=T||F||0;t("progress:part",{path:e.path,part:f,totalParts:i,received:Math.min(M,Y||M),total:Y})},1,o,D,T)}catch{try{A.unlinkSync(E)}catch{}try{b>0&&t("progress:bytes",{delta:-b})}catch{}try{t("progress:part:reset",{path:e.path,part:f,totalParts:i})}catch{}let T=Math.min(2e3*L,1e4);await N(T);continue}if((await j(E)).toLowerCase()===String(h.checksum).toLowerCase())break;try{A.unlinkSync(E)}catch{}try{b>0&&t("progress:bytes",{delta:-b})}catch{}try{t("progress:part:reset",{path:e.path,part:f,totalParts:i})}catch{}let W=Math.min(2e3*L,1e4);await N(W)}l[f]=E}}let g=Array.from({length:Math.max(1,s)},()=>S());await Promise.all(g),t("progress:merge:start",{path:e.path,parts:l.length});let w=A.createWriteStream(c);for(let f=0;f<l.length;f++){let h=l[f];t("progress:merge:part",{path:e.path,part:f,totalParts:l.length}),await new Promise((k,C)=>{let E=A.createReadStream(h);E.on("error",C),w.on("error",C),E.on("end",()=>{try{A.unlinkSync(h)}catch{}k()}),E.pipe(w,{end:!1})})}await new Promise((f,h)=>{w.on("error",h),w.on("finish",f),w.end()});try{t("progress:merge:done",{path:e.path})}catch{}}else{let i=Z(e.path),l=`${n.replace(/\/$/,"")}/${i}`,d=0;for(;;){d+=1;let p=0,S=0,g=`${c}.download`,w=0;try{w=A.statSync(g).size}catch{}let f=Number(e.size||0);if(f>0&&w>f)try{A.unlinkSync(g),w=0}catch{}if(await V(l,g,(k,C)=>{let E=Math.max(0,k-S);S=k;try{E>0&&t("progress:bytes",{delta:E})}catch{}p+=E;let L=f||C||0;t("progress:file",{path:e.path,received:Math.min(k,L||k),total:L})},1,o,w,f),(await j(g)).toLowerCase()===String(e.checksum).toLowerCase())break;try{A.unlinkSync(g)}catch{}try{p>0&&t("progress:bytes",{delta:-p})}catch{}if(d>=2)throw new Error(`Checksum mismatch for ${e.path}`)}try{A.unlinkSync(c)}catch{}A.renameSync(`${c}.download`,c)}if(t("progress:verify",{path:e.path}),(await j(c)).toLowerCase()!==String(e.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${e.path}`)}async function yt(n,e,r,t,s=!1,o=4,a=4,c){let u=new Set,i=[];for(let h of e.files||[]){if(!(s||!h.optional))continue;let k=ht(h.path);k&&(u.has(k)||(u.add(k),i.push(h)))}let l=i.filter(h=>!(Array.isArray(h.parts)&&h.parts.length>0)),d=i.filter(h=>Array.isArray(h.parts)&&h.parts.length>0),p=l.concat(d),S=p.length,g=0,w=p.reduce((h,k)=>{let C=Number(k.size||0);return C>0?h+C:Array.isArray(k.parts)&&k.parts.length?h+k.parts.reduce((E,L)=>E+Number(L.size||0),0):h},0);try{t("progress:bytes:total",{totalBytes:w})}catch{}async function f(h,k,C){let E=0;async function L(){for(;;){let P=E++;if(P>=h.length)return;let R=h[P],W=k+P,D=ht(R.path),T=async()=>Ut(n,R,r,t,a,c),M=!1,F=B.get(D);F?M=!0:(t("progress:start",{index:W,total:S,path:R.path,completed:g}),F=(async()=>{try{await T()}catch(U){if(String(U?.message||U||"error").includes("cancelled"))throw U;try{let H=z.join(r,R.path.replace(/\\/g,z.sep));try{A.unlinkSync(H)}catch{}await T()}catch(H){try{t("progress:error",{path:R.path,message:String(H?.message||H)})}catch{}}}})(),B.set(D,F));try{await F}finally{M||B.delete(D)}g+=1,t("progress:done",{index:W,total:S,path:R.path,completed:g}),await N(10)}}let b=Array.from({length:Math.max(1,C)},()=>L());await Promise.all(b)}if(await f(l,0,Math.max(1,o)),B.size>0)try{await Promise.all([...B.values()])}catch{}await f(d,l.length,1)}import rt from"node:fs";import Nt from"node:path";import{app as It}from"electron";var mt=It.getPath("userData"),gt=Nt.join(mt,"settings.json");function nt(){try{let n=rt.readFileSync(gt,"utf-8");return JSON.parse(n)}catch{return{}}}function Ft(n){rt.mkdirSync(mt,{recursive:!0}),rt.writeFileSync(gt,JSON.stringify(n,null,2),"utf-8")}function wt(n,e=void 0){return nt()[n]??e}function ot(n,e){let r=nt();r[n]=e,Ft(r)}function St(){return nt()}var Ct=Vt(import.meta.url),{autoUpdater:$}=Ct("electron-updater"),vt=Ct("electron-log"),qt=zt(import.meta.url),O=y.dirname(qt);var v,I=null,st=new Set,K=new Map,X=new Map,at="r5v",Q=[];function At(n){try{return(n||[]).filter(e=>typeof e=="string"&&e.startsWith(`${at}://`))}catch{return[]}}function lt(n){try{let e=new URL(n);if(e.hostname==="mod"&&e.pathname==="/install"){let r=e.searchParams.get("name")||"",t=e.searchParams.get("version")||"",s=e.searchParams.get("downloadUrl")?.split(",")||"";if(v&&v.webContents&&!v.webContents.isLoading())try{v.webContents.send("deeplink:mod-install",{url:n,name:r,version:t,downloadUrls:s})}catch{}else Q.push(n)}}catch{}}function Wt(){for(;Q.length;){let n=Q.shift();lt(n)}}var Ht=_.requestSingleInstanceLock();Ht?_.on("second-instance",(n,e)=>{try{At(e).forEach(t=>lt(t)),v&&(v.isMinimized()&&v.restore(),v.focus())}catch{}}):_.quit();_.on("open-url",(n,e)=>{n.preventDefault(),lt(e)});async function Et(){v=new xt({width:1150,height:800,minWidth:1150,minHeight:800,frame:!1,titleBarStyle:"hidden",webPreferences:{preload:y.join(O,"preload.cjs"),contextIsolation:!0,nodeIntegration:!1},show:!1,icon:y.join(O,"..","public","icon.png")});let n=process.env.VITE_DEV_SERVER_URL;if(n)await v.loadURL(n);else{let s=y.join(O,"..","dist","index.html");await v.loadFile(s)}v.webContents.setWindowOpenHandler(({url:s})=>{try{J.openExternal(s)}catch{}return{action:"deny"}}),v.webContents.on("will-navigate",(s,o)=>{let a=o.startsWith("file:"),c=!!process.env.VITE_DEV_SERVER_URL&&o.startsWith(String(process.env.VITE_DEV_SERVER_URL));if(!a&&!c){s.preventDefault();try{J.openExternal(o)}catch{}}});let e=()=>{v&&(v.isVisible()||v.show(),v.isFocused()||v.focus())};v.once("ready-to-show",e),v.webContents.once("did-finish-load",e);let r=setTimeout(e,1e3);v.on("show",()=>clearTimeout(r)),(!!process.env.VITE_DEV_SERVER_URL||process.env.NODE_ENV==="development")&&v.webContents.openDevTools({mode:"detach"}),v.webContents.on("did-fail-load",(s,o,a,c)=>{console.error("Load failed",{errorCode:o,errorDesc:a,validatedURL:c}),it.showErrorBox("Load failed",`${a} (code ${o})
URL: ${c}`),v.show()})}_.on("window-all-closed",()=>{process.platform!=="darwin"&&_.quit()});_.whenReady().then(()=>{try{process.defaultApp&&process.platform==="win32"?_.setAsDefaultProtocolClient(at,process.execPath,[process.argv[1]]):_.setAsDefaultProtocolClient(at)}catch{}let n=y.resolve(_.getAppPath(),".."),e=y.join(n,"cache");kt.registerFileProtocol("r5v",(t,s)=>{try{let o=new URL(t.url),a=decodeURIComponent(o.pathname).replace(/^\//,""),c=y.normalize(y.join(e,a));s({path:c})}catch{s({error:-6})}});let r=y.join(O,"..","dist");kt.interceptFileProtocol("file",(t,s)=>{try{let o=new URL(t.url),a=decodeURIComponent(o.pathname),c=a.replace(/\\/g,"/"),u=c.indexOf("/_astro/");if(u!==-1){let i=c.substring(u+8),l=y.join(r,"_astro",i);return s({path:l})}if(c.endsWith("/favicon.svg")||/\/favicon\.svg$/i.test(c)){let i=y.join(r,"favicon.svg");return s({path:i})}if(c.startsWith("/")){let i=c.replace(/^\/+/,""),l=y.join(r,i);try{return m.accessSync(l),s({path:l})}catch{}}return s({path:a})}catch{return s({error:-6})}}),Et();try{At(process.argv).forEach(t=>Q.push(t))}catch{}try{v?.webContents?.once("did-finish-load",Wt)}catch{}try{$.autoDownload=!1;try{$.logger=vt,vt.transports.file.level="info"}catch{}$.on("error",t=>{try{v?.webContents.send("update:error",{message:String(t?.stack||t?.message||t)})}catch{}}),$.on("update-available",t=>{try{v?.webContents.send("update:available",t)}catch{}}),$.on("update-not-available",t=>{try{v?.webContents.send("update:not-available",t)}catch{}}),$.on("download-progress",t=>{try{v?.webContents.send("update:download-progress",t)}catch{}}),$.on("update-downloaded",t=>{try{v?.webContents.send("update:downloaded",t)}catch{}})}catch{}_.on("activate",()=>{xt.getAllWindows().length===0&&Et()})});x.handle("update:check",async()=>{try{return{ok:!0,result:(await $.checkForUpdates())?.updateInfo||null}}catch(n){return{ok:!1,error:String(n?.message||n)}}});x.handle("update:download",async()=>{try{return await $.downloadUpdate(),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});x.handle("update:quitAndInstall",async()=>{try{return setImmediate(()=>$.quitAndInstall(!1,!0)),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});x.handle("app:getVersion",async()=>{try{return _.getVersion()}catch{return"0.0.0"}});x.handle("app:getBaseDir",async()=>{try{return y.resolve(_.getAppPath(),"..")}catch{return""}});x.handle("app:getLauncherInstallRoot",async()=>{try{let n=process.env.LOCALAPPDATA||y.join(_.getPath("home"),"AppData","Local");return y.join(n,"Programs","r5vlauncher")}catch{return""}});function Ot(n){try{let e=y.join(n,"mods.vdf"),r=m.readFileSync(e,"utf-8"),t={},s=/"([^"]+)"\s*"([01])"/g,o;for(;o=s.exec(r);){let a=o[1];a&&a!=="ModList"&&(t[a]=o[2]==="1")}return t}catch{return{}}}function dt(n){try{let e=y.join(n,"mods.vdf"),r=m.readFileSync(e,"utf-8"),t={},s=[],o=/"([^"]+)"\s*"([01])"/g,a;for(;a=o.exec(r);){let c=a[1];!c||c==="ModList"||(c in t||s.push(c),t[c]=a[2]==="1")}return{map:t,order:s}}catch{return{map:{},order:[]}}}function ct(n){try{let e=m.readFileSync(n,"utf-8"),r=e.match(/"id"\s*"([^"]+)"/i),t=e.match(/"name"\s*"([^"]+)"/i),s=r?r[1]:null,o=t?t[1]:null;return{id:s,name:o}}catch{return{id:null,name:null}}}function Jt(n,e){let r=['"ModList"',"{"];for(let[t,s]of Object.entries(e))r.push(`	"${t}"		"${s?"1":"0"}"`);r.push("}"),m.mkdirSync(n,{recursive:!0}),m.writeFileSync(y.join(n,"mods.vdf"),r.join(`
`),"utf-8")}function Pt(n,e,r){let t=new Set,s=['"ModList"',"{"],o=a=>{s.push(`	"${a}"		"${r[a]?"1":"0"}"`),t.add(a)};for(let a of Array.isArray(e)?e:[])Object.prototype.hasOwnProperty.call(r,a)&&!t.has(a)&&o(a);for(let a of Object.keys(r))t.has(a)||o(a);s.push("}"),m.mkdirSync(n,{recursive:!0}),m.writeFileSync(y.join(n,"mods.vdf"),s.join(`
`),"utf-8")}x.handle("mods:listInstalled",async(n,{installDir:e})=>{try{let r=y.join(e,"mods"),{map:t,order:s}=dt(r),o=[],a=m.existsSync(r)?m.readdirSync(r,{withFileTypes:!0}):[];for(let u of a){if(!u.isDirectory())continue;let i=y.join(r,u.name),l=y.join(i,"manifest.json"),d=y.join(i,"mod.vdf"),p=y.join(i,"icon.png"),S=null;try{S=JSON.parse(m.readFileSync(l,"utf-8"))}catch{}let g=ct(d),w=g.id||S?.name||u.name,f=null;try{f=`data:image/png;base64,${m.readFileSync(p).toString("base64")}`}catch{}o.push({id:w,name:S?.name||g.name||u.name,folder:u.name,version:S?.version_number||null,description:S?.description||"",enabled:w?!!t[w]:!1,hasManifest:m.existsSync(l),iconDataUrl:f})}let c=new Map(s.map((u,i)=>[u,i]));return o.sort((u,i)=>{let l=u.id!=null&&c.has(u.id)?c.get(u.id):Number.MAX_SAFE_INTEGER,d=i.id!=null&&c.has(i.id)?c.get(i.id):Number.MAX_SAFE_INTEGER;return l!==d?l-d:String(u.name||"").localeCompare(String(i.name||""))}),{ok:!0,mods:o}}catch(r){return{ok:!1,error:String(r?.message||r)}}});x.handle("mods:setEnabled",async(n,{installDir:e,name:r,enabled:t})=>{try{let s=y.join(e,"mods"),{map:o}=dt(s);return o[r]=!!t,Pt(s,void 0,o),{ok:!0}}catch(s){return{ok:!1,error:String(s?.message||s)}}});x.handle("mods:reorder",async(n,{installDir:e,orderIds:r})=>{try{let t=y.join(e,"mods"),{map:s,order:o}=dt(t),a=Array.isArray(r)?r.filter(l=>typeof l=="string"&&l&&Object.prototype.hasOwnProperty.call(s,l)):[],c=new Set(a),u=o.filter(l=>Object.prototype.hasOwnProperty.call(s,l)&&!c.has(l)),i=[...a,...u];return Pt(t,i,s),{ok:!0}}catch(t){return{ok:!1,error:String(t?.message||t)}}});x.handle("mods:uninstall",async(n,{installDir:e,folder:r})=>{try{let t=y.join(e,"mods"),s=y.join(t,r);return m.rmSync(s,{recursive:!0,force:!0}),{ok:!0}}catch(t){return{ok:!1,error:String(t?.message||t)}}});x.handle("mods:fetchAll",async(n,{query:e})=>{let r="https://thunderstore.io/c/r5valkyrie/api/v1/package-listing-index/",t=o=>new Promise((a,c)=>{q.get(o,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"*/*"}},i=>{if(i.statusCode&&i.statusCode>=300&&i.statusCode<400&&i.headers.location){i.resume();let d=i.headers.location.startsWith("http")?i.headers.location:new URL(i.headers.location,o).toString();return a(t(d))}if(i.statusCode!==200)return i.resume(),c(new Error(`HTTP ${i.statusCode}`));let l=[];i.on("data",d=>l.push(Buffer.isBuffer(d)?d:Buffer.from(d))),i.on("end",()=>a(Buffer.concat(l)))}).on("error",c)}),s=o=>{try{return Bt.gunzipSync(o)}catch{return o}};try{let o=await t(r),a=JSON.parse(s(o).toString("utf8")),c=Array.isArray(a)?a:[],u=6,i=[],l=0;await Promise.all(Array.from({length:u}).map(async()=>{for(;l<c.length;){let p=l++,S=c[p];try{let g=await t(S),w=s(g).toString("utf8"),f=JSON.parse(w);Array.isArray(f)&&i.push(...f)}catch{}}}));let d=i;if(e&&String(e).trim()){let p=String(e).toLowerCase();d=d.filter(S=>String(S?.name||"").toLowerCase().includes(p)||String(S?.full_name||"").toLowerCase().includes(p))}return{ok:!0,mods:d}}catch(o){try{let c=await t("https://thunderstore.io/c/r5valkyrie/api/v1/package/"),u=JSON.parse(c.toString("utf8")),i=Array.isArray(u)?u:[];if(e&&String(e).trim()){let l=String(e).toLowerCase();i=i.filter(d=>String(d?.name||"").toLowerCase().includes(l)||String(d?.full_name||"").toLowerCase().includes(l))}return{ok:!0,mods:i}}catch(a){return{ok:!1,error:String(a?.message||o?.message||a||o)}}}});x.handle("mods:install",async(n,{installDir:e,name:r,downloadUrl:t})=>{try{let s=String(r||"").trim();if(!s)return{ok:!1,error:"Invalid mod name"};if(st.has(s))return{ok:!0};st.add(s);let o=y.join(e,"mods");m.mkdirSync(o,{recursive:!0});let a=y.join(o,`.__mod_${Date.now()}.zip`),c=(d,p=0)=>new Promise((S,g)=>{if(p>5)return g(new Error("Too many redirects"));let w=m.createWriteStream(a);q.get(d,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"application/octet-stream,*/*;q=0.8",Referer:"https://thunderstore.io/",Connection:"keep-alive"}},h=>{if(h.statusCode&&h.statusCode>=300&&h.statusCode<400&&h.headers.location){h.resume(),w.close(()=>{});try{m.unlinkSync(a)}catch{}let b=h.headers.location.startsWith("http")?h.headers.location:new URL(h.headers.location,d).toString();return S(c(b,p+1))}if(h.statusCode!==200){w.close(()=>{});try{m.unlinkSync(a)}catch{}return h.resume(),g(new Error(`HTTP ${h.statusCode}`))}let k=Number(h.headers["content-length"]||0),C=0,E=Date.now(),L=b=>{try{n?.sender?.send("mods:progress",{key:r,phase:b,received:C,total:k})}catch{}};h.on("data",b=>{C+=Buffer.isBuffer(b)?b.length:Buffer.byteLength(String(b));let P=Date.now();P-E>150&&(E=P,L("downloading"))}),h.pipe(w),w.on("finish",()=>{L("downloading"),w.close(S)})}).on("error",h=>{try{m.unlinkSync(a)}catch{}g(h)})});await c(t);try{n?.sender?.send("mods:progress",{key:r,phase:"extracting"})}catch{}let u=y.join(o,r);try{m.rmSync(u,{recursive:!0,force:!0})}catch{}m.mkdirSync(u,{recursive:!0}),await new Promise((d,p)=>{let S=G("powershell.exe",["-NoProfile","-NonInteractive","-Command",`Expand-Archive -LiteralPath "${a}" -DestinationPath "${u}" -Force`],{stdio:"ignore"});S.on("exit",g=>g===0?d():p(new Error(`Expand-Archive failed ${g}`))),S.on("error",p)});try{m.unlinkSync(a)}catch{}let i=null;try{let d=y.join(u,"mod.vdf");if(m.existsSync(d))i=ct(d).id;else{let p=m.readdirSync(u,{withFileTypes:!0});for(let S of p)if(S.isDirectory()){let g=y.join(u,S.name,"mod.vdf");if(m.existsSync(g)&&(i=ct(g).id,i))break}}}catch{}let l=Ot(o);l[i||r]=!0,Jt(o,l);try{n?.sender?.send("mods:progress",{key:r,phase:"done"})}catch{}return{ok:!0}}catch(s){return{ok:!1,error:String(s?.message||s)}}finally{try{st.delete(String(r||""))}catch{}}});x.handle("mods:watch",async(n,{installDir:e})=>{try{let r=y.join(e,"mods");if(!m.existsSync(r))return{ok:!0};let t=r;if(K.has(t))return{ok:!0};let s=m.watch(r,{persistent:!0},(o,a)=>{let c=t;clearTimeout(X.get(c));let u=setTimeout(()=>{try{v?.webContents?.send("mods:changed",{installDir:e})}catch{}},300);X.set(c,u)});return K.set(t,s),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});x.handle("mods:unwatch",async(n,{installDir:e})=>{try{let t=y.join(e,"mods"),s=K.get(t);if(s){try{s.close()}catch{}K.delete(t)}let o=X.get(t);return o&&(clearTimeout(o),X.delete(t)),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});x.handle("mods:iconDataUrl",async(n,{installDir:e,folder:r})=>{try{let t=y.join(e,"mods",r,"icon.png");return await m.promises.access(t),{ok:!0,dataUrl:`data:image/png;base64,${(await m.promises.readFile(t)).toString("base64")}`}}catch(t){return{ok:!1,error:String(t?.message||t)}}});x.handle("select-directory",async()=>{let n=await it.showOpenDialog({properties:["openDirectory","createDirectory"]});return n.canceled||n.filePaths.length===0?null:n.filePaths[0]});x.handle("settings:get",()=>St());x.handle("settings:set",(n,{key:e,value:r})=>ot(e,r));x.handle("download:checksums",async(n,{baseUrl:e})=>ft(e));x.handle("download:all",async(n,{baseUrl:e,checksums:r,installDir:t,includeOptional:s,concurrency:o,partConcurrency:a,channelName:c,mode:u})=>{let i=(l,d)=>n.sender.send(l,d);try{if(!(String(u||"install").toLowerCase()==="install")){let d=y.join(t,"mods","mods.vdf");if(m.existsSync(d)){let S=(Array.isArray(r?.files)?r.files:[]).filter(g=>{try{return String(g?.path||g?.name||"").replace(/\\/g,"/").toLowerCase()!=="mods/mods.vdf"}catch{return!0}});r={...r||{},files:S}}}}catch{}I=pt();try{await yt(e,r,t,i,!!s,Number(o)||4,Number(a)||4,I);try{let l=wt("channels",{})||{};l[String(c||"default")]={installDir:t,gameVersion:r?.game_version||null,gameBaseUrl:e,lastUpdatedAt:Date.now()},ot("channels",l)}catch(l){console.error("Failed to persist channel info",l)}}finally{I=null}return!0});x.handle("default-install-dir",(n,{channelName:e})=>{let r=process.env.LOCALAPPDATA||y.join(_.getPath("home"),"AppData","Local"),t=y.join(r,"Programs","R5VLibrary");return e?y.join(t,e):t});x.handle("launcher:config",async(n,{url:e})=>(t=>new Promise((s,o)=>{q.get(t,a=>{if(a.statusCode!==200){o(new Error(`HTTP ${a.statusCode} for ${t}`)),a.resume();return}let c="";a.setEncoding("utf8"),a.on("data",u=>c+=u),a.on("end",()=>{try{s(JSON.parse(c))}catch(u){o(u)}})}).on("error",o)}))(e));x.handle("eula:get",async()=>{let n="https://playvalkyrie.org/api/eula",e=r=>new Promise((t,s)=>{q.get(r,o=>{if(o.statusCode!==200){s(new Error(`HTTP ${o.statusCode}`)),o.resume();return}let a=[];o.on("data",c=>a.push(Buffer.isBuffer(c)?c:Buffer.from(c))),o.on("end",()=>{try{let c=Buffer.concat(a).toString("utf8");t(JSON.parse(c))}catch(c){s(c)}})}).on("error",s)});try{return{ok:!0,json:await e(n)}}catch(r){return{ok:!1,error:String(r?.message||r)}}});x.handle("video:cache",async(n,{filename:e})=>{let t=`https://blaze.playvalkyrie.org/video_backgrounds/${e}`,s=y.join(y.resolve(_.getAppPath(),".."),"cache"),o=y.join(s,"videos"),a=y.join(o,e);await m.promises.mkdir(o,{recursive:!0});try{return await m.promises.access(a),`r5v://videos/${e}`}catch{}return await new Promise((c,u)=>{let i=m.createWriteStream(a);q.get(t,l=>{if(l.statusCode!==200){i.close(()=>{}),m.unlink(a,()=>{}),u(new Error(`HTTP ${l.statusCode} video`)),l.resume();return}l.pipe(i),i.on("finish",()=>i.close(c))}).on("error",l=>{m.unlink(a,()=>u(l))})}),`r5v://videos/${e}`});x.handle("fs:exists",async(n,{path:e})=>{try{return await m.promises.access(e),!0}catch{return!1}});x.handle("path:open",async(n,{path:e})=>{try{return await J.openPath(e),!0}catch{return!1}});x.handle("open-external",async(n,{url:e})=>{try{return await J.openExternal(e),!0}catch{return!1}});x.handle("download:cancel",async()=>{try{et(I)}catch{}I=null;try{v?.webContents.send("progress:cancelled",{})}catch{}return!0});x.handle("select-file",async(n,{filters:e})=>{let r=await it.showOpenDialog({properties:["openFile"],filters:Array.isArray(e)?e:void 0});return r.canceled||r.filePaths.length===0?null:r.filePaths[0]});x.handle("game:launch",async(n,{channelName:e,installDir:r,mode:t,argsString:s})=>{try{if(!r)throw new Error("Missing installDir");let o=String(t).toUpperCase()==="SERVER"?"r5apex_ds.exe":"r5apex.exe",a=y.join(r,o);await m.promises.access(a).catch(()=>{throw new Error(`Executable not found: ${a}`)});let u=(l=>!l||typeof l!="string"?[]:(l.match(/(?:[^\s\"]+|\"[^\"]*\")+/g)||[]).map(p=>p.replace(/^\"|\"$/g,"")))(s);return G(a,u,{cwd:r,detached:!0,stdio:"ignore",env:{...process.env}}).unref(),{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}});x.handle("fix-folder-permissions",async(n,{folderPath:e})=>{let r=[];try{if(!e)return{ok:!1,error:"No folder path provided"};let t=y.resolve(e).replace(/\//g,"\\");if(!t||t.length<3)return{ok:!1,error:`Invalid path format: ${e}`};let s=t.length>=3&&t[1]===":"?t.slice(3):t;if(/[<>:"|?*]/.test(s))return{ok:!1,error:`Path contains invalid characters: ${t}`};try{m.mkdirSync(e,{recursive:!0})}catch(d){r.push(`Folder creation: ${d.message}`)}let c=jt.userInfo().username,u=y.join(process.resourcesPath,"elevate.exe"),i=m.existsSync(u);try{m.mkdirSync(t,{recursive:!0})}catch{}let l=[{exe:"icacls",args:[t,"/grant",`${c}:F`,"/t","/q"],desc:`Grant permissions to current user (${c})`},{exe:"icacls",args:[t,"/grant","Everyone:F","/t","/q"],desc:"Grant Everyone full permissions"},{exe:"icacls",args:[t,"/grant","Users:F","/t","/q"],desc:"Grant Users full permissions"}];for(let d=0;d<l.length;d++){let{exe:p,args:S,desc:g}=l[d];try{let w=await new Promise((f,h)=>{let k,C,E;i?(C=[u,["-wait",p,...S]],E={stdio:["ignore","pipe","pipe"],windowsHide:!0}):(C=[p,S],E={stdio:["ignore","pipe","pipe"],windowsHide:!0});try{k=G(C[0],C[1],E)}catch(P){console.error("[Permission Fix] Spawn failed:",P),h(P);return}let L="",b="";k.stdout&&k.stdout.on("data",P=>{L+=P.toString()}),k.stderr&&k.stderr.on("data",P=>{b+=P.toString()}),k.on("exit",(P,R)=>{f({code:P,stdout:L,stderr:b,signal:R})}),k.on("error",P=>{h(P)}),setTimeout(()=>{try{k.kill()}catch{}h(new Error("Command timeout"))},3e4)});if(w.code!==0){let f=w.stderr||w.stdout||"Unknown error";if(!(f.includes("duplicate")||f.includes("already")||w.code===1332)){let k=`${g} failed (code ${w.code}): ${f}`;r.push(k)}}}catch(w){let f=`${g} error: ${w.message}`;r.push(f)}}try{let d=y.join(t,"test_write.tmp");m.writeFileSync(d,"test"),m.unlinkSync(d)}catch(d){let p=`Write test failed: ${d.message}`;r.push(p);try{if(m.mkdirSync(t,{recursive:!0}),(await new Promise(g=>{let w=G("cmd",["/c",`icacls "${t}" /grant "%USERNAME%":F /q`],{stdio:"ignore",windowsHide:!0});w.on("exit",f=>g({code:f})),w.on("error",()=>g({code:1})),setTimeout(()=>{try{w.kill()}catch{}g({code:1})},5e3)})).code===0){let g=y.join(t,"test_write2.tmp");return m.writeFileSync(g,"test"),m.unlinkSync(g),{ok:!0,warnings:r}}}catch{}return{ok:!1,error:p,details:r}}return r.length>0?{ok:!0,warnings:r}:{ok:!0}}catch(t){let s=`Unexpected error: ${t?.message||t}`;return r.push(s),{ok:!1,error:s,details:r}}});x.on("window:minimize",()=>{v?.minimize()});x.on("window:maximize",()=>{v&&(v.isMaximized()?v.unmaximize():v.maximize())});x.on("window:close",()=>{v?.close()});_.on("before-quit",()=>{if(I)try{et(I)}catch{}});
