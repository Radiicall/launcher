import{app as _,BrowserWindow as Ct,ipcMain as C,dialog as it,protocol as vt,shell as J}from"electron";import{createRequire as zt}from"node:module";import y from"node:path";import{fileURLToPath as Vt,pathToFileURL as le}from"node:url";import W from"node:https";import m from"node:fs";import Bt from"node:zlib";import{spawn as G}from"node:child_process";import Ot from"node:os";import A from"node:fs";import V from"node:path";import _t from"node:crypto";import{pipeline as Dt}from"node:stream";import{promisify as Rt}from"node:util";import tt from"node:https";var Lt=Rt(Dt);function Z(n){return String(n||"").replace(/\\/g,"/").replace(/^\/+/,"")}function ht(n){return String(n||"").replace(/\\/g,"/").toLowerCase()}var B=new Map,ut=new tt.Agent({keepAlive:!0,maxSockets:64,maxFreeSockets:32,keepAliveMsecs:6e4,scheduling:"fifo"});function O(n){return new Promise((e,r)=>{let t=_t.createHash("sha256"),o=A.createReadStream(n);o.on("error",r),o.on("end",()=>e(t.digest("hex"))),o.on("data",s=>t.update(s))})}function ft(n){A.mkdirSync(n,{recursive:!0})}function Tt(n){return new Promise((e,r)=>{let t=tt.get(n,{agent:ut},o=>{if(o.statusCode!==200){r(new Error(`HTTP ${o.statusCode} for ${n}`)),o.resume();return}let s="";o.setEncoding("utf8"),o.on("data",a=>s+=a),o.on("end",()=>{try{e(JSON.parse(s))}catch(a){r(a)}})});t.on("error",r),t.setTimeout(3e4,()=>{t.destroy(),r(new Error("JSON fetch timeout"))})})}function U(n){return new Promise(e=>setTimeout(e,n))}function pt(){return{cancelled:!1,requests:new Set}}function et(n){if(n){n.cancelled=!0;for(let e of n.requests)try{e.destroy(new Error("cancelled"))}catch{}n.requests.clear()}}var $t=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE","ENOTFOUND","ECONNREFUSED","EHOSTDOWN","ENETDOWN"]);async function z(n,e,r,t=1,o,s=0,a=0){return new Promise((c,u)=>{ft(V.dirname(e));let i=A.createWriteStream(e,{flags:s>0?"a":"w"});if(o?.cancelled)return i.close(()=>{}),u(new Error("cancelled"));let l={agent:ut};s>0&&(l.headers={Range:`bytes=${s}-`});let d=tt.get(n,l,h=>{if(h.statusCode!==200&&!(s>0&&h.statusCode===206)){if(i.close(()=>{}),s>0&&h.statusCode===200){try{A.unlinkSync(e)}catch{}let E=Math.min(2e3*t,1e4);h.resume();try{d.destroy(new Error("restart:range-ignored"))}catch{}return U(E).then(()=>c(z(n,e,r,t+1,o,0,a)))}if(A.unlink(e,()=>{}),h.statusCode&&[429,500,502,503,504].includes(h.statusCode)&&t<5){let E=Math.min(2e3*t,1e4);return h.resume(),U(E).then(()=>c(z(n,e,r,t+1,o,s,a)))}u(new Error(`HTTP ${h.statusCode} for ${n}`)),h.resume();return}let S=Number(h.headers["content-length"]||0),g=a>0?a:s>0?s+S:S,w=0,p=Date.now(),f=t<=2?3e4:45e3,k=setInterval(()=>{if(!o?.cancelled&&Date.now()-p>f)try{let E=new Error("stalled");E.code="ETIMEDOUT",d.destroy(E)}catch{}},1e4);h.on("data",E=>{w+=E.length,p=Date.now(),r&&r(Math.min(s+w,g||s+w),g||0)}),h.on("aborted",async()=>{let E=new Promise(x=>i.close(()=>x()));try{clearInterval(k)}catch{}try{await E}catch{}if(t<5){let x=Math.min(2e3*t,1e4);return U(x).then(()=>c(z(n,e,r,t+1,o,s+w,a)))}u(new Error("response aborted"))}),Lt(h,i).then(()=>{try{clearInterval(k)}catch{}c()}).catch(E=>{try{clearInterval(k)}catch{}u(E)})});if(o?.requests.add(d),d.on("socket",h=>{try{h.setKeepAlive(!0,6e4),h.setNoDelay(!0),h.setRecvBufferSize&&h.setRecvBufferSize(64*1024),h.setSendBufferSize&&h.setSendBufferSize(64*1024)}catch{}}),d.on("close",()=>o?.requests.delete(d)),d.setTimeout(9e4,()=>{try{let h=new Error("Request timeout");h.code="ETIMEDOUT",d.destroy(h)}catch{}}),o?.cancelled)try{d.destroy(new Error("cancelled"))}catch{}d.on("error",async h=>{let S=h?.code,g=t<8&&S&&$t.has(String(S)),w=new Promise(p=>{try{i.close(()=>p())}catch{p()}});try{await w}catch{}if(g){let p=Math.min(1e3*Math.pow(1.5,t),15e3),f=Math.random()*1e3,k=p+f,E=s;try{E=A.statSync(e).size}catch{}return U(k).then(()=>c(z(n,e,r,t+1,o,E,a)))}u(h)})})}async function Mt(n,e,r){try{let t=A.statSync(n);return r&&Number(r)>0&&t.size!==Number(r)?!1:(await O(n)).toLowerCase()===String(e).toLowerCase()}catch{return!1}}async function yt(n){let e=`${n.replace(/\/$/,"")}/checksums.json`;return Tt(e)}async function Nt(n,e,r,t,o=4,s){let a=Z(e.path).split("/").join(V.sep),c=V.join(r,a);if(ft(V.dirname(c)),await Mt(c,e.checksum,e.size)){t("progress:skip",{path:e.path});return}if(s?.cancelled)throw new Error("cancelled");if(Array.isArray(e.parts)&&e.parts.length>0){let i=e.parts.length,l=new Array(i),d=0,h=new Set;async function S(){for(;;){let p=d++;if(p>=i)return;if(h.has(p))continue;h.add(p);let f=e.parts[p],k=Z(f.path),E=`${n.replace(/\/$/,"")}/${k}`,x=`${c}.part${p}`;try{if(A.existsSync(x))if((await O(x)).toLowerCase()===String(f.checksum).toLowerCase()){t("progress:part",{path:e.path,part:p,totalParts:i,received:Number(f.size||0),total:Number(f.size||0)}),l[p]=x;continue}else try{A.unlinkSync(x)}catch{}}catch{}let D=0;for(;;){if(s?.cancelled)throw new Error("cancelled");D+=1;let b=0,P=0;try{let T=0;try{T=A.statSync(x).size}catch{}let $=Number(f.size||0);if($>0&&T>$)try{A.unlinkSync(x),T=0}catch{}await z(E,x,(M,F)=>{let N=Math.max(0,M-P);P=M;try{N>0&&t("progress:bytes",{delta:N})}catch{}b+=N;let Y=$||F||0;t("progress:part",{path:e.path,part:p,totalParts:i,received:Math.min(M,Y||M),total:Y})},1,s,T,$)}catch{try{A.unlinkSync(x)}catch{}try{b>0&&t("progress:bytes",{delta:-b})}catch{}try{t("progress:part:reset",{path:e.path,part:p,totalParts:i})}catch{}let $=Math.min(2e3*D,1e4);await U($);continue}if((await O(x)).toLowerCase()===String(f.checksum).toLowerCase())break;try{A.unlinkSync(x)}catch{}try{b>0&&t("progress:bytes",{delta:-b})}catch{}try{t("progress:part:reset",{path:e.path,part:p,totalParts:i})}catch{}let j=Math.min(2e3*D,1e4);await U(j)}l[p]=x}}let g=Array.from({length:Math.max(1,o)},()=>S());await Promise.all(g),t("progress:merge:start",{path:e.path,parts:l.length});let w=A.createWriteStream(c);for(let p=0;p<l.length;p++){let f=l[p];t("progress:merge:part",{path:e.path,part:p,totalParts:l.length}),await new Promise((k,E)=>{let x=A.createReadStream(f);x.on("error",E),w.on("error",E),x.on("end",()=>{try{A.unlinkSync(f)}catch{}k()}),x.pipe(w,{end:!1})})}await new Promise((p,f)=>{w.on("error",f),w.on("finish",p),w.end()});try{t("progress:merge:done",{path:e.path})}catch{}}else{let i=Z(e.path),l=`${n.replace(/\/$/,"")}/${i}`,d=0;for(;;){d+=1;let h=0,S=0,g=`${c}.download`,w=0;try{w=A.statSync(g).size}catch{}let p=Number(e.size||0);if(p>0&&w>p)try{A.unlinkSync(g),w=0}catch{}if(await z(l,g,(k,E)=>{let x=Math.max(0,k-S);S=k;try{x>0&&t("progress:bytes",{delta:x})}catch{}h+=x;let D=p||E||0;t("progress:file",{path:e.path,received:Math.min(k,D||k),total:D})},1,s,w,p),(await O(g)).toLowerCase()===String(e.checksum).toLowerCase())break;try{A.unlinkSync(g)}catch{}try{h>0&&t("progress:bytes",{delta:-h})}catch{}if(d>=2)throw new Error(`Checksum mismatch for ${e.path}`)}try{A.unlinkSync(c)}catch{}A.renameSync(`${c}.download`,c)}if(t("progress:verify",{path:e.path}),(await O(c)).toLowerCase()!==String(e.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${e.path}`)}async function mt(n,e,r,t,o=!1,s=4,a=4,c){let u=new Set,i=[];for(let f of e.files||[]){if(!(o||!f.optional))continue;let k=ht(f.path);k&&(u.has(k)||(u.add(k),i.push(f)))}let l=i.filter(f=>!(Array.isArray(f.parts)&&f.parts.length>0)),d=i.filter(f=>Array.isArray(f.parts)&&f.parts.length>0),h=l.concat(d),S=h.length,g=0,w=h.reduce((f,k)=>{let E=Number(k.size||0);return E>0?f+E:Array.isArray(k.parts)&&k.parts.length?f+k.parts.reduce((x,D)=>x+Number(D.size||0),0):f},0);try{t("progress:bytes:total",{totalBytes:w})}catch{}async function p(f,k,E){let x=0;async function D(){for(;;){let P=x++;if(P>=f.length)return;let L=f[P],j=k+P,T=ht(L.path),$=async()=>Nt(n,L,r,t,a,c),M=!1,F=B.get(T);F?M=!0:(t("progress:start",{index:j,total:S,path:L.path,completed:g}),F=(async()=>{try{await $()}catch(N){if(String(N?.message||N||"error").includes("cancelled"))throw N;try{let q=V.join(r,L.path.replace(/\\/g,V.sep));try{A.unlinkSync(q)}catch{}await $()}catch(q){try{t("progress:error",{path:L.path,message:String(q?.message||q)})}catch{}}}})(),B.set(T,F));try{await F}finally{M||B.delete(T)}g+=1,t("progress:done",{index:j,total:S,path:L.path,completed:g}),await U(10)}}let b=Array.from({length:Math.max(1,E)},()=>D());await Promise.all(b)}if(await p(l,0,Math.max(1,s)),B.size>0)try{await Promise.all([...B.values()])}catch{}await p(d,l.length,1)}import rt from"node:fs";import Ut from"node:path";import{app as It}from"electron";var gt=It.getPath("userData"),wt=Ut.join(gt,"settings.json");function nt(){try{let n=rt.readFileSync(wt,"utf-8");return JSON.parse(n)}catch{return{}}}function Ft(n){rt.mkdirSync(gt,{recursive:!0}),rt.writeFileSync(wt,JSON.stringify(n,null,2),"utf-8")}function St(n,e=void 0){return nt()[n]??e}function ot(n,e){let r=nt();r[n]=e,Ft(r)}function kt(){return nt()}var At=zt(import.meta.url),{autoUpdater:R}=At("electron-updater"),Et=At("electron-log"),Wt=Vt(import.meta.url),H=y.dirname(Wt);var v,I=null,st=new Set,K=new Map,X=new Map,at="r5v",Q=[];function Pt(n){try{return(n||[]).filter(e=>typeof e=="string"&&e.startsWith(`${at}://`))}catch{return[]}}function lt(n){try{let e=new URL(n);if(e.hostname==="mod"&&e.pathname==="/install"){let r=e.searchParams.get("name")||"",t=e.searchParams.get("version")||"",o=e.searchParams.get("downloadUrl")?.split(",")||"";if(v&&v.webContents&&!v.webContents.isLoading())try{v.webContents.send("deeplink:mod-install",{url:n,name:r,version:t,downloadUrls:o})}catch{}else Q.push(n)}}catch{}}function jt(){for(;Q.length;){let n=Q.shift();lt(n)}}var qt=_.requestSingleInstanceLock();qt?_.on("second-instance",(n,e)=>{try{Pt(e).forEach(t=>lt(t)),v&&(v.isMinimized()&&v.restore(),v.focus())}catch{}}):_.quit();_.on("open-url",(n,e)=>{n.preventDefault(),lt(e)});async function xt(){v=new Ct({width:1150,height:800,minWidth:1150,minHeight:800,frame:!1,titleBarStyle:"hidden",webPreferences:{preload:y.join(H,"preload.cjs"),contextIsolation:!0,nodeIntegration:!1},show:!1,icon:y.join(H,"..","public","icon.png")});let n=process.env.VITE_DEV_SERVER_URL;if(n)await v.loadURL(n);else{let o=y.join(H,"..","dist","index.html");await v.loadFile(o)}v.webContents.setWindowOpenHandler(({url:o})=>{try{J.openExternal(o)}catch{}return{action:"deny"}}),v.webContents.on("will-navigate",(o,s)=>{let a=s.startsWith("file:"),c=!!process.env.VITE_DEV_SERVER_URL&&s.startsWith(String(process.env.VITE_DEV_SERVER_URL));if(!a&&!c){o.preventDefault();try{J.openExternal(s)}catch{}}});let e=()=>{v&&(v.isVisible()||v.show(),v.isFocused()||v.focus())};v.once("ready-to-show",e),v.webContents.once("did-finish-load",e);let r=setTimeout(e,1e3);v.on("show",()=>clearTimeout(r)),(!!process.env.VITE_DEV_SERVER_URL||process.env.NODE_ENV==="development")&&v.webContents.openDevTools({mode:"detach"}),v.webContents.on("did-fail-load",(o,s,a,c)=>{console.error("Load failed",{errorCode:s,errorDesc:a,validatedURL:c}),it.showErrorBox("Load failed",`${a} (code ${s})
URL: ${c}`),v.show()})}_.on("window-all-closed",()=>{process.platform!=="darwin"&&_.quit()});_.whenReady().then(()=>{try{process.defaultApp&&process.platform==="win32"?_.setAsDefaultProtocolClient(at,process.execPath,[process.argv[1]]):_.setAsDefaultProtocolClient(at)}catch{}let n=y.resolve(_.getAppPath(),".."),e=y.join(n,"cache");vt.registerFileProtocol("r5v",(t,o)=>{try{let s=new URL(t.url),a=decodeURIComponent(s.pathname).replace(/^\//,""),c=y.normalize(y.join(e,a));o({path:c})}catch{o({error:-6})}});let r=y.join(H,"..","dist");vt.interceptFileProtocol("file",(t,o)=>{try{let s=new URL(t.url),a=decodeURIComponent(s.pathname),c=a.replace(/\\/g,"/"),u=c.indexOf("/_astro/");if(u!==-1){let i=c.substring(u+8),l=y.join(r,"_astro",i);return o({path:l})}if(c.endsWith("/favicon.svg")||/\/favicon\.svg$/i.test(c)){let i=y.join(r,"favicon.svg");return o({path:i})}if(c.startsWith("/")){let i=c.replace(/^\/+/,""),l=y.join(r,i);try{return m.accessSync(l),o({path:l})}catch{}}return o({path:a})}catch{return o({error:-6})}}),xt();try{Pt(process.argv).forEach(t=>Q.push(t))}catch{}try{v?.webContents?.once("did-finish-load",jt)}catch{}try{R.autoDownload=!1;try{R.logger=Et,Et.transports.file.level="info"}catch{}R.on("error",t=>{try{v?.webContents.send("update:error",{message:String(t?.stack||t?.message||t)})}catch{}}),R.on("update-available",t=>{try{v?.webContents.send("update:available",t)}catch{}}),R.on("update-not-available",t=>{try{v?.webContents.send("update:not-available",t)}catch{}}),R.on("download-progress",t=>{try{v?.webContents.send("update:download-progress",t)}catch{}}),R.on("update-downloaded",t=>{try{v?.webContents.send("update:downloaded",t)}catch{}})}catch{}_.on("activate",()=>{Ct.getAllWindows().length===0&&xt()})});C.handle("update:check",async()=>{try{return{ok:!0,result:(await R.checkForUpdates())?.updateInfo||null}}catch(n){return{ok:!1,error:String(n?.message||n)}}});C.handle("update:download",async()=>{try{return await R.downloadUpdate(),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});C.handle("update:quitAndInstall",async()=>{try{return setImmediate(()=>R.quitAndInstall(!1,!0)),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});C.handle("app:getVersion",async()=>{try{return _.getVersion()}catch{return"0.0.0"}});C.handle("app:getBaseDir",async()=>{try{return y.resolve(_.getAppPath(),"..")}catch{return""}});C.handle("app:getLauncherInstallRoot",async()=>{try{let n=process.env.LOCALAPPDATA||y.join(_.getPath("home"),"AppData","Local");return y.join(n,"Programs","r5vlauncher")}catch{return""}});function Ht(n){try{let e=y.join(n,"mods.vdf"),r=m.readFileSync(e,"utf-8"),t={},o=/"([^"]+)"\s*"([01])"/g,s;for(;s=o.exec(r);){let a=s[1];a&&a!=="ModList"&&(t[a]=s[2]==="1")}return t}catch{return{}}}function dt(n){try{let e=y.join(n,"mods.vdf"),r=m.readFileSync(e,"utf-8"),t={},o=[],s=/"([^"]+)"\s*"([01])"/g,a;for(;a=s.exec(r);){let c=a[1];!c||c==="ModList"||(c in t||o.push(c),t[c]=a[2]==="1")}return{map:t,order:o}}catch{return{map:{},order:[]}}}function ct(n){try{let e=m.readFileSync(n,"utf-8"),r=e.match(/"id"\s*"([^"]+)"/i),t=e.match(/"name"\s*"([^"]+)"/i),o=r?r[1]:null,s=t?t[1]:null;return{id:o,name:s}}catch{return{id:null,name:null}}}function Jt(n,e){let r=['"ModList"',"{"];for(let[t,o]of Object.entries(e))r.push(`	"${t}"		"${o?"1":"0"}"`);r.push("}"),m.mkdirSync(n,{recursive:!0}),m.writeFileSync(y.join(n,"mods.vdf"),r.join(`
`),"utf-8")}function bt(n,e,r){let t=new Set,o=['"ModList"',"{"],s=a=>{o.push(`	"${a}"		"${r[a]?"1":"0"}"`),t.add(a)};for(let a of Array.isArray(e)?e:[])Object.prototype.hasOwnProperty.call(r,a)&&!t.has(a)&&s(a);for(let a of Object.keys(r))t.has(a)||s(a);o.push("}"),m.mkdirSync(n,{recursive:!0}),m.writeFileSync(y.join(n,"mods.vdf"),o.join(`
`),"utf-8")}C.handle("mods:listInstalled",async(n,{installDir:e})=>{try{let r=y.join(e,"mods"),{map:t,order:o}=dt(r),s=[],a=m.existsSync(r)?m.readdirSync(r,{withFileTypes:!0}):[];for(let u of a){if(!u.isDirectory())continue;let i=y.join(r,u.name),l=y.join(i,"manifest.json"),d=y.join(i,"mod.vdf"),h=y.join(i,"icon.png"),S=null;try{S=JSON.parse(m.readFileSync(l,"utf-8"))}catch{}let g=ct(d),w=g.id||S?.name||u.name,p=null;try{p=`data:image/png;base64,${m.readFileSync(h).toString("base64")}`}catch{}s.push({id:w,name:S?.name||g.name||u.name,folder:u.name,version:S?.version_number||null,description:S?.description||"",enabled:w?!!t[w]:!1,hasManifest:m.existsSync(l),iconDataUrl:p})}let c=new Map(o.map((u,i)=>[u,i]));return s.sort((u,i)=>{let l=u.id!=null&&c.has(u.id)?c.get(u.id):Number.MAX_SAFE_INTEGER,d=i.id!=null&&c.has(i.id)?c.get(i.id):Number.MAX_SAFE_INTEGER;return l!==d?l-d:String(u.name||"").localeCompare(String(i.name||""))}),{ok:!0,mods:s}}catch(r){return{ok:!1,error:String(r?.message||r)}}});C.handle("mods:setEnabled",async(n,{installDir:e,name:r,enabled:t})=>{try{let o=y.join(e,"mods"),{map:s}=dt(o);return s[r]=!!t,bt(o,void 0,s),{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}});C.handle("mods:reorder",async(n,{installDir:e,orderIds:r})=>{try{let t=y.join(e,"mods"),{map:o,order:s}=dt(t),a=Array.isArray(r)?r.filter(l=>typeof l=="string"&&l&&Object.prototype.hasOwnProperty.call(o,l)):[],c=new Set(a),u=s.filter(l=>Object.prototype.hasOwnProperty.call(o,l)&&!c.has(l)),i=[...a,...u];return bt(t,i,o),{ok:!0}}catch(t){return{ok:!1,error:String(t?.message||t)}}});C.handle("mods:uninstall",async(n,{installDir:e,folder:r})=>{try{let t=y.join(e,"mods"),o=y.join(t,r);return m.rmSync(o,{recursive:!0,force:!0}),{ok:!0}}catch(t){return{ok:!1,error:String(t?.message||t)}}});C.handle("mods:fetchAll",async(n,{query:e})=>{let r="https://thunderstore.io/c/r5valkyrie/api/v1/package-listing-index/",t=s=>new Promise((a,c)=>{W.get(s,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"*/*"}},i=>{if(i.statusCode&&i.statusCode>=300&&i.statusCode<400&&i.headers.location){i.resume();let d=i.headers.location.startsWith("http")?i.headers.location:new URL(i.headers.location,s).toString();return a(t(d))}if(i.statusCode!==200)return i.resume(),c(new Error(`HTTP ${i.statusCode}`));let l=[];i.on("data",d=>l.push(Buffer.isBuffer(d)?d:Buffer.from(d))),i.on("end",()=>a(Buffer.concat(l)))}).on("error",c)}),o=s=>{try{return Bt.gunzipSync(s)}catch{return s}};try{let s=await t(r),a=JSON.parse(o(s).toString("utf8")),c=Array.isArray(a)?a:[],u=6,i=[],l=0;await Promise.all(Array.from({length:u}).map(async()=>{for(;l<c.length;){let h=l++,S=c[h];try{let g=await t(S),w=o(g).toString("utf8"),p=JSON.parse(w);Array.isArray(p)&&i.push(...p)}catch{}}}));let d=i;if(e&&String(e).trim()){let h=String(e).toLowerCase();d=d.filter(S=>String(S?.name||"").toLowerCase().includes(h)||String(S?.full_name||"").toLowerCase().includes(h))}return{ok:!0,mods:d}}catch(s){try{let c=await t("https://thunderstore.io/c/r5valkyrie/api/v1/package/"),u=JSON.parse(c.toString("utf8")),i=Array.isArray(u)?u:[];if(e&&String(e).trim()){let l=String(e).toLowerCase();i=i.filter(d=>String(d?.name||"").toLowerCase().includes(l)||String(d?.full_name||"").toLowerCase().includes(l))}return{ok:!0,mods:i}}catch(a){return{ok:!1,error:String(a?.message||s?.message||a||s)}}}});C.handle("mods:install",async(n,{installDir:e,name:r,downloadUrl:t})=>{try{let o=String(r||"").trim();if(!o)return{ok:!1,error:"Invalid mod name"};if(st.has(o))return{ok:!0};st.add(o);let s=y.join(e,"mods");m.mkdirSync(s,{recursive:!0});let a=y.join(s,`.__mod_${Date.now()}.zip`),c=(d,h=0)=>new Promise((S,g)=>{if(h>5)return g(new Error("Too many redirects"));let w=m.createWriteStream(a);W.get(d,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"application/octet-stream,*/*;q=0.8",Referer:"https://thunderstore.io/",Connection:"keep-alive"}},f=>{if(f.statusCode&&f.statusCode>=300&&f.statusCode<400&&f.headers.location){f.resume(),w.close(()=>{});try{m.unlinkSync(a)}catch{}let b=f.headers.location.startsWith("http")?f.headers.location:new URL(f.headers.location,d).toString();return S(c(b,h+1))}if(f.statusCode!==200){w.close(()=>{});try{m.unlinkSync(a)}catch{}return f.resume(),g(new Error(`HTTP ${f.statusCode}`))}let k=Number(f.headers["content-length"]||0),E=0,x=Date.now(),D=b=>{try{n?.sender?.send("mods:progress",{key:r,phase:b,received:E,total:k})}catch{}};f.on("data",b=>{E+=Buffer.isBuffer(b)?b.length:Buffer.byteLength(String(b));let P=Date.now();P-x>150&&(x=P,D("downloading"))}),f.pipe(w),w.on("finish",()=>{D("downloading"),w.close(S)})}).on("error",f=>{try{m.unlinkSync(a)}catch{}g(f)})});await c(t);try{n?.sender?.send("mods:progress",{key:r,phase:"extracting"})}catch{}let u=y.join(s,r);try{m.rmSync(u,{recursive:!0,force:!0})}catch{}m.mkdirSync(u,{recursive:!0}),await new Promise((d,h)=>{let S=G("powershell.exe",["-NoProfile","-NonInteractive","-Command",`Expand-Archive -LiteralPath "${a}" -DestinationPath "${u}" -Force`],{stdio:"ignore"});S.on("exit",g=>g===0?d():h(new Error(`Expand-Archive failed ${g}`))),S.on("error",h)});try{m.unlinkSync(a)}catch{}let i=null;try{let d=y.join(u,"mod.vdf");if(m.existsSync(d))i=ct(d).id;else{let h=m.readdirSync(u,{withFileTypes:!0});for(let S of h)if(S.isDirectory()){let g=y.join(u,S.name,"mod.vdf");if(m.existsSync(g)&&(i=ct(g).id,i))break}}}catch{}let l=Ht(s);l[i||r]=!0,Jt(s,l);try{n?.sender?.send("mods:progress",{key:r,phase:"done"})}catch{}return{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}finally{try{st.delete(String(r||""))}catch{}}});C.handle("mods:watch",async(n,{installDir:e})=>{try{let r=y.join(e,"mods");if(!m.existsSync(r))return{ok:!0};let t=r;if(K.has(t))return{ok:!0};let o=m.watch(r,{persistent:!0},(s,a)=>{let c=t;clearTimeout(X.get(c));let u=setTimeout(()=>{try{v?.webContents?.send("mods:changed",{installDir:e})}catch{}},300);X.set(c,u)});return K.set(t,o),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});C.handle("mods:unwatch",async(n,{installDir:e})=>{try{let t=y.join(e,"mods"),o=K.get(t);if(o){try{o.close()}catch{}K.delete(t)}let s=X.get(t);return s&&(clearTimeout(s),X.delete(t)),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});C.handle("mods:iconDataUrl",async(n,{installDir:e,folder:r})=>{try{let t=y.join(e,"mods",r,"icon.png");return await m.promises.access(t),{ok:!0,dataUrl:`data:image/png;base64,${(await m.promises.readFile(t)).toString("base64")}`}}catch(t){return{ok:!1,error:String(t?.message||t)}}});C.handle("select-directory",async()=>{let n=await it.showOpenDialog({properties:["openDirectory","createDirectory"]});return n.canceled||n.filePaths.length===0?null:n.filePaths[0]});C.handle("settings:get",()=>kt());C.handle("settings:set",(n,{key:e,value:r})=>ot(e,r));C.handle("download:checksums",async(n,{baseUrl:e})=>yt(e));C.handle("download:all",async(n,{baseUrl:e,checksums:r,installDir:t,includeOptional:o,concurrency:s,partConcurrency:a,channelName:c,mode:u})=>{let i=(l,d)=>n.sender.send(l,d);try{if(!(String(u||"install").toLowerCase()==="install")){let d=y.join(t,"mods","mods.vdf");if(m.existsSync(d)){let S=(Array.isArray(r?.files)?r.files:[]).filter(g=>{try{return String(g?.path||g?.name||"").replace(/\\/g,"/").toLowerCase()!=="mods/mods.vdf"}catch{return!0}});r={...r||{},files:S}}}}catch{}I=pt();try{await mt(e,r,t,i,!!o,Number(s)||4,Number(a)||4,I);try{let l=St("channels",{})||{};l[String(c||"default")]={installDir:t,gameVersion:r?.game_version||null,gameBaseUrl:e,lastUpdatedAt:Date.now()},ot("channels",l)}catch(l){console.error("Failed to persist channel info",l)}}finally{I=null}return!0});C.handle("default-install-dir",(n,{channelName:e})=>{let r=process.env.LOCALAPPDATA||y.join(_.getPath("home"),"AppData","Local"),t=y.join(r,"Programs","R5VLibrary");return e?y.join(t,e):t});C.handle("launcher:config",async(n,{url:e})=>(t=>new Promise((o,s)=>{W.get(t,a=>{if(a.statusCode!==200){s(new Error(`HTTP ${a.statusCode} for ${t}`)),a.resume();return}let c="";a.setEncoding("utf8"),a.on("data",u=>c+=u),a.on("end",()=>{try{o(JSON.parse(c))}catch(u){s(u)}})}).on("error",s)}))(e));C.handle("eula:get",async()=>{let n="https://playvalkyrie.org/api/eula",e=r=>new Promise((t,o)=>{W.get(r,s=>{if(s.statusCode!==200){o(new Error(`HTTP ${s.statusCode}`)),s.resume();return}let a=[];s.on("data",c=>a.push(Buffer.isBuffer(c)?c:Buffer.from(c))),s.on("end",()=>{try{let c=Buffer.concat(a).toString("utf8");t(JSON.parse(c))}catch(c){o(c)}})}).on("error",o)});try{return{ok:!0,json:await e(n)}}catch(r){return{ok:!1,error:String(r?.message||r)}}});C.handle("video:cache",async(n,{filename:e})=>{let t=`https://blaze.playvalkyrie.org/video_backgrounds/${e}`,o=y.join(y.resolve(_.getAppPath(),".."),"cache"),s=y.join(o,"videos"),a=y.join(s,e);await m.promises.mkdir(s,{recursive:!0});try{return await m.promises.access(a),`r5v://videos/${e}`}catch{}return await new Promise((c,u)=>{let i=m.createWriteStream(a);W.get(t,l=>{if(l.statusCode!==200){i.close(()=>{}),m.unlink(a,()=>{}),u(new Error(`HTTP ${l.statusCode} video`)),l.resume();return}l.pipe(i),i.on("finish",()=>i.close(c))}).on("error",l=>{m.unlink(a,()=>u(l))})}),`r5v://videos/${e}`});C.handle("fs:exists",async(n,{path:e})=>{try{return await m.promises.access(e),!0}catch{return!1}});C.handle("path:open",async(n,{path:e})=>{try{return await J.openPath(e),!0}catch{return!1}});C.handle("open-external",async(n,{url:e})=>{try{return await J.openExternal(e),!0}catch{return!1}});C.handle("download:cancel",async()=>{try{et(I)}catch{}I=null;try{v?.webContents.send("progress:cancelled",{})}catch{}return!0});C.handle("select-file",async(n,{filters:e})=>{let r=await it.showOpenDialog({properties:["openFile"],filters:Array.isArray(e)?e:void 0});return r.canceled||r.filePaths.length===0?null:r.filePaths[0]});C.handle("game:launch",async(n,{channelName:e,installDir:r,mode:t,argsString:o})=>{try{if(!r)throw new Error("Missing installDir");let s=String(t).toUpperCase()==="SERVER"?"r5apex_ds.exe":"r5apex.exe",a=y.join(r,s);await m.promises.access(a).catch(()=>{throw new Error(`Executable not found: ${a}`)});let u=(l=>!l||typeof l!="string"?[]:(l.match(/(?:[^\s\"]+|\"[^\"]*\")+/g)||[]).map(h=>h.replace(/^\"|\"$/g,"")))(o);return G(a,u,{cwd:r,detached:!0,stdio:"ignore",env:{...process.env}}).unref(),{ok:!0}}catch(s){return{ok:!1,error:String(s?.message||s)}}});C.handle("fix-folder-permissions",async(n,{folderPath:e})=>{let r=[];try{if(!e)return{ok:!1,error:"No folder path provided"};let t=y.resolve(e).replace(/\//g,"\\");if(!t||t.length<3)return{ok:!1,error:`Invalid path format: ${e}`};let o=t.length>=3&&t[1]===":"?t.slice(3):t;if(/[<>:"|?*]/.test(o))return{ok:!1,error:`Path contains invalid characters: ${t}`};try{m.mkdirSync(e,{recursive:!0})}catch(d){r.push(`Folder creation: ${d.message}`)}let c=Ot.userInfo().username,u=y.join(process.resourcesPath,"elevate.exe"),i=m.existsSync(u);try{m.mkdirSync(t,{recursive:!0})}catch{}let l=[{exe:"icacls",args:[t,"/grant",`${c}:F`,"/t","/q"],desc:`Grant permissions to current user (${c})`},{exe:"icacls",args:[t,"/grant","Everyone:F","/t","/q"],desc:"Grant Everyone full permissions"},{exe:"icacls",args:[t,"/grant","Users:F","/t","/q"],desc:"Grant Users full permissions"}];for(let d=0;d<l.length;d++){let{exe:h,args:S,desc:g}=l[d];try{let w=await new Promise((p,f)=>{let k,E,x;i?(E=[u,["-wait",h,...S]],x={stdio:["ignore","pipe","pipe"],windowsHide:!0}):(E=[h,S],x={stdio:["ignore","pipe","pipe"],windowsHide:!0});try{k=G(E[0],E[1],x)}catch(P){console.error("[Permission Fix] Spawn failed:",P),f(P);return}let D="",b="";k.stdout&&k.stdout.on("data",P=>{D+=P.toString()}),k.stderr&&k.stderr.on("data",P=>{b+=P.toString()}),k.on("exit",(P,L)=>{p({code:P,stdout:D,stderr:b,signal:L})}),k.on("error",P=>{f(P)}),setTimeout(()=>{try{k.kill()}catch{}f(new Error("Command timeout"))},3e4)});if(w.code!==0){let p=w.stderr||w.stdout||"Unknown error";if(!(p.includes("duplicate")||p.includes("already")||w.code===1332)){let k=`${g} failed (code ${w.code}): ${p}`;r.push(k)}}}catch(w){let p=`${g} error: ${w.message}`;r.push(p)}}try{let d=y.join(t,"test_write.tmp");m.writeFileSync(d,"test"),m.unlinkSync(d)}catch(d){let h=`Write test failed: ${d.message}`;r.push(h);try{if(m.mkdirSync(t,{recursive:!0}),(await new Promise(g=>{let w=G("cmd",["/c",`icacls "${t}" /grant "%USERNAME%":F /q`],{stdio:"ignore",windowsHide:!0});w.on("exit",p=>g({code:p})),w.on("error",()=>g({code:1})),setTimeout(()=>{try{w.kill()}catch{}g({code:1})},5e3)})).code===0){let g=y.join(t,"test_write2.tmp");return m.writeFileSync(g,"test"),m.unlinkSync(g),{ok:!0,warnings:r}}}catch{}return{ok:!1,error:h,details:r}}return r.length>0?{ok:!0,warnings:r}:{ok:!0}}catch(t){let o=`Unexpected error: ${t?.message||t}`;return r.push(o),{ok:!1,error:o,details:r}}});C.on("window:minimize",()=>{v?.minimize()});C.on("window:maximize",()=>{v&&(v.isMaximized()?v.unmaximize():v.maximize())});C.on("window:close",()=>{v?.close()});_.on("before-quit",()=>{if(I)try{et(I)}catch{}});
