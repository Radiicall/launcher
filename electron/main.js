import{app as L,BrowserWindow as Nt,ipcMain as P,dialog as mt,protocol as Tt,shell as $t}from"electron";import{createRequire as Qt}from"node:module";import m from"node:path";import{fileURLToPath as Yt,pathToFileURL as Ee}from"node:url";import Q from"node:https";import g from"node:fs";import Zt from"node:zlib";import{spawn as et}from"node:child_process";import te from"node:os";import C from"node:fs";import b from"node:path";import zt from"node:crypto";import{pipeline as Bt}from"node:stream";import{promisify as Wt}from"node:util";import at from"node:https";var jt=Wt(Bt);function ot(s){return String(s||"").replace(/\\/g,"/").replace(/^\/+/,"")}function vt(s){return String(s||"").replace(/\\/g,"/").toLowerCase()}var K=new Map,Pt=new at.Agent({keepAlive:!0,maxSockets:64,maxFreeSockets:32,keepAliveMsecs:6e4,scheduling:"fifo"});function O(s){return new Promise((e,r)=>{let t=zt.createHash("sha256"),n=C.createReadStream(s);n.on("error",r),n.on("end",()=>e(t.digest("hex"))),n.on("data",o=>t.update(o))})}function Ct(s){C.mkdirSync(s,{recursive:!0})}function qt(s){return new Promise((e,r)=>{let t=at.get(s,{agent:Pt},n=>{if(n.statusCode!==200){r(new Error(`HTTP ${n.statusCode} for ${s}`)),n.resume();return}let o="";n.setEncoding("utf8"),n.on("data",a=>o+=a),n.on("end",()=>{try{e(JSON.parse(o))}catch(a){r(a)}})});t.on("error",r),t.setTimeout(3e4,()=>{t.destroy(),r(new Error("JSON fetch timeout"))})})}function B(s){return new Promise(e=>setTimeout(e,s))}function At(){return{cancelled:!1,requests:new Set}}function ct(s){if(s){s.cancelled=!0;for(let e of s.requests)try{e.destroy(new Error("cancelled"))}catch{}s.requests.clear()}}var Ht=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE","ENOTFOUND","ECONNREFUSED","EHOSTDOWN","ENETDOWN"]);async function J(s,e,r,t=1,n,o=0,a=0){return new Promise((c,f)=>{Ct(b.dirname(e));let i=C.createWriteStream(e,{flags:o>0?"a":"w"});if(n?.cancelled)return i.close(()=>{}),f(new Error("cancelled"));let l={agent:Pt};o>0&&(l.headers={Range:`bytes=${o}-`});let p=at.get(s,l,d=>{if(d.statusCode!==200&&!(o>0&&d.statusCode===206)){if(i.close(()=>{}),o>0&&d.statusCode===200){try{C.unlinkSync(e)}catch{}let u=Math.min(2e3*t,1e4);d.resume();try{p.destroy(new Error("restart:range-ignored"))}catch{}return B(u).then(()=>c(J(s,e,r,t+1,n,0,a)))}if(C.unlink(e,()=>{}),d.statusCode&&[429,500,502,503,504].includes(d.statusCode)&&t<5){let u=Math.min(2e3*t,1e4);return d.resume(),B(u).then(()=>c(J(s,e,r,t+1,n,o,a)))}f(new Error(`HTTP ${d.statusCode} for ${s}`)),d.resume();return}let S=Number(d.headers["content-length"]||0),k=a>0?a:o>0?o+S:S,h=0,E=Date.now(),y=t<=2?3e4:45e3,w=setInterval(()=>{if(!n?.cancelled&&Date.now()-E>y)try{let u=new Error("stalled");u.code="ETIMEDOUT",p.destroy(u)}catch{}},1e4);d.on("data",u=>{h+=u.length,E=Date.now(),r&&r(Math.min(o+h,k||o+h),k||0)}),d.on("aborted",async()=>{let u=new Promise(A=>i.close(()=>A()));try{clearInterval(w)}catch{}try{await u}catch{}if(t<5){let A=Math.min(2e3*t,1e4);return B(A).then(()=>c(J(s,e,r,t+1,n,o+h,a)))}f(new Error("response aborted"))}),jt(d,i).then(()=>{try{clearInterval(w)}catch{}c()}).catch(u=>{try{clearInterval(w)}catch{}f(u)})});if(n?.requests.add(p),p.on("socket",d=>{try{d.setKeepAlive(!0,6e4),d.setNoDelay(!0),d.setRecvBufferSize&&d.setRecvBufferSize(64*1024),d.setSendBufferSize&&d.setSendBufferSize(64*1024)}catch{}}),p.on("close",()=>n?.requests.delete(p)),p.setTimeout(9e4,()=>{try{let d=new Error("Request timeout");d.code="ETIMEDOUT",p.destroy(d)}catch{}}),n?.cancelled)try{p.destroy(new Error("cancelled"))}catch{}p.on("error",async d=>{let S=d?.code,k=t<8&&S&&Ht.has(String(S)),h=new Promise(E=>{try{i.close(()=>E())}catch{E()}});try{await h}catch{}if(k){let E=Math.min(1e3*Math.pow(1.5,t),15e3),y=Math.random()*1e3,w=E+y,u=o;try{u=C.statSync(e).size}catch{}return B(w).then(()=>c(J(s,e,r,t+1,n,u,a)))}f(d)})})}async function Ot(s,e,r){try{let t=C.statSync(s);return r&&Number(r)>0&&t.size!==Number(r)?!1:(await O(s)).toLowerCase()===String(e).toLowerCase()}catch{return!1}}async function xt(s){let e=`${s.replace(/\/$/,"")}/checksums.json`;return qt(e)}async function Jt(s,e,r,t,n=4,o){let a=ot(e.path).split("/").join(b.sep),c=b.join(r,a);if(Ct(b.dirname(c)),await Ot(c,e.checksum,e.size))return t("progress:skip",{path:e.path}),{downloadComplete:!0,verificationComplete:!0,targetPath:c};if(o?.cancelled)throw new Error("cancelled");if(Array.isArray(e.parts)&&e.parts.length>0){let i=e.parts.length,l=new Array(i),p=0,d=new Set;async function S(){for(;;){let h=p++;if(h>=i)return;if(d.has(h))continue;d.add(h);let E=e.parts[h],y=ot(E.path),w=`${s.replace(/\/$/,"")}/${y}`,u=`${c}.part${h}`;try{if(C.existsSync(u))if((await O(u)).toLowerCase()===String(E.checksum).toLowerCase()){t("progress:part",{path:e.path,part:h,totalParts:i,received:Number(E.size||0),total:Number(E.size||0)}),l[h]=u;continue}else try{C.unlinkSync(u)}catch{}}catch{}let A=0;for(;;){if(o?.cancelled)throw new Error("cancelled");A+=1;let x=0,D=0;try{let V=0;try{V=C.statSync(u).size}catch{}let N=Number(E.size||0);if(N>0&&V>N)try{C.unlinkSync(u),V=0}catch{}await J(w,u,(_,W)=>{let j=Math.max(0,_-D);D=_;try{j>0&&t("progress:bytes",{delta:j})}catch{}x+=j;let H=N||W||0;t("progress:part",{path:e.path,part:h,totalParts:i,received:Math.min(_,H||_),total:H})},1,o,V,N)}catch{try{C.unlinkSync(u)}catch{}try{x>0&&t("progress:bytes",{delta:-x})}catch{}try{t("progress:part:reset",{path:e.path,part:h,totalParts:i})}catch{}let N=Math.min(2e3*A,1e4);await B(N);continue}if((await O(u)).toLowerCase()===String(E.checksum).toLowerCase())break;try{C.unlinkSync(u)}catch{}try{x>0&&t("progress:bytes",{delta:-x})}catch{}try{t("progress:part:reset",{path:e.path,part:h,totalParts:i})}catch{}let T=Math.min(2e3*A,1e4);await B(T)}l[h]=u}}let k=Array.from({length:Math.max(1,n)},()=>S());return await Promise.all(k),{downloadComplete:!0,verificationComplete:!1,targetPath:c,mergeAndVerifyAsync:async()=>{t("progress:merge:start",{path:e.path,parts:l.length});let h=C.createWriteStream(c);for(let y=0;y<l.length;y++){let w=l[y];t("progress:merge:part",{path:e.path,part:y,totalParts:l.length}),await new Promise((u,A)=>{let x=C.createReadStream(w);x.on("error",A),h.on("error",A),x.on("end",()=>{try{C.unlinkSync(w)}catch{}u()}),x.pipe(h,{end:!1})})}await new Promise((y,w)=>{h.on("error",w),h.on("finish",y),h.end()});try{t("progress:merge:done",{path:e.path})}catch{}if(t("progress:verify",{path:e.path}),(await O(c)).toLowerCase()!==String(e.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${e.path}`);try{let y=C.readdirSync(b.dirname(c)),w=b.basename(c);y.forEach(u=>{if(u.startsWith(w+".part"))try{C.unlinkSync(b.join(b.dirname(c),u))}catch{}})}catch{}return{verificationComplete:!0,targetPath:c,filePath:e.path}}}}else{let i=ot(e.path),l=`${s.replace(/\/$/,"")}/${i}`,p=0;for(;;){p+=1;let d=0,S=0,k=`${c}.download`,h=0;try{h=C.statSync(k).size}catch{}let E=Number(e.size||0);if(E>0&&h>E)try{C.unlinkSync(k),h=0}catch{}if(await J(l,k,(w,u)=>{let A=Math.max(0,w-S);S=w;try{A>0&&t("progress:bytes",{delta:A})}catch{}d+=A;let x=E||u||0;t("progress:file",{path:e.path,received:Math.min(w,x||w),total:x})},1,o,h,E),(await O(k)).toLowerCase()===String(e.checksum).toLowerCase())break;try{C.unlinkSync(k)}catch{}try{d>0&&t("progress:bytes",{delta:-d})}catch{}if(p>=2)throw new Error(`Checksum mismatch for ${e.path}`)}try{C.unlinkSync(c)}catch{}C.renameSync(`${c}.download`,c)}if(t("progress:verify",{path:e.path}),(await O(c)).toLowerCase()!==String(e.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${e.path}`);return{downloadComplete:!0,verificationComplete:!0,targetPath:c}}async function bt(s,e,r,t,n=!1,o=4,a=4,c,f){let i=new Set,l=[];for(let w of e.files||[]){if(!(n||!w.optional))continue;let u=vt(w.path);u&&(i.has(u)||(i.add(u),l.push(w)))}let p=l.filter(w=>!(Array.isArray(w.parts)&&w.parts.length>0)),d=l.filter(w=>Array.isArray(w.parts)&&w.parts.length>0),S=p.concat(d),k=S.length,h=0,E=S.reduce((w,u)=>{let A=Number(u.size||0);return A>0?w+A:Array.isArray(u.parts)&&u.parts.length?w+u.parts.reduce((x,D)=>x+Number(D.size||0),0):w},0);try{t("progress:bytes:total",{totalBytes:E})}catch{}async function y(w,u,A,x=!1){let D=0,M=[];async function T(){for(;;){for(;f&&f();)if(await B(100),c?.cancelled)return;let N=D++;if(N>=w.length)return;let _=w[N],W=u+N,j=vt(_.path),H=async()=>Jt(s,_,r,t,a,c),wt=!1,Y=K.get(j);Y?wt=!0:(t("progress:start",{index:W,total:k,path:_.path,completed:h}),Y=(async()=>{try{let z=await H();if(x&&z?.mergeAndVerifyAsync){let kt=z.mergeAndVerifyAsync().then($=>($?.filePath&&(h+=1,t("progress:done",{index:W,total:k,path:$.filePath,completed:h})),$)).catch($=>{if(String($?.message||$||"error").includes("cancelled"))throw $;try{let U=b.join(r,_.path.replace(/\\/g,b.sep));try{C.unlinkSync(U)}catch{}try{let R=C.readdirSync(b.dirname(U)),F=b.basename(U);R.forEach(Z=>{if(Z.startsWith(F+".part"))try{C.unlinkSync(b.join(b.dirname(U),Z))}catch{}})}catch{}return H().then(R=>R.mergeAndVerifyAsync?R.mergeAndVerifyAsync().then(F=>(F?.filePath&&(h+=1,t("progress:done",{index:W,total:k,path:F.filePath,completed:h})),F)):R)}catch(U){try{t("progress:error",{path:_.path,message:String(U?.message||U)})}catch{}throw U}});return M.push(kt),{...z,skipProgressDone:!0}}return z}catch(z){if(String(z?.message||z||"error").includes("cancelled"))throw z;try{let $=b.join(r,_.path.replace(/\\/g,b.sep));try{C.unlinkSync($)}catch{}let G=await H();if(x&&G?.mergeAndVerifyAsync){let U=G.mergeAndVerifyAsync().then(R=>(R?.filePath&&(h+=1,t("progress:done",{index:W,total:k,path:R.filePath,completed:h})),R)).catch(R=>{try{let F=b.join(r,_.path.replace(/\\/g,b.sep)),Z=C.readdirSync(b.dirname(F)),Ft=b.basename(F);Z.forEach(Et=>{if(Et.startsWith(Ft+".part"))try{C.unlinkSync(b.join(b.dirname(F),Et))}catch{}})}catch{}try{t("progress:error",{path:_.path,message:String(R?.message||R)})}catch{}throw R});return M.push(U),{...G,skipProgressDone:!0}}return G}catch($){try{t("progress:error",{path:_.path,message:String($?.message||$)})}catch{}throw $}}})(),K.set(j,Y));let St;try{St=await Y}finally{wt||K.delete(j)}St?.skipProgressDone||(h+=1,t("progress:done",{index:W,total:k,path:_.path,completed:h})),await B(10)}}let V=Array.from({length:Math.max(1,A)},()=>T());await Promise.all(V),M.length>0&&await Promise.all(M)}if(await y(p,0,Math.max(1,o)),K.size>0)try{await Promise.all([...K.values()])}catch{}await y(d,p.length,1,!0)}import it from"node:fs";import Gt from"node:path";import{app as Kt}from"electron";var Dt=Kt.getPath("userData"),Lt=Gt.join(Dt,"settings.json");function lt(){try{let s=it.readFileSync(Lt,"utf-8");return JSON.parse(s)}catch{return{}}}function Xt(s){it.mkdirSync(Dt,{recursive:!0}),it.writeFileSync(Lt,JSON.stringify(s,null,2),"utf-8")}function _t(s,e=void 0){return lt()[s]??e}function dt(s,e){let r=lt();r[s]=e,Xt(r)}function ht(){return lt()}var Ut=Qt(import.meta.url),{autoUpdater:I}=Ut("electron-updater"),Rt=Ut("electron-log"),ee=Yt(import.meta.url),tt=m.dirname(ee);var v,q=null,ut=new Set,rt=new Map,nt=new Map,ft="r5v",st=[];function It(s){try{return(s||[]).filter(e=>typeof e=="string"&&e.startsWith(`${ft}://`))}catch{return[]}}function yt(s){try{let e=new URL(s);if(e.hostname==="mod"&&e.pathname==="/install"){let r=e.searchParams.get("name")||"",t=e.searchParams.get("version")||"",n=e.searchParams.get("downloadUrl")?.split(",")||"";if(v&&v.webContents&&!v.webContents.isLoading())try{v.webContents.send("deeplink:mod-install",{url:s,name:r,version:t,downloadUrls:n})}catch{}else st.push(s)}}catch{}}function re(){for(;st.length;){let s=st.shift();yt(s)}}var ne=L.requestSingleInstanceLock();ne?L.on("second-instance",(s,e)=>{try{It(e).forEach(t=>yt(t)),v&&(v.isMinimized()&&v.restore(),v.focus())}catch{}}):L.quit();L.on("open-url",(s,e)=>{s.preventDefault(),yt(e)});async function Mt(){v=new Nt({width:1150,height:800,minWidth:1150,minHeight:800,frame:!1,titleBarStyle:"hidden",webPreferences:{preload:m.join(tt,"preload.cjs"),contextIsolation:!0,nodeIntegration:!1},show:!1,icon:m.join(tt,"..","public","icon.png")});let s=process.env.VITE_DEV_SERVER_URL;if(s)await v.loadURL(s);else{let n=m.join(tt,"..","dist","index.html");await v.loadFile(n)}v.webContents.setWindowOpenHandler(({url:n})=>{try{$t.openExternal(n)}catch{}return{action:"deny"}}),v.webContents.on("will-navigate",(n,o)=>{let a=o.startsWith("file:"),c=!!process.env.VITE_DEV_SERVER_URL&&o.startsWith(String(process.env.VITE_DEV_SERVER_URL));if(!a&&!c){n.preventDefault();try{$t.openExternal(o)}catch{}}});let e=()=>{v&&(v.isVisible()||v.show(),v.isFocused()||v.focus())};v.once("ready-to-show",e),v.webContents.once("did-finish-load",e);let r=setTimeout(e,1e3);v.on("show",()=>clearTimeout(r)),(!!process.env.VITE_DEV_SERVER_URL||process.env.NODE_ENV==="development")&&v.webContents.openDevTools({mode:"detach"}),v.webContents.on("did-fail-load",(n,o,a,c)=>{console.error("Load failed",{errorCode:o,errorDesc:a,validatedURL:c}),mt.showErrorBox("Load failed",`${a} (code ${o})
URL: ${c}`),v.show()})}L.on("window-all-closed",()=>{process.platform!=="darwin"&&L.quit()});L.whenReady().then(()=>{try{process.defaultApp&&process.platform==="win32"?L.setAsDefaultProtocolClient(ft,process.execPath,[process.argv[1]]):L.setAsDefaultProtocolClient(ft)}catch{}let s=m.resolve(L.getAppPath(),".."),e=m.join(s,"cache");Tt.registerFileProtocol("r5v",(t,n)=>{try{let o=new URL(t.url),a=decodeURIComponent(o.pathname).replace(/^\//,""),c=m.normalize(m.join(e,a));n({path:c})}catch{n({error:-6})}});let r=m.join(tt,"..","dist");Tt.interceptFileProtocol("file",(t,n)=>{try{let o=new URL(t.url),a=decodeURIComponent(o.pathname),c=a.replace(/\\/g,"/"),f=c.indexOf("/_astro/");if(f!==-1){let i=c.substring(f+8),l=m.join(r,"_astro",i);return n({path:l})}if(c.endsWith("/favicon.svg")||/\/favicon\.svg$/i.test(c)){let i=m.join(r,"favicon.svg");return n({path:i})}if(c.startsWith("/")){let i=c.replace(/^\/+/,""),l=m.join(r,i);try{return g.accessSync(l),n({path:l})}catch{}}return n({path:a})}catch{return n({error:-6})}}),Mt();try{It(process.argv).forEach(t=>st.push(t))}catch{}try{v?.webContents?.once("did-finish-load",re)}catch{}try{I.autoDownload=!1;try{I.logger=Rt,Rt.transports.file.level="info"}catch{}I.on("error",t=>{try{v?.webContents.send("update:error",{message:String(t?.stack||t?.message||t)})}catch{}}),I.on("update-available",t=>{try{v?.webContents.send("update:available",t)}catch{}}),I.on("update-not-available",t=>{try{v?.webContents.send("update:not-available",t)}catch{}}),I.on("download-progress",t=>{try{v?.webContents.send("update:download-progress",t)}catch{}}),I.on("update-downloaded",t=>{try{v?.webContents.send("update:downloaded",t)}catch{}})}catch{}L.on("activate",()=>{Nt.getAllWindows().length===0&&Mt()})});P.handle("update:check",async()=>{try{return{ok:!0,result:(await I.checkForUpdates())?.updateInfo||null}}catch(s){return{ok:!1,error:String(s?.message||s)}}});P.handle("update:download",async()=>{try{return await I.downloadUpdate(),{ok:!0}}catch(s){return{ok:!1,error:String(s?.message||s)}}});P.handle("update:quitAndInstall",async()=>{try{return setImmediate(()=>I.quitAndInstall(!1,!0)),{ok:!0}}catch(s){return{ok:!1,error:String(s?.message||s)}}});P.handle("app:getVersion",async()=>{try{return L.getVersion()}catch{return"0.0.0"}});P.handle("app:getBaseDir",async()=>{try{return m.resolve(L.getAppPath(),"..")}catch{return""}});P.handle("app:getLauncherInstallRoot",async()=>{try{let s=process.env.LOCALAPPDATA||m.join(L.getPath("home"),"AppData","Local");return m.join(s,"Programs","r5vlauncher")}catch{return""}});function se(s){try{let e=m.join(s,"mods.vdf"),r=g.readFileSync(e,"utf-8"),t={},n=/"([^"]+)"\s*"([01])"/g,o;for(;o=n.exec(r);){let a=o[1];a&&a!=="ModList"&&(t[a]=o[2]==="1")}return t}catch{return{}}}function gt(s){try{let e=m.join(s,"mods.vdf"),r=g.readFileSync(e,"utf-8"),t={},n=[],o=/"([^"]+)"\s*"([01])"/g,a;for(;a=o.exec(r);){let c=a[1];!c||c==="ModList"||(c in t||n.push(c),t[c]=a[2]==="1")}return{map:t,order:n}}catch{return{map:{},order:[]}}}function pt(s){try{let e=g.readFileSync(s,"utf-8"),r=e.match(/"id"\s*"([^"]+)"/i),t=e.match(/"name"\s*"([^"]+)"/i),n=r?r[1]:null,o=t?t[1]:null;return{id:n,name:o}}catch{return{id:null,name:null}}}function oe(s,e){let r=['"ModList"',"{"];for(let[t,n]of Object.entries(e))r.push(`	"${t}"		"${n?"1":"0"}"`);r.push("}"),g.mkdirSync(s,{recursive:!0}),g.writeFileSync(m.join(s,"mods.vdf"),r.join(`
`),"utf-8")}function Vt(s,e,r){let t=new Set,n=['"ModList"',"{"],o=a=>{n.push(`	"${a}"		"${r[a]?"1":"0"}"`),t.add(a)};for(let a of Array.isArray(e)?e:[])Object.prototype.hasOwnProperty.call(r,a)&&!t.has(a)&&o(a);for(let a of Object.keys(r))t.has(a)||o(a);n.push("}"),g.mkdirSync(s,{recursive:!0}),g.writeFileSync(m.join(s,"mods.vdf"),n.join(`
`),"utf-8")}P.handle("mods:listInstalled",async(s,{installDir:e})=>{try{let r=m.join(e,"mods"),{map:t,order:n}=gt(r),o=[],a=g.existsSync(r)?g.readdirSync(r,{withFileTypes:!0}):[];for(let f of a){if(!f.isDirectory())continue;let i=m.join(r,f.name),l=m.join(i,"manifest.json"),p=m.join(i,"mod.vdf"),d=m.join(i,"icon.png"),S=null;try{S=JSON.parse(g.readFileSync(l,"utf-8"))}catch{}let k=pt(p),h=k.id||S?.name||f.name,E=null;try{E=`data:image/png;base64,${g.readFileSync(d).toString("base64")}`}catch{}o.push({id:h,name:S?.name||k.name||f.name,folder:f.name,version:S?.version_number||null,description:S?.description||"",enabled:h?!!t[h]:!1,hasManifest:g.existsSync(l),iconDataUrl:E})}let c=new Map(n.map((f,i)=>[f,i]));return o.sort((f,i)=>{let l=f.id!=null&&c.has(f.id)?c.get(f.id):Number.MAX_SAFE_INTEGER,p=i.id!=null&&c.has(i.id)?c.get(i.id):Number.MAX_SAFE_INTEGER;return l!==p?l-p:String(f.name||"").localeCompare(String(i.name||""))}),{ok:!0,mods:o}}catch(r){return{ok:!1,error:String(r?.message||r)}}});P.handle("mods:setEnabled",async(s,{installDir:e,name:r,enabled:t})=>{try{let n=m.join(e,"mods"),{map:o}=gt(n);return o[r]=!!t,Vt(n,void 0,o),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});P.handle("mods:reorder",async(s,{installDir:e,orderIds:r})=>{try{let t=m.join(e,"mods"),{map:n,order:o}=gt(t),a=Array.isArray(r)?r.filter(l=>typeof l=="string"&&l&&Object.prototype.hasOwnProperty.call(n,l)):[],c=new Set(a),f=o.filter(l=>Object.prototype.hasOwnProperty.call(n,l)&&!c.has(l)),i=[...a,...f];return Vt(t,i,n),{ok:!0}}catch(t){return{ok:!1,error:String(t?.message||t)}}});P.handle("mods:uninstall",async(s,{installDir:e,folder:r})=>{try{let t=m.join(e,"mods"),n=m.join(t,r);return g.rmSync(n,{recursive:!0,force:!0}),{ok:!0}}catch(t){return{ok:!1,error:String(t?.message||t)}}});P.handle("mods:fetchAll",async(s,{query:e})=>{let r="https://thunderstore.io/c/r5valkyrie/api/v1/package-listing-index/",t=o=>new Promise((a,c)=>{Q.get(o,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"*/*"}},i=>{if(i.statusCode&&i.statusCode>=300&&i.statusCode<400&&i.headers.location){i.resume();let p=i.headers.location.startsWith("http")?i.headers.location:new URL(i.headers.location,o).toString();return a(t(p))}if(i.statusCode!==200)return i.resume(),c(new Error(`HTTP ${i.statusCode}`));let l=[];i.on("data",p=>l.push(Buffer.isBuffer(p)?p:Buffer.from(p))),i.on("end",()=>a(Buffer.concat(l)))}).on("error",c)}),n=o=>{try{return Zt.gunzipSync(o)}catch{return o}};try{let o=await t(r),a=JSON.parse(n(o).toString("utf8")),c=Array.isArray(a)?a:[],f=6,i=[],l=0;await Promise.all(Array.from({length:f}).map(async()=>{for(;l<c.length;){let d=l++,S=c[d];try{let k=await t(S),h=n(k).toString("utf8"),E=JSON.parse(h);Array.isArray(E)&&i.push(...E)}catch{}}}));let p=i;if(e&&String(e).trim()){let d=String(e).toLowerCase();p=p.filter(S=>String(S?.name||"").toLowerCase().includes(d)||String(S?.full_name||"").toLowerCase().includes(d))}return{ok:!0,mods:p}}catch(o){try{let c=await t("https://thunderstore.io/c/r5valkyrie/api/v1/package/"),f=JSON.parse(c.toString("utf8")),i=Array.isArray(f)?f:[];if(e&&String(e).trim()){let l=String(e).toLowerCase();i=i.filter(p=>String(p?.name||"").toLowerCase().includes(l)||String(p?.full_name||"").toLowerCase().includes(l))}return{ok:!0,mods:i}}catch(a){return{ok:!1,error:String(a?.message||o?.message||a||o)}}}});P.handle("mods:install",async(s,{installDir:e,name:r,downloadUrl:t})=>{if(!t.startsWith("https://thunderstore.io"))return{ok:!1,error:"Download URL does not point to Thunderstore"};try{let n=String(r||"").trim();if(!n)return{ok:!1,error:"Invalid mod name"};if(ut.has(n))return{ok:!0};ut.add(n);let o=m.join(e,"mods");g.mkdirSync(o,{recursive:!0});let a=m.join(o,`.__mod_${Date.now()}.zip`),c=(p,d=0)=>new Promise((S,k)=>{if(d>5)return k(new Error("Too many redirects"));let h=g.createWriteStream(a);Q.get(p,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"application/octet-stream,*/*;q=0.8",Referer:"https://thunderstore.io/",Connection:"keep-alive"}},y=>{if(y.statusCode&&y.statusCode>=300&&y.statusCode<400&&y.headers.location){y.resume(),h.close(()=>{});try{g.unlinkSync(a)}catch{}let D=y.headers.location.startsWith("http")?y.headers.location:new URL(y.headers.location,p).toString();return S(c(D,d+1))}if(y.statusCode!==200){h.close(()=>{});try{g.unlinkSync(a)}catch{}return y.resume(),k(new Error(`HTTP ${y.statusCode}`))}let w=Number(y.headers["content-length"]||0),u=0,A=Date.now(),x=D=>{try{s?.sender?.send("mods:progress",{key:r,phase:D,received:u,total:w})}catch{}};y.on("data",D=>{u+=Buffer.isBuffer(D)?D.length:Buffer.byteLength(String(D));let M=Date.now();M-A>150&&(A=M,x("downloading"))}),y.pipe(h),h.on("finish",()=>{x("downloading"),h.close(S)})}).on("error",y=>{try{g.unlinkSync(a)}catch{}k(y)})});await c(t);try{s?.sender?.send("mods:progress",{key:r,phase:"extracting"})}catch{}let f=m.join(o,r);try{g.rmSync(f,{recursive:!0,force:!0})}catch{}g.mkdirSync(f,{recursive:!0}),await new Promise((p,d)=>{let S=et("powershell.exe",["-NoProfile","-NonInteractive","-Command",`Expand-Archive -LiteralPath "${a}" -DestinationPath "${f}" -Force`],{stdio:"ignore"});S.on("exit",k=>k===0?p():d(new Error(`Expand-Archive failed ${k}`))),S.on("error",d)});try{g.unlinkSync(a)}catch{}let i=null;try{let p=m.join(f,"mod.vdf");if(g.existsSync(p))i=pt(p).id;else{let d=g.readdirSync(f,{withFileTypes:!0});for(let S of d)if(S.isDirectory()){let k=m.join(f,S.name,"mod.vdf");if(g.existsSync(k)&&(i=pt(k).id,i))break}}}catch{}let l=se(o);l[i||r]=!0,oe(o,l);try{s?.sender?.send("mods:progress",{key:r,phase:"done"})}catch{}return{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}finally{try{ut.delete(String(r||""))}catch{}}});P.handle("mods:watch",async(s,{installDir:e})=>{try{let r=m.join(e,"mods");if(!g.existsSync(r))return{ok:!0};let t=r;if(rt.has(t))return{ok:!0};let n=g.watch(r,{persistent:!0},(o,a)=>{let c=t;clearTimeout(nt.get(c));let f=setTimeout(()=>{try{v?.webContents?.send("mods:changed",{installDir:e})}catch{}},300);nt.set(c,f)});return rt.set(t,n),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});P.handle("mods:unwatch",async(s,{installDir:e})=>{try{let t=m.join(e,"mods"),n=rt.get(t);if(n){try{n.close()}catch{}rt.delete(t)}let o=nt.get(t);return o&&(clearTimeout(o),nt.delete(t)),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});P.handle("mods:iconDataUrl",async(s,{installDir:e,folder:r})=>{try{let t=m.join(e,"mods",r,"icon.png");return await g.promises.access(t),{ok:!0,dataUrl:`data:image/png;base64,${(await g.promises.readFile(t)).toString("base64")}`}}catch(t){return{ok:!1,error:String(t?.message||t)}}});P.handle("select-directory",async()=>{let s=await mt.showOpenDialog({properties:["openDirectory","createDirectory"]});return s.canceled||s.filePaths.length===0?null:s.filePaths[0]});P.handle("settings:get",()=>ht());P.handle("settings:set",(s,{key:e,value:r})=>dt(e,r));P.handle("download:checksums",async(s,{baseUrl:e})=>xt(e));P.handle("download:all",async(s,{baseUrl:e,checksums:r,installDir:t,includeOptional:n,concurrency:o,partConcurrency:a,channelName:c,mode:f})=>{let i=(l,p)=>s.sender.send(l,p);try{if(!(String(f||"install").toLowerCase()==="install")){let p=m.join(t,"mods","mods.vdf");if(g.existsSync(p)){let S=(Array.isArray(r?.files)?r.files:[]).filter(k=>{try{return String(k?.path||k?.name||"").replace(/\\/g,"/").toLowerCase()!=="mods/mods.vdf"}catch{return!0}});r={...r||{},files:S}}}}catch{}q=At(),X=!1;try{await bt(e,r,t,i,!!n,Number(o)||4,Number(a)||4,q,()=>X);try{let l=_t("channels",{})||{};l[String(c||"default")]={installDir:t,gameVersion:r?.game_version||null,gameBaseUrl:e,lastUpdatedAt:Date.now()},dt("channels",l)}catch(l){console.error("Failed to persist channel info",l)}}finally{q=null}return!0});P.handle("default-install-dir",(s,{channelName:e})=>{let r=process.env.LOCALAPPDATA||m.join(L.getPath("home"),"AppData","Local"),t=m.join(r,"Programs","R5VLibrary");return e?m.join(t,e):t});P.handle("launcher:config",async(s,{url:e})=>(t=>new Promise((n,o)=>{Q.get(t,a=>{if(a.statusCode!==200){o(new Error(`HTTP ${a.statusCode} for ${t}`)),a.resume();return}let c="";a.setEncoding("utf8"),a.on("data",f=>c+=f),a.on("end",()=>{try{n(JSON.parse(c))}catch(f){o(f)}})}).on("error",o)}))(e));P.handle("eula:get",async()=>{let s="https://playvalkyrie.org/api/eula",e=r=>new Promise((t,n)=>{Q.get(r,o=>{if(o.statusCode!==200){n(new Error(`HTTP ${o.statusCode}`)),o.resume();return}let a=[];o.on("data",c=>a.push(Buffer.isBuffer(c)?c:Buffer.from(c))),o.on("end",()=>{try{let c=Buffer.concat(a).toString("utf8");t(JSON.parse(c))}catch(c){n(c)}})}).on("error",n)});try{return{ok:!0,json:await e(s)}}catch(r){return{ok:!1,error:String(r?.message||r)}}});P.handle("video:cache",async(s,{filename:e})=>{let t=`https://blaze.playvalkyrie.org/video_backgrounds/${e}`,n=m.join(m.resolve(L.getAppPath(),".."),"cache"),o=m.join(n,"videos"),a=m.join(o,e);await g.promises.mkdir(o,{recursive:!0});try{return await g.promises.access(a),`r5v://videos/${e}`}catch{}return await new Promise((c,f)=>{let i=g.createWriteStream(a);Q.get(t,l=>{if(l.statusCode!==200){i.close(()=>{}),g.unlink(a,()=>{}),f(new Error(`HTTP ${l.statusCode} video`)),l.resume();return}l.pipe(i),i.on("finish",()=>i.close(c))}).on("error",l=>{g.unlink(a,()=>f(l))})}),`r5v://videos/${e}`});P.handle("fs:is-installed-in-dir",async(s,{path:e})=>{let r=!1,t=!1;try{await g.promises.access(m.join(e,"r5apex.exe")),r=!0}catch{}try{await g.promises.access(m.join(e,"r5apex_ds.exe")),t=!0}catch{}return r||t});var X=!1;P.handle("download:pause",async()=>{X=!0;try{v?.webContents.send("progress:paused",{})}catch{}return!0});P.handle("download:resume",async()=>{X=!1;try{v?.webContents.send("progress:resumed",{})}catch{}return!0});P.handle("download:cancel",async()=>{try{ct(q)}catch{}q=null,X=!1;try{v?.webContents.send("progress:cancelled",{})}catch{}return!0});P.handle("select-file",async(s,{filters:e})=>{let r=await mt.showOpenDialog({properties:["openFile"],filters:Array.isArray(e)?e:void 0});return r.canceled||r.filePaths.length===0?null:r.filePaths[0]});P.handle("game:launch",async(s,{channelName:e,installDir:r,mode:t,argsString:n})=>{try{if(!r)throw new Error("Missing installDir");let o=String(t).toUpperCase()==="SERVER"?"r5apex_ds.exe":"r5apex.exe",a=m.join(r,o);await g.promises.access(a).catch(()=>{throw new Error(`Executable not found: ${a}`)});let f=(l=>!l||typeof l!="string"?[]:(l.match(/(?:[^\s\"]+|\"[^\"]*\")+/g)||[]).map(d=>d.replace(/^\"|\"$/g,"")))(n);return et(a,f,{cwd:r,detached:!0,stdio:"ignore",env:{...process.env}}).unref(),{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}});P.handle("fix-folder-permissions",async(s,{selectedChannel:e})=>{let r=[],t=ht().channels[e].installDir;try{if(!t)return{ok:!1,error:"No folder path provided"};let n=m.resolve(t).replace(/\//g,"\\");if(!n||n.length<3)return{ok:!1,error:`Invalid path format: ${t}`};let o=n.length>=3&&n[1]===":"?n.slice(3):n;if(/[<>:"|?*]/.test(o))return{ok:!1,error:`Path contains invalid characters: ${n}`};let f=te.userInfo().username,i=m.join(process.resourcesPath,"elevate.exe"),l=g.existsSync(i);try{g.mkdirSync(n,{recursive:!0})}catch{}let p=[{exe:"icacls",args:[n,"/grant",`${f}:F`,"/t","/q"],desc:`Grant permissions to current user (${f})`},{exe:"icacls",args:[n,"/grant","Everyone:F","/t","/q"],desc:"Grant Everyone full permissions"},{exe:"icacls",args:[n,"/grant","Users:F","/t","/q"],desc:"Grant Users full permissions"}];for(let d=0;d<p.length;d++){let{exe:S,args:k,desc:h}=p[d];try{let E=await new Promise((y,w)=>{let u,A,x;l?(A=[i,["-wait",S,...k]],x={stdio:["ignore","pipe","pipe"],windowsHide:!0}):(A=[S,k],x={stdio:["ignore","pipe","pipe"],windowsHide:!0});try{u=et(A[0],A[1],x)}catch(T){console.error("[Permission Fix] Spawn failed:",T),w(T);return}let D="",M="";u.stdout&&u.stdout.on("data",T=>{D+=T.toString()}),u.stderr&&u.stderr.on("data",T=>{M+=T.toString()}),u.on("exit",(T,V)=>{y({code:T,stdout:D,stderr:M,signal:V})}),u.on("error",T=>{w(T)}),setTimeout(()=>{try{u.kill()}catch{}w(new Error("Command timeout"))},3e4)});if(E.code!==0){let y=E.stderr||E.stdout||"Unknown error";if(!(y.includes("duplicate")||y.includes("already")||E.code===1332)){let u=`${h} failed (code ${E.code}): ${y}`;r.push(u)}}}catch(E){let y=`${h} error: ${E.message}`;r.push(y)}}try{let d=m.join(n,"test_write.tmp");g.writeFileSync(d,"test"),g.unlinkSync(d)}catch(d){let S=`Write test failed: ${d.message}`;r.push(S);try{if(g.mkdirSync(n,{recursive:!0}),(await new Promise(h=>{let E=et("cmd",["/c",`icacls "${n}" /grant "%USERNAME%":F /q`],{stdio:"ignore",windowsHide:!0});E.on("exit",y=>h({code:y})),E.on("error",()=>h({code:1})),setTimeout(()=>{try{E.kill()}catch{}h({code:1})},5e3)})).code===0){let h=m.join(n,"test_write2.tmp");return g.writeFileSync(h,"test"),g.unlinkSync(h),{ok:!0,warnings:r}}}catch{}return{ok:!1,error:S,details:r}}return r.length>0?{ok:!0,warnings:r}:{ok:!0}}catch(n){let o=`Unexpected error: ${n?.message||n}`;return r.push(o),{ok:!1,error:o,details:r}}});P.on("window:minimize",()=>{v?.minimize()});P.on("window:maximize",()=>{v&&(v.isMaximized()?v.unmaximize():v.maximize())});P.on("window:close",()=>{v?.close()});L.on("before-quit",()=>{if(q)try{ct(q)}catch{}});
