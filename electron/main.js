import{app as k,BrowserWindow as dt,ipcMain as E,dialog as X,protocol as it,shell as F}from"electron";import{createRequire as kt}from"node:module";import m from"node:path";import{fileURLToPath as Rt,pathToFileURL as Gt}from"node:url";import ut from"node:https";import L from"node:fs";import{spawn as _t}from"node:child_process";import S from"node:fs";import M from"node:path";import ft from"node:crypto";import{pipeline as yt}from"node:stream";import{promisify as wt}from"node:util";import G from"node:https";var gt=wt(yt);function j(n){return String(n||"").replace(/\\/g,"/").toLowerCase()}var z=new Map,mt=new G.Agent({keepAlive:!0,maxSockets:32,maxFreeSockets:16,keepAliveMsecs:3e4});function q(n){return new Promise((t,a)=>{let e=ft.createHash("sha256"),s=S.createReadStream(n);s.on("error",a),s.on("end",()=>t(e.digest("hex"))),s.on("data",r=>e.update(r))})}function tt(n){S.mkdirSync(n,{recursive:!0})}function Et(n){return new Promise((t,a)=>{G.get(n,e=>{if(e.statusCode!==200){a(new Error(`HTTP ${e.statusCode} for ${n}`)),e.resume();return}let s="";e.setEncoding("utf8"),e.on("data",r=>s+=r),e.on("end",()=>{try{t(JSON.parse(s))}catch(r){a(r)}})}).on("error",a)})}function $(n){return new Promise(t=>setTimeout(t,n))}function et(){return{cancelled:!1,requests:new Set}}function K(n){if(n){n.cancelled=!0;for(let t of n.requests)try{t.destroy(new Error("cancelled"))}catch{}n.requests.clear()}}var St=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE"]);async function U(n,t,a,e=1,s,r=0,o=0){return new Promise((d,h)=>{tt(M.dirname(t));let c=S.createWriteStream(t,{flags:r>0?"a":"w"});if(s?.cancelled)return c.close(()=>{}),h(new Error("cancelled"));let p={agent:mt};r>0&&(p.headers={Range:`bytes=${r}-`});let v=G.get(n,p,i=>{if(i.statusCode!==200&&!(r>0&&i.statusCode===206)){if(c.close(()=>{}),r>0&&i.statusCode===200){try{S.unlinkSync(t)}catch{}let y=Math.min(2e3*e,1e4);i.resume();try{v.destroy(new Error("restart:range-ignored"))}catch{}return $(y).then(()=>d(U(n,t,a,e+1,s,0,o)))}if(S.unlink(t,()=>{}),i.statusCode&&[429,500,502,503,504].includes(i.statusCode)&&e<5){let y=Math.min(2e3*e,1e4);return i.resume(),$(y).then(()=>d(U(n,t,a,e+1,s,r,o)))}h(new Error(`HTTP ${i.statusCode} for ${n}`)),i.resume();return}let C=Number(i.headers["content-length"]||0),A=o>0?o:r>0?r+C:C,u=0,f=Date.now(),g=e<=2?6e4:9e4,l=setInterval(()=>{if(!s?.cancelled&&Date.now()-f>g)try{let y=new Error("stalled");y.code="ETIMEDOUT",v.destroy(y)}catch{}},1e4);i.on("data",y=>{u+=y.length,f=Date.now(),a&&a(Math.min(r+u,A||r+u),A||0)}),i.on("aborted",async()=>{let y=new Promise(P=>c.close(()=>P()));try{clearInterval(l)}catch{}try{await y}catch{}if(e<5){let P=Math.min(2e3*e,1e4);return $(P).then(()=>d(U(n,t,a,e+1,s,r+u,o)))}h(new Error("response aborted"))}),gt(i,c).then(()=>{try{clearInterval(l)}catch{}d()}).catch(y=>{try{clearInterval(l)}catch{}h(y)})});if(s?.requests.add(v),v.on("socket",i=>{try{i.setKeepAlive(!0,6e4),i.setNoDelay(!0)}catch{}}),v.on("close",()=>s?.requests.delete(v)),v.setTimeout(45e3,()=>{try{let i=new Error("Request timeout");i.code="ETIMEDOUT",v.destroy(i)}catch{}}),s?.cancelled)try{v.destroy(new Error("cancelled"))}catch{}v.on("error",async i=>{let C=i?.code,A=e<5&&C&&St.has(String(C)),u=new Promise(f=>{try{c.close(()=>f())}catch{f()}});try{await u}catch{}if(A){let f=Math.min(2e3*e,1e4),g=r;try{g=S.statSync(t).size}catch{}return $(f).then(()=>d(U(n,t,a,e+1,s,g,o)))}h(i)})})}async function vt(n,t,a){try{let e=S.statSync(n);return a&&Number(a)>0&&e.size!==Number(a)?!1:(await q(n)).toLowerCase()===String(t).toLowerCase()}catch{return!1}}async function nt(n){let t=`${n.replace(/\/$/,"")}/checksums.json`;return Et(t)}async function At(n,t,a,e,s=4,r){let o=M.join(a,t.path.replace(/\\/g,M.sep));if(tt(M.dirname(o)),await vt(o,t.checksum,t.size)){e("progress:skip",{path:t.path});return}if(r?.cancelled)throw new Error("cancelled");if(Array.isArray(t.parts)&&t.parts.length>0){let h=t.parts.length,c=new Array(h),p=0,v=new Set;async function i(){for(;;){let u=p++;if(u>=h)return;if(v.has(u))continue;v.add(u);let f=t.parts[u],g=`${n.replace(/\/$/,"")}/${f.path.replace(/\\/g,"/")}`,l=`${o}.part${u}`;try{if(S.existsSync(l))if((await q(l)).toLowerCase()===String(f.checksum).toLowerCase()){e("progress:part",{path:t.path,part:u,totalParts:h,received:Number(f.size||0),total:Number(f.size||0)}),c[u]=l;continue}else try{S.unlinkSync(l)}catch{}}catch{}let y=0;for(;;){if(r?.cancelled)throw new Error("cancelled");y+=1;let P=0,N=0;try{let x=0;try{x=S.statSync(l).size}catch{}let _=Number(f.size||0);if(_>0&&x>_)try{S.unlinkSync(l),x=0}catch{}await U(g,l,(D,H)=>{let I=Math.max(0,D-N);N=D;try{I>0&&e("progress:bytes",{delta:I})}catch{}P+=I;let T=_||H||0;e("progress:part",{path:t.path,part:u,totalParts:h,received:Math.min(D,T||D),total:T})},1,r,x,_)}catch{try{S.unlinkSync(l)}catch{}try{P>0&&e("progress:bytes",{delta:-P})}catch{}try{e("progress:part:reset",{path:t.path,part:u,totalParts:h})}catch{}let _=Math.min(2e3*y,1e4);await $(_);continue}if((await q(l)).toLowerCase()===String(f.checksum).toLowerCase())break;try{S.unlinkSync(l)}catch{}try{P>0&&e("progress:bytes",{delta:-P})}catch{}try{e("progress:part:reset",{path:t.path,part:u,totalParts:h})}catch{}let V=Math.min(2e3*y,1e4);await $(V)}c[u]=l}}let C=Array.from({length:Math.max(1,s)},()=>i());await Promise.all(C),e("progress:merge:start",{path:t.path,parts:c.length});let A=S.createWriteStream(o);for(let u=0;u<c.length;u++){let f=c[u];e("progress:merge:part",{path:t.path,part:u,totalParts:c.length}),await new Promise((g,l)=>{let y=S.createReadStream(f);y.on("error",l),A.on("error",l),y.on("end",()=>{try{S.unlinkSync(f)}catch{}g()}),y.pipe(A,{end:!1})})}await new Promise((u,f)=>{A.on("error",f),A.on("finish",u),A.end()});try{e("progress:merge:done",{path:t.path})}catch{}}else{let h=`${n.replace(/\/$/,"")}/${t.path.replace(/\\/g,"/")}`,c=0;for(;;){c+=1;let p=0,v=0,i=`${o}.download`,C=0;try{C=S.statSync(i).size}catch{}let A=Number(t.size||0);if(A>0&&C>A)try{S.unlinkSync(i),C=0}catch{}if(await U(h,i,(f,g)=>{let l=Math.max(0,f-v);v=f;try{l>0&&e("progress:bytes",{delta:l})}catch{}p+=l;let y=A||g||0;e("progress:file",{path:t.path,received:Math.min(f,y||f),total:y})},1,r,C,A),(await q(i)).toLowerCase()===String(t.checksum).toLowerCase())break;try{S.unlinkSync(i)}catch{}try{p>0&&e("progress:bytes",{delta:-p})}catch{}if(c>=2)throw new Error(`Checksum mismatch for ${t.path}`)}try{S.unlinkSync(o)}catch{}S.renameSync(`${o}.download`,o)}if(e("progress:verify",{path:t.path}),(await q(o)).toLowerCase()!==String(t.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${t.path}`)}async function rt(n,t,a,e,s=!1,r=4,o=4,d){let h=new Set,c=[];for(let g of t.files||[]){if(!(s||!g.optional))continue;let l=j(g.path);l&&(h.has(l)||(h.add(l),c.push(g)))}let p=c.filter(g=>!(Array.isArray(g.parts)&&g.parts.length>0)),v=c.filter(g=>Array.isArray(g.parts)&&g.parts.length>0),i=p.concat(v),C=i.length,A=0,u=i.reduce((g,l)=>{let y=Number(l.size||0);return y>0?g+y:Array.isArray(l.parts)&&l.parts.length?g+l.parts.reduce((P,N)=>P+Number(N.size||0),0):g},0);try{e("progress:bytes:total",{totalBytes:u})}catch{}async function f(g,l,y){let P=0;async function N(){for(;;){let V=P++;if(V>=g.length)return;let x=g[V],_=l+V,D=j(x.path),H=async()=>At(n,x,a,e,o,d),I=!1,T=z.get(D);T?I=!0:(e("progress:start",{index:_,total:C,path:x.path,completed:A}),T=(async()=>{try{await H()}catch(J){if(String(J?.message||J||"error").includes("cancelled"))throw J;try{let W=M.join(a,x.path.replace(/\\/g,M.sep));try{S.unlinkSync(W)}catch{}await H()}catch(W){try{e("progress:error",{path:x.path,message:String(W?.message||W)})}catch{}}}})(),z.set(D,T));try{await T}finally{I||z.delete(D)}A+=1,e("progress:done",{index:_,total:C,path:x.path,completed:A}),await $(10)}}let Z=Array.from({length:Math.max(1,y)},()=>N());await Promise.all(Z)}if(await f(p,0,Math.max(1,r)),z.size>0)try{await Promise.all([...z.values()])}catch{}await f(v,p.length,1)}import O from"node:fs";import Ct from"node:path";import{app as Pt}from"electron";var at=Pt.getPath("userData"),ot=Ct.join(at,"settings.json");function Y(){try{let n=O.readFileSync(ot,"utf-8");return JSON.parse(n)}catch{return{}}}function xt(n){O.mkdirSync(at,{recursive:!0}),O.writeFileSync(ot,JSON.stringify(n,null,2),"utf-8")}function st(n,t=void 0){return Y()[n]??t}function Q(n,t){let a=Y();a[n]=t,xt(a)}function ct(){return Y()}var pt=kt(import.meta.url),{autoUpdater:R}=pt("electron-updater"),lt=pt("electron-log"),Dt=Rt(import.meta.url),B=m.dirname(Dt);var w,b=null;async function ht(){w=new dt({width:1150,height:800,minWidth:1150,minHeight:800,frame:!1,titleBarStyle:"hidden",webPreferences:{preload:m.join(B,"preload.cjs"),contextIsolation:!0,nodeIntegration:!1},show:!1,icon:m.join(B,"..","public","icon.png")});let n=process.env.VITE_DEV_SERVER_URL;if(n)await w.loadURL(n);else{let s=m.join(B,"..","dist","index.html");await w.loadFile(s)}w.webContents.setWindowOpenHandler(({url:s})=>{try{F.openExternal(s)}catch{}return{action:"deny"}}),w.webContents.on("will-navigate",(s,r)=>{let o=r.startsWith("file:"),d=!!process.env.VITE_DEV_SERVER_URL&&r.startsWith(String(process.env.VITE_DEV_SERVER_URL));if(!o&&!d){s.preventDefault();try{F.openExternal(r)}catch{}}});let t=()=>{w&&(w.isVisible()||w.show(),w.isFocused()||w.focus())};w.once("ready-to-show",t),w.webContents.once("did-finish-load",t);let a=setTimeout(t,1e3);w.on("show",()=>clearTimeout(a)),(!!process.env.VITE_DEV_SERVER_URL||process.env.NODE_ENV==="development")&&w.webContents.openDevTools({mode:"detach"}),w.webContents.on("did-fail-load",(s,r,o,d)=>{console.error("Load failed",{errorCode:r,errorDesc:o,validatedURL:d}),X.showErrorBox("Load failed",`${o} (code ${r})
URL: ${d}`),w.show()})}k.on("window-all-closed",()=>{process.platform!=="darwin"&&k.quit()});k.whenReady().then(()=>{let n=m.resolve(k.getAppPath(),".."),t=m.join(n,"cache");it.registerFileProtocol("r5v",(e,s)=>{try{let r=new URL(e.url),o=decodeURIComponent(r.pathname).replace(/^\//,""),d=m.normalize(m.join(t,o));s({path:d})}catch{s({error:-6})}});let a=m.join(B,"..","dist");it.interceptFileProtocol("file",(e,s)=>{try{let r=new URL(e.url),o=decodeURIComponent(r.pathname),d=o.replace(/\\/g,"/"),h=d.indexOf("/_astro/");if(h!==-1){let c=d.substring(h+8),p=m.join(a,"_astro",c);return s({path:p})}if(d.endsWith("/favicon.svg")||/\/favicon\.svg$/i.test(d)){let c=m.join(a,"favicon.svg");return s({path:c})}if(d.startsWith("/")){let c=d.replace(/^\/+/,""),p=m.join(a,c);try{return L.accessSync(p),s({path:p})}catch{}}return s({path:o})}catch{return s({error:-6})}}),ht();try{R.autoDownload=!1;try{R.logger=lt,lt.transports.file.level="info"}catch{}R.on("error",e=>{try{w?.webContents.send("update:error",{message:String(e?.stack||e?.message||e)})}catch{}}),R.on("update-available",e=>{try{w?.webContents.send("update:available",e)}catch{}}),R.on("update-not-available",e=>{try{w?.webContents.send("update:not-available",e)}catch{}}),R.on("download-progress",e=>{try{w?.webContents.send("update:download-progress",e)}catch{}}),R.on("update-downloaded",e=>{try{w?.webContents.send("update:downloaded",e)}catch{}})}catch{}k.on("activate",()=>{dt.getAllWindows().length===0&&ht()})});E.handle("update:check",async()=>{try{return{ok:!0,result:(await R.checkForUpdates())?.updateInfo||null}}catch(n){return{ok:!1,error:String(n?.message||n)}}});E.handle("update:download",async()=>{try{return await R.downloadUpdate(),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});E.handle("update:quitAndInstall",async()=>{try{return setImmediate(()=>R.quitAndInstall(!1,!0)),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});E.handle("app:getVersion",async()=>{try{return k.getVersion()}catch{return"0.0.0"}});E.handle("app:getBaseDir",async()=>{try{return m.resolve(k.getAppPath(),"..")}catch{return""}});E.handle("app:getLauncherInstallRoot",async()=>{try{let n=process.env.LOCALAPPDATA||m.join(k.getPath("home"),"AppData","Local");return m.join(n,"Programs","r5vlauncher")}catch{return""}});E.handle("select-directory",async()=>{let n=await X.showOpenDialog({properties:["openDirectory","createDirectory"]});return n.canceled||n.filePaths.length===0?null:n.filePaths[0]});E.handle("settings:get",()=>ct());E.handle("settings:set",(n,{key:t,value:a})=>Q(t,a));E.handle("download:checksums",async(n,{baseUrl:t})=>nt(t));E.handle("download:all",async(n,{baseUrl:t,checksums:a,installDir:e,includeOptional:s,concurrency:r,partConcurrency:o,channelName:d})=>{let h=(c,p)=>n.sender.send(c,p);b=et();try{await rt(t,a,e,h,!!s,Number(r)||4,Number(o)||4,b);try{let c=st("channels",{})||{};c[String(d||"default")]={installDir:e,gameVersion:a?.game_version||null,gameBaseUrl:t,lastUpdatedAt:Date.now()},Q("channels",c)}catch(c){console.error("Failed to persist channel info",c)}}finally{b=null}return!0});E.handle("default-install-dir",(n,{channelName:t})=>{let a=process.env.LOCALAPPDATA||m.join(k.getPath("home"),"AppData","Local"),e=m.join(a,"Programs","R5VLibrary");return t?m.join(e,t):e});E.handle("launcher:config",async(n,{url:t})=>(e=>new Promise((s,r)=>{ut.get(e,o=>{if(o.statusCode!==200){r(new Error(`HTTP ${o.statusCode} for ${e}`)),o.resume();return}let d="";o.setEncoding("utf8"),o.on("data",h=>d+=h),o.on("end",()=>{try{s(JSON.parse(d))}catch(h){r(h)}})}).on("error",r)}))(t));E.handle("video:cache",async(n,{filename:t})=>{let e=`https://blaze.playvalkyrie.org/video_backgrounds/${t}`,s=m.join(m.resolve(k.getAppPath(),".."),"cache"),r=m.join(s,"videos"),o=m.join(r,t);await L.promises.mkdir(r,{recursive:!0});try{return await L.promises.access(o),`r5v://videos/${t}`}catch{}return await new Promise((d,h)=>{let c=L.createWriteStream(o);ut.get(e,p=>{if(p.statusCode!==200){c.close(()=>{}),L.unlink(o,()=>{}),h(new Error(`HTTP ${p.statusCode} video`)),p.resume();return}p.pipe(c),c.on("finish",()=>c.close(d))}).on("error",p=>{L.unlink(o,()=>h(p))})}),`r5v://videos/${t}`});E.handle("fs:exists",async(n,{path:t})=>{try{return await L.promises.access(t),!0}catch{return!1}});E.handle("path:open",async(n,{path:t})=>{try{return await F.openPath(t),!0}catch{return!1}});E.handle("open-external",async(n,{url:t})=>{try{return await F.openExternal(t),!0}catch{return!1}});E.handle("download:cancel",async()=>{try{K(b)}catch{}b=null;try{w?.webContents.send("progress:cancelled",{})}catch{}return!0});E.handle("select-file",async(n,{filters:t})=>{let a=await X.showOpenDialog({properties:["openFile"],filters:Array.isArray(t)?t:void 0});return a.canceled||a.filePaths.length===0?null:a.filePaths[0]});E.handle("game:launch",async(n,{channelName:t,installDir:a,mode:e,argsString:s})=>{try{if(!a)throw new Error("Missing installDir");let r=String(e).toUpperCase()==="SERVER"?"r5apex_ds.exe":"r5apex.exe",o=m.join(a,r);await L.promises.access(o).catch(()=>{throw new Error(`Executable not found: ${o}`)});let h=(p=>!p||typeof p!="string"?[]:(p.match(/(?:[^\s\"]+|\"[^\"]*\")+/g)||[]).map(i=>i.replace(/^\"|\"$/g,"")))(s);return _t(o,h,{cwd:a,detached:!0,stdio:"ignore",env:{...process.env}}).unref(),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});E.on("window:minimize",()=>{w?.minimize()});E.on("window:maximize",()=>{w&&(w.isMaximized()?w.unmaximize():w.maximize())});E.on("window:close",()=>{w?.close()});k.on("before-quit",()=>{if(b)try{K(b)}catch{}});
