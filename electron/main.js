import{app as k,BrowserWindow as dt,ipcMain as E,dialog as X,protocol as it,shell as F}from"electron";import{createRequire as kt}from"node:module";import m from"node:path";import{fileURLToPath as Rt,pathToFileURL as Gt}from"node:url";import ut from"node:https";import L from"node:fs";import{spawn as _t}from"node:child_process";import v from"node:fs";import M from"node:path";import ft from"node:crypto";import{pipeline as yt}from"node:stream";import{promisify as wt}from"node:util";import G from"node:https";var gt=wt(yt);function j(n){return String(n||"").replace(/\\/g,"/").toLowerCase()}var z=new Map,mt=new G.Agent({keepAlive:!0,maxSockets:32,maxFreeSockets:16,keepAliveMsecs:3e4});function q(n){return new Promise((t,a)=>{let e=ft.createHash("sha256"),s=v.createReadStream(n);s.on("error",a),s.on("end",()=>t(e.digest("hex"))),s.on("data",r=>e.update(r))})}function tt(n){v.mkdirSync(n,{recursive:!0})}function Et(n){return new Promise((t,a)=>{G.get(n,e=>{if(e.statusCode!==200){a(new Error(`HTTP ${e.statusCode} for ${n}`)),e.resume();return}let s="";e.setEncoding("utf8"),e.on("data",r=>s+=r),e.on("end",()=>{try{t(JSON.parse(s))}catch(r){a(r)}})}).on("error",a)})}function b(n){return new Promise(t=>setTimeout(t,n))}function et(){return{cancelled:!1,requests:new Set}}function K(n){if(n){n.cancelled=!0;for(let t of n.requests)try{t.destroy(new Error("cancelled"))}catch{}n.requests.clear()}}var St=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE"]);async function U(n,t,a,e=1,s,r=0,o=0){return new Promise((p,d)=>{tt(M.dirname(t));let c=v.createWriteStream(t,{flags:r>0?"a":"w"});if(s?.cancelled)return c.close(()=>{}),d(new Error("cancelled"));let u={agent:mt};r>0&&(u.headers={Range:`bytes=${r}-`});let S=G.get(n,u,i=>{if(i.statusCode!==200&&!(r>0&&i.statusCode===206)){if(c.close(()=>{}),r>0&&i.statusCode===200){try{v.unlinkSync(t)}catch{}let w=Math.min(2e3*e,1e4);i.resume();try{S.destroy(new Error("restart:range-ignored"))}catch{}return b(w).then(()=>p(U(n,t,a,e+1,s,0,o)))}if(v.unlink(t,()=>{}),i.statusCode&&[429,500,502,503,504].includes(i.statusCode)&&e<5){let w=Math.min(2e3*e,1e4);return i.resume(),b(w).then(()=>p(U(n,t,a,e+1,s,r,o)))}d(new Error(`HTTP ${i.statusCode} for ${n}`)),i.resume();return}let A=Number(i.headers["content-length"]||0),C=o>0?o:r>0?r+A:A,l=0,g=Date.now(),f=e<=2?6e4:9e4,h=setInterval(()=>{if(!s?.cancelled&&Date.now()-g>f)try{let w=new Error("stalled");w.code="ETIMEDOUT",S.destroy(w)}catch{}},1e4);i.on("data",w=>{l+=w.length,g=Date.now(),a&&a(Math.min(r+l,C||r+l),C||0)}),i.on("aborted",async()=>{let w=new Promise(P=>c.close(()=>P()));try{clearInterval(h)}catch{}try{await w}catch{}if(e<5){let P=Math.min(2e3*e,1e4);return b(P).then(()=>p(U(n,t,a,e+1,s,r+l,o)))}d(new Error("response aborted"))}),gt(i,c).then(()=>{try{clearInterval(h)}catch{}p()}).catch(w=>{try{clearInterval(h)}catch{}d(w)})});if(s?.requests.add(S),S.on("socket",i=>{try{i.setKeepAlive(!0,6e4),i.setNoDelay(!0)}catch{}}),S.on("close",()=>s?.requests.delete(S)),S.setTimeout(45e3,()=>{try{let i=new Error("Request timeout");i.code="ETIMEDOUT",S.destroy(i)}catch{}}),s?.cancelled)try{S.destroy(new Error("cancelled"))}catch{}S.on("error",async i=>{let A=i?.code,C=e<5&&A&&St.has(String(A)),l=new Promise(g=>{try{c.close(()=>g())}catch{g()}});try{await l}catch{}if(C){let g=Math.min(2e3*e,1e4),f=r;try{f=v.statSync(t).size}catch{}return b(g).then(()=>p(U(n,t,a,e+1,s,f,o)))}d(i)})})}async function vt(n,t,a){try{let e=v.statSync(n);return a&&Number(a)>0&&e.size!==Number(a)?!1:(await q(n)).toLowerCase()===String(t).toLowerCase()}catch{return!1}}async function nt(n){let t=`${n.replace(/\/$/,"")}/checksums.json`;return Et(t)}async function At(n,t,a,e,s=4,r){let o=M.join(a,t.path.replace(/\\/g,M.sep));if(tt(M.dirname(o)),await vt(o,t.checksum,t.size)){e("progress:skip",{path:t.path});return}if(r?.cancelled)throw new Error("cancelled");if(Array.isArray(t.parts)&&t.parts.length>0){let d=t.parts.length,c=new Array(d),u=0,S=new Set;async function i(){for(;;){let l=u++;if(l>=d)return;if(S.has(l))continue;S.add(l);let g=t.parts[l],f=`${n.replace(/\/$/,"")}/${g.path.replace(/\\/g,"/")}`,h=`${o}.part${l}`;try{if(v.existsSync(h))if((await q(h)).toLowerCase()===String(g.checksum).toLowerCase()){e("progress:part",{path:t.path,part:l,totalParts:d,received:Number(g.size||0),total:Number(g.size||0)}),c[l]=h;continue}else try{v.unlinkSync(h)}catch{}}catch{}let w=0;for(;;){if(r?.cancelled)throw new Error("cancelled");w+=1;let P=0,N=0;try{let x=0;try{x=v.statSync(h).size}catch{}let _=Number(g.size||0);if(_>0&&x>_)try{v.unlinkSync(h),x=0}catch{}await U(f,h,(D,H)=>{let I=Math.max(0,D-N);N=D;try{I>0&&e("progress:bytes",{delta:I})}catch{}P+=I;let T=_||H||0;e("progress:part",{path:t.path,part:l,totalParts:d,received:Math.min(D,T||D),total:T})},1,r,x,_)}catch{try{v.unlinkSync(h)}catch{}try{P>0&&e("progress:bytes",{delta:-P})}catch{}try{e("progress:part:reset",{path:t.path,part:l,totalParts:d})}catch{}let _=Math.min(2e3*w,1e4);await b(_);continue}if((await q(h)).toLowerCase()===String(g.checksum).toLowerCase())break;try{v.unlinkSync(h)}catch{}try{P>0&&e("progress:bytes",{delta:-P})}catch{}try{e("progress:part:reset",{path:t.path,part:l,totalParts:d})}catch{}let V=Math.min(2e3*w,1e4);await b(V)}c[l]=h}}let A=Array.from({length:Math.max(1,s)},()=>i());await Promise.all(A),e("progress:merge:start",{path:t.path,parts:c.length});let C=v.createWriteStream(o);for(let l=0;l<c.length;l++){let g=c[l];e("progress:merge:part",{path:t.path,part:l,totalParts:c.length}),await new Promise((f,h)=>{let w=v.createReadStream(g);w.on("error",h),C.on("error",h),w.on("end",()=>{try{v.unlinkSync(g)}catch{}f()}),w.pipe(C,{end:!1})})}await new Promise((l,g)=>{C.on("error",g),C.on("finish",l),C.end()});try{e("progress:merge:done",{path:t.path})}catch{}}else{let d=`${n.replace(/\/$/,"")}/${t.path.replace(/\\/g,"/")}`,c=0;for(;;){c+=1;let u=0,S=0,i=0;try{i=v.statSync(o).size}catch{}let A=Number(t.size||0);if(A>0&&i>A)try{v.unlinkSync(o),i=0}catch{}if(await U(d,o,(l,g)=>{let f=Math.max(0,l-S);S=l;try{f>0&&e("progress:bytes",{delta:f})}catch{}u+=f;let h=A||g||0;e("progress:file",{path:t.path,received:Math.min(l,h||l),total:h})},1,r,i,A),(await q(o)).toLowerCase()===String(t.checksum).toLowerCase())break;try{v.unlinkSync(o)}catch{}try{u>0&&e("progress:bytes",{delta:-u})}catch{}if(c>=2)throw new Error(`Checksum mismatch for ${t.path}`)}}if(e("progress:verify",{path:t.path}),(await q(o)).toLowerCase()!==String(t.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${t.path}`)}async function rt(n,t,a,e,s=!1,r=4,o=4,p){let d=new Set,c=[];for(let f of t.files||[]){if(!(s||!f.optional))continue;let h=j(f.path);h&&(d.has(h)||(d.add(h),c.push(f)))}let u=c.filter(f=>!(Array.isArray(f.parts)&&f.parts.length>0)),S=c.filter(f=>Array.isArray(f.parts)&&f.parts.length>0),i=u.concat(S),A=i.length,C=0,l=i.reduce((f,h)=>{let w=Number(h.size||0);return w>0?f+w:Array.isArray(h.parts)&&h.parts.length?f+h.parts.reduce((P,N)=>P+Number(N.size||0),0):f},0);try{e("progress:bytes:total",{totalBytes:l})}catch{}async function g(f,h,w){let P=0;async function N(){for(;;){let V=P++;if(V>=f.length)return;let x=f[V],_=h+V,D=j(x.path),H=async()=>At(n,x,a,e,o,p),I=!1,T=z.get(D);T?I=!0:(e("progress:start",{index:_,total:A,path:x.path,completed:C}),T=(async()=>{try{await H()}catch(J){if(String(J?.message||J||"error").includes("cancelled"))throw J;try{let W=M.join(a,x.path.replace(/\\/g,M.sep));try{v.unlinkSync(W)}catch{}await H()}catch(W){try{e("progress:error",{path:x.path,message:String(W?.message||W)})}catch{}}}})(),z.set(D,T));try{await T}finally{I||z.delete(D)}C+=1,e("progress:done",{index:_,total:A,path:x.path,completed:C}),await b(10)}}let Z=Array.from({length:Math.max(1,w)},()=>N());await Promise.all(Z)}if(await g(u,0,Math.max(1,r)),z.size>0)try{await Promise.all([...z.values()])}catch{}await g(S,u.length,1)}import O from"node:fs";import Ct from"node:path";import{app as Pt}from"electron";var at=Pt.getPath("userData"),ot=Ct.join(at,"settings.json");function Y(){try{let n=O.readFileSync(ot,"utf-8");return JSON.parse(n)}catch{return{}}}function xt(n){O.mkdirSync(at,{recursive:!0}),O.writeFileSync(ot,JSON.stringify(n,null,2),"utf-8")}function st(n,t=void 0){return Y()[n]??t}function Q(n,t){let a=Y();a[n]=t,xt(a)}function ct(){return Y()}var pt=kt(import.meta.url),{autoUpdater:R}=pt("electron-updater"),lt=pt("electron-log"),Dt=Rt(import.meta.url),B=m.dirname(Dt);var y,$=null;async function ht(){y=new dt({width:1150,height:800,minWidth:1150,minHeight:800,frame:!1,titleBarStyle:"hidden",webPreferences:{preload:m.join(B,"preload.cjs"),contextIsolation:!0,nodeIntegration:!1},show:!1,icon:m.join(B,"..","public","icon.png")});let n=process.env.VITE_DEV_SERVER_URL;if(n)await y.loadURL(n);else{let s=m.join(B,"..","dist","index.html");await y.loadFile(s)}y.webContents.setWindowOpenHandler(({url:s})=>{try{F.openExternal(s)}catch{}return{action:"deny"}}),y.webContents.on("will-navigate",(s,r)=>{let o=r.startsWith("file:"),p=!!process.env.VITE_DEV_SERVER_URL&&r.startsWith(String(process.env.VITE_DEV_SERVER_URL));if(!o&&!p){s.preventDefault();try{F.openExternal(r)}catch{}}});let t=()=>{y&&(y.isVisible()||y.show(),y.isFocused()||y.focus())};y.once("ready-to-show",t),y.webContents.once("did-finish-load",t);let a=setTimeout(t,1e3);y.on("show",()=>clearTimeout(a)),(!!process.env.VITE_DEV_SERVER_URL||process.env.NODE_ENV==="development")&&y.webContents.openDevTools({mode:"detach"}),y.webContents.on("did-fail-load",(s,r,o,p)=>{console.error("Load failed",{errorCode:r,errorDesc:o,validatedURL:p}),X.showErrorBox("Load failed",`${o} (code ${r})
URL: ${p}`),y.show()})}k.on("window-all-closed",()=>{process.platform!=="darwin"&&k.quit()});k.whenReady().then(()=>{let n=m.resolve(k.getAppPath(),".."),t=m.join(n,"cache");it.registerFileProtocol("r5v",(e,s)=>{try{let r=new URL(e.url),o=decodeURIComponent(r.pathname).replace(/^\//,""),p=m.normalize(m.join(t,o));s({path:p})}catch{s({error:-6})}});let a=m.join(B,"..","dist");it.interceptFileProtocol("file",(e,s)=>{try{let r=new URL(e.url),o=decodeURIComponent(r.pathname),p=o.replace(/\\/g,"/"),d=p.indexOf("/_astro/");if(d!==-1){let c=p.substring(d+8),u=m.join(a,"_astro",c);return s({path:u})}if(p.endsWith("/favicon.svg")||/\/favicon\.svg$/i.test(p)){let c=m.join(a,"favicon.svg");return s({path:c})}if(p.startsWith("/")){let c=p.replace(/^\/+/,""),u=m.join(a,c);try{return L.accessSync(u),s({path:u})}catch{}}return s({path:o})}catch{return s({error:-6})}}),ht();try{R.autoDownload=!1;try{R.logger=lt,lt.transports.file.level="info"}catch{}R.on("error",e=>{try{y?.webContents.send("update:error",{message:String(e?.stack||e?.message||e)})}catch{}}),R.on("update-available",e=>{try{y?.webContents.send("update:available",e)}catch{}}),R.on("update-not-available",e=>{try{y?.webContents.send("update:not-available",e)}catch{}}),R.on("download-progress",e=>{try{y?.webContents.send("update:download-progress",e)}catch{}}),R.on("update-downloaded",e=>{try{y?.webContents.send("update:downloaded",e)}catch{}})}catch{}k.on("activate",()=>{dt.getAllWindows().length===0&&ht()})});E.handle("update:check",async()=>{try{return{ok:!0,result:(await R.checkForUpdates())?.updateInfo||null}}catch(n){return{ok:!1,error:String(n?.message||n)}}});E.handle("update:download",async()=>{try{return await R.downloadUpdate(),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});E.handle("update:quitAndInstall",async()=>{try{return setImmediate(()=>R.quitAndInstall(!1,!0)),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});E.handle("app:getVersion",async()=>{try{return k.getVersion()}catch{return"0.0.0"}});E.handle("app:getBaseDir",async()=>{try{return m.resolve(k.getAppPath(),"..")}catch{return""}});E.handle("app:getLauncherInstallRoot",async()=>{try{let n=process.env.LOCALAPPDATA||m.join(k.getPath("home"),"AppData","Local");return m.join(n,"Programs","r5vlauncher")}catch{return""}});E.handle("select-directory",async()=>{let n=await X.showOpenDialog({properties:["openDirectory","createDirectory"]});return n.canceled||n.filePaths.length===0?null:n.filePaths[0]});E.handle("settings:get",()=>ct());E.handle("settings:set",(n,{key:t,value:a})=>Q(t,a));E.handle("download:checksums",async(n,{baseUrl:t})=>nt(t));E.handle("download:all",async(n,{baseUrl:t,checksums:a,installDir:e,includeOptional:s,concurrency:r,partConcurrency:o,channelName:p})=>{let d=(c,u)=>n.sender.send(c,u);$=et();try{await rt(t,a,e,d,!!s,Number(r)||4,Number(o)||4,$);try{let c=st("channels",{})||{};c[String(p||"default")]={installDir:e,gameVersion:a?.game_version||null,gameBaseUrl:t,lastUpdatedAt:Date.now()},Q("channels",c)}catch(c){console.error("Failed to persist channel info",c)}}finally{$=null}return!0});E.handle("default-install-dir",(n,{channelName:t})=>{let a=process.env.LOCALAPPDATA||m.join(k.getPath("home"),"AppData","Local"),e=m.join(a,"Programs","R5VLibrary");return t?m.join(e,t):e});E.handle("launcher:config",async(n,{url:t})=>(e=>new Promise((s,r)=>{ut.get(e,o=>{if(o.statusCode!==200){r(new Error(`HTTP ${o.statusCode} for ${e}`)),o.resume();return}let p="";o.setEncoding("utf8"),o.on("data",d=>p+=d),o.on("end",()=>{try{s(JSON.parse(p))}catch(d){r(d)}})}).on("error",r)}))(t));E.handle("video:cache",async(n,{filename:t})=>{let e=`https://blaze.playvalkyrie.org/video_backgrounds/${t}`,s=m.join(m.resolve(k.getAppPath(),".."),"cache"),r=m.join(s,"videos"),o=m.join(r,t);await L.promises.mkdir(r,{recursive:!0});try{return await L.promises.access(o),`r5v://videos/${t}`}catch{}return await new Promise((p,d)=>{let c=L.createWriteStream(o);ut.get(e,u=>{if(u.statusCode!==200){c.close(()=>{}),L.unlink(o,()=>{}),d(new Error(`HTTP ${u.statusCode} video`)),u.resume();return}u.pipe(c),c.on("finish",()=>c.close(p))}).on("error",u=>{L.unlink(o,()=>d(u))})}),`r5v://videos/${t}`});E.handle("fs:exists",async(n,{path:t})=>{try{return await L.promises.access(t),!0}catch{return!1}});E.handle("path:open",async(n,{path:t})=>{try{return await F.openPath(t),!0}catch{return!1}});E.handle("open-external",async(n,{url:t})=>{try{return await F.openExternal(t),!0}catch{return!1}});E.handle("download:cancel",async()=>{try{K($)}catch{}$=null;try{y?.webContents.send("progress:cancelled",{})}catch{}return!0});E.handle("select-file",async(n,{filters:t})=>{let a=await X.showOpenDialog({properties:["openFile"],filters:Array.isArray(t)?t:void 0});return a.canceled||a.filePaths.length===0?null:a.filePaths[0]});E.handle("game:launch",async(n,{channelName:t,installDir:a,mode:e,argsString:s})=>{try{if(!a)throw new Error("Missing installDir");let r=String(e).toUpperCase()==="SERVER"?"r5apex_ds.exe":"r5apex.exe",o=m.join(a,r);await L.promises.access(o).catch(()=>{throw new Error(`Executable not found: ${o}`)});let d=(u=>!u||typeof u!="string"?[]:(u.match(/(?:[^\s\"]+|\"[^\"]*\")+/g)||[]).map(i=>i.replace(/^\"|\"$/g,"")))(s);return _t(o,d,{cwd:a,detached:!0,stdio:"ignore",env:{...process.env}}).unref(),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});E.on("window:minimize",()=>{y?.minimize()});E.on("window:maximize",()=>{y&&(y.isMaximized()?y.unmaximize():y.maximize())});E.on("window:close",()=>{y?.close()});k.on("before-quit",()=>{if($)try{K($)}catch{}});
