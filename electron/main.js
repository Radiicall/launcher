import{app as x,BrowserWindow as Et,ipcMain as k,dialog as ct,protocol as St,shell as J}from"electron";import{createRequire as zt}from"node:module";import f from"node:path";import{fileURLToPath as Bt,pathToFileURL as ie}from"node:url";import W from"node:https";import g from"node:fs";import jt from"node:zlib";import{spawn as Ct}from"node:child_process";import P from"node:fs";import B from"node:path";import bt from"node:crypto";import{pipeline as _t}from"node:stream";import{promisify as Lt}from"node:util";import Z from"node:https";var Rt=Lt(_t);function Y(r){return String(r||"").replace(/\\/g,"/").replace(/^\/+/,"")}function dt(r){return String(r||"").replace(/\\/g,"/").toLowerCase()}var j=new Map,Dt=new Z.Agent({keepAlive:!0,maxSockets:32,maxFreeSockets:16,keepAliveMsecs:3e4});function F(r){return new Promise((e,n)=>{let t=bt.createHash("sha256"),a=P.createReadStream(r);a.on("error",n),a.on("end",()=>e(t.digest("hex"))),a.on("data",o=>t.update(o))})}function ht(r){P.mkdirSync(r,{recursive:!0})}function Tt(r){return new Promise((e,n)=>{Z.get(r,t=>{if(t.statusCode!==200){n(new Error(`HTTP ${t.statusCode} for ${r}`)),t.resume();return}let a="";t.setEncoding("utf8"),t.on("data",o=>a+=o),t.on("end",()=>{try{e(JSON.parse(a))}catch(o){n(o)}})}).on("error",n)})}function U(r){return new Promise(e=>setTimeout(e,r))}function ut(){return{cancelled:!1,requests:new Set}}function tt(r){if(r){r.cancelled=!0;for(let e of r.requests)try{e.destroy(new Error("cancelled"))}catch{}r.requests.clear()}}var $t=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE"]);async function z(r,e,n,t=1,a,o=0,s=0){return new Promise((c,d)=>{ht(B.dirname(e));let i=P.createWriteStream(e,{flags:o>0?"a":"w"});if(a?.cancelled)return i.close(()=>{}),d(new Error("cancelled"));let l={agent:Dt};o>0&&(l.headers={Range:`bytes=${o}-`});let p=Z.get(r,l,u=>{if(u.statusCode!==200&&!(o>0&&u.statusCode===206)){if(i.close(()=>{}),o>0&&u.statusCode===200){try{P.unlinkSync(e)}catch{}let C=Math.min(2e3*t,1e4);u.resume();try{p.destroy(new Error("restart:range-ignored"))}catch{}return U(C).then(()=>c(z(r,e,n,t+1,a,0,s)))}if(P.unlink(e,()=>{}),u.statusCode&&[429,500,502,503,504].includes(u.statusCode)&&t<5){let C=Math.min(2e3*t,1e4);return u.resume(),U(C).then(()=>c(z(r,e,n,t+1,a,o,s)))}d(new Error(`HTTP ${u.statusCode} for ${r}`)),u.resume();return}let w=Number(u.headers["content-length"]||0),S=s>0?s:o>0?o+w:w,v=0,y=Date.now(),h=t<=2?6e4:9e4,A=setInterval(()=>{if(!a?.cancelled&&Date.now()-y>h)try{let C=new Error("stalled");C.code="ETIMEDOUT",p.destroy(C)}catch{}},1e4);u.on("data",C=>{v+=C.length,y=Date.now(),n&&n(Math.min(o+v,S||o+v),S||0)}),u.on("aborted",async()=>{let C=new Promise(E=>i.close(()=>E()));try{clearInterval(A)}catch{}try{await C}catch{}if(t<5){let E=Math.min(2e3*t,1e4);return U(E).then(()=>c(z(r,e,n,t+1,a,o+v,s)))}d(new Error("response aborted"))}),Rt(u,i).then(()=>{try{clearInterval(A)}catch{}c()}).catch(C=>{try{clearInterval(A)}catch{}d(C)})});if(a?.requests.add(p),p.on("socket",u=>{try{u.setKeepAlive(!0,6e4),u.setNoDelay(!0)}catch{}}),p.on("close",()=>a?.requests.delete(p)),p.setTimeout(45e3,()=>{try{let u=new Error("Request timeout");u.code="ETIMEDOUT",p.destroy(u)}catch{}}),a?.cancelled)try{p.destroy(new Error("cancelled"))}catch{}p.on("error",async u=>{let w=u?.code,S=t<5&&w&&$t.has(String(w)),v=new Promise(y=>{try{i.close(()=>y())}catch{y()}});try{await v}catch{}if(S){let y=Math.min(2e3*t,1e4),h=o;try{h=P.statSync(e).size}catch{}return U(y).then(()=>c(z(r,e,n,t+1,a,h,s)))}d(u)})})}async function Mt(r,e,n){try{let t=P.statSync(r);return n&&Number(n)>0&&t.size!==Number(n)?!1:(await F(r)).toLowerCase()===String(e).toLowerCase()}catch{return!1}}async function pt(r){let e=`${r.replace(/\/$/,"")}/checksums.json`;return Tt(e)}async function Nt(r,e,n,t,a=4,o){let s=Y(e.path).split("/").join(B.sep),c=B.join(n,s);if(ht(B.dirname(c)),await Mt(c,e.checksum,e.size)){t("progress:skip",{path:e.path});return}if(o?.cancelled)throw new Error("cancelled");if(Array.isArray(e.parts)&&e.parts.length>0){let i=e.parts.length,l=new Array(i),p=0,u=new Set;async function w(){for(;;){let y=p++;if(y>=i)return;if(u.has(y))continue;u.add(y);let h=e.parts[y],A=Y(h.path),C=`${r.replace(/\/$/,"")}/${A}`,E=`${c}.part${y}`;try{if(P.existsSync(E))if((await F(E)).toLowerCase()===String(h.checksum).toLowerCase()){t("progress:part",{path:e.path,part:y,totalParts:i,received:Number(h.size||0),total:Number(h.size||0)}),l[y]=E;continue}else try{P.unlinkSync(E)}catch{}}catch{}let _=0;for(;;){if(o?.cancelled)throw new Error("cancelled");_+=1;let b=0,R=0;try{let D=0;try{D=P.statSync(E).size}catch{}let T=Number(h.size||0);if(T>0&&D>T)try{P.unlinkSync(E),D=0}catch{}await z(C,E,($,V)=>{let N=Math.max(0,$-R);R=$;try{N>0&&t("progress:bytes",{delta:N})}catch{}b+=N;let Q=T||V||0;t("progress:part",{path:e.path,part:y,totalParts:i,received:Math.min($,Q||$),total:Q})},1,o,D,T)}catch{try{P.unlinkSync(E)}catch{}try{b>0&&t("progress:bytes",{delta:-b})}catch{}try{t("progress:part:reset",{path:e.path,part:y,totalParts:i})}catch{}let T=Math.min(2e3*_,1e4);await U(T);continue}if((await F(E)).toLowerCase()===String(h.checksum).toLowerCase())break;try{P.unlinkSync(E)}catch{}try{b>0&&t("progress:bytes",{delta:-b})}catch{}try{t("progress:part:reset",{path:e.path,part:y,totalParts:i})}catch{}let q=Math.min(2e3*_,1e4);await U(q)}l[y]=E}}let S=Array.from({length:Math.max(1,a)},()=>w());await Promise.all(S),t("progress:merge:start",{path:e.path,parts:l.length});let v=P.createWriteStream(c);for(let y=0;y<l.length;y++){let h=l[y];t("progress:merge:part",{path:e.path,part:y,totalParts:l.length}),await new Promise((A,C)=>{let E=P.createReadStream(h);E.on("error",C),v.on("error",C),E.on("end",()=>{try{P.unlinkSync(h)}catch{}A()}),E.pipe(v,{end:!1})})}await new Promise((y,h)=>{v.on("error",h),v.on("finish",y),v.end()});try{t("progress:merge:done",{path:e.path})}catch{}}else{let i=Y(e.path),l=`${r.replace(/\/$/,"")}/${i}`,p=0;for(;;){p+=1;let u=0,w=0,S=`${c}.download`,v=0;try{v=P.statSync(S).size}catch{}let y=Number(e.size||0);if(y>0&&v>y)try{P.unlinkSync(S),v=0}catch{}if(await z(l,S,(A,C)=>{let E=Math.max(0,A-w);w=A;try{E>0&&t("progress:bytes",{delta:E})}catch{}u+=E;let _=y||C||0;t("progress:file",{path:e.path,received:Math.min(A,_||A),total:_})},1,o,v,y),(await F(S)).toLowerCase()===String(e.checksum).toLowerCase())break;try{P.unlinkSync(S)}catch{}try{u>0&&t("progress:bytes",{delta:-u})}catch{}if(p>=2)throw new Error(`Checksum mismatch for ${e.path}`)}try{P.unlinkSync(c)}catch{}P.renameSync(`${c}.download`,c)}if(t("progress:verify",{path:e.path}),(await F(c)).toLowerCase()!==String(e.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${e.path}`)}async function ft(r,e,n,t,a=!1,o=4,s=4,c){let d=new Set,i=[];for(let h of e.files||[]){if(!(a||!h.optional))continue;let A=dt(h.path);A&&(d.has(A)||(d.add(A),i.push(h)))}let l=i.filter(h=>!(Array.isArray(h.parts)&&h.parts.length>0)),p=i.filter(h=>Array.isArray(h.parts)&&h.parts.length>0),u=l.concat(p),w=u.length,S=0,v=u.reduce((h,A)=>{let C=Number(A.size||0);return C>0?h+C:Array.isArray(A.parts)&&A.parts.length?h+A.parts.reduce((E,_)=>E+Number(_.size||0),0):h},0);try{t("progress:bytes:total",{totalBytes:v})}catch{}async function y(h,A,C){let E=0;async function _(){for(;;){let R=E++;if(R>=h.length)return;let M=h[R],q=A+R,D=dt(M.path),T=async()=>Nt(r,M,n,t,s,c),$=!1,V=j.get(D);V?$=!0:(t("progress:start",{index:q,total:w,path:M.path,completed:S}),V=(async()=>{try{await T()}catch(N){if(String(N?.message||N||"error").includes("cancelled"))throw N;try{let O=B.join(n,M.path.replace(/\\/g,B.sep));try{P.unlinkSync(O)}catch{}await T()}catch(O){try{t("progress:error",{path:M.path,message:String(O?.message||O)})}catch{}}}})(),j.set(D,V));try{await V}finally{$||j.delete(D)}S+=1,t("progress:done",{index:q,total:w,path:M.path,completed:S}),await U(10)}}let b=Array.from({length:Math.max(1,C)},()=>_());await Promise.all(b)}if(await y(l,0,Math.max(1,o)),j.size>0)try{await Promise.all([...j.values()])}catch{}await y(p,l.length,1)}import et from"node:fs";import Ut from"node:path";import{app as It}from"electron";var yt=It.getPath("userData"),mt=Ut.join(yt,"settings.json");function nt(){try{let r=et.readFileSync(mt,"utf-8");return JSON.parse(r)}catch{return{}}}function Vt(r){et.mkdirSync(yt,{recursive:!0}),et.writeFileSync(mt,JSON.stringify(r,null,2),"utf-8")}function gt(r,e=void 0){return nt()[r]??e}function rt(r,e){let n=nt();n[r]=e,Vt(n)}function wt(){return nt()}var At=zt(import.meta.url),{autoUpdater:L}=At("electron-updater"),kt=At("electron-log"),Ft=Bt(import.meta.url),H=f.dirname(Ft);var m,I=null,ot=new Set,G=new Map,K=new Map,at="r5v",X=[];function Pt(r){try{return(r||[]).filter(e=>typeof e=="string"&&e.startsWith(`${at}://`))}catch{return[]}}function it(r){try{let e=new URL(r);if(e.hostname==="mod"&&e.pathname==="/install"){let n=e.searchParams.get("name")||"",t=e.searchParams.get("version")||"",a=e.searchParams.get("downloadUrl")||"";if(m&&m.webContents&&!m.webContents.isLoading())try{m.webContents.send("deeplink:mod-install",{url:r,name:n,version:t,downloadUrl:a})}catch{}else X.push(r)}}catch{}}function Wt(){for(;X.length;){let r=X.shift();it(r)}}var qt=x.requestSingleInstanceLock();qt?x.on("second-instance",(r,e)=>{try{Pt(e).forEach(t=>it(t)),m&&(m.isMinimized()&&m.restore(),m.focus())}catch{}}):x.quit();x.on("open-url",(r,e)=>{r.preventDefault(),it(e)});async function vt(){m=new Et({width:1150,height:800,minWidth:1150,minHeight:800,frame:!1,titleBarStyle:"hidden",webPreferences:{preload:f.join(H,"preload.cjs"),contextIsolation:!0,nodeIntegration:!1},show:!1,icon:f.join(H,"..","public","icon.png")});let r=process.env.VITE_DEV_SERVER_URL;if(r)await m.loadURL(r);else{let a=f.join(H,"..","dist","index.html");await m.loadFile(a)}m.webContents.setWindowOpenHandler(({url:a})=>{try{J.openExternal(a)}catch{}return{action:"deny"}}),m.webContents.on("will-navigate",(a,o)=>{let s=o.startsWith("file:"),c=!!process.env.VITE_DEV_SERVER_URL&&o.startsWith(String(process.env.VITE_DEV_SERVER_URL));if(!s&&!c){a.preventDefault();try{J.openExternal(o)}catch{}}});let e=()=>{m&&(m.isVisible()||m.show(),m.isFocused()||m.focus())};m.once("ready-to-show",e),m.webContents.once("did-finish-load",e);let n=setTimeout(e,1e3);m.on("show",()=>clearTimeout(n)),(!!process.env.VITE_DEV_SERVER_URL||process.env.NODE_ENV==="development")&&m.webContents.openDevTools({mode:"detach"}),m.webContents.on("did-fail-load",(a,o,s,c)=>{console.error("Load failed",{errorCode:o,errorDesc:s,validatedURL:c}),ct.showErrorBox("Load failed",`${s} (code ${o})
URL: ${c}`),m.show()})}x.on("window-all-closed",()=>{process.platform!=="darwin"&&x.quit()});x.whenReady().then(()=>{try{process.defaultApp&&process.platform==="win32"?x.setAsDefaultProtocolClient(at,process.execPath,[process.argv[1]]):x.setAsDefaultProtocolClient(at)}catch{}let r=f.resolve(x.getAppPath(),".."),e=f.join(r,"cache");St.registerFileProtocol("r5v",(t,a)=>{try{let o=new URL(t.url),s=decodeURIComponent(o.pathname).replace(/^\//,""),c=f.normalize(f.join(e,s));a({path:c})}catch{a({error:-6})}});let n=f.join(H,"..","dist");St.interceptFileProtocol("file",(t,a)=>{try{let o=new URL(t.url),s=decodeURIComponent(o.pathname),c=s.replace(/\\/g,"/"),d=c.indexOf("/_astro/");if(d!==-1){let i=c.substring(d+8),l=f.join(n,"_astro",i);return a({path:l})}if(c.endsWith("/favicon.svg")||/\/favicon\.svg$/i.test(c)){let i=f.join(n,"favicon.svg");return a({path:i})}if(c.startsWith("/")){let i=c.replace(/^\/+/,""),l=f.join(n,i);try{return g.accessSync(l),a({path:l})}catch{}}return a({path:s})}catch{return a({error:-6})}}),vt();try{Pt(process.argv).forEach(t=>X.push(t))}catch{}try{m?.webContents?.once("did-finish-load",Wt)}catch{}try{L.autoDownload=!1;try{L.logger=kt,kt.transports.file.level="info"}catch{}L.on("error",t=>{try{m?.webContents.send("update:error",{message:String(t?.stack||t?.message||t)})}catch{}}),L.on("update-available",t=>{try{m?.webContents.send("update:available",t)}catch{}}),L.on("update-not-available",t=>{try{m?.webContents.send("update:not-available",t)}catch{}}),L.on("download-progress",t=>{try{m?.webContents.send("update:download-progress",t)}catch{}}),L.on("update-downloaded",t=>{try{m?.webContents.send("update:downloaded",t)}catch{}})}catch{}x.on("activate",()=>{Et.getAllWindows().length===0&&vt()})});k.handle("update:check",async()=>{try{return{ok:!0,result:(await L.checkForUpdates())?.updateInfo||null}}catch(r){return{ok:!1,error:String(r?.message||r)}}});k.handle("update:download",async()=>{try{return await L.downloadUpdate(),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});k.handle("update:quitAndInstall",async()=>{try{return setImmediate(()=>L.quitAndInstall(!1,!0)),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});k.handle("app:getVersion",async()=>{try{return x.getVersion()}catch{return"0.0.0"}});k.handle("app:getBaseDir",async()=>{try{return f.resolve(x.getAppPath(),"..")}catch{return""}});k.handle("app:getLauncherInstallRoot",async()=>{try{let r=process.env.LOCALAPPDATA||f.join(x.getPath("home"),"AppData","Local");return f.join(r,"Programs","r5vlauncher")}catch{return""}});function Ot(r){try{let e=f.join(r,"mods.vdf"),n=g.readFileSync(e,"utf-8"),t={},a=/"([^"]+)"\s*"([01])"/g,o;for(;o=a.exec(n);){let s=o[1];s&&s!=="ModList"&&(t[s]=o[2]==="1")}return t}catch{return{}}}function lt(r){try{let e=f.join(r,"mods.vdf"),n=g.readFileSync(e,"utf-8"),t={},a=[],o=/"([^"]+)"\s*"([01])"/g,s;for(;s=o.exec(n);){let c=s[1];!c||c==="ModList"||(c in t||a.push(c),t[c]=s[2]==="1")}return{map:t,order:a}}catch{return{map:{},order:[]}}}function st(r){try{let e=g.readFileSync(r,"utf-8"),n=e.match(/"id"\s*"([^"]+)"/i),t=e.match(/"name"\s*"([^"]+)"/i),a=n?n[1]:null,o=t?t[1]:null;return{id:a,name:o}}catch{return{id:null,name:null}}}function Ht(r,e){let n=['"ModList"',"{"];for(let[t,a]of Object.entries(e))n.push(`	"${t}"		"${a?"1":"0"}"`);n.push("}"),g.mkdirSync(r,{recursive:!0}),g.writeFileSync(f.join(r,"mods.vdf"),n.join(`
`),"utf-8")}function xt(r,e,n){let t=new Set,a=['"ModList"',"{"],o=s=>{a.push(`	"${s}"		"${n[s]?"1":"0"}"`),t.add(s)};for(let s of Array.isArray(e)?e:[])Object.prototype.hasOwnProperty.call(n,s)&&!t.has(s)&&o(s);for(let s of Object.keys(n))t.has(s)||o(s);a.push("}"),g.mkdirSync(r,{recursive:!0}),g.writeFileSync(f.join(r,"mods.vdf"),a.join(`
`),"utf-8")}k.handle("mods:listInstalled",async(r,{installDir:e})=>{try{let n=f.join(e,"mods"),{map:t,order:a}=lt(n),o=[],s=g.existsSync(n)?g.readdirSync(n,{withFileTypes:!0}):[];for(let d of s){if(!d.isDirectory())continue;let i=f.join(n,d.name),l=f.join(i,"manifest.json"),p=f.join(i,"mod.vdf"),u=f.join(i,"icon.png"),w=null;try{w=JSON.parse(g.readFileSync(l,"utf-8"))}catch{}let S=st(p),v=S.id||w?.name||d.name,y=null;try{y=`data:image/png;base64,${g.readFileSync(u).toString("base64")}`}catch{}o.push({id:v,name:w?.name||S.name||d.name,folder:d.name,version:w?.version_number||null,description:w?.description||"",enabled:v?!!t[v]:!1,hasManifest:g.existsSync(l),iconDataUrl:y})}let c=new Map(a.map((d,i)=>[d,i]));return o.sort((d,i)=>{let l=d.id!=null&&c.has(d.id)?c.get(d.id):Number.MAX_SAFE_INTEGER,p=i.id!=null&&c.has(i.id)?c.get(i.id):Number.MAX_SAFE_INTEGER;return l!==p?l-p:String(d.name||"").localeCompare(String(i.name||""))}),{ok:!0,mods:o}}catch(n){return{ok:!1,error:String(n?.message||n)}}});k.handle("mods:setEnabled",async(r,{installDir:e,name:n,enabled:t})=>{try{let a=f.join(e,"mods"),{map:o}=lt(a);return o[n]=!!t,xt(a,void 0,o),{ok:!0}}catch(a){return{ok:!1,error:String(a?.message||a)}}});k.handle("mods:reorder",async(r,{installDir:e,orderIds:n})=>{try{let t=f.join(e,"mods"),{map:a,order:o}=lt(t),s=Array.isArray(n)?n.filter(l=>typeof l=="string"&&l&&Object.prototype.hasOwnProperty.call(a,l)):[],c=new Set(s),d=o.filter(l=>Object.prototype.hasOwnProperty.call(a,l)&&!c.has(l)),i=[...s,...d];return xt(t,i,a),{ok:!0}}catch(t){return{ok:!1,error:String(t?.message||t)}}});k.handle("mods:uninstall",async(r,{installDir:e,folder:n})=>{try{let t=f.join(e,"mods"),a=f.join(t,n);return g.rmSync(a,{recursive:!0,force:!0}),{ok:!0}}catch(t){return{ok:!1,error:String(t?.message||t)}}});k.handle("mods:fetchAll",async(r,{query:e})=>{let n="https://thunderstore.io/c/r5valkyrie/api/v1/package-listing-index/",t=o=>new Promise((s,c)=>{W.get(o,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"*/*"}},i=>{if(i.statusCode&&i.statusCode>=300&&i.statusCode<400&&i.headers.location){i.resume();let p=i.headers.location.startsWith("http")?i.headers.location:new URL(i.headers.location,o).toString();return s(t(p))}if(i.statusCode!==200)return i.resume(),c(new Error(`HTTP ${i.statusCode}`));let l=[];i.on("data",p=>l.push(Buffer.isBuffer(p)?p:Buffer.from(p))),i.on("end",()=>s(Buffer.concat(l)))}).on("error",c)}),a=o=>{try{return jt.gunzipSync(o)}catch{return o}};try{let o=await t(n),s=JSON.parse(a(o).toString("utf8")),c=Array.isArray(s)?s:[],d=6,i=[],l=0;await Promise.all(Array.from({length:d}).map(async()=>{for(;l<c.length;){let u=l++,w=c[u];try{let S=await t(w),v=a(S).toString("utf8"),y=JSON.parse(v);Array.isArray(y)&&i.push(...y)}catch{}}}));let p=i;if(e&&String(e).trim()){let u=String(e).toLowerCase();p=p.filter(w=>String(w?.name||"").toLowerCase().includes(u)||String(w?.full_name||"").toLowerCase().includes(u))}return{ok:!0,mods:p}}catch(o){try{let c=await t("https://thunderstore.io/c/r5valkyrie/api/v1/package/"),d=JSON.parse(c.toString("utf8")),i=Array.isArray(d)?d:[];if(e&&String(e).trim()){let l=String(e).toLowerCase();i=i.filter(p=>String(p?.name||"").toLowerCase().includes(l)||String(p?.full_name||"").toLowerCase().includes(l))}return{ok:!0,mods:i}}catch(s){return{ok:!1,error:String(s?.message||o?.message||s||o)}}}});k.handle("mods:install",async(r,{installDir:e,name:n,downloadUrl:t})=>{try{let a=String(n||"").trim();if(!a)return{ok:!1,error:"Invalid mod name"};if(ot.has(a))return{ok:!0};ot.add(a);let o=f.join(e,"mods");g.mkdirSync(o,{recursive:!0});let s=f.join(o,`.__mod_${Date.now()}.zip`),c=(p,u=0)=>new Promise((w,S)=>{if(u>5)return S(new Error("Too many redirects"));let v=g.createWriteStream(s);W.get(p,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"application/octet-stream,*/*;q=0.8",Referer:"https://thunderstore.io/",Connection:"keep-alive"}},h=>{if(h.statusCode&&h.statusCode>=300&&h.statusCode<400&&h.headers.location){h.resume(),v.close(()=>{});try{g.unlinkSync(s)}catch{}let b=h.headers.location.startsWith("http")?h.headers.location:new URL(h.headers.location,p).toString();return w(c(b,u+1))}if(h.statusCode!==200){v.close(()=>{});try{g.unlinkSync(s)}catch{}return h.resume(),S(new Error(`HTTP ${h.statusCode}`))}let A=Number(h.headers["content-length"]||0),C=0,E=Date.now(),_=b=>{try{r?.sender?.send("mods:progress",{key:n,phase:b,received:C,total:A})}catch{}};h.on("data",b=>{C+=Buffer.isBuffer(b)?b.length:Buffer.byteLength(String(b));let R=Date.now();R-E>150&&(E=R,_("downloading"))}),h.pipe(v),v.on("finish",()=>{_("downloading"),v.close(w)})}).on("error",h=>{try{g.unlinkSync(s)}catch{}S(h)})});await c(t);try{r?.sender?.send("mods:progress",{key:n,phase:"extracting"})}catch{}let d=f.join(o,n);try{g.rmSync(d,{recursive:!0,force:!0})}catch{}g.mkdirSync(d,{recursive:!0}),await new Promise((p,u)=>{let w=Ct("powershell.exe",["-NoProfile","-NonInteractive","-Command",`Expand-Archive -LiteralPath "${s}" -DestinationPath "${d}" -Force`],{stdio:"ignore"});w.on("exit",S=>S===0?p():u(new Error(`Expand-Archive failed ${S}`))),w.on("error",u)});try{g.unlinkSync(s)}catch{}let i=null;try{let p=f.join(d,"mod.vdf");if(g.existsSync(p))i=st(p).id;else{let u=g.readdirSync(d,{withFileTypes:!0});for(let w of u)if(w.isDirectory()){let S=f.join(d,w.name,"mod.vdf");if(g.existsSync(S)&&(i=st(S).id,i))break}}}catch{}let l=Ot(o);l[i||n]=!0,Ht(o,l);try{r?.sender?.send("mods:progress",{key:n,phase:"done"})}catch{}return{ok:!0}}catch(a){return{ok:!1,error:String(a?.message||a)}}finally{try{ot.delete(String(n||""))}catch{}}});k.handle("mods:watch",async(r,{installDir:e})=>{try{let n=f.join(e,"mods");if(!g.existsSync(n))return{ok:!0};let t=n;if(G.has(t))return{ok:!0};let a=g.watch(n,{persistent:!0},(o,s)=>{let c=t;clearTimeout(K.get(c));let d=setTimeout(()=>{try{m?.webContents?.send("mods:changed",{installDir:e})}catch{}},300);K.set(c,d)});return G.set(t,a),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});k.handle("mods:unwatch",async(r,{installDir:e})=>{try{let t=f.join(e,"mods"),a=G.get(t);if(a){try{a.close()}catch{}G.delete(t)}let o=K.get(t);return o&&(clearTimeout(o),K.delete(t)),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});k.handle("mods:iconDataUrl",async(r,{installDir:e,folder:n})=>{try{let t=f.join(e,"mods",n,"icon.png");return await g.promises.access(t),{ok:!0,dataUrl:`data:image/png;base64,${(await g.promises.readFile(t)).toString("base64")}`}}catch(t){return{ok:!1,error:String(t?.message||t)}}});k.handle("select-directory",async()=>{let r=await ct.showOpenDialog({properties:["openDirectory","createDirectory"]});return r.canceled||r.filePaths.length===0?null:r.filePaths[0]});k.handle("settings:get",()=>wt());k.handle("settings:set",(r,{key:e,value:n})=>rt(e,n));k.handle("download:checksums",async(r,{baseUrl:e})=>pt(e));k.handle("download:all",async(r,{baseUrl:e,checksums:n,installDir:t,includeOptional:a,concurrency:o,partConcurrency:s,channelName:c,mode:d})=>{let i=(l,p)=>r.sender.send(l,p);try{if(!(String(d||"install").toLowerCase()==="install")){let p=f.join(t,"mods","mods.vdf");if(g.existsSync(p)){let w=(Array.isArray(n?.files)?n.files:[]).filter(S=>{try{return String(S?.path||S?.name||"").replace(/\\/g,"/").toLowerCase()!=="mods/mods.vdf"}catch{return!0}});n={...n||{},files:w}}}}catch{}I=ut();try{await ft(e,n,t,i,!!a,Number(o)||4,Number(s)||4,I);try{let l=gt("channels",{})||{};l[String(c||"default")]={installDir:t,gameVersion:n?.game_version||null,gameBaseUrl:e,lastUpdatedAt:Date.now()},rt("channels",l)}catch(l){console.error("Failed to persist channel info",l)}}finally{I=null}return!0});k.handle("default-install-dir",(r,{channelName:e})=>{let n=process.env.LOCALAPPDATA||f.join(x.getPath("home"),"AppData","Local"),t=f.join(n,"Programs","R5VLibrary");return e?f.join(t,e):t});k.handle("launcher:config",async(r,{url:e})=>(t=>new Promise((a,o)=>{W.get(t,s=>{if(s.statusCode!==200){o(new Error(`HTTP ${s.statusCode} for ${t}`)),s.resume();return}let c="";s.setEncoding("utf8"),s.on("data",d=>c+=d),s.on("end",()=>{try{a(JSON.parse(c))}catch(d){o(d)}})}).on("error",o)}))(e));k.handle("eula:get",async()=>{let r="https://playvalkyrie.org/api/eula",e=n=>new Promise((t,a)=>{W.get(n,o=>{if(o.statusCode!==200){a(new Error(`HTTP ${o.statusCode}`)),o.resume();return}let s=[];o.on("data",c=>s.push(Buffer.isBuffer(c)?c:Buffer.from(c))),o.on("end",()=>{try{let c=Buffer.concat(s).toString("utf8");t(JSON.parse(c))}catch(c){a(c)}})}).on("error",a)});try{return{ok:!0,json:await e(r)}}catch(n){return{ok:!1,error:String(n?.message||n)}}});k.handle("video:cache",async(r,{filename:e})=>{let t=`https://blaze.playvalkyrie.org/video_backgrounds/${e}`,a=f.join(f.resolve(x.getAppPath(),".."),"cache"),o=f.join(a,"videos"),s=f.join(o,e);await g.promises.mkdir(o,{recursive:!0});try{return await g.promises.access(s),`r5v://videos/${e}`}catch{}return await new Promise((c,d)=>{let i=g.createWriteStream(s);W.get(t,l=>{if(l.statusCode!==200){i.close(()=>{}),g.unlink(s,()=>{}),d(new Error(`HTTP ${l.statusCode} video`)),l.resume();return}l.pipe(i),i.on("finish",()=>i.close(c))}).on("error",l=>{g.unlink(s,()=>d(l))})}),`r5v://videos/${e}`});k.handle("fs:exists",async(r,{path:e})=>{try{return await g.promises.access(e),!0}catch{return!1}});k.handle("path:open",async(r,{path:e})=>{try{return await J.openPath(e),!0}catch{return!1}});k.handle("open-external",async(r,{url:e})=>{try{return await J.openExternal(e),!0}catch{return!1}});k.handle("download:cancel",async()=>{try{tt(I)}catch{}I=null;try{m?.webContents.send("progress:cancelled",{})}catch{}return!0});k.handle("select-file",async(r,{filters:e})=>{let n=await ct.showOpenDialog({properties:["openFile"],filters:Array.isArray(e)?e:void 0});return n.canceled||n.filePaths.length===0?null:n.filePaths[0]});k.handle("game:launch",async(r,{channelName:e,installDir:n,mode:t,argsString:a})=>{try{if(!n)throw new Error("Missing installDir");let o=String(t).toUpperCase()==="SERVER"?"r5apex_ds.exe":"r5apex.exe",s=f.join(n,o);await g.promises.access(s).catch(()=>{throw new Error(`Executable not found: ${s}`)});let d=(l=>!l||typeof l!="string"?[]:(l.match(/(?:[^\s\"]+|\"[^\"]*\")+/g)||[]).map(u=>u.replace(/^\"|\"$/g,"")))(a);return Ct(s,d,{cwd:n,detached:!0,stdio:"ignore",env:{...process.env}}).unref(),{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}});k.on("window:minimize",()=>{m?.minimize()});k.on("window:maximize",()=>{m&&(m.isMaximized()?m.unmaximize():m.maximize())});k.on("window:close",()=>{m?.close()});x.on("before-quit",()=>{if(I)try{tt(I)}catch{}});
