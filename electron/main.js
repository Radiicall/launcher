import{app as R,BrowserWindow as mt,ipcMain as S,dialog as nt,protocol as pt,shell as J}from"electron";import{createRequire as Tt}from"node:module";import p from"node:path";import{fileURLToPath as $t,pathToFileURL as Qt}from"node:url";import O from"node:https";import g from"node:fs";import Nt from"node:zlib";import{spawn as wt}from"node:child_process";import Ut from"node:os";import A from"node:fs";import B from"node:path";import vt from"node:crypto";import{pipeline as kt}from"node:stream";import{promisify as Et}from"node:util";import Y from"node:https";var Ct=Et(kt);function K(n){return String(n||"").replace(/\\/g,"/").replace(/^\/+/,"")}function at(n){return String(n||"").replace(/\\/g,"/").toLowerCase()}var W=new Map,xt=new Y.Agent({keepAlive:!0,maxSockets:32,maxFreeSockets:16,keepAliveMsecs:3e4});function q(n){return new Promise((t,a)=>{let e=vt.createHash("sha256"),o=A.createReadStream(n);o.on("error",a),o.on("end",()=>t(e.digest("hex"))),o.on("data",r=>e.update(r))})}function ot(n){A.mkdirSync(n,{recursive:!0})}function At(n){return new Promise((t,a)=>{Y.get(n,e=>{if(e.statusCode!==200){a(new Error(`HTTP ${e.statusCode} for ${n}`)),e.resume();return}let o="";e.setEncoding("utf8"),e.on("data",r=>o+=r),e.on("end",()=>{try{t(JSON.parse(o))}catch(r){a(r)}})}).on("error",a)})}function U(n){return new Promise(t=>setTimeout(t,n))}function st(){return{cancelled:!1,requests:new Set}}function Z(n){if(n){n.cancelled=!0;for(let t of n.requests)try{t.destroy(new Error("cancelled"))}catch{}n.requests.clear()}}var Pt=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE"]);async function z(n,t,a,e=1,o,r=0,c=0){return new Promise((i,f)=>{ot(B.dirname(t));let s=A.createWriteStream(t,{flags:r>0?"a":"w"});if(o?.cancelled)return s.close(()=>{}),f(new Error("cancelled"));let d={agent:xt};r>0&&(d.headers={Range:`bytes=${r}-`});let u=Y.get(n,d,h=>{if(h.statusCode!==200&&!(r>0&&h.statusCode===206)){if(s.close(()=>{}),r>0&&h.statusCode===200){try{A.unlinkSync(t)}catch{}let C=Math.min(2e3*e,1e4);h.resume();try{u.destroy(new Error("restart:range-ignored"))}catch{}return U(C).then(()=>i(z(n,t,a,e+1,o,0,c)))}if(A.unlink(t,()=>{}),h.statusCode&&[429,500,502,503,504].includes(h.statusCode)&&e<5){let C=Math.min(2e3*e,1e4);return h.resume(),U(C).then(()=>i(z(n,t,a,e+1,o,r,c)))}f(new Error(`HTTP ${h.statusCode} for ${n}`)),h.resume();return}let m=Number(h.headers["content-length"]||0),E=c>0?c:r>0?r+m:m,x=0,l=Date.now(),y=e<=2?6e4:9e4,v=setInterval(()=>{if(!o?.cancelled&&Date.now()-l>y)try{let C=new Error("stalled");C.code="ETIMEDOUT",u.destroy(C)}catch{}},1e4);h.on("data",C=>{x+=C.length,l=Date.now(),a&&a(Math.min(r+x,E||r+x),E||0)}),h.on("aborted",async()=>{let C=new Promise(w=>s.close(()=>w()));try{clearInterval(v)}catch{}try{await C}catch{}if(e<5){let w=Math.min(2e3*e,1e4);return U(w).then(()=>i(z(n,t,a,e+1,o,r+x,c)))}f(new Error("response aborted"))}),Ct(h,s).then(()=>{try{clearInterval(v)}catch{}i()}).catch(C=>{try{clearInterval(v)}catch{}f(C)})});if(o?.requests.add(u),u.on("socket",h=>{try{h.setKeepAlive(!0,6e4),h.setNoDelay(!0)}catch{}}),u.on("close",()=>o?.requests.delete(u)),u.setTimeout(45e3,()=>{try{let h=new Error("Request timeout");h.code="ETIMEDOUT",u.destroy(h)}catch{}}),o?.cancelled)try{u.destroy(new Error("cancelled"))}catch{}u.on("error",async h=>{let m=h?.code,E=e<5&&m&&Pt.has(String(m)),x=new Promise(l=>{try{s.close(()=>l())}catch{l()}});try{await x}catch{}if(E){let l=Math.min(2e3*e,1e4),y=r;try{y=A.statSync(t).size}catch{}return U(l).then(()=>i(z(n,t,a,e+1,o,y,c)))}f(h)})})}async function bt(n,t,a){try{let e=A.statSync(n);return a&&Number(a)>0&&e.size!==Number(a)?!1:(await q(n)).toLowerCase()===String(t).toLowerCase()}catch{return!1}}async function ct(n){let t=`${n.replace(/\/$/,"")}/checksums.json`;return At(t)}async function Rt(n,t,a,e,o=4,r){let c=K(t.path).split("/").join(B.sep),i=B.join(a,c);if(ot(B.dirname(i)),await bt(i,t.checksum,t.size)){e("progress:skip",{path:t.path});return}if(r?.cancelled)throw new Error("cancelled");if(Array.isArray(t.parts)&&t.parts.length>0){let s=t.parts.length,d=new Array(s),u=0,h=new Set;async function m(){for(;;){let l=u++;if(l>=s)return;if(h.has(l))continue;h.add(l);let y=t.parts[l],v=K(y.path),C=`${n.replace(/\/$/,"")}/${v}`,w=`${i}.part${l}`;try{if(A.existsSync(w))if((await q(w)).toLowerCase()===String(y.checksum).toLowerCase()){e("progress:part",{path:t.path,part:l,totalParts:s,received:Number(y.size||0),total:Number(y.size||0)}),d[l]=w;continue}else try{A.unlinkSync(w)}catch{}}catch{}let P=0;for(;;){if(r?.cancelled)throw new Error("cancelled");P+=1;let b=0,I=0;try{let D=0;try{D=A.statSync(w).size}catch{}let _=Number(y.size||0);if(_>0&&D>_)try{A.unlinkSync(w),D=0}catch{}await z(C,w,(T,V)=>{let N=Math.max(0,T-I);I=T;try{N>0&&e("progress:bytes",{delta:N})}catch{}b+=N;let G=_||V||0;e("progress:part",{path:t.path,part:l,totalParts:s,received:Math.min(T,G||T),total:G})},1,r,D,_)}catch{try{A.unlinkSync(w)}catch{}try{b>0&&e("progress:bytes",{delta:-b})}catch{}try{e("progress:part:reset",{path:t.path,part:l,totalParts:s})}catch{}let _=Math.min(2e3*P,1e4);await U(_);continue}if((await q(w)).toLowerCase()===String(y.checksum).toLowerCase())break;try{A.unlinkSync(w)}catch{}try{b>0&&e("progress:bytes",{delta:-b})}catch{}try{e("progress:part:reset",{path:t.path,part:l,totalParts:s})}catch{}let F=Math.min(2e3*P,1e4);await U(F)}d[l]=w}}let E=Array.from({length:Math.max(1,o)},()=>m());await Promise.all(E),e("progress:merge:start",{path:t.path,parts:d.length});let x=A.createWriteStream(i);for(let l=0;l<d.length;l++){let y=d[l];e("progress:merge:part",{path:t.path,part:l,totalParts:d.length}),await new Promise((v,C)=>{let w=A.createReadStream(y);w.on("error",C),x.on("error",C),w.on("end",()=>{try{A.unlinkSync(y)}catch{}v()}),w.pipe(x,{end:!1})})}await new Promise((l,y)=>{x.on("error",y),x.on("finish",l),x.end()});try{e("progress:merge:done",{path:t.path})}catch{}}else{let s=K(t.path),d=`${n.replace(/\/$/,"")}/${s}`,u=0;for(;;){u+=1;let h=0,m=0,E=`${i}.download`,x=0;try{x=A.statSync(E).size}catch{}let l=Number(t.size||0);if(l>0&&x>l)try{A.unlinkSync(E),x=0}catch{}if(await z(d,E,(v,C)=>{let w=Math.max(0,v-m);m=v;try{w>0&&e("progress:bytes",{delta:w})}catch{}h+=w;let P=l||C||0;e("progress:file",{path:t.path,received:Math.min(v,P||v),total:P})},1,r,x,l),(await q(E)).toLowerCase()===String(t.checksum).toLowerCase())break;try{A.unlinkSync(E)}catch{}try{h>0&&e("progress:bytes",{delta:-h})}catch{}if(u>=2)throw new Error(`Checksum mismatch for ${t.path}`)}try{A.unlinkSync(i)}catch{}A.renameSync(`${i}.download`,i)}if(e("progress:verify",{path:t.path}),(await q(i)).toLowerCase()!==String(t.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${t.path}`)}async function it(n,t,a,e,o=!1,r=4,c=4,i){let f=new Set,s=[];for(let y of t.files||[]){if(!(o||!y.optional))continue;let v=at(y.path);v&&(f.has(v)||(f.add(v),s.push(y)))}let d=s.filter(y=>!(Array.isArray(y.parts)&&y.parts.length>0)),u=s.filter(y=>Array.isArray(y.parts)&&y.parts.length>0),h=d.concat(u),m=h.length,E=0,x=h.reduce((y,v)=>{let C=Number(v.size||0);return C>0?y+C:Array.isArray(v.parts)&&v.parts.length?y+v.parts.reduce((w,P)=>w+Number(P.size||0),0):y},0);try{e("progress:bytes:total",{totalBytes:x})}catch{}async function l(y,v,C){let w=0;async function P(){for(;;){let I=w++;if(I>=y.length)return;let $=y[I],F=v+I,D=at($.path),_=async()=>Rt(n,$,a,e,c,i),T=!1,V=W.get(D);V?T=!0:(e("progress:start",{index:F,total:m,path:$.path,completed:E}),V=(async()=>{try{await _()}catch(N){if(String(N?.message||N||"error").includes("cancelled"))throw N;try{let H=B.join(a,$.path.replace(/\\/g,B.sep));try{A.unlinkSync(H)}catch{}await _()}catch(H){try{e("progress:error",{path:$.path,message:String(H?.message||H)})}catch{}}}})(),W.set(D,V));try{await V}finally{T||W.delete(D)}E+=1,e("progress:done",{index:F,total:m,path:$.path,completed:E}),await U(10)}}let b=Array.from({length:Math.max(1,C)},()=>P());await Promise.all(b)}if(await l(d,0,Math.max(1,r)),W.size>0)try{await Promise.all([...W.values()])}catch{}await l(u,d.length,1)}import Q from"node:fs";import Lt from"node:path";import{app as Dt}from"electron";var lt=Dt.getPath("userData"),dt=Lt.join(lt,"settings.json");function X(){try{let n=Q.readFileSync(dt,"utf-8");return JSON.parse(n)}catch{return{}}}function _t(n){Q.mkdirSync(lt,{recursive:!0}),Q.writeFileSync(dt,JSON.stringify(n,null,2),"utf-8")}function ht(n,t=void 0){return X()[n]??t}function tt(n,t){let a=X();a[n]=t,_t(a)}function ut(){return X()}var gt=Tt(import.meta.url),{autoUpdater:L}=gt("electron-updater"),ft=gt("electron-log"),Mt=$t(import.meta.url),j=p.dirname(Mt);var k,M=null;async function yt(){k=new mt({width:1150,height:800,minWidth:1150,minHeight:800,frame:!1,titleBarStyle:"hidden",webPreferences:{preload:p.join(j,"preload.cjs"),contextIsolation:!0,nodeIntegration:!1},show:!1,icon:p.join(j,"..","public","icon.png")});let n=process.env.VITE_DEV_SERVER_URL;if(n)await k.loadURL(n);else{let o=p.join(j,"..","dist","index.html");await k.loadFile(o)}k.webContents.setWindowOpenHandler(({url:o})=>{try{J.openExternal(o)}catch{}return{action:"deny"}}),k.webContents.on("will-navigate",(o,r)=>{let c=r.startsWith("file:"),i=!!process.env.VITE_DEV_SERVER_URL&&r.startsWith(String(process.env.VITE_DEV_SERVER_URL));if(!c&&!i){o.preventDefault();try{J.openExternal(r)}catch{}}});let t=()=>{k&&(k.isVisible()||k.show(),k.isFocused()||k.focus())};k.once("ready-to-show",t),k.webContents.once("did-finish-load",t);let a=setTimeout(t,1e3);k.on("show",()=>clearTimeout(a)),(!!process.env.VITE_DEV_SERVER_URL||process.env.NODE_ENV==="development")&&k.webContents.openDevTools({mode:"detach"}),k.webContents.on("did-fail-load",(o,r,c,i)=>{console.error("Load failed",{errorCode:r,errorDesc:c,validatedURL:i}),nt.showErrorBox("Load failed",`${c} (code ${r})
URL: ${i}`),k.show()})}R.on("window-all-closed",()=>{process.platform!=="darwin"&&R.quit()});R.whenReady().then(()=>{let n=p.resolve(R.getAppPath(),".."),t=p.join(n,"cache");pt.registerFileProtocol("r5v",(e,o)=>{try{let r=new URL(e.url),c=decodeURIComponent(r.pathname).replace(/^\//,""),i=p.normalize(p.join(t,c));o({path:i})}catch{o({error:-6})}});let a=p.join(j,"..","dist");pt.interceptFileProtocol("file",(e,o)=>{try{let r=new URL(e.url),c=decodeURIComponent(r.pathname),i=c.replace(/\\/g,"/"),f=i.indexOf("/_astro/");if(f!==-1){let s=i.substring(f+8),d=p.join(a,"_astro",s);return o({path:d})}if(i.endsWith("/favicon.svg")||/\/favicon\.svg$/i.test(i)){let s=p.join(a,"favicon.svg");return o({path:s})}if(i.startsWith("/")){let s=i.replace(/^\/+/,""),d=p.join(a,s);try{return g.accessSync(d),o({path:d})}catch{}}return o({path:c})}catch{return o({error:-6})}}),yt();try{L.autoDownload=!1;try{L.logger=ft,ft.transports.file.level="info"}catch{}L.on("error",e=>{try{k?.webContents.send("update:error",{message:String(e?.stack||e?.message||e)})}catch{}}),L.on("update-available",e=>{try{k?.webContents.send("update:available",e)}catch{}}),L.on("update-not-available",e=>{try{k?.webContents.send("update:not-available",e)}catch{}}),L.on("download-progress",e=>{try{k?.webContents.send("update:download-progress",e)}catch{}}),L.on("update-downloaded",e=>{try{k?.webContents.send("update:downloaded",e)}catch{}})}catch{}R.on("activate",()=>{mt.getAllWindows().length===0&&yt()})});S.handle("update:check",async()=>{try{return{ok:!0,result:(await L.checkForUpdates())?.updateInfo||null}}catch(n){return{ok:!1,error:String(n?.message||n)}}});S.handle("update:download",async()=>{try{return await L.downloadUpdate(),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});S.handle("update:quitAndInstall",async()=>{try{return setImmediate(()=>L.quitAndInstall(!1,!0)),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});S.handle("app:getVersion",async()=>{try{return R.getVersion()}catch{return"0.0.0"}});S.handle("app:getBaseDir",async()=>{try{return p.resolve(R.getAppPath(),"..")}catch{return""}});S.handle("app:getLauncherInstallRoot",async()=>{try{let n=process.env.LOCALAPPDATA||p.join(R.getPath("home"),"AppData","Local");return p.join(n,"Programs","r5vlauncher")}catch{return""}});function rt(n){try{let t=p.join(n,"mods.vdf"),a=g.readFileSync(t,"utf-8"),e={},o=/"([^"]+)"\s*"([01])"/g,r;for(;r=o.exec(a);){let c=r[1];c&&c!=="ModList"&&(e[c]=r[2]==="1")}return e}catch{return{}}}function et(n){try{let t=g.readFileSync(n,"utf-8"),a=t.match(/"id"\s*"([^"]+)"/i),e=t.match(/"name"\s*"([^"]+)"/i),o=a?a[1]:null,r=e?e[1]:null;return{id:o,name:r}}catch{return{id:null,name:null}}}function St(n,t){let a=['"ModList"',"{"];for(let[e,o]of Object.entries(t))a.push(`	"${e}"		"${o?"1":"0"}"`);a.push("}"),g.mkdirSync(n,{recursive:!0}),g.writeFileSync(p.join(n,"mods.vdf"),a.join(`
`),"utf-8")}S.handle("mods:listInstalled",async(n,{installDir:t})=>{try{let a=p.join(t,"mods"),e=rt(a),o=[],r=g.existsSync(a)?g.readdirSync(a,{withFileTypes:!0}):[];for(let c of r){if(!c.isDirectory())continue;let i=p.join(a,c.name),f=p.join(i,"manifest.json"),s=p.join(i,"mod.vdf"),d=p.join(i,"icon.png"),u=null;try{u=JSON.parse(g.readFileSync(f,"utf-8"))}catch{}let h=et(s),m=h.id||u?.name||c.name,E=null;try{E=`data:image/png;base64,${g.readFileSync(d).toString("base64")}`}catch{}o.push({id:m,name:u?.name||h.name||c.name,folder:c.name,version:u?.version_number||null,description:u?.description||"",enabled:m?!!e[m]:!1,hasManifest:g.existsSync(f),iconDataUrl:E})}return{ok:!0,mods:o}}catch(a){return{ok:!1,error:String(a?.message||a)}}});S.handle("mods:setEnabled",async(n,{installDir:t,name:a,enabled:e})=>{try{let o=p.join(t,"mods"),r=rt(o);return r[a]=!!e,St(o,r),{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}});S.handle("mods:uninstall",async(n,{installDir:t,folder:a})=>{try{let e=p.join(t,"mods"),o=p.join(e,a);return g.rmSync(o,{recursive:!0,force:!0}),{ok:!0}}catch(e){return{ok:!1,error:String(e?.message||e)}}});S.handle("mods:fetchAll",async(n,{query:t})=>{let a="https://thunderstore.io/c/r5valkyrie/api/v1/package-listing-index/",e=r=>new Promise((c,i)=>{O.get(r,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"*/*"}},s=>{if(s.statusCode&&s.statusCode>=300&&s.statusCode<400&&s.headers.location){s.resume();let u=s.headers.location.startsWith("http")?s.headers.location:new URL(s.headers.location,r).toString();return c(e(u))}if(s.statusCode!==200)return s.resume(),i(new Error(`HTTP ${s.statusCode}`));let d=[];s.on("data",u=>d.push(Buffer.isBuffer(u)?u:Buffer.from(u))),s.on("end",()=>c(Buffer.concat(d)))}).on("error",i)}),o=r=>{try{return Nt.gunzipSync(r)}catch{return r}};try{let r=await e(a),c=JSON.parse(o(r).toString("utf8")),i=Array.isArray(c)?c:[],f=6,s=[],d=0;await Promise.all(Array.from({length:f}).map(async()=>{for(;d<i.length;){let h=d++,m=i[h];try{let E=await e(m),x=o(E).toString("utf8"),l=JSON.parse(x);Array.isArray(l)&&s.push(...l)}catch{}}}));let u=s;if(t&&String(t).trim()){let h=String(t).toLowerCase();u=u.filter(m=>String(m?.name||"").toLowerCase().includes(h)||String(m?.full_name||"").toLowerCase().includes(h))}return{ok:!0,mods:u}}catch(r){try{let i=await e("https://thunderstore.io/c/r5valkyrie/api/v1/package/"),f=JSON.parse(i.toString("utf8")),s=Array.isArray(f)?f:[];if(t&&String(t).trim()){let d=String(t).toLowerCase();s=s.filter(u=>String(u?.name||"").toLowerCase().includes(d)||String(u?.full_name||"").toLowerCase().includes(d))}return{ok:!0,mods:s}}catch(c){return{ok:!1,error:String(c?.message||r?.message||c||r)}}}});S.handle("mods:install",async(n,{installDir:t,name:a,downloadUrl:e})=>{try{let o=p.join(t,"mods");g.mkdirSync(o,{recursive:!0});let r=p.join(Ut.tmpdir(),`mod_${Date.now()}.zip`),c=(d,u=0)=>new Promise((h,m)=>{if(u>5)return m(new Error("Too many redirects"));let E=g.createWriteStream(r);O.get(d,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"application/octet-stream,*/*;q=0.8",Referer:"https://thunderstore.io/",Connection:"keep-alive"}},l=>{if(l.statusCode&&l.statusCode>=300&&l.statusCode<400&&l.headers.location){l.resume(),E.close(()=>{});try{g.unlinkSync(r)}catch{}let P=l.headers.location.startsWith("http")?l.headers.location:new URL(l.headers.location,d).toString();return h(c(P,u+1))}if(l.statusCode!==200){E.close(()=>{});try{g.unlinkSync(r)}catch{}return l.resume(),m(new Error(`HTTP ${l.statusCode}`))}let y=Number(l.headers["content-length"]||0),v=0,C=Date.now(),w=P=>{try{n?.sender?.send("mods:progress",{key:a,phase:P,received:v,total:y})}catch{}};l.on("data",P=>{v+=Buffer.isBuffer(P)?P.length:Buffer.byteLength(String(P));let b=Date.now();b-C>150&&(C=b,w("downloading"))}),l.pipe(E),E.on("finish",()=>{w("downloading"),E.close(h)})}).on("error",l=>{try{g.unlinkSync(r)}catch{}m(l)})});await c(e);try{n?.sender?.send("mods:progress",{key:a,phase:"extracting"})}catch{}let i=p.join(o,a);try{g.rmSync(i,{recursive:!0,force:!0})}catch{}g.mkdirSync(i,{recursive:!0}),await new Promise((d,u)=>{let h=wt("powershell.exe",["-NoProfile","-NonInteractive","-Command",`Expand-Archive -LiteralPath "${r}" -DestinationPath "${i}" -Force`],{stdio:"ignore"});h.on("exit",m=>m===0?d():u(new Error(`Expand-Archive failed ${m}`))),h.on("error",u)});try{g.unlinkSync(r)}catch{}let f=null;try{let d=p.join(i,"mod.vdf");if(g.existsSync(d))f=et(d).id;else{let u=g.readdirSync(i,{withFileTypes:!0});for(let h of u)if(h.isDirectory()){let m=p.join(i,h.name,"mod.vdf");if(g.existsSync(m)&&(f=et(m).id,f))break}}}catch{}let s=rt(o);s[f||a]=!0,St(o,s);try{n?.sender?.send("mods:progress",{key:a,phase:"done"})}catch{}return{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}});S.handle("mods:iconDataUrl",async(n,{installDir:t,folder:a})=>{try{let e=p.join(t,"mods",a,"icon.png");return await g.promises.access(e),{ok:!0,dataUrl:`data:image/png;base64,${(await g.promises.readFile(e)).toString("base64")}`}}catch(e){return{ok:!1,error:String(e?.message||e)}}});S.handle("select-directory",async()=>{let n=await nt.showOpenDialog({properties:["openDirectory","createDirectory"]});return n.canceled||n.filePaths.length===0?null:n.filePaths[0]});S.handle("settings:get",()=>ut());S.handle("settings:set",(n,{key:t,value:a})=>tt(t,a));S.handle("download:checksums",async(n,{baseUrl:t})=>ct(t));S.handle("download:all",async(n,{baseUrl:t,checksums:a,installDir:e,includeOptional:o,concurrency:r,partConcurrency:c,channelName:i})=>{let f=(s,d)=>n.sender.send(s,d);M=st();try{await it(t,a,e,f,!!o,Number(r)||4,Number(c)||4,M);try{let s=ht("channels",{})||{};s[String(i||"default")]={installDir:e,gameVersion:a?.game_version||null,gameBaseUrl:t,lastUpdatedAt:Date.now()},tt("channels",s)}catch(s){console.error("Failed to persist channel info",s)}}finally{M=null}return!0});S.handle("default-install-dir",(n,{channelName:t})=>{let a=process.env.LOCALAPPDATA||p.join(R.getPath("home"),"AppData","Local"),e=p.join(a,"Programs","R5VLibrary");return t?p.join(e,t):e});S.handle("launcher:config",async(n,{url:t})=>(e=>new Promise((o,r)=>{O.get(e,c=>{if(c.statusCode!==200){r(new Error(`HTTP ${c.statusCode} for ${e}`)),c.resume();return}let i="";c.setEncoding("utf8"),c.on("data",f=>i+=f),c.on("end",()=>{try{o(JSON.parse(i))}catch(f){r(f)}})}).on("error",r)}))(t));S.handle("video:cache",async(n,{filename:t})=>{let e=`https://blaze.playvalkyrie.org/video_backgrounds/${t}`,o=p.join(p.resolve(R.getAppPath(),".."),"cache"),r=p.join(o,"videos"),c=p.join(r,t);await g.promises.mkdir(r,{recursive:!0});try{return await g.promises.access(c),`r5v://videos/${t}`}catch{}return await new Promise((i,f)=>{let s=g.createWriteStream(c);O.get(e,d=>{if(d.statusCode!==200){s.close(()=>{}),g.unlink(c,()=>{}),f(new Error(`HTTP ${d.statusCode} video`)),d.resume();return}d.pipe(s),s.on("finish",()=>s.close(i))}).on("error",d=>{g.unlink(c,()=>f(d))})}),`r5v://videos/${t}`});S.handle("fs:exists",async(n,{path:t})=>{try{return await g.promises.access(t),!0}catch{return!1}});S.handle("path:open",async(n,{path:t})=>{try{return await J.openPath(t),!0}catch{return!1}});S.handle("open-external",async(n,{url:t})=>{try{return await J.openExternal(t),!0}catch{return!1}});S.handle("download:cancel",async()=>{try{Z(M)}catch{}M=null;try{k?.webContents.send("progress:cancelled",{})}catch{}return!0});S.handle("select-file",async(n,{filters:t})=>{let a=await nt.showOpenDialog({properties:["openFile"],filters:Array.isArray(t)?t:void 0});return a.canceled||a.filePaths.length===0?null:a.filePaths[0]});S.handle("game:launch",async(n,{channelName:t,installDir:a,mode:e,argsString:o})=>{try{if(!a)throw new Error("Missing installDir");let r=String(e).toUpperCase()==="SERVER"?"r5apex_ds.exe":"r5apex.exe",c=p.join(a,r);await g.promises.access(c).catch(()=>{throw new Error(`Executable not found: ${c}`)});let f=(d=>!d||typeof d!="string"?[]:(d.match(/(?:[^\s\"]+|\"[^\"]*\")+/g)||[]).map(h=>h.replace(/^\"|\"$/g,"")))(o);return wt(c,f,{cwd:a,detached:!0,stdio:"ignore",env:{...process.env}}).unref(),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});S.on("window:minimize",()=>{k?.minimize()});S.on("window:maximize",()=>{k&&(k.isMaximized()?k.unmaximize():k.maximize())});S.on("window:close",()=>{k?.close()});R.on("before-quit",()=>{if(M)try{Z(M)}catch{}});
