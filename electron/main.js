var fe=(r=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(r,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):r)(function(r){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+r+'" is not supported')});import{app as st,BrowserWindow as nr,ipcMain as O}from"electron";import{BrowserWindow as we,shell as Ut}from"electron";import dt from"node:path";import{fileURLToPath as Se,pathToFileURL as pr}from"node:url";import yt from"node:fs";import me from"node:path";import{app as ye}from"electron";var Rt=ye.getPath("userData"),Tt=me.join(Rt,"settings.json");function gt(){try{let r=yt.readFileSync(Tt,"utf-8");return JSON.parse(r)}catch{return{}}}function ge(r){yt.mkdirSync(Rt,{recursive:!0}),yt.writeFileSync(Tt,JSON.stringify(r,null,2),"utf-8")}function ct(r,t=void 0){return gt()[r]??t}function G(r,t){let n=gt();n[r]=t,ge(n)}function lt(){return gt()}var ke=Se(import.meta.url),wt=dt.dirname(ke);async function St(){let r=ct("windowState",{width:1150,height:800,x:void 0,y:void 0,isMaximized:!1}),t=new we({width:r.width,height:r.height,x:r.x,y:r.y,minWidth:1150,minHeight:800,frame:!1,titleBarStyle:"hidden",webPreferences:{preload:dt.join(wt,"preload.cjs"),contextIsolation:!0,nodeIntegration:!1},show:!1,icon:dt.join(wt,"..","public","icon.png")}),n=process.env.VITE_DEV_SERVER_URL;if(n)await t.loadURL(n);else{let a=dt.join(wt,"..","dist","index.html");await t.loadFile(a)}t.webContents.setWindowOpenHandler(({url:a})=>{try{Ut.openExternal(a)}catch{}return{action:"deny"}}),t.webContents.on("will-navigate",(a,d)=>{let c=d.startsWith("file:"),f=!!process.env.VITE_DEV_SERVER_URL&&d.startsWith(String(process.env.VITE_DEV_SERVER_URL));if(!c&&!f){a.preventDefault();try{Ut.openExternal(d)}catch{}}});let e=()=>{t&&(t.isVisible()||t.show(),t.isFocused()||t.focus())};r.isMaximized&&t.maximize(),t.once("ready-to-show",e),t.webContents.once("did-finish-load",e);let o=setTimeout(e,1e3);t.on("show",()=>clearTimeout(o));function s(){if(!t)return;let a=t.getBounds(),d=t.isMaximized();G("windowState",{width:a.width,height:a.height,x:a.x,y:a.y,isMaximized:d})}return t.on("resize",s),t.on("move",s),t.on("maximize",s),t.on("unmaximize",s),(!!process.env.VITE_DEV_SERVER_URL||process.env.NODE_ENV==="development")&&t.webContents.openDevTools({mode:"detach"}),t.webContents.on("did-fail-load",(a,d,c,f)=>{console.error("Load failed",{errorCode:d,errorDesc:c,validatedURL:f});let{dialog:u}=fe("electron");u.showErrorBox("Load failed",`${c} (code ${d})
URL: ${f}`),t.show()}),t}function Nt(r,t){r.on("window:minimize",()=>{t()?.minimize()}),r.on("window:maximize",()=>{let n=t();n&&(n.isMaximized()?n.unmaximize():n.maximize())}),r.on("window:close",()=>{t()?.close()})}import{app as K}from"electron";var kt="r5v",ht=[];function Vt(r){try{return(r||[]).filter(t=>typeof t=="string"&&t.startsWith(`${kt}://`))}catch{return[]}}function xt(r,t){try{let n=new URL(r);if(n.hostname==="mod"&&n.pathname==="/install"){let e=n.searchParams.get("name")||"",o=n.searchParams.get("version")||"",s=n.searchParams.get("downloadUrl")?.split(",")||"",i=t();if(i&&i.webContents&&!i.webContents.isLoading())try{i.webContents.send("deeplink:mod-install",{url:r,name:e,version:o,downloadUrls:s})}catch{}else ht.push(r)}}catch{}}function Ft(r){for(;ht.length;){let t=ht.shift();xt(t,r)}}function zt(r){return K.requestSingleInstanceLock()?(K.on("second-instance",(n,e)=>{try{Vt(e).forEach(i=>xt(i,r));let s=r();s&&(s.isMinimized()&&s.restore(),s.focus())}catch{}}),K.on("open-url",(n,e)=>{n.preventDefault(),xt(e,r)}),!0):(K.quit(),!1)}function jt(){try{process.defaultApp&&process.platform==="win32"?K.setAsDefaultProtocolClient(kt,process.execPath,[process.argv[1]]):K.setAsDefaultProtocolClient(kt)}catch{}}function Bt(){try{Vt(process.argv).forEach(r=>ht.push(r))}catch{}}import{createRequire as xe}from"node:module";var qt=xe(import.meta.url),{autoUpdater:N}=qt("electron-updater"),Wt=qt("electron-log");function Ht(r){try{N.autoDownload=!1;try{N.logger=Wt,Wt.transports.file.level="info"}catch{}N.on("error",t=>{try{r()?.webContents.send("update:error",{message:String(t?.stack||t?.message||t)})}catch{}}),N.on("update-available",t=>{try{r()?.webContents.send("update:available",t)}catch{}}),N.on("update-not-available",t=>{try{r()?.webContents.send("update:not-available",t)}catch{}}),N.on("download-progress",t=>{try{r()?.webContents.send("update:download-progress",t)}catch{}}),N.on("update-downloaded",t=>{try{r()?.webContents.send("update:downloaded",t)}catch{}})}catch{}}function Mt(r){r.handle("update:check",async()=>{try{return{ok:!0,result:(await N.checkForUpdates())?.updateInfo||null}}catch(t){return{ok:!1,error:String(t?.message||t)}}}),r.handle("update:download",async()=>{try{return await N.downloadUpdate(),{ok:!0}}catch(t){return{ok:!1,error:String(t?.message||t)}}}),r.handle("update:quitAndInstall",async()=>{try{return setImmediate(()=>N.quitAndInstall(!1,!0)),{ok:!0}}catch(t){return{ok:!1,error:String(t?.message||t)}}})}import Ot from"node:https";import P from"node:fs";import C from"node:path";import Pe from"node:zlib";import{spawn as Ee}from"node:child_process";var Pt=new Set,ut=new Map,pt=new Map;function ve(r){try{let t=C.join(r,"mods.vdf"),n=P.readFileSync(t,"utf-8"),e={},o=/"([^"]+)"\s*"([01])"/g,s;for(;s=o.exec(n);){let i=s[1];i&&i!=="ModList"&&(e[i]=s[2]==="1")}return e}catch{return{}}}function vt(r){try{let t=C.join(r,"mods.vdf"),n=P.readFileSync(t,"utf-8"),e={},o=[],s=/"([^"]+)"\s*"([01])"/g,i;for(;i=s.exec(n);){let a=i[1];!a||a==="ModList"||(a in e||o.push(a),e[a]=i[2]==="1")}return{map:e,order:o}}catch{return{map:{},order:[]}}}function Et(r){try{let t=P.readFileSync(r,"utf-8"),n=t.match(/"id"\s*"([^"]+)"/i),e=t.match(/"name"\s*"([^"]+)"/i),o=n?n[1]:null,s=e?e[1]:null;return{id:o,name:s}}catch{return{id:null,name:null}}}function Ce(r,t){let n=['"ModList"',"{"];for(let[e,o]of Object.entries(t))n.push(`	"${e}"		"${o?"1":"0"}"`);n.push("}"),P.mkdirSync(r,{recursive:!0}),P.writeFileSync(C.join(r,"mods.vdf"),n.join(`
`),"utf-8")}function Jt(r,t,n){let e=new Set,o=['"ModList"',"{"],s=i=>{o.push(`	"${i}"		"${n[i]?"1":"0"}"`),e.add(i)};for(let i of Array.isArray(t)?t:[])Object.prototype.hasOwnProperty.call(n,i)&&!e.has(i)&&s(i);for(let i of Object.keys(n))e.has(i)||s(i);o.push("}"),P.mkdirSync(r,{recursive:!0}),P.writeFileSync(C.join(r,"mods.vdf"),o.join(`
`),"utf-8")}async function Ae(r,{installDir:t}){try{let n=C.join(t,"mods"),{map:e,order:o}=vt(n),s=[],i=P.existsSync(n)?P.readdirSync(n,{withFileTypes:!0}):[];for(let d of i){if(!d.isDirectory())continue;let c=C.join(n,d.name),f=C.join(c,"manifest.json"),u=C.join(c,"mod.vdf"),l=C.join(c,"icon.png"),y=null;try{y=JSON.parse(P.readFileSync(f,"utf-8"))}catch{}let m=Et(u),h=m.id||y?.name||d.name,w=null;try{w=`data:image/png;base64,${P.readFileSync(l).toString("base64")}`}catch{}s.push({id:h,name:y?.name||m.name||d.name,folder:d.name,version:y?.version_number||null,description:y?.description||"",enabled:h?!!e[h]:!1,hasManifest:P.existsSync(f),iconDataUrl:w})}let a=new Map(o.map((d,c)=>[d,c]));return s.sort((d,c)=>{let f=d.id!=null&&a.has(d.id)?a.get(d.id):Number.MAX_SAFE_INTEGER,u=c.id!=null&&a.has(c.id)?a.get(c.id):Number.MAX_SAFE_INTEGER;return f!==u?f-u:String(d.name||"").localeCompare(String(c.name||""))}),{ok:!0,mods:s}}catch(n){return{ok:!1,error:String(n?.message||n)}}}async function De(r,{installDir:t,name:n,enabled:e}){try{let o=C.join(t,"mods"),{map:s}=vt(o);return s[n]=!!e,Jt(o,void 0,s),{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}}async function be(r,{installDir:t,orderIds:n}){try{let e=C.join(t,"mods"),{map:o,order:s}=vt(e),i=Array.isArray(n)?n.filter(f=>typeof f=="string"&&f&&Object.prototype.hasOwnProperty.call(o,f)):[],a=new Set(i),d=s.filter(f=>Object.prototype.hasOwnProperty.call(o,f)&&!a.has(f)),c=[...i,...d];return Jt(e,c,o),{ok:!0}}catch(e){return{ok:!1,error:String(e?.message||e)}}}async function _e(r,{installDir:t,folder:n}){try{let e=C.join(t,"mods"),o=C.join(e,n);return P.rmSync(o,{recursive:!0,force:!0}),{ok:!0}}catch(e){return{ok:!1,error:String(e?.message||e)}}}async function Le(r,{query:t}){let n="https://thunderstore.io/c/r5valkyrie/api/v1/package-listing-index/",e=s=>new Promise((i,a)=>{Ot.get(s,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"*/*"}},c=>{if(c.statusCode&&c.statusCode>=300&&c.statusCode<400&&c.headers.location){c.resume();let u=c.headers.location.startsWith("http")?c.headers.location:new URL(c.headers.location,s).toString();return i(e(u))}if(c.statusCode!==200)return c.resume(),a(new Error(`HTTP ${c.statusCode}`));let f=[];c.on("data",u=>f.push(Buffer.isBuffer(u)?u:Buffer.from(u))),c.on("end",()=>i(Buffer.concat(f)))}).on("error",a)}),o=s=>{try{return Pe.gunzipSync(s)}catch{return s}};try{let s=await e(n),i=JSON.parse(o(s).toString("utf8")),a=Array.isArray(i)?i:[],d=6,c=[],f=0;await Promise.all(Array.from({length:d}).map(async()=>{for(;f<a.length;){let l=f++,y=a[l];try{let m=await e(y),h=o(m).toString("utf8"),w=JSON.parse(h);Array.isArray(w)&&c.push(...w)}catch{}}}));let u=c;if(t&&String(t).trim()){let l=String(t).toLowerCase();u=u.filter(y=>String(y?.name||"").toLowerCase().includes(l)||String(y?.full_name||"").toLowerCase().includes(l))}return{ok:!0,mods:u}}catch(s){try{let a=await e("https://thunderstore.io/c/r5valkyrie/api/v1/package/"),d=JSON.parse(a.toString("utf8")),c=Array.isArray(d)?d:[];if(t&&String(t).trim()){let f=String(t).toLowerCase();c=c.filter(u=>String(u?.name||"").toLowerCase().includes(f)||String(u?.full_name||"").toLowerCase().includes(f))}return{ok:!0,mods:c}}catch(i){return{ok:!1,error:String(i?.message||s?.message||i||s)}}}}async function $e(r,{installDir:t,name:n,downloadUrl:e}){if(!e.startsWith("https://thunderstore.io"))return{ok:!1,error:"Download URL does not point to Thunderstore"};try{let o=String(n||"").trim();if(!o)return{ok:!1,error:"Invalid mod name"};if(Pt.has(o))return{ok:!0};Pt.add(o);let s=C.join(t,"mods");P.mkdirSync(s,{recursive:!0});let i=C.join(s,`.__mod_${Date.now()}.zip`),a=(u,l=0)=>new Promise((y,m)=>{if(l>5)return m(new Error("Too many redirects"));let h=P.createWriteStream(i);Ot.get(u,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"application/octet-stream,*/*;q=0.8",Referer:"https://thunderstore.io/",Connection:"keep-alive"}},g=>{if(g.statusCode&&g.statusCode>=300&&g.statusCode<400&&g.headers.location){g.resume(),h.close(()=>{});try{P.unlinkSync(i)}catch{}let A=g.headers.location.startsWith("http")?g.headers.location:new URL(g.headers.location,u).toString();return y(a(A,l+1))}if(g.statusCode!==200){h.close(()=>{});try{P.unlinkSync(i)}catch{}return g.resume(),m(new Error(`HTTP ${g.statusCode}`))}let S=Number(g.headers["content-length"]||0),p=0,x=Date.now(),E=A=>{try{r?.sender?.send("mods:progress",{key:n,phase:A,received:p,total:S})}catch{}};g.on("data",A=>{p+=Buffer.isBuffer(A)?A.length:Buffer.byteLength(String(A));let R=Date.now();R-x>150&&(x=R,E("downloading"))}),g.pipe(h),h.on("finish",()=>{E("downloading"),h.close(y)})}).on("error",g=>{try{P.unlinkSync(i)}catch{}m(g)})});await a(e);try{r?.sender?.send("mods:progress",{key:n,phase:"extracting"})}catch{}let d=C.join(s,n);try{P.rmSync(d,{recursive:!0,force:!0})}catch{}P.mkdirSync(d,{recursive:!0}),await new Promise((u,l)=>{let y=Ee("powershell.exe",["-NoProfile","-NonInteractive","-Command",`Expand-Archive -LiteralPath "${i}" -DestinationPath "${d}" -Force`],{stdio:"ignore"});y.on("exit",m=>m===0?u():l(new Error(`Expand-Archive failed ${m}`))),y.on("error",l)});try{P.unlinkSync(i)}catch{}let c=null;try{let u=C.join(d,"mod.vdf");if(P.existsSync(u))c=Et(u).id;else{let l=P.readdirSync(d,{withFileTypes:!0});for(let y of l)if(y.isDirectory()){let m=C.join(d,y.name,"mod.vdf");if(P.existsSync(m)&&(c=Et(m).id,c))break}}}catch{}let f=ve(s);f[c||n]=!0,Ce(s,f);try{r?.sender?.send("mods:progress",{key:n,phase:"done"})}catch{}return{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}finally{try{Pt.delete(String(n||""))}catch{}}}async function Ie(r,{installDir:t},n){try{let e=C.join(t,"mods");if(!P.existsSync(e))return{ok:!0};let o=e;if(ut.has(o))return{ok:!0};let s=P.watch(e,{persistent:!0},(i,a)=>{let d=o;clearTimeout(pt.get(d));let c=setTimeout(()=>{try{n()?.webContents?.send("mods:changed",{installDir:t})}catch{}},300);pt.set(d,c)});return ut.set(o,s),{ok:!0}}catch(e){return{ok:!1,error:String(e?.message||e)}}}async function Re(r,{installDir:t}){try{let e=C.join(t,"mods"),o=ut.get(e);if(o){try{o.close()}catch{}ut.delete(e)}let s=pt.get(e);return s&&(clearTimeout(s),pt.delete(e)),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}}async function Te(r,{installDir:t,folder:n}){try{let e=C.join(t,"mods",n,"icon.png");return await P.promises.access(e),{ok:!0,dataUrl:`data:image/png;base64,${(await P.promises.readFile(e)).toString("base64")}`}}catch(e){return{ok:!1,error:String(e?.message||e)}}}function Gt(r,t){r.handle("mods:listInstalled",Ae),r.handle("mods:setEnabled",De),r.handle("mods:reorder",be),r.handle("mods:uninstall",_e),r.handle("mods:fetchAll",Le),r.handle("mods:install",$e),r.handle("mods:watch",(n,e)=>Ie(n,e,t)),r.handle("mods:unwatch",Re),r.handle("mods:iconDataUrl",Te)}import qe from"node:path";import He from"node:fs";import k from"node:fs";import v from"node:path";import Ue from"node:crypto";import{pipeline as Ne}from"node:stream";import{promisify as Ve}from"node:util";import At from"node:https";var Fe=Ve(Ne);function Ct(r){return String(r||"").replace(/\\/g,"/").replace(/^\/+/,"")}function Kt(r){return String(r||"").replace(/\\/g,"/").toLowerCase()}var rt=new Map,Xt=new At.Agent({keepAlive:!0,maxSockets:64,maxFreeSockets:32,keepAliveMsecs:6e4,scheduling:"fifo"});function X(r){return new Promise((t,n)=>{let e=Ue.createHash("sha256"),o=k.createReadStream(r);o.on("error",n),o.on("end",()=>t(e.digest("hex"))),o.on("data",s=>e.update(s))})}function Qt(r){k.mkdirSync(r,{recursive:!0})}function ze(r){return new Promise((t,n)=>{let e=At.get(r,{agent:Xt},o=>{if(o.statusCode!==200){n(new Error(`HTTP ${o.statusCode} for ${r}`)),o.resume();return}let s="";o.setEncoding("utf8"),o.on("data",i=>s+=i),o.on("end",()=>{try{t(JSON.parse(s))}catch(i){n(i)}})});e.on("error",n),e.setTimeout(3e4,()=>{e.destroy(),n(new Error("JSON fetch timeout"))})})}function B(r){return new Promise(t=>setTimeout(t,r))}function Yt(){return{cancelled:!1,requests:new Set}}function Dt(r){if(r){r.cancelled=!0;for(let t of r.requests)try{t.destroy(new Error("cancelled"))}catch{}r.requests.clear()}}var je=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE","ENOTFOUND","ECONNREFUSED","EHOSTDOWN","ENETDOWN"]);async function Q(r,t,n,e=1,o,s=0,i=0){return new Promise((a,d)=>{Qt(v.dirname(t));let c=k.createWriteStream(t,{flags:s>0?"a":"w"});if(o?.cancelled)return c.close(()=>{}),d(new Error("cancelled"));let f={agent:Xt};s>0&&(f.headers={Range:`bytes=${s}-`});let u=At.get(r,f,l=>{if(l.statusCode!==200&&!(s>0&&l.statusCode===206)){if(c.close(()=>{}),s>0&&l.statusCode===200){try{k.unlinkSync(t)}catch{}let p=Math.min(2e3*e,1e4);l.resume();try{u.destroy(new Error("restart:range-ignored"))}catch{}return B(p).then(()=>a(Q(r,t,n,e+1,o,0,i)))}if(k.unlink(t,()=>{}),l.statusCode&&[429,500,502,503,504].includes(l.statusCode)&&e<5){let p=Math.min(2e3*e,1e4);return l.resume(),B(p).then(()=>a(Q(r,t,n,e+1,o,s,i)))}d(new Error(`HTTP ${l.statusCode} for ${r}`)),l.resume();return}let y=Number(l.headers["content-length"]||0),m=i>0?i:s>0?s+y:y,h=0,w=Date.now(),g=e<=2?3e4:45e3,S=setInterval(()=>{if(!o?.cancelled&&Date.now()-w>g)try{let p=new Error("stalled");p.code="ETIMEDOUT",u.destroy(p)}catch{}},1e4);l.on("data",p=>{h+=p.length,w=Date.now(),n&&n(Math.min(s+h,m||s+h),m||0)}),l.on("aborted",async()=>{let p=new Promise(x=>c.close(()=>x()));try{clearInterval(S)}catch{}try{await p}catch{}if(e<5){let x=Math.min(2e3*e,1e4);return B(x).then(()=>a(Q(r,t,n,e+1,o,s+h,i)))}d(new Error("response aborted"))}),Fe(l,c).then(()=>{try{clearInterval(S)}catch{}a()}).catch(p=>{try{clearInterval(S)}catch{}d(p)})});if(o?.requests.add(u),u.on("socket",l=>{try{l.setKeepAlive(!0,6e4),l.setNoDelay(!0),l.setRecvBufferSize&&l.setRecvBufferSize(64*1024),l.setSendBufferSize&&l.setSendBufferSize(64*1024)}catch{}}),u.on("close",()=>o?.requests.delete(u)),u.setTimeout(9e4,()=>{try{let l=new Error("Request timeout");l.code="ETIMEDOUT",u.destroy(l)}catch{}}),o?.cancelled)try{u.destroy(new Error("cancelled"))}catch{}u.on("error",async l=>{let y=l?.code,m=e<8&&y&&je.has(String(y)),h=new Promise(w=>{try{c.close(()=>w())}catch{w()}});try{await h}catch{}if(m){let w=Math.min(1e3*Math.pow(1.5,e),15e3),g=Math.random()*1e3,S=w+g,p=s;try{p=k.statSync(t).size}catch{}return B(S).then(()=>a(Q(r,t,n,e+1,o,p,i)))}d(l)})})}async function Be(r,t,n){try{let e=k.statSync(r);return n&&Number(n)>0&&e.size!==Number(n)?!1:(await X(r)).toLowerCase()===String(t).toLowerCase()}catch{return!1}}async function Zt(r){let t=`${r.replace(/\/$/,"")}/checksums.json`;return ze(t)}async function We(r,t,n,e,o=4,s){let i=Ct(t.path).split("/").join(v.sep),a=v.join(n,i);if(Qt(v.dirname(a)),await Be(a,t.checksum,t.size))return e("progress:skip",{path:t.path}),{downloadComplete:!0,verificationComplete:!0,targetPath:a};if(s?.cancelled)throw new Error("cancelled");if(Array.isArray(t.parts)&&t.parts.length>0){let c=t.parts.length,f=new Array(c),u=0,l=new Set;async function y(){for(;;){let h=u++;if(h>=c)return;if(l.has(h))continue;l.add(h);let w=t.parts[h],g=Ct(w.path),S=`${r.replace(/\/$/,"")}/${g}`,p=`${a}.part${h}`;try{if(k.existsSync(p))if((await X(p)).toLowerCase()===String(w.checksum).toLowerCase()){e("progress:part",{path:t.path,part:h,totalParts:c,received:Number(w.size||0),total:Number(w.size||0)}),f[h]=p;continue}else try{k.unlinkSync(p)}catch{}}catch{}let x=0;for(;;){if(s?.cancelled)throw new Error("cancelled");x+=1;let E=0,A=0;try{let V=0;try{V=k.statSync(p).size}catch{}let T=Number(w.size||0);if(T>0&&V>T)try{k.unlinkSync(p),V=0}catch{}await Q(S,p,(b,W)=>{let q=Math.max(0,b-A);A=b;try{q>0&&e("progress:bytes",{delta:q})}catch{}E+=q;let J=T||W||0;e("progress:part",{path:t.path,part:h,totalParts:c,received:Math.min(b,J||b),total:J})},1,s,V,T)}catch{try{k.unlinkSync(p)}catch{}try{E>0&&e("progress:bytes",{delta:-E})}catch{}try{e("progress:part:reset",{path:t.path,part:h,totalParts:c})}catch{}let T=Math.min(2e3*x,1e4);await B(T);continue}if((await X(p)).toLowerCase()===String(w.checksum).toLowerCase())break;try{k.unlinkSync(p)}catch{}try{E>0&&e("progress:bytes",{delta:-E})}catch{}try{e("progress:part:reset",{path:t.path,part:h,totalParts:c})}catch{}let _=Math.min(2e3*x,1e4);await B(_)}f[h]=p}}let m=Array.from({length:Math.max(1,o)},()=>y());return await Promise.all(m),{downloadComplete:!0,verificationComplete:!1,targetPath:a,mergeAndVerifyAsync:async()=>{e("progress:merge:start",{path:t.path,parts:f.length});let h=k.createWriteStream(a);for(let g=0;g<f.length;g++){let S=f[g];e("progress:merge:part",{path:t.path,part:g,totalParts:f.length}),await new Promise((p,x)=>{let E=k.createReadStream(S);E.on("error",x),h.on("error",x),E.on("end",()=>{try{k.unlinkSync(S)}catch{}p()}),E.pipe(h,{end:!1})})}await new Promise((g,S)=>{h.on("error",S),h.on("finish",g),h.end()});try{e("progress:merge:done",{path:t.path})}catch{}if(e("progress:verify",{path:t.path}),(await X(a)).toLowerCase()!==String(t.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${t.path}`);try{let g=k.readdirSync(v.dirname(a)),S=v.basename(a);g.forEach(p=>{if(p.startsWith(S+".part"))try{k.unlinkSync(v.join(v.dirname(a),p))}catch{}})}catch{}return{verificationComplete:!0,targetPath:a,filePath:t.path}}}}else{let c=Ct(t.path),f=`${r.replace(/\/$/,"")}/${c}`,u=0;for(;;){u+=1;let l=0,y=0,m=`${a}.download`,h=0;try{h=k.statSync(m).size}catch{}let w=Number(t.size||0);if(w>0&&h>w)try{k.unlinkSync(m),h=0}catch{}if(await Q(f,m,(S,p)=>{let x=Math.max(0,S-y);y=S;try{x>0&&e("progress:bytes",{delta:x})}catch{}l+=x;let E=w||p||0;e("progress:file",{path:t.path,received:Math.min(S,E||S),total:E})},1,s,h,w),(await X(m)).toLowerCase()===String(t.checksum).toLowerCase())break;try{k.unlinkSync(m)}catch{}try{l>0&&e("progress:bytes",{delta:-l})}catch{}if(u>=2)throw new Error(`Checksum mismatch for ${t.path}`)}try{k.unlinkSync(a)}catch{}k.renameSync(`${a}.download`,a)}if(e("progress:verify",{path:t.path}),(await X(a)).toLowerCase()!==String(t.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${t.path}`);return{downloadComplete:!0,verificationComplete:!0,targetPath:a}}async function te(r,t,n,e,o=!1,s=4,i=4,a,d){let c=new Set,f=[];for(let S of t.files||[]){if(!(o||!S.optional))continue;let p=Kt(S.path);p&&(c.has(p)||(c.add(p),f.push(S)))}let u=f.filter(S=>!(Array.isArray(S.parts)&&S.parts.length>0)),l=f.filter(S=>Array.isArray(S.parts)&&S.parts.length>0),y=u.concat(l),m=y.length,h=0,w=y.reduce((S,p)=>{let x=Number(p.size||0);return x>0?S+x:Array.isArray(p.parts)&&p.parts.length?S+p.parts.reduce((E,A)=>E+Number(A.size||0),0):S},0);try{e("progress:bytes:total",{totalBytes:w})}catch{}async function g(S,p,x,E=!1){let A=0,R=[];async function _(){for(;;){for(;d&&d();)if(await B(100),a?.cancelled)return;let T=A++;if(T>=S.length)return;let b=S[T],W=p+T,q=Kt(b.path),J=async()=>We(r,b,n,e,i,a),_t=!1,at=rt.get(q);at?_t=!0:(e("progress:start",{index:W,total:m,path:b.path,completed:h}),at=(async()=>{try{let j=await J();if(E&&j?.mergeAndVerifyAsync){let $t=j.mergeAndVerifyAsync().then(L=>(L?.filePath&&(h+=1,e("progress:done",{index:W,total:m,path:L.filePath,completed:h})),L)).catch(L=>{if(String(L?.message||L||"error").includes("cancelled"))throw L;try{let U=v.join(n,b.path.replace(/\\/g,v.sep));try{k.unlinkSync(U)}catch{}try{let $=k.readdirSync(v.dirname(U)),F=v.basename(U);$.forEach(it=>{if(it.startsWith(F+".part"))try{k.unlinkSync(v.join(v.dirname(U),it))}catch{}})}catch{}return J().then($=>$.mergeAndVerifyAsync?$.mergeAndVerifyAsync().then(F=>(F?.filePath&&(h+=1,e("progress:done",{index:W,total:m,path:F.filePath,completed:h})),F)):$)}catch(U){try{e("progress:error",{path:b.path,message:String(U?.message||U)})}catch{}throw U}});return R.push($t),{...j,skipProgressDone:!0}}return j}catch(j){if(String(j?.message||j||"error").includes("cancelled"))throw j;try{let L=v.join(n,b.path.replace(/\\/g,v.sep));try{k.unlinkSync(L)}catch{}let et=await J();if(E&&et?.mergeAndVerifyAsync){let U=et.mergeAndVerifyAsync().then($=>($?.filePath&&(h+=1,e("progress:done",{index:W,total:m,path:$.filePath,completed:h})),$)).catch($=>{try{let F=v.join(n,b.path.replace(/\\/g,v.sep)),it=k.readdirSync(v.dirname(F)),pe=v.basename(F);it.forEach(It=>{if(It.startsWith(pe+".part"))try{k.unlinkSync(v.join(v.dirname(F),It))}catch{}})}catch{}try{e("progress:error",{path:b.path,message:String($?.message||$)})}catch{}throw $});return R.push(U),{...et,skipProgressDone:!0}}return et}catch(L){try{e("progress:error",{path:b.path,message:String(L?.message||L)})}catch{}throw L}}})(),rt.set(q,at));let Lt;try{Lt=await at}finally{_t||rt.delete(q)}Lt?.skipProgressDone||(h+=1,e("progress:done",{index:W,total:m,path:b.path,completed:h})),await B(10)}}let V=Array.from({length:Math.max(1,x)},()=>_());await Promise.all(V),R.length>0&&await Promise.all(R)}if(await g(u,0,Math.max(1,s)),rt.size>0)try{await Promise.all([...rt.values()])}catch{}await g(l,u.length,1,!0)}var H=null,nt=!1;function ee(r,t){r.handle("download:checksums",async(n,{baseUrl:e})=>Zt(e)),r.handle("download:all",async(n,{baseUrl:e,checksums:o,installDir:s,includeOptional:i,concurrency:a,partConcurrency:d,channelName:c,mode:f})=>{let u=(l,y)=>n.sender.send(l,y);try{if(!(String(f||"install").toLowerCase()==="install")){let y=qe.join(s,"mods","mods.vdf");if(He.existsSync(y)){let h=(Array.isArray(o?.files)?o.files:[]).filter(w=>{try{return String(w?.path||w?.name||"").replace(/\\/g,"/").toLowerCase()!=="mods/mods.vdf"}catch{return!0}});o={...o||{},files:h}}}}catch{}H=Yt(),nt=!1;try{await te(e,o,s,u,!!i,Number(a)||4,Number(d)||4,H,()=>nt);try{let l=ct("channels",{})||{};l[String(c||"default")]={installDir:s,gameVersion:o?.game_version||null,gameBaseUrl:e,lastUpdatedAt:Date.now()},G("channels",l)}catch(l){console.error("Failed to persist channel info",l)}}finally{H=null}return!0}),r.handle("download:pause",async()=>{nt=!0;try{t()?.webContents.send("progress:paused",{})}catch{}return!0}),r.handle("download:resume",async()=>{nt=!1;try{t()?.webContents.send("progress:resumed",{})}catch{}return!0}),r.handle("download:cancel",async()=>{try{Dt(H)}catch{}H=null,nt=!1;try{t()?.webContents.send("progress:cancelled",{})}catch{}return!0})}function re(){if(H)try{Dt(H)}catch{}}import Y from"node:path";import ot from"node:fs";import{spawn as ne}from"node:child_process";import{app as oe}from"electron";function Me(r){return!r||typeof r!="string"?[]:(r.match(/(?:[^\s\"]+|\"[^\"]*\")+/g)||[]).map(n=>n.replace(/^\"|\"$/g,""))}async function Oe(r,{channelName:t,installDir:n,mode:e,argsString:o,winePrefix:s}){try{if(!n)throw new Error("Missing installDir");let i=String(e).toUpperCase()==="SERVER"?"r5apex_ds.exe":"r5apex.exe",a=Y.join(n,i);await ot.promises.access(a).catch(()=>{throw new Error(`Executable not found: ${a}`)});let d=Me(o),c;if(process.platform==="win32")c=ne(a,d,{cwd:n,detached:!0,stdio:"ignore",env:{...process.env}});else if(process.platform==="linux"){let f=s||Y.join(oe.getPath("home"),"Games","R5VLibrary","wineprefix");d.unshift(a);let u=Y.join(oe.getPath("home"),".local","share","Steam"),l=Y.join(f,"drive_c","Program Files (x86)","Steam");ot.mkdirSync(l,{recursive:!0}),["GameOverlayRenderer64.dll","steamclient64.dll","steamclient.dll"].forEach(m=>{let h=Y.join(u,m),w=Y.join(l,m);if(!ot.existsSync(h))throw new Error(`Steam is not installed correctly!
Source file not found: ${h}`);ot.existsSync(w)?console.log(`Skipped (exists): ${m}`):(ot.copyFileSync(h,w),console.log(`Copied: ${m}`))}),c=ne("umu-run",d,{cwd:n,detached:!0,stdio:"ignore",env:{...process.env,WINEPREFIX:f}})}return c.unref(),{ok:!0}}catch(i){return{ok:!1,error:String(i?.message||i)}}}function se(r){r.handle("game:launch",Oe)}import ft from"node:path";import M from"node:fs";import Je from"node:os";import{spawn as ae}from"node:child_process";async function Ge(r,{selectedChannel:t}){let n=[],e=lt().channels[t].installDir;try{if(!e)return{ok:!1,error:"No folder path provided"};let o=ft.resolve(e).replace(/\//g,"\\");if(!o||o.length<3)return{ok:!1,error:`Invalid path format: ${e}`};let s=o.length>=3&&o[1]===":"?o.slice(3):o;if(/[<>:"|?*]/.test(s))return{ok:!1,error:`Path contains invalid characters: ${o}`};let d=Je.userInfo().username,c=ft.join(process.resourcesPath,"elevate.exe"),f=M.existsSync(c);try{M.mkdirSync(o,{recursive:!0})}catch{}let u=[{exe:"icacls",args:[o,"/grant",`${d}:F`,"/t","/q"],desc:`Grant permissions to current user (${d})`},{exe:"icacls",args:[o,"/grant","Everyone:F","/t","/q"],desc:"Grant Everyone full permissions"},{exe:"icacls",args:[o,"/grant","Users:F","/t","/q"],desc:"Grant Users full permissions"}];for(let l=0;l<u.length;l++){let{exe:y,args:m,desc:h}=u[l];try{let w=await new Promise((g,S)=>{let p,x,E;f?(x=[c,["-wait",y,...m]],E={stdio:["ignore","pipe","pipe"],windowsHide:!0}):(x=[y,m],E={stdio:["ignore","pipe","pipe"],windowsHide:!0});try{p=ae(x[0],x[1],E)}catch(_){console.error("[Permission Fix] Spawn failed:",_),S(_);return}let A="",R="";p.stdout&&p.stdout.on("data",_=>{A+=_.toString()}),p.stderr&&p.stderr.on("data",_=>{R+=_.toString()}),p.on("exit",(_,V)=>{g({code:_,stdout:A,stderr:R,signal:V})}),p.on("error",_=>{S(_)}),setTimeout(()=>{try{p.kill()}catch{}S(new Error("Command timeout"))},3e4)});if(w.code!==0){let g=w.stderr||w.stdout||"Unknown error";if(!(g.includes("duplicate")||g.includes("already")||w.code===1332)){let p=`${h} failed (code ${w.code}): ${g}`;n.push(p)}}}catch(w){let g=`${h} error: ${w.message}`;n.push(g)}}try{let l=ft.join(o,"test_write.tmp");M.writeFileSync(l,"test"),M.unlinkSync(l)}catch(l){let y=`Write test failed: ${l.message}`;n.push(y);try{if(M.mkdirSync(o,{recursive:!0}),(await new Promise(h=>{let w=ae("cmd",["/c",`icacls "${o}" /grant "%USERNAME%":F /q`],{stdio:"ignore",windowsHide:!0});w.on("exit",g=>h({code:g})),w.on("error",()=>h({code:1})),setTimeout(()=>{try{w.kill()}catch{}h({code:1})},5e3)})).code===0){let h=ft.join(o,"test_write2.tmp");return M.writeFileSync(h,"test"),M.unlinkSync(h),{ok:!0,warnings:n}}}catch{}return{ok:!1,error:y,details:n}}return n.length>0?{ok:!0,warnings:n}:{ok:!0}}catch(o){let s=`Unexpected error: ${o?.message||o}`;return n.push(s),{ok:!1,error:s,details:n}}}function ie(r){r.handle("fix-folder-permissions",Ge)}import{protocol as ce,app as Ke}from"electron";import z from"node:path";import Xe from"node:fs";import{fileURLToPath as Qe}from"node:url";var Ye=Qe(import.meta.url),Ze=z.dirname(Ye);function le(){let r=z.resolve(Ke.getAppPath(),".."),t=z.join(r,"cache");ce.registerFileProtocol("r5v",(n,e)=>{try{let o=new URL(n.url),s=decodeURIComponent(o.pathname).replace(/^\//,""),i=z.normalize(z.join(t,s));e({path:i})}catch{e({error:-6})}})}function de(){let r=z.join(Ze,"..","..","dist");ce.interceptFileProtocol("file",(t,n)=>{try{let e=new URL(t.url),o=decodeURIComponent(e.pathname),s=o.replace(/\\/g,"/"),i=s.indexOf("/_astro/");if(i!==-1){let a=s.substring(i+8),d=z.join(r,"_astro",a);return n({path:d})}if(s.endsWith("/favicon.svg")||/\/favicon\.svg$/i.test(s)){let a=z.join(r,"favicon.svg");return n({path:a})}if(s.startsWith("/")){let a=s.replace(/^\/+/,""),d=z.join(r,a);try{return Xe.accessSync(d),n({path:d})}catch{}}return n({path:o})}catch{return n({error:-6})}})}import{app as Z,dialog as he}from"electron";import D from"node:path";import I from"node:fs";import bt from"node:https";import{fileURLToPath as tr}from"node:url";var er=tr(import.meta.url),rr=D.dirname(er);function ue(r){r.handle("app:getVersion",async()=>{try{return Z.getVersion()}catch{return"0.0.0"}}),r.handle("app:getBaseDir",async()=>{try{return D.resolve(Z.getAppPath(),"..")}catch{return""}}),r.handle("app:getLauncherInstallRoot",async()=>{try{let t=process.env.LOCALAPPDATA||D.join(Z.getPath("home"),"AppData","Local");return D.join(t,"Programs","r5vlauncher")}catch{return""}}),r.handle("settings:get",()=>lt()),r.handle("settings:set",(t,{key:n,value:e})=>G(n,e)),r.handle("select-directory",async()=>{let t=await he.showOpenDialog({properties:["openDirectory","createDirectory"]});return t.canceled||t.filePaths.length===0?null:t.filePaths[0]}),r.handle("select-file",async(t,{filters:n})=>{let e=await he.showOpenDialog({properties:["openFile"],filters:Array.isArray(n)?n:void 0});return e.canceled||e.filePaths.length===0?null:e.filePaths[0]}),r.handle("default-install-dir",(t,{channelName:n})=>{let e="";if(process.platform==="win32"){let o=process.env.LOCALAPPDATA||D.join(Z.getPath("home"),"AppData","Local");e=D.join(o,"Programs","R5VLibrary")}else if(process.platform==="linux"){let o=D.join(Z.getPath("home"),"Games");e=D.join(o,"R5VLibrary")}return n?D.join(e,n):e}),r.handle("launcher:config",async(t,{url:n})=>(o=>new Promise((s,i)=>{bt.get(o,a=>{if(a.statusCode!==200){i(new Error(`HTTP ${a.statusCode} for ${o}`)),a.resume();return}let d="";a.setEncoding("utf8"),a.on("data",c=>d+=c),a.on("end",()=>{try{s(JSON.parse(d))}catch(c){i(c)}})}).on("error",i)}))(n)),r.handle("eula:get",async()=>{let t="https://playvalkyrie.org/api/eula",n=e=>new Promise((o,s)=>{bt.get(e,i=>{if(i.statusCode!==200){s(new Error(`HTTP ${i.statusCode}`)),i.resume();return}let a=[];i.on("data",d=>a.push(Buffer.isBuffer(d)?d:Buffer.from(d))),i.on("end",()=>{try{let d=Buffer.concat(a).toString("utf8");o(JSON.parse(d))}catch(d){s(d)}})}).on("error",s)});try{return{ok:!0,json:await n(t)}}catch(e){return{ok:!1,error:String(e?.message||e)}}}),r.handle("video:cache",async(t,{filename:n})=>{try{let o=`https://blaze.playvalkyrie.org/video_backgrounds/${n}`,s=D.join(D.resolve(Z.getAppPath(),".."),"cache"),i=D.join(s,"videos"),a=D.join(i,n),d=D.join(rr,"..","..","dist"),c=D.join(d,n);await I.promises.mkdir(i,{recursive:!0});try{if((await I.promises.stat(a)).size>0){try{await I.promises.access(c)}catch{await I.promises.copyFile(a,c)}return`./${n}`}else await I.promises.unlink(a)}catch{}return await new Promise((f,u)=>{let l=I.createWriteStream(a),y=bt.get(o,m=>{if(m.statusCode!==200){l.close(()=>{}),I.unlink(a,()=>{}),u(new Error(`HTTP ${m.statusCode} for video ${n}`)),m.resume();return}m.pipe(l),l.on("finish",()=>l.close(f)),l.on("error",h=>{I.unlink(a,()=>u(h))})});y.on("error",m=>{l.close(()=>{}),I.unlink(a,()=>{}),u(m)}),y.setTimeout(3e4,()=>{y.destroy(),l.close(()=>{}),I.unlink(a,()=>{}),u(new Error(`Video download timeout for ${n}`))})}),await I.promises.copyFile(a,c),`./${n}`}catch(e){throw console.error(`Video cache error for ${n}:`,e),e}}),r.handle("fs:is-installed-in-dir",async(t,{path:n})=>{let e=!1,o=!1;try{await I.promises.access(D.join(n,"r5apex.exe")),e=!0}catch{}try{await I.promises.access(D.join(n,"r5apex_ds.exe")),o=!0}catch{}return e||o})}var mt;function tt(){return mt}var or=zt(tt);or||process.exit(0);st.on("window-all-closed",()=>{process.platform!=="darwin"&&st.quit()});st.whenReady().then(async()=>{jt(),le(),de(),mt=await St(),Ht(tt),Bt();try{mt?.webContents?.once("did-finish-load",()=>Ft(tt))}catch{}st.on("activate",()=>{nr.getAllWindows().length===0&&St().then(r=>{mt=r})})});Mt(O);ue(O);Gt(O,tt);ee(O,tt);se(O);ie(O);Nt(O,tt);st.on("before-quit",()=>{re()});
