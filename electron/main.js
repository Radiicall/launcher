import{app as k,BrowserWindow as ct,ipcMain as w,dialog as G,protocol as at,shell as H}from"electron";import{createRequire as vt}from"node:module";import m from"node:path";import{fileURLToPath as Ct,pathToFileURL as qt}from"node:url";import lt from"node:https";import L from"node:fs";import{spawn as xt}from"node:child_process";import g from"node:fs";import U from"node:path";import ht from"node:crypto";import{pipeline as dt}from"node:stream";import{promisify as pt}from"node:util";import O from"node:https";var ut=pt(dt);function V(n){return new Promise((t,a)=>{let e=ht.createHash("sha256"),s=g.createReadStream(n);s.on("error",a),s.on("end",()=>t(e.digest("hex"))),s.on("data",r=>e.update(r))})}function Q(n){g.mkdirSync(n,{recursive:!0})}function ft(n){return new Promise((t,a)=>{O.get(n,e=>{if(e.statusCode!==200){a(new Error(`HTTP ${e.statusCode} for ${n}`)),e.resume();return}let s="";e.setEncoding("utf8"),e.on("data",r=>s+=r),e.on("end",()=>{try{t(JSON.parse(s))}catch(r){a(r)}})}).on("error",a)})}function N(n){return new Promise(t=>setTimeout(t,n))}function X(){return{cancelled:!1,requests:new Set}}function W(n){if(n){n.cancelled=!0;for(let t of n.requests)try{t.destroy(new Error("cancelled"))}catch{}n.requests.clear()}}var yt=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE"]);async function I(n,t,a,e=1,s,r=0,o=0){return new Promise((u,d)=>{Q(U.dirname(t));let c=g.createWriteStream(t,{flags:r>0?"a":"w"});if(s?.cancelled)return c.close(()=>{}),d(new Error("cancelled"));let f={};r>0&&(f.headers={Range:`bytes=${r}-`});let S=O.get(n,f,p=>{if(p.statusCode!==200&&!(r>0&&p.statusCode===206)){if(c.close(()=>{}),r>0&&p.statusCode===200){try{g.unlinkSync(t)}catch{}let i=Math.min(2e3*e,1e4);return p.resume(),N(i).then(()=>u(I(n,t,a,e+1,s,0,o)))}if(g.unlink(t,()=>{}),p.statusCode&&[429,500,502,503,504].includes(p.statusCode)&&e<5){let i=Math.min(2e3*e,1e4);return p.resume(),N(i).then(()=>u(I(n,t,a,e+1,s,r,o)))}d(new Error(`HTTP ${p.statusCode} for ${n}`)),p.resume();return}let v=Number(p.headers["content-length"]||0),C=o>0?o:r>0?r+v:v,l=0,h=Date.now(),E=setInterval(()=>{if(!s?.cancelled&&Date.now()-h>15e3)try{let i=new Error("stalled");i.code="ETIMEDOUT",S.destroy(i)}catch{}},5e3);p.on("data",i=>{l+=i.length,h=Date.now(),a&&a(Math.min(r+l,C||r+l),C||0)}),p.on("aborted",()=>{c.close(()=>{});try{clearInterval(E)}catch{}if(e<5){let i=Math.min(2e3*e,1e4);return N(i).then(()=>u(I(n,t,a,e+1,s,r+l,o)))}d(new Error("response aborted"))}),ut(p,c).then(()=>{try{clearInterval(E)}catch{}u()}).catch(i=>{try{clearInterval(E)}catch{}d(i)})});if(s?.requests.add(S),S.on("close",()=>s?.requests.delete(S)),S.setTimeout(45e3,()=>{try{let p=new Error("Request timeout");p.code="ETIMEDOUT",S.destroy(p)}catch{}}),s?.cancelled)try{S.destroy(new Error("cancelled"))}catch{}S.on("error",p=>{let v=p?.code,C=e<5&&v&&yt.has(String(v));try{c.close(()=>{})}catch{}if(C){let l=Math.min(2e3*e,1e4),h=r;try{h=g.statSync(t).size}catch{}return N(l).then(()=>u(I(n,t,a,e+1,s,h,o)))}d(p)})})}async function wt(n,t,a){try{let e=g.statSync(n);return a&&Number(a)>0&&e.size!==Number(a)?!1:(await V(n)).toLowerCase()===String(t).toLowerCase()}catch{return!1}}async function Z(n){let t=`${n.replace(/\/$/,"")}/checksums.json`;return ft(t)}async function gt(n,t,a,e,s=4,r){let o=U.join(a,t.path.replace(/\\/g,U.sep));if(Q(U.dirname(o)),await wt(o,t.checksum,t.size)){e("progress:skip",{path:t.path});return}if(r?.cancelled)throw new Error("cancelled");if(Array.isArray(t.parts)&&t.parts.length>0){let d=t.parts.length,c=new Array(d),f=0,S=new Set;async function p(){for(;;){let l=f++;if(l>=d)return;if(S.has(l))continue;S.add(l);let h=t.parts[l],E=`${n.replace(/\/$/,"")}/${h.path.replace(/\\/g,"/")}`,i=`${o}.part${l}`;try{if(g.existsSync(i))if((await V(i)).toLowerCase()===String(h.checksum).toLowerCase()){e("progress:part",{path:t.path,part:l,totalParts:d,received:Number(h.size||0),total:Number(h.size||0)}),c[l]=i;continue}else try{g.unlinkSync(i)}catch{}}catch{}let x=0;for(;;){if(r?.cancelled)throw new Error("cancelled");x+=1;let R=0,M=0;try{let T=0;try{T=g.statSync(i).size}catch{}let P=Number(h.size||0);if(P>0&&T>P)try{g.unlinkSync(i),T=0}catch{}await I(E,i,(_,Y)=>{let D=Math.max(0,_-M);M=_;try{D>0&&e("progress:bytes",{delta:D})}catch{}R+=D;let K=P||Y||0;e("progress:part",{path:t.path,part:l,totalParts:d,received:Math.min(_,K||_),total:K})},1,r,T,P)}catch{try{g.unlinkSync(i)}catch{}try{R>0&&e("progress:bytes",{delta:-R})}catch{}try{e("progress:part:reset",{path:t.path,part:l,totalParts:d})}catch{}let P=Math.min(2e3*x,1e4);await N(P);continue}if((await V(i)).toLowerCase()===String(h.checksum).toLowerCase())break;try{g.unlinkSync(i)}catch{}try{R>0&&e("progress:bytes",{delta:-R})}catch{}try{e("progress:part:reset",{path:t.path,part:l,totalParts:d})}catch{}let $=Math.min(2e3*x,1e4);await N($)}c[l]=i}}let v=Array.from({length:Math.max(1,s)},()=>p());await Promise.all(v),e("progress:merge:start",{path:t.path,parts:c.length});let C=g.createWriteStream(o);for(let l=0;l<c.length;l++){let h=c[l];e("progress:merge:part",{path:t.path,part:l,totalParts:c.length}),await new Promise((E,i)=>{let x=g.createReadStream(h);x.on("error",i),C.on("error",i),x.on("end",()=>{try{g.unlinkSync(h)}catch{}E()}),x.pipe(C,{end:!1})})}await new Promise((l,h)=>{C.on("error",h),C.on("finish",l),C.end()});try{e("progress:merge:done",{path:t.path})}catch{}}else{let d=`${n.replace(/\/$/,"")}/${t.path.replace(/\\/g,"/")}`,c=0;for(;;){c+=1;let f=0,S=0,p=0;try{p=g.statSync(o).size}catch{}let v=Number(t.size||0);if(v>0&&p>v)try{g.unlinkSync(o),p=0}catch{}if(await I(d,o,(l,h)=>{let E=Math.max(0,l-S);S=l;try{E>0&&e("progress:bytes",{delta:E})}catch{}f+=E;let i=v||h||0;e("progress:file",{path:t.path,received:Math.min(l,i||l),total:i})},1,r,p,v),(await V(o)).toLowerCase()===String(t.checksum).toLowerCase())break;try{g.unlinkSync(o)}catch{}try{f>0&&e("progress:bytes",{delta:-f})}catch{}if(c>=2)throw new Error(`Checksum mismatch for ${t.path}`)}}if(e("progress:verify",{path:t.path}),(await V(o)).toLowerCase()!==String(t.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${t.path}`)}async function j(n,t,a,e,s=!1,r=4,o=4,u){let d=(t.files||[]).filter(h=>s||!h.optional),c=d.filter(h=>!(Array.isArray(h.parts)&&h.parts.length>0)),f=d.filter(h=>Array.isArray(h.parts)&&h.parts.length>0),S=c.concat(f),p=S.length,v=0,C=S.reduce((h,E)=>{let i=Number(E.size||0);return i>0?h+i:Array.isArray(E.parts)&&E.parts.length?h+E.parts.reduce((x,R)=>x+Number(R.size||0),0):h},0);try{e("progress:bytes:total",{totalBytes:C})}catch{}async function l(h,E,i){let x=0;async function R(){for(;;){let z=x++;if(z>=h.length)return;let $=h[z],T=E+z;e("progress:start",{index:T,total:p,path:$.path,completed:v});let P=async()=>gt(n,$,a,e,o,u);try{await P()}catch(_){if(String(_?.message||_||"error").includes("cancelled"))throw _;try{let D=U.join(a,$.path.replace(/\\/g,U.sep));try{g.unlinkSync(D)}catch{}await P()}catch(D){try{e("progress:error",{path:$.path,message:String(D?.message||D)})}catch{}}}v+=1,e("progress:done",{index:T,total:p,path:$.path,completed:v})}}let M=Array.from({length:Math.max(1,i)},()=>R());await Promise.all(M)}await l(c,0,Math.max(1,r)),await l(f,c.length,1)}import B from"node:fs";import mt from"node:path";import{app as Et}from"electron";var tt=Et.getPath("userData"),et=mt.join(tt,"settings.json");function J(){try{let n=B.readFileSync(et,"utf-8");return JSON.parse(n)}catch{return{}}}function St(n){B.mkdirSync(tt,{recursive:!0}),B.writeFileSync(et,JSON.stringify(n,null,2),"utf-8")}function nt(n,t=void 0){return J()[n]??t}function F(n,t){let a=J();a[n]=t,St(a)}function rt(){return J()}var it=vt(import.meta.url),{autoUpdater:A}=it("electron-updater"),ot=it("electron-log"),Rt=Ct(import.meta.url),q=m.dirname(Rt);var y,b=null;async function st(){y=new ct({width:1150,height:800,minWidth:1150,minHeight:800,frame:!1,titleBarStyle:"hidden",webPreferences:{preload:m.join(q,"preload.cjs"),contextIsolation:!0,nodeIntegration:!1},show:!1,icon:m.join(q,"..","public","icon.png")});let n=process.env.VITE_DEV_SERVER_URL;if(n)await y.loadURL(n);else{let s=m.join(q,"..","dist","index.html");await y.loadFile(s)}y.webContents.setWindowOpenHandler(({url:s})=>{try{H.openExternal(s)}catch{}return{action:"deny"}}),y.webContents.on("will-navigate",(s,r)=>{let o=r.startsWith("file:"),u=!!process.env.VITE_DEV_SERVER_URL&&r.startsWith(String(process.env.VITE_DEV_SERVER_URL));if(!o&&!u){s.preventDefault();try{H.openExternal(r)}catch{}}});let t=()=>{y&&(y.isVisible()||y.show(),y.isFocused()||y.focus())};y.once("ready-to-show",t),y.webContents.once("did-finish-load",t);let a=setTimeout(t,1e3);y.on("show",()=>clearTimeout(a)),(!!process.env.VITE_DEV_SERVER_URL||process.env.NODE_ENV==="development")&&y.webContents.openDevTools({mode:"detach"}),y.webContents.on("did-fail-load",(s,r,o,u)=>{console.error("Load failed",{errorCode:r,errorDesc:o,validatedURL:u}),G.showErrorBox("Load failed",`${o} (code ${r})
URL: ${u}`),y.show()})}k.on("window-all-closed",()=>{process.platform!=="darwin"&&k.quit()});k.whenReady().then(()=>{let n=m.resolve(k.getAppPath(),".."),t=m.join(n,"cache");at.registerFileProtocol("r5v",(e,s)=>{try{let r=new URL(e.url),o=decodeURIComponent(r.pathname).replace(/^\//,""),u=m.normalize(m.join(t,o));s({path:u})}catch{s({error:-6})}});let a=m.join(q,"..","dist");at.interceptFileProtocol("file",(e,s)=>{try{let r=new URL(e.url),o=decodeURIComponent(r.pathname),u=o.replace(/\\/g,"/"),d=u.indexOf("/_astro/");if(d!==-1){let c=u.substring(d+8),f=m.join(a,"_astro",c);return s({path:f})}if(u.endsWith("/favicon.svg")||/\/favicon\.svg$/i.test(u)){let c=m.join(a,"favicon.svg");return s({path:c})}if(u.startsWith("/")){let c=u.replace(/^\/+/,""),f=m.join(a,c);try{return L.accessSync(f),s({path:f})}catch{}}return s({path:o})}catch{return s({error:-6})}}),st();try{A.autoDownload=!1;try{A.logger=ot,ot.transports.file.level="info"}catch{}A.on("error",e=>{try{y?.webContents.send("update:error",{message:String(e?.stack||e?.message||e)})}catch{}}),A.on("update-available",e=>{try{y?.webContents.send("update:available",e)}catch{}}),A.on("update-not-available",e=>{try{y?.webContents.send("update:not-available",e)}catch{}}),A.on("download-progress",e=>{try{y?.webContents.send("update:download-progress",e)}catch{}}),A.on("update-downloaded",e=>{try{y?.webContents.send("update:downloaded",e)}catch{}})}catch{}k.on("activate",()=>{ct.getAllWindows().length===0&&st()})});w.handle("update:check",async()=>{try{return{ok:!0,result:(await A.checkForUpdates())?.updateInfo||null}}catch(n){return{ok:!1,error:String(n?.message||n)}}});w.handle("update:download",async()=>{try{return await A.downloadUpdate(),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});w.handle("update:quitAndInstall",async()=>{try{return setImmediate(()=>A.quitAndInstall(!1,!0)),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});w.handle("app:getVersion",async()=>{try{return k.getVersion()}catch{return"0.0.0"}});w.handle("select-directory",async()=>{let n=await G.showOpenDialog({properties:["openDirectory","createDirectory"]});return n.canceled||n.filePaths.length===0?null:n.filePaths[0]});w.handle("settings:get",()=>rt());w.handle("settings:set",(n,{key:t,value:a})=>F(t,a));w.handle("download:checksums",async(n,{baseUrl:t})=>Z(t));w.handle("download:all",async(n,{baseUrl:t,checksums:a,installDir:e,includeOptional:s,concurrency:r,partConcurrency:o,channelName:u})=>{let d=(c,f)=>n.sender.send(c,f);b=X();try{await j(t,a,e,d,!!s,Number(r)||4,Number(o)||4,b);try{let c=nt("channels",{})||{};c[String(u||"default")]={installDir:e,gameVersion:a?.game_version||null,gameBaseUrl:t,lastUpdatedAt:Date.now()},F("channels",c)}catch(c){console.error("Failed to persist channel info",c)}}finally{b=null}return!0});w.handle("default-install-dir",(n,{channelName:t})=>{let a=process.env.LOCALAPPDATA||m.join(k.getPath("home"),"AppData","Local"),e=m.join(a,"Programs","R5VLibrary");return t?m.join(e,t):e});w.handle("launcher:config",async(n,{url:t})=>(e=>new Promise((s,r)=>{lt.get(e,o=>{if(o.statusCode!==200){r(new Error(`HTTP ${o.statusCode} for ${e}`)),o.resume();return}let u="";o.setEncoding("utf8"),o.on("data",d=>u+=d),o.on("end",()=>{try{s(JSON.parse(u))}catch(d){r(d)}})}).on("error",r)}))(t));w.handle("video:cache",async(n,{filename:t})=>{let e=`https://blaze.playvalkyrie.org/video_backgrounds/${t}`,s=m.join(m.resolve(k.getAppPath(),".."),"cache"),r=m.join(s,"videos"),o=m.join(r,t);await L.promises.mkdir(r,{recursive:!0});try{return await L.promises.access(o),`r5v://videos/${t}`}catch{}return await new Promise((u,d)=>{let c=L.createWriteStream(o);lt.get(e,f=>{if(f.statusCode!==200){c.close(()=>{}),L.unlink(o,()=>{}),d(new Error(`HTTP ${f.statusCode} video`)),f.resume();return}f.pipe(c),c.on("finish",()=>c.close(u))}).on("error",f=>{L.unlink(o,()=>d(f))})}),`r5v://videos/${t}`});w.handle("fs:exists",async(n,{path:t})=>{try{return await L.promises.access(t),!0}catch{return!1}});w.handle("path:open",async(n,{path:t})=>{try{return await H.openPath(t),!0}catch{return!1}});w.handle("open-external",async(n,{url:t})=>{try{return await H.openExternal(t),!0}catch{return!1}});w.handle("download:cancel",async()=>{try{W(b)}catch{}b=null;try{y?.webContents.send("progress:cancelled",{})}catch{}return!0});w.handle("select-file",async(n,{filters:t})=>{let a=await G.showOpenDialog({properties:["openFile"],filters:Array.isArray(t)?t:void 0});return a.canceled||a.filePaths.length===0?null:a.filePaths[0]});w.handle("game:launch",async(n,{channelName:t,installDir:a,mode:e,argsString:s})=>{try{if(!a)throw new Error("Missing installDir");let r=String(e).toUpperCase()==="SERVER"?"r5apex_ds.exe":"r5apex.exe",o=m.join(a,r);await L.promises.access(o).catch(()=>{throw new Error(`Executable not found: ${o}`)});let d=(f=>!f||typeof f!="string"?[]:(f.match(/(?:[^\s\"]+|\"[^\"]*\")+/g)||[]).map(p=>p.replace(/^\"|\"$/g,"")))(s);return xt(o,d,{cwd:a,detached:!0,stdio:"ignore",env:{...process.env}}).unref(),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});w.on("window:minimize",()=>{y?.minimize()});w.on("window:maximize",()=>{y&&(y.isMaximized()?y.unmaximize():y.maximize())});w.on("window:close",()=>{y?.close()});k.on("before-quit",()=>{if(b)try{W(b)}catch{}});
