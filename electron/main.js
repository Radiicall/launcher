import{app as L,BrowserWindow as Nt,ipcMain as C,dialog as mt,protocol as Tt,shell as et}from"electron";import{createRequire as Qt}from"node:module";import y from"node:path";import{fileURLToPath as Yt,pathToFileURL as Ee}from"node:url";import Q from"node:https";import w from"node:fs";import Zt from"node:zlib";import{spawn as rt}from"node:child_process";import te from"node:os";import P from"node:fs";import b from"node:path";import zt from"node:crypto";import{pipeline as Bt}from"node:stream";import{promisify as Wt}from"node:util";import ct from"node:https";var jt=Wt(Bt);function at(n){return String(n||"").replace(/\\/g,"/").replace(/^\/+/,"")}function vt(n){return String(n||"").replace(/\\/g,"/").toLowerCase()}var K=new Map,Ct=new ct.Agent({keepAlive:!0,maxSockets:64,maxFreeSockets:32,keepAliveMsecs:6e4,scheduling:"fifo"});function H(n){return new Promise((e,r)=>{let t=zt.createHash("sha256"),s=P.createReadStream(n);s.on("error",r),s.on("end",()=>e(t.digest("hex"))),s.on("data",o=>t.update(o))})}function Pt(n){P.mkdirSync(n,{recursive:!0})}function qt(n){return new Promise((e,r)=>{let t=ct.get(n,{agent:Ct},s=>{if(s.statusCode!==200){r(new Error(`HTTP ${s.statusCode} for ${n}`)),s.resume();return}let o="";s.setEncoding("utf8"),s.on("data",a=>o+=a),s.on("end",()=>{try{e(JSON.parse(o))}catch(a){r(a)}})});t.on("error",r),t.setTimeout(3e4,()=>{t.destroy(),r(new Error("JSON fetch timeout"))})})}function F(n){return new Promise(e=>setTimeout(e,n))}function At(){return{cancelled:!1,requests:new Set}}function it(n){if(n){n.cancelled=!0;for(let e of n.requests)try{e.destroy(new Error("cancelled"))}catch{}n.requests.clear()}}var Ht=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE","ENOTFOUND","ECONNREFUSED","EHOSTDOWN","ENETDOWN"]);async function O(n,e,r,t=1,s,o=0,a=0){return new Promise((c,p)=>{Pt(b.dirname(e));let i=P.createWriteStream(e,{flags:o>0?"a":"w"});if(s?.cancelled)return i.close(()=>{}),p(new Error("cancelled"));let l={agent:Ct};o>0&&(l.headers={Range:`bytes=${o}-`});let h=ct.get(n,l,u=>{if(u.statusCode!==200&&!(o>0&&u.statusCode===206)){if(i.close(()=>{}),o>0&&u.statusCode===200){try{P.unlinkSync(e)}catch{}let f=Math.min(2e3*t,1e4);u.resume();try{h.destroy(new Error("restart:range-ignored"))}catch{}return F(f).then(()=>c(O(n,e,r,t+1,s,0,a)))}if(P.unlink(e,()=>{}),u.statusCode&&[429,500,502,503,504].includes(u.statusCode)&&t<5){let f=Math.min(2e3*t,1e4);return u.resume(),F(f).then(()=>c(O(n,e,r,t+1,s,o,a)))}p(new Error(`HTTP ${u.statusCode} for ${n}`)),u.resume();return}let k=Number(u.headers["content-length"]||0),g=a>0?a:o>0?o+k:k,d=0,v=Date.now(),S=t<=2?3e4:45e3,m=setInterval(()=>{if(!s?.cancelled&&Date.now()-v>S)try{let f=new Error("stalled");f.code="ETIMEDOUT",h.destroy(f)}catch{}},1e4);u.on("data",f=>{d+=f.length,v=Date.now(),r&&r(Math.min(o+d,g||o+d),g||0)}),u.on("aborted",async()=>{let f=new Promise(A=>i.close(()=>A()));try{clearInterval(m)}catch{}try{await f}catch{}if(t<5){let A=Math.min(2e3*t,1e4);return F(A).then(()=>c(O(n,e,r,t+1,s,o+d,a)))}p(new Error("response aborted"))}),jt(u,i).then(()=>{try{clearInterval(m)}catch{}c()}).catch(f=>{try{clearInterval(m)}catch{}p(f)})});if(s?.requests.add(h),h.on("socket",u=>{try{u.setKeepAlive(!0,6e4),u.setNoDelay(!0),u.setRecvBufferSize&&u.setRecvBufferSize(64*1024),u.setSendBufferSize&&u.setSendBufferSize(64*1024)}catch{}}),h.on("close",()=>s?.requests.delete(h)),h.setTimeout(9e4,()=>{try{let u=new Error("Request timeout");u.code="ETIMEDOUT",h.destroy(u)}catch{}}),s?.cancelled)try{h.destroy(new Error("cancelled"))}catch{}h.on("error",async u=>{let k=u?.code,g=t<8&&k&&Ht.has(String(k)),d=new Promise(v=>{try{i.close(()=>v())}catch{v()}});try{await d}catch{}if(g){let v=Math.min(1e3*Math.pow(1.5,t),15e3),S=Math.random()*1e3,m=v+S,f=o;try{f=P.statSync(e).size}catch{}return F(m).then(()=>c(O(n,e,r,t+1,s,f,a)))}p(u)})})}async function Ot(n,e,r){try{let t=P.statSync(n);return r&&Number(r)>0&&t.size!==Number(r)?!1:(await H(n)).toLowerCase()===String(e).toLowerCase()}catch{return!1}}async function xt(n){let e=`${n.replace(/\/$/,"")}/checksums.json`;return qt(e)}async function Jt(n,e,r,t,s=4,o){let a=at(e.path).split("/").join(b.sep),c=b.join(r,a);if(Pt(b.dirname(c)),await Ot(c,e.checksum,e.size))return t("progress:skip",{path:e.path}),{downloadComplete:!0,verificationComplete:!0,targetPath:c};if(o?.cancelled)throw new Error("cancelled");if(Array.isArray(e.parts)&&e.parts.length>0){let i=e.parts.length,l=new Array(i),h=0,u=new Set;async function k(){for(;;){let d=h++;if(d>=i)return;if(u.has(d))continue;u.add(d);let v=e.parts[d],S=at(v.path),m=`${n.replace(/\/$/,"")}/${S}`,f=`${c}.part${d}`;try{if(P.existsSync(f))if((await H(f)).toLowerCase()===String(v.checksum).toLowerCase()){t("progress:part",{path:e.path,part:d,totalParts:i,received:Number(v.size||0),total:Number(v.size||0)}),l[d]=f;continue}else try{P.unlinkSync(f)}catch{}}catch{}let A=0;for(;;){if(o?.cancelled)throw new Error("cancelled");A+=1;let x=0,D=0;try{let z=0;try{z=P.statSync(f).size}catch{}let M=Number(v.size||0);if(M>0&&z>M)try{P.unlinkSync(f),z=0}catch{}await O(m,f,($,B)=>{let W=Math.max(0,$-D);D=$;try{W>0&&t("progress:bytes",{delta:W})}catch{}x+=W;let q=M||B||0;t("progress:part",{path:e.path,part:d,totalParts:i,received:Math.min($,q||$),total:q})},1,o,z,M)}catch{try{P.unlinkSync(f)}catch{}try{x>0&&t("progress:bytes",{delta:-x})}catch{}try{t("progress:part:reset",{path:e.path,part:d,totalParts:i})}catch{}let M=Math.min(2e3*A,1e4);await F(M);continue}if((await H(f)).toLowerCase()===String(v.checksum).toLowerCase())break;try{P.unlinkSync(f)}catch{}try{x>0&&t("progress:bytes",{delta:-x})}catch{}try{t("progress:part:reset",{path:e.path,part:d,totalParts:i})}catch{}let J=Math.min(2e3*A,1e4);await F(J)}l[d]=f}}let g=Array.from({length:Math.max(1,s)},()=>k());return await Promise.all(g),{downloadComplete:!0,verificationComplete:!1,targetPath:c,mergeAndVerifyAsync:async()=>{t("progress:merge:start",{path:e.path,parts:l.length});let d=P.createWriteStream(c);for(let S=0;S<l.length;S++){let m=l[S];t("progress:merge:part",{path:e.path,part:S,totalParts:l.length}),await new Promise((f,A)=>{let x=P.createReadStream(m);x.on("error",A),d.on("error",A),x.on("end",()=>{try{P.unlinkSync(m)}catch{}f()}),x.pipe(d,{end:!1})})}await new Promise((S,m)=>{d.on("error",m),d.on("finish",S),d.end()});try{t("progress:merge:done",{path:e.path})}catch{}if(t("progress:verify",{path:e.path}),(await H(c)).toLowerCase()!==String(e.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${e.path}`);try{let S=P.readdirSync(b.dirname(c)),m=b.basename(c);S.forEach(f=>{if(f.startsWith(m+".part"))try{P.unlinkSync(b.join(b.dirname(c),f))}catch{}})}catch{}return{verificationComplete:!0,targetPath:c,filePath:e.path}}}}else{let i=at(e.path),l=`${n.replace(/\/$/,"")}/${i}`,h=0;for(;;){h+=1;let u=0,k=0,g=`${c}.download`,d=0;try{d=P.statSync(g).size}catch{}let v=Number(e.size||0);if(v>0&&d>v)try{P.unlinkSync(g),d=0}catch{}if(await O(l,g,(m,f)=>{let A=Math.max(0,m-k);k=m;try{A>0&&t("progress:bytes",{delta:A})}catch{}u+=A;let x=v||f||0;t("progress:file",{path:e.path,received:Math.min(m,x||m),total:x})},1,o,d,v),(await H(g)).toLowerCase()===String(e.checksum).toLowerCase())break;try{P.unlinkSync(g)}catch{}try{u>0&&t("progress:bytes",{delta:-u})}catch{}if(h>=2)throw new Error(`Checksum mismatch for ${e.path}`)}try{P.unlinkSync(c)}catch{}P.renameSync(`${c}.download`,c)}if(t("progress:verify",{path:e.path}),(await H(c)).toLowerCase()!==String(e.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${e.path}`);return{downloadComplete:!0,verificationComplete:!0,targetPath:c}}async function bt(n,e,r,t,s=!1,o=4,a=4,c,p){let i=new Set,l=[];for(let m of e.files||[]){if(!(s||!m.optional))continue;let f=vt(m.path);f&&(i.has(f)||(i.add(f),l.push(m)))}let h=l.filter(m=>!(Array.isArray(m.parts)&&m.parts.length>0)),u=l.filter(m=>Array.isArray(m.parts)&&m.parts.length>0),k=h.concat(u),g=k.length,d=0,v=k.reduce((m,f)=>{let A=Number(f.size||0);return A>0?m+A:Array.isArray(f.parts)&&f.parts.length?m+f.parts.reduce((x,D)=>x+Number(D.size||0),0):m},0);try{t("progress:bytes:total",{totalBytes:v})}catch{}async function S(m,f,A,x=!1){let D=0,_=[];async function J(){for(;;){for(;p&&p();)if(await F(100),c?.cancelled)return;let M=D++;if(M>=m.length)return;let $=m[M],B=f+M,W=vt($.path),q=async()=>Jt(n,$,r,t,a,c),wt=!1,Y=K.get(W);Y?wt=!0:(t("progress:start",{index:B,total:g,path:$.path,completed:d}),Y=(async()=>{try{let V=await q();if(x&&V?.mergeAndVerifyAsync){let kt=V.mergeAndVerifyAsync().then(T=>(T?.filePath&&(d+=1,t("progress:done",{index:B,total:g,path:T.filePath,completed:d})),T)).catch(T=>{if(String(T?.message||T||"error").includes("cancelled"))throw T;try{let N=b.join(r,$.path.replace(/\\/g,b.sep));try{P.unlinkSync(N)}catch{}try{let R=P.readdirSync(b.dirname(N)),I=b.basename(N);R.forEach(Z=>{if(Z.startsWith(I+".part"))try{P.unlinkSync(b.join(b.dirname(N),Z))}catch{}})}catch{}return q().then(R=>R.mergeAndVerifyAsync?R.mergeAndVerifyAsync().then(I=>(I?.filePath&&(d+=1,t("progress:done",{index:B,total:g,path:I.filePath,completed:d})),I)):R)}catch(N){try{t("progress:error",{path:$.path,message:String(N?.message||N)})}catch{}throw N}});return _.push(kt),{...V,skipProgressDone:!0}}return V}catch(V){if(String(V?.message||V||"error").includes("cancelled"))throw V;try{let T=b.join(r,$.path.replace(/\\/g,b.sep));try{P.unlinkSync(T)}catch{}let G=await q();if(x&&G?.mergeAndVerifyAsync){let N=G.mergeAndVerifyAsync().then(R=>(R?.filePath&&(d+=1,t("progress:done",{index:B,total:g,path:R.filePath,completed:d})),R)).catch(R=>{try{let I=b.join(r,$.path.replace(/\\/g,b.sep)),Z=P.readdirSync(b.dirname(I)),Ft=b.basename(I);Z.forEach(Et=>{if(Et.startsWith(Ft+".part"))try{P.unlinkSync(b.join(b.dirname(I),Et))}catch{}})}catch{}try{t("progress:error",{path:$.path,message:String(R?.message||R)})}catch{}throw R});return _.push(N),{...G,skipProgressDone:!0}}return G}catch(T){try{t("progress:error",{path:$.path,message:String(T?.message||T)})}catch{}throw T}}})(),K.set(W,Y));let St;try{St=await Y}finally{wt||K.delete(W)}St?.skipProgressDone||(d+=1,t("progress:done",{index:B,total:g,path:$.path,completed:d})),await F(10)}}let z=Array.from({length:Math.max(1,A)},()=>J());await Promise.all(z),_.length>0&&await Promise.all(_)}if(await S(h,0,Math.max(1,o)),K.size>0)try{await Promise.all([...K.values()])}catch{}await S(u,h.length,1,!0)}import lt from"node:fs";import Gt from"node:path";import{app as Kt}from"electron";var _t=Kt.getPath("userData"),Dt=Gt.join(_t,"settings.json");function dt(){try{let n=lt.readFileSync(Dt,"utf-8");return JSON.parse(n)}catch{return{}}}function Xt(n){lt.mkdirSync(_t,{recursive:!0}),lt.writeFileSync(Dt,JSON.stringify(n,null,2),"utf-8")}function Lt(n,e=void 0){return dt()[n]??e}function ht(n,e){let r=dt();r[n]=e,Xt(r)}function $t(){return dt()}var Ut=Qt(import.meta.url),{autoUpdater:U}=Ut("electron-updater"),Rt=Ut("electron-log"),ee=Yt(import.meta.url),tt=y.dirname(ee);var E,j=null,ut=new Set,nt=new Map,st=new Map,pt="r5v",ot=[];function It(n){try{return(n||[]).filter(e=>typeof e=="string"&&e.startsWith(`${pt}://`))}catch{return[]}}function yt(n){try{let e=new URL(n);if(e.hostname==="mod"&&e.pathname==="/install"){let r=e.searchParams.get("name")||"",t=e.searchParams.get("version")||"",s=e.searchParams.get("downloadUrl")?.split(",")||"";if(E&&E.webContents&&!E.webContents.isLoading())try{E.webContents.send("deeplink:mod-install",{url:n,name:r,version:t,downloadUrls:s})}catch{}else ot.push(n)}}catch{}}function re(){for(;ot.length;){let n=ot.shift();yt(n)}}var ne=L.requestSingleInstanceLock();ne?L.on("second-instance",(n,e)=>{try{It(e).forEach(t=>yt(t)),E&&(E.isMinimized()&&E.restore(),E.focus())}catch{}}):L.quit();L.on("open-url",(n,e)=>{n.preventDefault(),yt(e)});async function Mt(){E=new Nt({width:1150,height:800,minWidth:1150,minHeight:800,frame:!1,titleBarStyle:"hidden",webPreferences:{preload:y.join(tt,"preload.cjs"),contextIsolation:!0,nodeIntegration:!1},show:!1,icon:y.join(tt,"..","public","icon.png")});let n=process.env.VITE_DEV_SERVER_URL;if(n)await E.loadURL(n);else{let s=y.join(tt,"..","dist","index.html");await E.loadFile(s)}E.webContents.setWindowOpenHandler(({url:s})=>{try{et.openExternal(s)}catch{}return{action:"deny"}}),E.webContents.on("will-navigate",(s,o)=>{let a=o.startsWith("file:"),c=!!process.env.VITE_DEV_SERVER_URL&&o.startsWith(String(process.env.VITE_DEV_SERVER_URL));if(!a&&!c){s.preventDefault();try{et.openExternal(o)}catch{}}});let e=()=>{E&&(E.isVisible()||E.show(),E.isFocused()||E.focus())};E.once("ready-to-show",e),E.webContents.once("did-finish-load",e);let r=setTimeout(e,1e3);E.on("show",()=>clearTimeout(r)),(!!process.env.VITE_DEV_SERVER_URL||process.env.NODE_ENV==="development")&&E.webContents.openDevTools({mode:"detach"}),E.webContents.on("did-fail-load",(s,o,a,c)=>{console.error("Load failed",{errorCode:o,errorDesc:a,validatedURL:c}),mt.showErrorBox("Load failed",`${a} (code ${o})
URL: ${c}`),E.show()})}L.on("window-all-closed",()=>{process.platform!=="darwin"&&L.quit()});L.whenReady().then(()=>{try{process.defaultApp&&process.platform==="win32"?L.setAsDefaultProtocolClient(pt,process.execPath,[process.argv[1]]):L.setAsDefaultProtocolClient(pt)}catch{}let n=y.resolve(L.getAppPath(),".."),e=y.join(n,"cache");Tt.registerFileProtocol("r5v",(t,s)=>{try{let o=new URL(t.url),a=decodeURIComponent(o.pathname).replace(/^\//,""),c=y.normalize(y.join(e,a));s({path:c})}catch{s({error:-6})}});let r=y.join(tt,"..","dist");Tt.interceptFileProtocol("file",(t,s)=>{try{let o=new URL(t.url),a=decodeURIComponent(o.pathname),c=a.replace(/\\/g,"/"),p=c.indexOf("/_astro/");if(p!==-1){let i=c.substring(p+8),l=y.join(r,"_astro",i);return s({path:l})}if(c.endsWith("/favicon.svg")||/\/favicon\.svg$/i.test(c)){let i=y.join(r,"favicon.svg");return s({path:i})}if(c.startsWith("/")){let i=c.replace(/^\/+/,""),l=y.join(r,i);try{return w.accessSync(l),s({path:l})}catch{}}return s({path:a})}catch{return s({error:-6})}}),Mt();try{It(process.argv).forEach(t=>ot.push(t))}catch{}try{E?.webContents?.once("did-finish-load",re)}catch{}try{U.autoDownload=!1;try{U.logger=Rt,Rt.transports.file.level="info"}catch{}U.on("error",t=>{try{E?.webContents.send("update:error",{message:String(t?.stack||t?.message||t)})}catch{}}),U.on("update-available",t=>{try{E?.webContents.send("update:available",t)}catch{}}),U.on("update-not-available",t=>{try{E?.webContents.send("update:not-available",t)}catch{}}),U.on("download-progress",t=>{try{E?.webContents.send("update:download-progress",t)}catch{}}),U.on("update-downloaded",t=>{try{E?.webContents.send("update:downloaded",t)}catch{}})}catch{}L.on("activate",()=>{Nt.getAllWindows().length===0&&Mt()})});C.handle("update:check",async()=>{try{return{ok:!0,result:(await U.checkForUpdates())?.updateInfo||null}}catch(n){return{ok:!1,error:String(n?.message||n)}}});C.handle("update:download",async()=>{try{return await U.downloadUpdate(),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});C.handle("update:quitAndInstall",async()=>{try{return setImmediate(()=>U.quitAndInstall(!1,!0)),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});C.handle("app:getVersion",async()=>{try{return L.getVersion()}catch{return"0.0.0"}});C.handle("app:getBaseDir",async()=>{try{return y.resolve(L.getAppPath(),"..")}catch{return""}});C.handle("app:getLauncherInstallRoot",async()=>{try{let n=process.env.LOCALAPPDATA||y.join(L.getPath("home"),"AppData","Local");return y.join(n,"Programs","r5vlauncher")}catch{return""}});function se(n){try{let e=y.join(n,"mods.vdf"),r=w.readFileSync(e,"utf-8"),t={},s=/"([^"]+)"\s*"([01])"/g,o;for(;o=s.exec(r);){let a=o[1];a&&a!=="ModList"&&(t[a]=o[2]==="1")}return t}catch{return{}}}function gt(n){try{let e=y.join(n,"mods.vdf"),r=w.readFileSync(e,"utf-8"),t={},s=[],o=/"([^"]+)"\s*"([01])"/g,a;for(;a=o.exec(r);){let c=a[1];!c||c==="ModList"||(c in t||s.push(c),t[c]=a[2]==="1")}return{map:t,order:s}}catch{return{map:{},order:[]}}}function ft(n){try{let e=w.readFileSync(n,"utf-8"),r=e.match(/"id"\s*"([^"]+)"/i),t=e.match(/"name"\s*"([^"]+)"/i),s=r?r[1]:null,o=t?t[1]:null;return{id:s,name:o}}catch{return{id:null,name:null}}}function oe(n,e){let r=['"ModList"',"{"];for(let[t,s]of Object.entries(e))r.push(`	"${t}"		"${s?"1":"0"}"`);r.push("}"),w.mkdirSync(n,{recursive:!0}),w.writeFileSync(y.join(n,"mods.vdf"),r.join(`
`),"utf-8")}function Vt(n,e,r){let t=new Set,s=['"ModList"',"{"],o=a=>{s.push(`	"${a}"		"${r[a]?"1":"0"}"`),t.add(a)};for(let a of Array.isArray(e)?e:[])Object.prototype.hasOwnProperty.call(r,a)&&!t.has(a)&&o(a);for(let a of Object.keys(r))t.has(a)||o(a);s.push("}"),w.mkdirSync(n,{recursive:!0}),w.writeFileSync(y.join(n,"mods.vdf"),s.join(`
`),"utf-8")}C.handle("mods:listInstalled",async(n,{installDir:e})=>{try{let r=y.join(e,"mods"),{map:t,order:s}=gt(r),o=[],a=w.existsSync(r)?w.readdirSync(r,{withFileTypes:!0}):[];for(let p of a){if(!p.isDirectory())continue;let i=y.join(r,p.name),l=y.join(i,"manifest.json"),h=y.join(i,"mod.vdf"),u=y.join(i,"icon.png"),k=null;try{k=JSON.parse(w.readFileSync(l,"utf-8"))}catch{}let g=ft(h),d=g.id||k?.name||p.name,v=null;try{v=`data:image/png;base64,${w.readFileSync(u).toString("base64")}`}catch{}o.push({id:d,name:k?.name||g.name||p.name,folder:p.name,version:k?.version_number||null,description:k?.description||"",enabled:d?!!t[d]:!1,hasManifest:w.existsSync(l),iconDataUrl:v})}let c=new Map(s.map((p,i)=>[p,i]));return o.sort((p,i)=>{let l=p.id!=null&&c.has(p.id)?c.get(p.id):Number.MAX_SAFE_INTEGER,h=i.id!=null&&c.has(i.id)?c.get(i.id):Number.MAX_SAFE_INTEGER;return l!==h?l-h:String(p.name||"").localeCompare(String(i.name||""))}),{ok:!0,mods:o}}catch(r){return{ok:!1,error:String(r?.message||r)}}});C.handle("mods:setEnabled",async(n,{installDir:e,name:r,enabled:t})=>{try{let s=y.join(e,"mods"),{map:o}=gt(s);return o[r]=!!t,Vt(s,void 0,o),{ok:!0}}catch(s){return{ok:!1,error:String(s?.message||s)}}});C.handle("mods:reorder",async(n,{installDir:e,orderIds:r})=>{try{let t=y.join(e,"mods"),{map:s,order:o}=gt(t),a=Array.isArray(r)?r.filter(l=>typeof l=="string"&&l&&Object.prototype.hasOwnProperty.call(s,l)):[],c=new Set(a),p=o.filter(l=>Object.prototype.hasOwnProperty.call(s,l)&&!c.has(l)),i=[...a,...p];return Vt(t,i,s),{ok:!0}}catch(t){return{ok:!1,error:String(t?.message||t)}}});C.handle("mods:uninstall",async(n,{installDir:e,folder:r})=>{try{let t=y.join(e,"mods"),s=y.join(t,r);return w.rmSync(s,{recursive:!0,force:!0}),{ok:!0}}catch(t){return{ok:!1,error:String(t?.message||t)}}});C.handle("mods:fetchAll",async(n,{query:e})=>{let r="https://thunderstore.io/c/r5valkyrie/api/v1/package-listing-index/",t=o=>new Promise((a,c)=>{Q.get(o,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"*/*"}},i=>{if(i.statusCode&&i.statusCode>=300&&i.statusCode<400&&i.headers.location){i.resume();let h=i.headers.location.startsWith("http")?i.headers.location:new URL(i.headers.location,o).toString();return a(t(h))}if(i.statusCode!==200)return i.resume(),c(new Error(`HTTP ${i.statusCode}`));let l=[];i.on("data",h=>l.push(Buffer.isBuffer(h)?h:Buffer.from(h))),i.on("end",()=>a(Buffer.concat(l)))}).on("error",c)}),s=o=>{try{return Zt.gunzipSync(o)}catch{return o}};try{let o=await t(r),a=JSON.parse(s(o).toString("utf8")),c=Array.isArray(a)?a:[],p=6,i=[],l=0;await Promise.all(Array.from({length:p}).map(async()=>{for(;l<c.length;){let u=l++,k=c[u];try{let g=await t(k),d=s(g).toString("utf8"),v=JSON.parse(d);Array.isArray(v)&&i.push(...v)}catch{}}}));let h=i;if(e&&String(e).trim()){let u=String(e).toLowerCase();h=h.filter(k=>String(k?.name||"").toLowerCase().includes(u)||String(k?.full_name||"").toLowerCase().includes(u))}return{ok:!0,mods:h}}catch(o){try{let c=await t("https://thunderstore.io/c/r5valkyrie/api/v1/package/"),p=JSON.parse(c.toString("utf8")),i=Array.isArray(p)?p:[];if(e&&String(e).trim()){let l=String(e).toLowerCase();i=i.filter(h=>String(h?.name||"").toLowerCase().includes(l)||String(h?.full_name||"").toLowerCase().includes(l))}return{ok:!0,mods:i}}catch(a){return{ok:!1,error:String(a?.message||o?.message||a||o)}}}});C.handle("mods:install",async(n,{installDir:e,name:r,downloadUrl:t})=>{try{let s=String(r||"").trim();if(!s)return{ok:!1,error:"Invalid mod name"};if(ut.has(s))return{ok:!0};ut.add(s);let o=y.join(e,"mods");w.mkdirSync(o,{recursive:!0});let a=y.join(o,`.__mod_${Date.now()}.zip`),c=(h,u=0)=>new Promise((k,g)=>{if(u>5)return g(new Error("Too many redirects"));let d=w.createWriteStream(a);Q.get(h,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"application/octet-stream,*/*;q=0.8",Referer:"https://thunderstore.io/",Connection:"keep-alive"}},S=>{if(S.statusCode&&S.statusCode>=300&&S.statusCode<400&&S.headers.location){S.resume(),d.close(()=>{});try{w.unlinkSync(a)}catch{}let D=S.headers.location.startsWith("http")?S.headers.location:new URL(S.headers.location,h).toString();return k(c(D,u+1))}if(S.statusCode!==200){d.close(()=>{});try{w.unlinkSync(a)}catch{}return S.resume(),g(new Error(`HTTP ${S.statusCode}`))}let m=Number(S.headers["content-length"]||0),f=0,A=Date.now(),x=D=>{try{n?.sender?.send("mods:progress",{key:r,phase:D,received:f,total:m})}catch{}};S.on("data",D=>{f+=Buffer.isBuffer(D)?D.length:Buffer.byteLength(String(D));let _=Date.now();_-A>150&&(A=_,x("downloading"))}),S.pipe(d),d.on("finish",()=>{x("downloading"),d.close(k)})}).on("error",S=>{try{w.unlinkSync(a)}catch{}g(S)})});await c(t);try{n?.sender?.send("mods:progress",{key:r,phase:"extracting"})}catch{}let p=y.join(o,r);try{w.rmSync(p,{recursive:!0,force:!0})}catch{}w.mkdirSync(p,{recursive:!0}),await new Promise((h,u)=>{let k=rt("powershell.exe",["-NoProfile","-NonInteractive","-Command",`Expand-Archive -LiteralPath "${a}" -DestinationPath "${p}" -Force`],{stdio:"ignore"});k.on("exit",g=>g===0?h():u(new Error(`Expand-Archive failed ${g}`))),k.on("error",u)});try{w.unlinkSync(a)}catch{}let i=null;try{let h=y.join(p,"mod.vdf");if(w.existsSync(h))i=ft(h).id;else{let u=w.readdirSync(p,{withFileTypes:!0});for(let k of u)if(k.isDirectory()){let g=y.join(p,k.name,"mod.vdf");if(w.existsSync(g)&&(i=ft(g).id,i))break}}}catch{}let l=se(o);l[i||r]=!0,oe(o,l);try{n?.sender?.send("mods:progress",{key:r,phase:"done"})}catch{}return{ok:!0}}catch(s){return{ok:!1,error:String(s?.message||s)}}finally{try{ut.delete(String(r||""))}catch{}}});C.handle("mods:watch",async(n,{installDir:e})=>{try{let r=y.join(e,"mods");if(!w.existsSync(r))return{ok:!0};let t=r;if(nt.has(t))return{ok:!0};let s=w.watch(r,{persistent:!0},(o,a)=>{let c=t;clearTimeout(st.get(c));let p=setTimeout(()=>{try{E?.webContents?.send("mods:changed",{installDir:e})}catch{}},300);st.set(c,p)});return nt.set(t,s),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});C.handle("mods:unwatch",async(n,{installDir:e})=>{try{let t=y.join(e,"mods"),s=nt.get(t);if(s){try{s.close()}catch{}nt.delete(t)}let o=st.get(t);return o&&(clearTimeout(o),st.delete(t)),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});C.handle("mods:iconDataUrl",async(n,{installDir:e,folder:r})=>{try{let t=y.join(e,"mods",r,"icon.png");return await w.promises.access(t),{ok:!0,dataUrl:`data:image/png;base64,${(await w.promises.readFile(t)).toString("base64")}`}}catch(t){return{ok:!1,error:String(t?.message||t)}}});C.handle("select-directory",async()=>{let n=await mt.showOpenDialog({properties:["openDirectory","createDirectory"]});return n.canceled||n.filePaths.length===0?null:n.filePaths[0]});C.handle("settings:get",()=>$t());C.handle("settings:set",(n,{key:e,value:r})=>ht(e,r));C.handle("download:checksums",async(n,{baseUrl:e})=>xt(e));C.handle("download:all",async(n,{baseUrl:e,checksums:r,installDir:t,includeOptional:s,concurrency:o,partConcurrency:a,channelName:c,mode:p})=>{let i=(l,h)=>n.sender.send(l,h);try{if(!(String(p||"install").toLowerCase()==="install")){let h=y.join(t,"mods","mods.vdf");if(w.existsSync(h)){let k=(Array.isArray(r?.files)?r.files:[]).filter(g=>{try{return String(g?.path||g?.name||"").replace(/\\/g,"/").toLowerCase()!=="mods/mods.vdf"}catch{return!0}});r={...r||{},files:k}}}}catch{}j=At(),X=!1;try{await bt(e,r,t,i,!!s,Number(o)||4,Number(a)||4,j,()=>X);try{let l=Lt("channels",{})||{};l[String(c||"default")]={installDir:t,gameVersion:r?.game_version||null,gameBaseUrl:e,lastUpdatedAt:Date.now()},ht("channels",l)}catch(l){console.error("Failed to persist channel info",l)}}finally{j=null}return!0});C.handle("default-install-dir",(n,{channelName:e})=>{let r=process.env.LOCALAPPDATA||y.join(L.getPath("home"),"AppData","Local"),t=y.join(r,"Programs","R5VLibrary");return e?y.join(t,e):t});C.handle("launcher:config",async(n,{url:e})=>(t=>new Promise((s,o)=>{Q.get(t,a=>{if(a.statusCode!==200){o(new Error(`HTTP ${a.statusCode} for ${t}`)),a.resume();return}let c="";a.setEncoding("utf8"),a.on("data",p=>c+=p),a.on("end",()=>{try{s(JSON.parse(c))}catch(p){o(p)}})}).on("error",o)}))(e));C.handle("eula:get",async()=>{let n="https://playvalkyrie.org/api/eula",e=r=>new Promise((t,s)=>{Q.get(r,o=>{if(o.statusCode!==200){s(new Error(`HTTP ${o.statusCode}`)),o.resume();return}let a=[];o.on("data",c=>a.push(Buffer.isBuffer(c)?c:Buffer.from(c))),o.on("end",()=>{try{let c=Buffer.concat(a).toString("utf8");t(JSON.parse(c))}catch(c){s(c)}})}).on("error",s)});try{return{ok:!0,json:await e(n)}}catch(r){return{ok:!1,error:String(r?.message||r)}}});C.handle("video:cache",async(n,{filename:e})=>{let t=`https://blaze.playvalkyrie.org/video_backgrounds/${e}`,s=y.join(y.resolve(L.getAppPath(),".."),"cache"),o=y.join(s,"videos"),a=y.join(o,e);await w.promises.mkdir(o,{recursive:!0});try{return await w.promises.access(a),`r5v://videos/${e}`}catch{}return await new Promise((c,p)=>{let i=w.createWriteStream(a);Q.get(t,l=>{if(l.statusCode!==200){i.close(()=>{}),w.unlink(a,()=>{}),p(new Error(`HTTP ${l.statusCode} video`)),l.resume();return}l.pipe(i),i.on("finish",()=>i.close(c))}).on("error",l=>{w.unlink(a,()=>p(l))})}),`r5v://videos/${e}`});C.handle("fs:exists",async(n,{path:e})=>{try{return await w.promises.access(e),!0}catch{return!1}});C.handle("path:open",async(n,{path:e})=>{try{return await et.openPath(e),!0}catch{return!1}});C.handle("open-external",async(n,{url:e})=>{try{return await et.openExternal(e),!0}catch{return!1}});var X=!1;C.handle("download:pause",async()=>{X=!0;try{E?.webContents.send("progress:paused",{})}catch{}return!0});C.handle("download:resume",async()=>{X=!1;try{E?.webContents.send("progress:resumed",{})}catch{}return!0});C.handle("download:cancel",async()=>{try{it(j)}catch{}j=null,X=!1;try{E?.webContents.send("progress:cancelled",{})}catch{}return!0});C.handle("select-file",async(n,{filters:e})=>{let r=await mt.showOpenDialog({properties:["openFile"],filters:Array.isArray(e)?e:void 0});return r.canceled||r.filePaths.length===0?null:r.filePaths[0]});C.handle("game:launch",async(n,{channelName:e,installDir:r,mode:t,argsString:s})=>{try{if(!r)throw new Error("Missing installDir");let o=String(t).toUpperCase()==="SERVER"?"r5apex_ds.exe":"r5apex.exe",a=y.join(r,o);await w.promises.access(a).catch(()=>{throw new Error(`Executable not found: ${a}`)});let p=(l=>!l||typeof l!="string"?[]:(l.match(/(?:[^\s\"]+|\"[^\"]*\")+/g)||[]).map(u=>u.replace(/^\"|\"$/g,"")))(s);return rt(a,p,{cwd:r,detached:!0,stdio:"ignore",env:{...process.env}}).unref(),{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}});C.handle("fix-folder-permissions",async(n,{folderPath:e})=>{let r=[];try{if(!e)return{ok:!1,error:"No folder path provided"};let t=y.resolve(e).replace(/\//g,"\\");if(!t||t.length<3)return{ok:!1,error:`Invalid path format: ${e}`};let s=t.length>=3&&t[1]===":"?t.slice(3):t;if(/[<>:"|?*]/.test(s))return{ok:!1,error:`Path contains invalid characters: ${t}`};try{w.mkdirSync(e,{recursive:!0})}catch(h){r.push(`Folder creation: ${h.message}`)}let c=te.userInfo().username,p=y.join(process.resourcesPath,"elevate.exe"),i=w.existsSync(p);try{w.mkdirSync(t,{recursive:!0})}catch{}let l=[{exe:"icacls",args:[t,"/grant",`${c}:F`,"/t","/q"],desc:`Grant permissions to current user (${c})`},{exe:"icacls",args:[t,"/grant","Everyone:F","/t","/q"],desc:"Grant Everyone full permissions"},{exe:"icacls",args:[t,"/grant","Users:F","/t","/q"],desc:"Grant Users full permissions"}];for(let h=0;h<l.length;h++){let{exe:u,args:k,desc:g}=l[h];try{let d=await new Promise((v,S)=>{let m,f,A;i?(f=[p,["-wait",u,...k]],A={stdio:["ignore","pipe","pipe"],windowsHide:!0}):(f=[u,k],A={stdio:["ignore","pipe","pipe"],windowsHide:!0});try{m=rt(f[0],f[1],A)}catch(_){console.error("[Permission Fix] Spawn failed:",_),S(_);return}let x="",D="";m.stdout&&m.stdout.on("data",_=>{x+=_.toString()}),m.stderr&&m.stderr.on("data",_=>{D+=_.toString()}),m.on("exit",(_,J)=>{v({code:_,stdout:x,stderr:D,signal:J})}),m.on("error",_=>{S(_)}),setTimeout(()=>{try{m.kill()}catch{}S(new Error("Command timeout"))},3e4)});if(d.code!==0){let v=d.stderr||d.stdout||"Unknown error";if(!(v.includes("duplicate")||v.includes("already")||d.code===1332)){let m=`${g} failed (code ${d.code}): ${v}`;r.push(m)}}}catch(d){let v=`${g} error: ${d.message}`;r.push(v)}}try{let h=y.join(t,"test_write.tmp");w.writeFileSync(h,"test"),w.unlinkSync(h)}catch(h){let u=`Write test failed: ${h.message}`;r.push(u);try{if(w.mkdirSync(t,{recursive:!0}),(await new Promise(g=>{let d=rt("cmd",["/c",`icacls "${t}" /grant "%USERNAME%":F /q`],{stdio:"ignore",windowsHide:!0});d.on("exit",v=>g({code:v})),d.on("error",()=>g({code:1})),setTimeout(()=>{try{d.kill()}catch{}g({code:1})},5e3)})).code===0){let g=y.join(t,"test_write2.tmp");return w.writeFileSync(g,"test"),w.unlinkSync(g),{ok:!0,warnings:r}}}catch{}return{ok:!1,error:u,details:r}}return r.length>0?{ok:!0,warnings:r}:{ok:!0}}catch(t){let s=`Unexpected error: ${t?.message||t}`;return r.push(s),{ok:!1,error:s,details:r}}});C.on("window:minimize",()=>{E?.minimize()});C.on("window:maximize",()=>{E&&(E.isMaximized()?E.unmaximize():E.maximize())});C.on("window:close",()=>{E?.close()});L.on("before-quit",()=>{if(j)try{it(j)}catch{}});
