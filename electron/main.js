import{app as P,BrowserWindow as Et,ipcMain as v,dialog as ct,protocol as St,shell as H}from"electron";import{createRequire as zt}from"node:module";import f from"node:path";import{fileURLToPath as jt,pathToFileURL as le}from"node:url";import X from"node:https";import g from"node:fs";import Ft from"node:zlib";import{spawn as Ct}from"node:child_process";import Bt from"node:os";import x from"node:fs";import j from"node:path";import bt from"node:crypto";import{pipeline as Lt}from"node:stream";import{promisify as _t}from"node:util";import Z from"node:https";var Rt=_t(Lt);function Y(n){return String(n||"").replace(/\\/g,"/").replace(/^\/+/,"")}function dt(n){return String(n||"").replace(/\\/g,"/").toLowerCase()}var F=new Map,Dt=new Z.Agent({keepAlive:!0,maxSockets:32,maxFreeSockets:16,keepAliveMsecs:3e4});function B(n){return new Promise((e,r)=>{let t=bt.createHash("sha256"),a=x.createReadStream(n);a.on("error",r),a.on("end",()=>e(t.digest("hex"))),a.on("data",o=>t.update(o))})}function ht(n){x.mkdirSync(n,{recursive:!0})}function Tt(n){return new Promise((e,r)=>{Z.get(n,t=>{if(t.statusCode!==200){r(new Error(`HTTP ${t.statusCode} for ${n}`)),t.resume();return}let a="";t.setEncoding("utf8"),t.on("data",o=>a+=o),t.on("end",()=>{try{e(JSON.parse(a))}catch(o){r(o)}})}).on("error",r)})}function U(n){return new Promise(e=>setTimeout(e,n))}function ut(){return{cancelled:!1,requests:new Set}}function tt(n){if(n){n.cancelled=!0;for(let e of n.requests)try{e.destroy(new Error("cancelled"))}catch{}n.requests.clear()}}var $t=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE"]);async function z(n,e,r,t=1,a,o=0,s=0){return new Promise((i,d)=>{ht(j.dirname(e));let c=x.createWriteStream(e,{flags:o>0?"a":"w"});if(a?.cancelled)return c.close(()=>{}),d(new Error("cancelled"));let l={agent:Dt};o>0&&(l.headers={Range:`bytes=${o}-`});let p=Z.get(n,l,u=>{if(u.statusCode!==200&&!(o>0&&u.statusCode===206)){if(c.close(()=>{}),o>0&&u.statusCode===200){try{x.unlinkSync(e)}catch{}let C=Math.min(2e3*t,1e4);u.resume();try{p.destroy(new Error("restart:range-ignored"))}catch{}return U(C).then(()=>i(z(n,e,r,t+1,a,0,s)))}if(x.unlink(e,()=>{}),u.statusCode&&[429,500,502,503,504].includes(u.statusCode)&&t<5){let C=Math.min(2e3*t,1e4);return u.resume(),U(C).then(()=>i(z(n,e,r,t+1,a,o,s)))}d(new Error(`HTTP ${u.statusCode} for ${n}`)),u.resume();return}let w=Number(u.headers["content-length"]||0),S=s>0?s:o>0?o+w:w,k=0,y=Date.now(),h=t<=2?6e4:9e4,A=setInterval(()=>{if(!a?.cancelled&&Date.now()-y>h)try{let C=new Error("stalled");C.code="ETIMEDOUT",p.destroy(C)}catch{}},1e4);u.on("data",C=>{k+=C.length,y=Date.now(),r&&r(Math.min(o+k,S||o+k),S||0)}),u.on("aborted",async()=>{let C=new Promise(E=>c.close(()=>E()));try{clearInterval(A)}catch{}try{await C}catch{}if(t<5){let E=Math.min(2e3*t,1e4);return U(E).then(()=>i(z(n,e,r,t+1,a,o+k,s)))}d(new Error("response aborted"))}),Rt(u,c).then(()=>{try{clearInterval(A)}catch{}i()}).catch(C=>{try{clearInterval(A)}catch{}d(C)})});if(a?.requests.add(p),p.on("socket",u=>{try{u.setKeepAlive(!0,6e4),u.setNoDelay(!0)}catch{}}),p.on("close",()=>a?.requests.delete(p)),p.setTimeout(45e3,()=>{try{let u=new Error("Request timeout");u.code="ETIMEDOUT",p.destroy(u)}catch{}}),a?.cancelled)try{p.destroy(new Error("cancelled"))}catch{}p.on("error",async u=>{let w=u?.code,S=t<5&&w&&$t.has(String(w)),k=new Promise(y=>{try{c.close(()=>y())}catch{y()}});try{await k}catch{}if(S){let y=Math.min(2e3*t,1e4),h=o;try{h=x.statSync(e).size}catch{}return U(y).then(()=>i(z(n,e,r,t+1,a,h,s)))}d(u)})})}async function Mt(n,e,r){try{let t=x.statSync(n);return r&&Number(r)>0&&t.size!==Number(r)?!1:(await B(n)).toLowerCase()===String(e).toLowerCase()}catch{return!1}}async function pt(n){let e=`${n.replace(/\/$/,"")}/checksums.json`;return Tt(e)}async function Nt(n,e,r,t,a=4,o){let s=Y(e.path).split("/").join(j.sep),i=j.join(r,s);if(ht(j.dirname(i)),await Mt(i,e.checksum,e.size)){t("progress:skip",{path:e.path});return}if(o?.cancelled)throw new Error("cancelled");if(Array.isArray(e.parts)&&e.parts.length>0){let c=e.parts.length,l=new Array(c),p=0,u=new Set;async function w(){for(;;){let y=p++;if(y>=c)return;if(u.has(y))continue;u.add(y);let h=e.parts[y],A=Y(h.path),C=`${n.replace(/\/$/,"")}/${A}`,E=`${i}.part${y}`;try{if(x.existsSync(E))if((await B(E)).toLowerCase()===String(h.checksum).toLowerCase()){t("progress:part",{path:e.path,part:y,totalParts:c,received:Number(h.size||0),total:Number(h.size||0)}),l[y]=E;continue}else try{x.unlinkSync(E)}catch{}}catch{}let L=0;for(;;){if(o?.cancelled)throw new Error("cancelled");L+=1;let b=0,R=0;try{let D=0;try{D=x.statSync(E).size}catch{}let T=Number(h.size||0);if(T>0&&D>T)try{x.unlinkSync(E),D=0}catch{}await z(C,E,($,V)=>{let N=Math.max(0,$-R);R=$;try{N>0&&t("progress:bytes",{delta:N})}catch{}b+=N;let Q=T||V||0;t("progress:part",{path:e.path,part:y,totalParts:c,received:Math.min($,Q||$),total:Q})},1,o,D,T)}catch{try{x.unlinkSync(E)}catch{}try{b>0&&t("progress:bytes",{delta:-b})}catch{}try{t("progress:part:reset",{path:e.path,part:y,totalParts:c})}catch{}let T=Math.min(2e3*L,1e4);await U(T);continue}if((await B(E)).toLowerCase()===String(h.checksum).toLowerCase())break;try{x.unlinkSync(E)}catch{}try{b>0&&t("progress:bytes",{delta:-b})}catch{}try{t("progress:part:reset",{path:e.path,part:y,totalParts:c})}catch{}let W=Math.min(2e3*L,1e4);await U(W)}l[y]=E}}let S=Array.from({length:Math.max(1,a)},()=>w());await Promise.all(S),t("progress:merge:start",{path:e.path,parts:l.length});let k=x.createWriteStream(i);for(let y=0;y<l.length;y++){let h=l[y];t("progress:merge:part",{path:e.path,part:y,totalParts:l.length}),await new Promise((A,C)=>{let E=x.createReadStream(h);E.on("error",C),k.on("error",C),E.on("end",()=>{try{x.unlinkSync(h)}catch{}A()}),E.pipe(k,{end:!1})})}await new Promise((y,h)=>{k.on("error",h),k.on("finish",y),k.end()});try{t("progress:merge:done",{path:e.path})}catch{}}else{let c=Y(e.path),l=`${n.replace(/\/$/,"")}/${c}`,p=0;for(;;){p+=1;let u=0,w=0,S=`${i}.download`,k=0;try{k=x.statSync(S).size}catch{}let y=Number(e.size||0);if(y>0&&k>y)try{x.unlinkSync(S),k=0}catch{}if(await z(l,S,(A,C)=>{let E=Math.max(0,A-w);w=A;try{E>0&&t("progress:bytes",{delta:E})}catch{}u+=E;let L=y||C||0;t("progress:file",{path:e.path,received:Math.min(A,L||A),total:L})},1,o,k,y),(await B(S)).toLowerCase()===String(e.checksum).toLowerCase())break;try{x.unlinkSync(S)}catch{}try{u>0&&t("progress:bytes",{delta:-u})}catch{}if(p>=2)throw new Error(`Checksum mismatch for ${e.path}`)}try{x.unlinkSync(i)}catch{}x.renameSync(`${i}.download`,i)}if(t("progress:verify",{path:e.path}),(await B(i)).toLowerCase()!==String(e.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${e.path}`)}async function ft(n,e,r,t,a=!1,o=4,s=4,i){let d=new Set,c=[];for(let h of e.files||[]){if(!(a||!h.optional))continue;let A=dt(h.path);A&&(d.has(A)||(d.add(A),c.push(h)))}let l=c.filter(h=>!(Array.isArray(h.parts)&&h.parts.length>0)),p=c.filter(h=>Array.isArray(h.parts)&&h.parts.length>0),u=l.concat(p),w=u.length,S=0,k=u.reduce((h,A)=>{let C=Number(A.size||0);return C>0?h+C:Array.isArray(A.parts)&&A.parts.length?h+A.parts.reduce((E,L)=>E+Number(L.size||0),0):h},0);try{t("progress:bytes:total",{totalBytes:k})}catch{}async function y(h,A,C){let E=0;async function L(){for(;;){let R=E++;if(R>=h.length)return;let M=h[R],W=A+R,D=dt(M.path),T=async()=>Nt(n,M,r,t,s,i),$=!1,V=F.get(D);V?$=!0:(t("progress:start",{index:W,total:w,path:M.path,completed:S}),V=(async()=>{try{await T()}catch(N){if(String(N?.message||N||"error").includes("cancelled"))throw N;try{let q=j.join(r,M.path.replace(/\\/g,j.sep));try{x.unlinkSync(q)}catch{}await T()}catch(q){try{t("progress:error",{path:M.path,message:String(q?.message||q)})}catch{}}}})(),F.set(D,V));try{await V}finally{$||F.delete(D)}S+=1,t("progress:done",{index:W,total:w,path:M.path,completed:S}),await U(10)}}let b=Array.from({length:Math.max(1,C)},()=>L());await Promise.all(b)}if(await y(l,0,Math.max(1,o)),F.size>0)try{await Promise.all([...F.values()])}catch{}await y(p,l.length,1)}import et from"node:fs";import Ut from"node:path";import{app as It}from"electron";var yt=It.getPath("userData"),mt=Ut.join(yt,"settings.json");function nt(){try{let n=et.readFileSync(mt,"utf-8");return JSON.parse(n)}catch{return{}}}function Vt(n){et.mkdirSync(yt,{recursive:!0}),et.writeFileSync(mt,JSON.stringify(n,null,2),"utf-8")}function gt(n,e=void 0){return nt()[n]??e}function rt(n,e){let r=nt();r[n]=e,Vt(r)}function wt(){return nt()}var At=zt(import.meta.url),{autoUpdater:_}=At("electron-updater"),kt=At("electron-log"),Wt=jt(import.meta.url),O=f.dirname(Wt);var m,I=null,ot=new Set,J=new Map,G=new Map,at="r5v",K=[];function xt(n){try{return(n||[]).filter(e=>typeof e=="string"&&e.startsWith(`${at}://`))}catch{return[]}}function it(n){try{let e=new URL(n);if(e.hostname==="mod"&&e.pathname==="/install"){let r=e.searchParams.get("name")||"",t=e.searchParams.get("version")||"",a=e.searchParams.get("downloadUrl")||"";if(m&&m.webContents&&!m.webContents.isLoading())try{m.webContents.send("deeplink:mod-install",{url:n,name:r,version:t,downloadUrl:a})}catch{}else K.push(n)}}catch{}}function qt(){for(;K.length;){let n=K.shift();it(n)}}var Ot=P.requestSingleInstanceLock();Ot?P.on("second-instance",(n,e)=>{try{xt(e).forEach(t=>it(t)),m&&(m.isMinimized()&&m.restore(),m.focus())}catch{}}):P.quit();P.on("open-url",(n,e)=>{n.preventDefault(),it(e)});async function vt(){m=new Et({width:1150,height:800,minWidth:1150,minHeight:800,frame:!1,titleBarStyle:"hidden",webPreferences:{preload:f.join(O,"preload.cjs"),contextIsolation:!0,nodeIntegration:!1},show:!1,icon:f.join(O,"..","public","icon.png")});let n=process.env.VITE_DEV_SERVER_URL;if(n)await m.loadURL(n);else{let a=f.join(O,"..","dist","index.html");await m.loadFile(a)}m.webContents.setWindowOpenHandler(({url:a})=>{try{H.openExternal(a)}catch{}return{action:"deny"}}),m.webContents.on("will-navigate",(a,o)=>{let s=o.startsWith("file:"),i=!!process.env.VITE_DEV_SERVER_URL&&o.startsWith(String(process.env.VITE_DEV_SERVER_URL));if(!s&&!i){a.preventDefault();try{H.openExternal(o)}catch{}}});let e=()=>{m&&(m.isVisible()||m.show(),m.isFocused()||m.focus())};m.once("ready-to-show",e),m.webContents.once("did-finish-load",e);let r=setTimeout(e,1e3);m.on("show",()=>clearTimeout(r)),(!!process.env.VITE_DEV_SERVER_URL||process.env.NODE_ENV==="development")&&m.webContents.openDevTools({mode:"detach"}),m.webContents.on("did-fail-load",(a,o,s,i)=>{console.error("Load failed",{errorCode:o,errorDesc:s,validatedURL:i}),ct.showErrorBox("Load failed",`${s} (code ${o})
URL: ${i}`),m.show()})}P.on("window-all-closed",()=>{process.platform!=="darwin"&&P.quit()});P.whenReady().then(()=>{try{process.defaultApp&&process.platform==="win32"?P.setAsDefaultProtocolClient(at,process.execPath,[process.argv[1]]):P.setAsDefaultProtocolClient(at)}catch{}let n=f.resolve(P.getAppPath(),".."),e=f.join(n,"cache");St.registerFileProtocol("r5v",(t,a)=>{try{let o=new URL(t.url),s=decodeURIComponent(o.pathname).replace(/^\//,""),i=f.normalize(f.join(e,s));a({path:i})}catch{a({error:-6})}});let r=f.join(O,"..","dist");St.interceptFileProtocol("file",(t,a)=>{try{let o=new URL(t.url),s=decodeURIComponent(o.pathname),i=s.replace(/\\/g,"/"),d=i.indexOf("/_astro/");if(d!==-1){let c=i.substring(d+8),l=f.join(r,"_astro",c);return a({path:l})}if(i.endsWith("/favicon.svg")||/\/favicon\.svg$/i.test(i)){let c=f.join(r,"favicon.svg");return a({path:c})}if(i.startsWith("/")){let c=i.replace(/^\/+/,""),l=f.join(r,c);try{return g.accessSync(l),a({path:l})}catch{}}return a({path:s})}catch{return a({error:-6})}}),vt();try{xt(process.argv).forEach(t=>K.push(t))}catch{}try{m?.webContents?.once("did-finish-load",qt)}catch{}try{_.autoDownload=!1;try{_.logger=kt,kt.transports.file.level="info"}catch{}_.on("error",t=>{try{m?.webContents.send("update:error",{message:String(t?.stack||t?.message||t)})}catch{}}),_.on("update-available",t=>{try{m?.webContents.send("update:available",t)}catch{}}),_.on("update-not-available",t=>{try{m?.webContents.send("update:not-available",t)}catch{}}),_.on("download-progress",t=>{try{m?.webContents.send("update:download-progress",t)}catch{}}),_.on("update-downloaded",t=>{try{m?.webContents.send("update:downloaded",t)}catch{}})}catch{}P.on("activate",()=>{Et.getAllWindows().length===0&&vt()})});v.handle("update:check",async()=>{try{return{ok:!0,result:(await _.checkForUpdates())?.updateInfo||null}}catch(n){return{ok:!1,error:String(n?.message||n)}}});v.handle("update:download",async()=>{try{return await _.downloadUpdate(),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});v.handle("update:quitAndInstall",async()=>{try{return setImmediate(()=>_.quitAndInstall(!1,!0)),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});v.handle("app:getVersion",async()=>{try{return P.getVersion()}catch{return"0.0.0"}});v.handle("app:getBaseDir",async()=>{try{return f.resolve(P.getAppPath(),"..")}catch{return""}});v.handle("app:getLauncherInstallRoot",async()=>{try{let n=process.env.LOCALAPPDATA||f.join(P.getPath("home"),"AppData","Local");return f.join(n,"Programs","r5vlauncher")}catch{return""}});function Ht(n){try{let e=f.join(n,"mods.vdf"),r=g.readFileSync(e,"utf-8"),t={},a=/"([^"]+)"\s*"([01])"/g,o;for(;o=a.exec(r);){let s=o[1];s&&s!=="ModList"&&(t[s]=o[2]==="1")}return t}catch{return{}}}function lt(n){try{let e=f.join(n,"mods.vdf"),r=g.readFileSync(e,"utf-8"),t={},a=[],o=/"([^"]+)"\s*"([01])"/g,s;for(;s=o.exec(r);){let i=s[1];!i||i==="ModList"||(i in t||a.push(i),t[i]=s[2]==="1")}return{map:t,order:a}}catch{return{map:{},order:[]}}}function st(n){try{let e=g.readFileSync(n,"utf-8"),r=e.match(/"id"\s*"([^"]+)"/i),t=e.match(/"name"\s*"([^"]+)"/i),a=r?r[1]:null,o=t?t[1]:null;return{id:a,name:o}}catch{return{id:null,name:null}}}function Jt(n,e){let r=['"ModList"',"{"];for(let[t,a]of Object.entries(e))r.push(`	"${t}"		"${a?"1":"0"}"`);r.push("}"),g.mkdirSync(n,{recursive:!0}),g.writeFileSync(f.join(n,"mods.vdf"),r.join(`
`),"utf-8")}function Pt(n,e,r){let t=new Set,a=['"ModList"',"{"],o=s=>{a.push(`	"${s}"		"${r[s]?"1":"0"}"`),t.add(s)};for(let s of Array.isArray(e)?e:[])Object.prototype.hasOwnProperty.call(r,s)&&!t.has(s)&&o(s);for(let s of Object.keys(r))t.has(s)||o(s);a.push("}"),g.mkdirSync(n,{recursive:!0}),g.writeFileSync(f.join(n,"mods.vdf"),a.join(`
`),"utf-8")}v.handle("mods:listInstalled",async(n,{installDir:e})=>{try{let r=f.join(e,"mods"),{map:t,order:a}=lt(r),o=[],s=g.existsSync(r)?g.readdirSync(r,{withFileTypes:!0}):[];for(let d of s){if(!d.isDirectory())continue;let c=f.join(r,d.name),l=f.join(c,"manifest.json"),p=f.join(c,"mod.vdf"),u=f.join(c,"icon.png"),w=null;try{w=JSON.parse(g.readFileSync(l,"utf-8"))}catch{}let S=st(p),k=S.id||w?.name||d.name,y=null;try{y=`data:image/png;base64,${g.readFileSync(u).toString("base64")}`}catch{}o.push({id:k,name:w?.name||S.name||d.name,folder:d.name,version:w?.version_number||null,description:w?.description||"",enabled:k?!!t[k]:!1,hasManifest:g.existsSync(l),iconDataUrl:y})}let i=new Map(a.map((d,c)=>[d,c]));return o.sort((d,c)=>{let l=d.id!=null&&i.has(d.id)?i.get(d.id):Number.MAX_SAFE_INTEGER,p=c.id!=null&&i.has(c.id)?i.get(c.id):Number.MAX_SAFE_INTEGER;return l!==p?l-p:String(d.name||"").localeCompare(String(c.name||""))}),{ok:!0,mods:o}}catch(r){return{ok:!1,error:String(r?.message||r)}}});v.handle("mods:setEnabled",async(n,{installDir:e,name:r,enabled:t})=>{try{let a=f.join(e,"mods"),{map:o}=lt(a);return o[r]=!!t,Pt(a,void 0,o),{ok:!0}}catch(a){return{ok:!1,error:String(a?.message||a)}}});v.handle("mods:reorder",async(n,{installDir:e,orderIds:r})=>{try{let t=f.join(e,"mods"),{map:a,order:o}=lt(t),s=Array.isArray(r)?r.filter(l=>typeof l=="string"&&l&&Object.prototype.hasOwnProperty.call(a,l)):[],i=new Set(s),d=o.filter(l=>Object.prototype.hasOwnProperty.call(a,l)&&!i.has(l)),c=[...s,...d];return Pt(t,c,a),{ok:!0}}catch(t){return{ok:!1,error:String(t?.message||t)}}});v.handle("mods:uninstall",async(n,{installDir:e,folder:r})=>{try{let t=f.join(e,"mods"),a=f.join(t,r);return g.rmSync(a,{recursive:!0,force:!0}),{ok:!0}}catch(t){return{ok:!1,error:String(t?.message||t)}}});v.handle("mods:fetchAll",async(n,{query:e})=>{let r="https://thunderstore.io/c/r5valkyrie/api/v1/package-listing-index/",t=o=>new Promise((s,i)=>{X.get(o,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"*/*"}},c=>{if(c.statusCode&&c.statusCode>=300&&c.statusCode<400&&c.headers.location){c.resume();let p=c.headers.location.startsWith("http")?c.headers.location:new URL(c.headers.location,o).toString();return s(t(p))}if(c.statusCode!==200)return c.resume(),i(new Error(`HTTP ${c.statusCode}`));let l=[];c.on("data",p=>l.push(Buffer.isBuffer(p)?p:Buffer.from(p))),c.on("end",()=>s(Buffer.concat(l)))}).on("error",i)}),a=o=>{try{return Ft.gunzipSync(o)}catch{return o}};try{let o=await t(r),s=JSON.parse(a(o).toString("utf8")),i=Array.isArray(s)?s:[],d=6,c=[],l=0;await Promise.all(Array.from({length:d}).map(async()=>{for(;l<i.length;){let u=l++,w=i[u];try{let S=await t(w),k=a(S).toString("utf8"),y=JSON.parse(k);Array.isArray(y)&&c.push(...y)}catch{}}}));let p=c;if(e&&String(e).trim()){let u=String(e).toLowerCase();p=p.filter(w=>String(w?.name||"").toLowerCase().includes(u)||String(w?.full_name||"").toLowerCase().includes(u))}return{ok:!0,mods:p}}catch(o){try{let i=await t("https://thunderstore.io/c/r5valkyrie/api/v1/package/"),d=JSON.parse(i.toString("utf8")),c=Array.isArray(d)?d:[];if(e&&String(e).trim()){let l=String(e).toLowerCase();c=c.filter(p=>String(p?.name||"").toLowerCase().includes(l)||String(p?.full_name||"").toLowerCase().includes(l))}return{ok:!0,mods:c}}catch(s){return{ok:!1,error:String(s?.message||o?.message||s||o)}}}});v.handle("mods:install",async(n,{installDir:e,name:r,downloadUrl:t})=>{try{let a=String(r||"").trim();if(!a)return{ok:!1,error:"Invalid mod name"};if(ot.has(a))return{ok:!0};ot.add(a);let o=f.join(e,"mods");g.mkdirSync(o,{recursive:!0});let s=f.join(Bt.tmpdir(),`mod_${Date.now()}.zip`),i=(p,u=0)=>new Promise((w,S)=>{if(u>5)return S(new Error("Too many redirects"));let k=g.createWriteStream(s);X.get(p,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"application/octet-stream,*/*;q=0.8",Referer:"https://thunderstore.io/",Connection:"keep-alive"}},h=>{if(h.statusCode&&h.statusCode>=300&&h.statusCode<400&&h.headers.location){h.resume(),k.close(()=>{});try{g.unlinkSync(s)}catch{}let b=h.headers.location.startsWith("http")?h.headers.location:new URL(h.headers.location,p).toString();return w(i(b,u+1))}if(h.statusCode!==200){k.close(()=>{});try{g.unlinkSync(s)}catch{}return h.resume(),S(new Error(`HTTP ${h.statusCode}`))}let A=Number(h.headers["content-length"]||0),C=0,E=Date.now(),L=b=>{try{n?.sender?.send("mods:progress",{key:r,phase:b,received:C,total:A})}catch{}};h.on("data",b=>{C+=Buffer.isBuffer(b)?b.length:Buffer.byteLength(String(b));let R=Date.now();R-E>150&&(E=R,L("downloading"))}),h.pipe(k),k.on("finish",()=>{L("downloading"),k.close(w)})}).on("error",h=>{try{g.unlinkSync(s)}catch{}S(h)})});await i(t);try{n?.sender?.send("mods:progress",{key:r,phase:"extracting"})}catch{}let d=f.join(o,r);try{g.rmSync(d,{recursive:!0,force:!0})}catch{}g.mkdirSync(d,{recursive:!0}),await new Promise((p,u)=>{let w=Ct("powershell.exe",["-NoProfile","-NonInteractive","-Command",`Expand-Archive -LiteralPath "${s}" -DestinationPath "${d}" -Force`],{stdio:"ignore"});w.on("exit",S=>S===0?p():u(new Error(`Expand-Archive failed ${S}`))),w.on("error",u)});try{g.unlinkSync(s)}catch{}let c=null;try{let p=f.join(d,"mod.vdf");if(g.existsSync(p))c=st(p).id;else{let u=g.readdirSync(d,{withFileTypes:!0});for(let w of u)if(w.isDirectory()){let S=f.join(d,w.name,"mod.vdf");if(g.existsSync(S)&&(c=st(S).id,c))break}}}catch{}let l=Ht(o);l[c||r]=!0,Jt(o,l);try{n?.sender?.send("mods:progress",{key:r,phase:"done"})}catch{}return{ok:!0}}catch(a){return{ok:!1,error:String(a?.message||a)}}finally{try{ot.delete(String(r||""))}catch{}}});v.handle("mods:watch",async(n,{installDir:e})=>{try{let r=f.join(e,"mods");if(!g.existsSync(r))return{ok:!0};let t=r;if(J.has(t))return{ok:!0};let a=g.watch(r,{persistent:!0},(o,s)=>{let i=t;clearTimeout(G.get(i));let d=setTimeout(()=>{try{m?.webContents?.send("mods:changed",{installDir:e})}catch{}},300);G.set(i,d)});return J.set(t,a),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});v.handle("mods:unwatch",async(n,{installDir:e})=>{try{let t=f.join(e,"mods"),a=J.get(t);if(a){try{a.close()}catch{}J.delete(t)}let o=G.get(t);return o&&(clearTimeout(o),G.delete(t)),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});v.handle("mods:iconDataUrl",async(n,{installDir:e,folder:r})=>{try{let t=f.join(e,"mods",r,"icon.png");return await g.promises.access(t),{ok:!0,dataUrl:`data:image/png;base64,${(await g.promises.readFile(t)).toString("base64")}`}}catch(t){return{ok:!1,error:String(t?.message||t)}}});v.handle("select-directory",async()=>{let n=await ct.showOpenDialog({properties:["openDirectory","createDirectory"]});return n.canceled||n.filePaths.length===0?null:n.filePaths[0]});v.handle("settings:get",()=>wt());v.handle("settings:set",(n,{key:e,value:r})=>rt(e,r));v.handle("download:checksums",async(n,{baseUrl:e})=>pt(e));v.handle("download:all",async(n,{baseUrl:e,checksums:r,installDir:t,includeOptional:a,concurrency:o,partConcurrency:s,channelName:i,mode:d})=>{let c=(l,p)=>n.sender.send(l,p);try{if(!(String(d||"install").toLowerCase()==="install")){let p=f.join(t,"mods","mods.vdf");if(g.existsSync(p)){let w=(Array.isArray(r?.files)?r.files:[]).filter(S=>{try{return String(S?.path||S?.name||"").replace(/\\/g,"/").toLowerCase()!=="mods/mods.vdf"}catch{return!0}});r={...r||{},files:w}}}}catch{}I=ut();try{await ft(e,r,t,c,!!a,Number(o)||4,Number(s)||4,I);try{let l=gt("channels",{})||{};l[String(i||"default")]={installDir:t,gameVersion:r?.game_version||null,gameBaseUrl:e,lastUpdatedAt:Date.now()},rt("channels",l)}catch(l){console.error("Failed to persist channel info",l)}}finally{I=null}return!0});v.handle("default-install-dir",(n,{channelName:e})=>{let r=process.env.LOCALAPPDATA||f.join(P.getPath("home"),"AppData","Local"),t=f.join(r,"Programs","R5VLibrary");return e?f.join(t,e):t});v.handle("launcher:config",async(n,{url:e})=>(t=>new Promise((a,o)=>{X.get(t,s=>{if(s.statusCode!==200){o(new Error(`HTTP ${s.statusCode} for ${t}`)),s.resume();return}let i="";s.setEncoding("utf8"),s.on("data",d=>i+=d),s.on("end",()=>{try{a(JSON.parse(i))}catch(d){o(d)}})}).on("error",o)}))(e));v.handle("video:cache",async(n,{filename:e})=>{let t=`https://blaze.playvalkyrie.org/video_backgrounds/${e}`,a=f.join(f.resolve(P.getAppPath(),".."),"cache"),o=f.join(a,"videos"),s=f.join(o,e);await g.promises.mkdir(o,{recursive:!0});try{return await g.promises.access(s),`r5v://videos/${e}`}catch{}return await new Promise((i,d)=>{let c=g.createWriteStream(s);X.get(t,l=>{if(l.statusCode!==200){c.close(()=>{}),g.unlink(s,()=>{}),d(new Error(`HTTP ${l.statusCode} video`)),l.resume();return}l.pipe(c),c.on("finish",()=>c.close(i))}).on("error",l=>{g.unlink(s,()=>d(l))})}),`r5v://videos/${e}`});v.handle("fs:exists",async(n,{path:e})=>{try{return await g.promises.access(e),!0}catch{return!1}});v.handle("path:open",async(n,{path:e})=>{try{return await H.openPath(e),!0}catch{return!1}});v.handle("open-external",async(n,{url:e})=>{try{return await H.openExternal(e),!0}catch{return!1}});v.handle("download:cancel",async()=>{try{tt(I)}catch{}I=null;try{m?.webContents.send("progress:cancelled",{})}catch{}return!0});v.handle("select-file",async(n,{filters:e})=>{let r=await ct.showOpenDialog({properties:["openFile"],filters:Array.isArray(e)?e:void 0});return r.canceled||r.filePaths.length===0?null:r.filePaths[0]});v.handle("game:launch",async(n,{channelName:e,installDir:r,mode:t,argsString:a})=>{try{if(!r)throw new Error("Missing installDir");let o=String(t).toUpperCase()==="SERVER"?"r5apex_ds.exe":"r5apex.exe",s=f.join(r,o);await g.promises.access(s).catch(()=>{throw new Error(`Executable not found: ${s}`)});let d=(l=>!l||typeof l!="string"?[]:(l.match(/(?:[^\s\"]+|\"[^\"]*\")+/g)||[]).map(u=>u.replace(/^\"|\"$/g,"")))(a);return Ct(s,d,{cwd:r,detached:!0,stdio:"ignore",env:{...process.env}}).unref(),{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}});v.on("window:minimize",()=>{m?.minimize()});v.on("window:maximize",()=>{m&&(m.isMaximized()?m.unmaximize():m.maximize())});v.on("window:close",()=>{m?.close()});P.on("before-quit",()=>{if(I)try{tt(I)}catch{}});
