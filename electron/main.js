import{app as D,BrowserWindow as Ne,ipcMain as x,dialog as ye,protocol as _e,shell as Re}from"electron";import{createRequire as Qe}from"node:module";import p from"node:path";import{fileURLToPath as Ye,pathToFileURL as Et}from"node:url";import Z from"node:https";import y from"node:fs";import Ze from"node:zlib";import{spawn as Q}from"node:child_process";import et from"node:os";import P from"node:fs";import b from"node:path";import Fe from"node:crypto";import{pipeline as je}from"node:stream";import{promisify as We}from"node:util";import ie from"node:https";var Be=We(je);function ae(n){return String(n||"").replace(/\\/g,"/").replace(/^\/+/,"")}function xe(n){return String(n||"").replace(/\\/g,"/").toLowerCase()}var K=new Map,Pe=new ie.Agent({keepAlive:!0,maxSockets:64,maxFreeSockets:32,keepAliveMsecs:6e4,scheduling:"fifo"});function O(n){return new Promise((t,r)=>{let e=Fe.createHash("sha256"),o=P.createReadStream(n);o.on("error",r),o.on("end",()=>t(e.digest("hex"))),o.on("data",a=>e.update(a))})}function Ce(n){P.mkdirSync(n,{recursive:!0})}function qe(n){return new Promise((t,r)=>{let e=ie.get(n,{agent:Pe},o=>{if(o.statusCode!==200){r(new Error(`HTTP ${o.statusCode} for ${n}`)),o.resume();return}let a="";o.setEncoding("utf8"),o.on("data",s=>a+=s),o.on("end",()=>{try{t(JSON.parse(a))}catch(s){r(s)}})});e.on("error",r),e.setTimeout(3e4,()=>{e.destroy(),r(new Error("JSON fetch timeout"))})})}function j(n){return new Promise(t=>setTimeout(t,n))}function Ae(){return{cancelled:!1,requests:new Set}}function ce(n){if(n){n.cancelled=!0;for(let t of n.requests)try{t.destroy(new Error("cancelled"))}catch{}n.requests.clear()}}var He=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE","ENOTFOUND","ECONNREFUSED","EHOSTDOWN","ENETDOWN"]);async function J(n,t,r,e=1,o,a=0,s=0){return new Promise((i,f)=>{Ce(b.dirname(t));let c=P.createWriteStream(t,{flags:a>0?"a":"w"});if(o?.cancelled)return c.close(()=>{}),f(new Error("cancelled"));let u={agent:Pe};a>0&&(u.headers={Range:`bytes=${a}-`});let d=ie.get(n,u,l=>{if(l.statusCode!==200&&!(a>0&&l.statusCode===206)){if(c.close(()=>{}),a>0&&l.statusCode===200){try{P.unlinkSync(t)}catch{}let m=Math.min(2e3*e,1e4);l.resume();try{d.destroy(new Error("restart:range-ignored"))}catch{}return j(m).then(()=>i(J(n,t,r,e+1,o,0,s)))}if(P.unlink(t,()=>{}),l.statusCode&&[429,500,502,503,504].includes(l.statusCode)&&e<5){let m=Math.min(2e3*e,1e4);return l.resume(),j(m).then(()=>i(J(n,t,r,e+1,o,a,s)))}f(new Error(`HTTP ${l.statusCode} for ${n}`)),l.resume();return}let g=Number(l.headers["content-length"]||0),v=s>0?s:a>0?a+g:g,h=0,k=Date.now(),w=e<=2?3e4:45e3,E=setInterval(()=>{if(!o?.cancelled&&Date.now()-k>w)try{let m=new Error("stalled");m.code="ETIMEDOUT",d.destroy(m)}catch{}},1e4);l.on("data",m=>{h+=m.length,k=Date.now(),r&&r(Math.min(a+h,v||a+h),v||0)}),l.on("aborted",async()=>{let m=new Promise(C=>c.close(()=>C()));try{clearInterval(E)}catch{}try{await m}catch{}if(e<5){let C=Math.min(2e3*e,1e4);return j(C).then(()=>i(J(n,t,r,e+1,o,a+h,s)))}f(new Error("response aborted"))}),Be(l,c).then(()=>{try{clearInterval(E)}catch{}i()}).catch(m=>{try{clearInterval(E)}catch{}f(m)})});if(o?.requests.add(d),d.on("socket",l=>{try{l.setKeepAlive(!0,6e4),l.setNoDelay(!0),l.setRecvBufferSize&&l.setRecvBufferSize(64*1024),l.setSendBufferSize&&l.setSendBufferSize(64*1024)}catch{}}),d.on("close",()=>o?.requests.delete(d)),d.setTimeout(9e4,()=>{try{let l=new Error("Request timeout");l.code="ETIMEDOUT",d.destroy(l)}catch{}}),o?.cancelled)try{d.destroy(new Error("cancelled"))}catch{}d.on("error",async l=>{let g=l?.code,v=e<8&&g&&He.has(String(g)),h=new Promise(k=>{try{c.close(()=>k())}catch{k()}});try{await h}catch{}if(v){let k=Math.min(1e3*Math.pow(1.5,e),15e3),w=Math.random()*1e3,E=k+w,m=a;try{m=P.statSync(t).size}catch{}return j(E).then(()=>i(J(n,t,r,e+1,o,m,s)))}f(l)})})}async function Oe(n,t,r){try{let e=P.statSync(n);return r&&Number(r)>0&&e.size!==Number(r)?!1:(await O(n)).toLowerCase()===String(t).toLowerCase()}catch{return!1}}async function be(n){let t=`${n.replace(/\/$/,"")}/checksums.json`;return qe(t)}async function Je(n,t,r,e,o=4,a){let s=ae(t.path).split("/").join(b.sep),i=b.join(r,s);if(Ce(b.dirname(i)),await Oe(i,t.checksum,t.size))return e("progress:skip",{path:t.path}),{downloadComplete:!0,verificationComplete:!0,targetPath:i};if(a?.cancelled)throw new Error("cancelled");if(Array.isArray(t.parts)&&t.parts.length>0){let c=t.parts.length,u=new Array(c),d=0,l=new Set;async function g(){for(;;){let h=d++;if(h>=c)return;if(l.has(h))continue;l.add(h);let k=t.parts[h],w=ae(k.path),E=`${n.replace(/\/$/,"")}/${w}`,m=`${i}.part${h}`;try{if(P.existsSync(m))if((await O(m)).toLowerCase()===String(k.checksum).toLowerCase()){e("progress:part",{path:t.path,part:h,totalParts:c,received:Number(k.size||0),total:Number(k.size||0)}),u[h]=m;continue}else try{P.unlinkSync(m)}catch{}}catch{}let C=0;for(;;){if(a?.cancelled)throw new Error("cancelled");C+=1;let A=0,$=0;try{let I=0;try{I=P.statSync(m).size}catch{}let N=Number(k.size||0);if(N>0&&I>N)try{P.unlinkSync(m),I=0}catch{}await J(E,m,(L,W)=>{let B=Math.max(0,L-$);$=L;try{B>0&&e("progress:bytes",{delta:B})}catch{}A+=B;let H=N||W||0;e("progress:part",{path:t.path,part:h,totalParts:c,received:Math.min(L,H||L),total:H})},1,a,I,N)}catch{try{P.unlinkSync(m)}catch{}try{A>0&&e("progress:bytes",{delta:-A})}catch{}try{e("progress:part:reset",{path:t.path,part:h,totalParts:c})}catch{}let N=Math.min(2e3*C,1e4);await j(N);continue}if((await O(m)).toLowerCase()===String(k.checksum).toLowerCase())break;try{P.unlinkSync(m)}catch{}try{A>0&&e("progress:bytes",{delta:-A})}catch{}try{e("progress:part:reset",{path:t.path,part:h,totalParts:c})}catch{}let _=Math.min(2e3*C,1e4);await j(_)}u[h]=m}}let v=Array.from({length:Math.max(1,o)},()=>g());return await Promise.all(v),{downloadComplete:!0,verificationComplete:!1,targetPath:i,mergeAndVerifyAsync:async()=>{e("progress:merge:start",{path:t.path,parts:u.length});let h=P.createWriteStream(i);for(let w=0;w<u.length;w++){let E=u[w];e("progress:merge:part",{path:t.path,part:w,totalParts:u.length}),await new Promise((m,C)=>{let A=P.createReadStream(E);A.on("error",C),h.on("error",C),A.on("end",()=>{try{P.unlinkSync(E)}catch{}m()}),A.pipe(h,{end:!1})})}await new Promise((w,E)=>{h.on("error",E),h.on("finish",w),h.end()});try{e("progress:merge:done",{path:t.path})}catch{}if(e("progress:verify",{path:t.path}),(await O(i)).toLowerCase()!==String(t.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${t.path}`);try{let w=P.readdirSync(b.dirname(i)),E=b.basename(i);w.forEach(m=>{if(m.startsWith(E+".part"))try{P.unlinkSync(b.join(b.dirname(i),m))}catch{}})}catch{}return{verificationComplete:!0,targetPath:i,filePath:t.path}}}}else{let c=ae(t.path),u=`${n.replace(/\/$/,"")}/${c}`,d=0;for(;;){d+=1;let l=0,g=0,v=`${i}.download`,h=0;try{h=P.statSync(v).size}catch{}let k=Number(t.size||0);if(k>0&&h>k)try{P.unlinkSync(v),h=0}catch{}if(await J(u,v,(E,m)=>{let C=Math.max(0,E-g);g=E;try{C>0&&e("progress:bytes",{delta:C})}catch{}l+=C;let A=k||m||0;e("progress:file",{path:t.path,received:Math.min(E,A||E),total:A})},1,a,h,k),(await O(v)).toLowerCase()===String(t.checksum).toLowerCase())break;try{P.unlinkSync(v)}catch{}try{l>0&&e("progress:bytes",{delta:-l})}catch{}if(d>=2)throw new Error(`Checksum mismatch for ${t.path}`)}try{P.unlinkSync(i)}catch{}P.renameSync(`${i}.download`,i)}if(e("progress:verify",{path:t.path}),(await O(i)).toLowerCase()!==String(t.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${t.path}`);return{downloadComplete:!0,verificationComplete:!0,targetPath:i}}async function De(n,t,r,e,o=!1,a=4,s=4,i,f){let c=new Set,u=[];for(let E of t.files||[]){if(!(o||!E.optional))continue;let m=xe(E.path);m&&(c.has(m)||(c.add(m),u.push(E)))}let d=u.filter(E=>!(Array.isArray(E.parts)&&E.parts.length>0)),l=u.filter(E=>Array.isArray(E.parts)&&E.parts.length>0),g=d.concat(l),v=g.length,h=0,k=g.reduce((E,m)=>{let C=Number(m.size||0);return C>0?E+C:Array.isArray(m.parts)&&m.parts.length?E+m.parts.reduce((A,$)=>A+Number($.size||0),0):E},0);try{e("progress:bytes:total",{totalBytes:k})}catch{}async function w(E,m,C,A=!1){let $=0,M=[];async function _(){for(;;){for(;f&&f();)if(await j(100),i?.cancelled)return;let N=$++;if(N>=E.length)return;let L=E[N],W=m+N,B=xe(L.path),H=async()=>Je(n,L,r,e,s,i),Se=!1,ee=K.get(B);ee?Se=!0:(e("progress:start",{index:W,total:v,path:L.path,completed:h}),ee=(async()=>{try{let F=await H();if(A&&F?.mergeAndVerifyAsync){let Ee=F.mergeAndVerifyAsync().then(R=>(R?.filePath&&(h+=1,e("progress:done",{index:W,total:v,path:R.filePath,completed:h})),R)).catch(R=>{if(String(R?.message||R||"error").includes("cancelled"))throw R;try{let U=b.join(r,L.path.replace(/\\/g,b.sep));try{P.unlinkSync(U)}catch{}try{let T=P.readdirSync(b.dirname(U)),z=b.basename(U);T.forEach(te=>{if(te.startsWith(z+".part"))try{P.unlinkSync(b.join(b.dirname(U),te))}catch{}})}catch{}return H().then(T=>T.mergeAndVerifyAsync?T.mergeAndVerifyAsync().then(z=>(z?.filePath&&(h+=1,e("progress:done",{index:W,total:v,path:z.filePath,completed:h})),z)):T)}catch(U){try{e("progress:error",{path:L.path,message:String(U?.message||U)})}catch{}throw U}});return M.push(Ee),{...F,skipProgressDone:!0}}return F}catch(F){if(String(F?.message||F||"error").includes("cancelled"))throw F;try{let R=b.join(r,L.path.replace(/\\/g,b.sep));try{P.unlinkSync(R)}catch{}let G=await H();if(A&&G?.mergeAndVerifyAsync){let U=G.mergeAndVerifyAsync().then(T=>(T?.filePath&&(h+=1,e("progress:done",{index:W,total:v,path:T.filePath,completed:h})),T)).catch(T=>{try{let z=b.join(r,L.path.replace(/\\/g,b.sep)),te=P.readdirSync(b.dirname(z)),ze=b.basename(z);te.forEach(ve=>{if(ve.startsWith(ze+".part"))try{P.unlinkSync(b.join(b.dirname(z),ve))}catch{}})}catch{}try{e("progress:error",{path:L.path,message:String(T?.message||T)})}catch{}throw T});return M.push(U),{...G,skipProgressDone:!0}}return G}catch(R){try{e("progress:error",{path:L.path,message:String(R?.message||R)})}catch{}throw R}}})(),K.set(B,ee));let ke;try{ke=await ee}finally{Se||K.delete(B)}ke?.skipProgressDone||(h+=1,e("progress:done",{index:W,total:v,path:L.path,completed:h})),await j(10)}}let I=Array.from({length:Math.max(1,C)},()=>_());await Promise.all(I),M.length>0&&await Promise.all(M)}if(await w(d,0,Math.max(1,a)),K.size>0)try{await Promise.all([...K.values()])}catch{}await w(l,d.length,1,!0)}import le from"node:fs";import Ge from"node:path";import{app as Ke}from"electron";var $e=Ke.getPath("userData"),Le=Ge.join($e,"settings.json");function de(){try{let n=le.readFileSync(Le,"utf-8");return JSON.parse(n)}catch{return{}}}function Xe(n){le.mkdirSync($e,{recursive:!0}),le.writeFileSync(Le,JSON.stringify(n,null,2),"utf-8")}function he(n,t=void 0){return de()[n]??t}function re(n,t){let r=de();r[n]=t,Xe(r)}function ue(){return de()}var Ue=Qe(import.meta.url),{autoUpdater:V}=Ue("electron-updater"),Te=Ue("electron-log"),tt=Ye(import.meta.url),X=p.dirname(tt);var S,q=null,fe=new Set,ne=new Map,oe=new Map,pe="r5v",se=[];function Ve(n){try{return(n||[]).filter(t=>typeof t=="string"&&t.startsWith(`${pe}://`))}catch{return[]}}function ge(n){try{let t=new URL(n);if(t.hostname==="mod"&&t.pathname==="/install"){let r=t.searchParams.get("name")||"",e=t.searchParams.get("version")||"",o=t.searchParams.get("downloadUrl")?.split(",")||"";if(S&&S.webContents&&!S.webContents.isLoading())try{S.webContents.send("deeplink:mod-install",{url:n,name:r,version:e,downloadUrls:o})}catch{}else se.push(n)}}catch{}}function rt(){for(;se.length;){let n=se.shift();ge(n)}}var nt=D.requestSingleInstanceLock();nt?D.on("second-instance",(n,t)=>{try{Ve(t).forEach(e=>ge(e)),S&&(S.isMinimized()&&S.restore(),S.focus())}catch{}}):D.quit();D.on("open-url",(n,t)=>{n.preventDefault(),ge(t)});async function Me(){let n=he("windowState",{width:1150,height:800,x:void 0,y:void 0,isMaximized:!1});S=new Ne({width:n.width,height:n.height,x:n.x,y:n.y,minWidth:1150,minHeight:800,frame:!1,titleBarStyle:"hidden",webPreferences:{preload:p.join(X,"preload.cjs"),contextIsolation:!0,nodeIntegration:!1},show:!1,icon:p.join(X,"..","public","icon.png")});let t=process.env.VITE_DEV_SERVER_URL;if(t)await S.loadURL(t);else{let s=p.join(X,"..","dist","index.html");await S.loadFile(s)}S.webContents.setWindowOpenHandler(({url:s})=>{try{Re.openExternal(s)}catch{}return{action:"deny"}}),S.webContents.on("will-navigate",(s,i)=>{let f=i.startsWith("file:"),c=!!process.env.VITE_DEV_SERVER_URL&&i.startsWith(String(process.env.VITE_DEV_SERVER_URL));if(!f&&!c){s.preventDefault();try{Re.openExternal(i)}catch{}}});let r=()=>{S&&(S.isVisible()||S.show(),S.isFocused()||S.focus())};n.isMaximized&&S.maximize(),S.once("ready-to-show",r),S.webContents.once("did-finish-load",r);let e=setTimeout(r,1e3);S.on("show",()=>clearTimeout(e));function o(){if(!S)return;let s=S.getBounds(),i=S.isMaximized();re("windowState",{width:s.width,height:s.height,x:s.x,y:s.y,isMaximized:i})}S.on("resize",o),S.on("move",o),S.on("maximize",o),S.on("unmaximize",o),(!!process.env.VITE_DEV_SERVER_URL||process.env.NODE_ENV==="development")&&S.webContents.openDevTools({mode:"detach"}),S.webContents.on("did-fail-load",(s,i,f,c)=>{console.error("Load failed",{errorCode:i,errorDesc:f,validatedURL:c}),ye.showErrorBox("Load failed",`${f} (code ${i})
URL: ${c}`),S.show()})}D.on("window-all-closed",()=>{process.platform!=="darwin"&&D.quit()});D.whenReady().then(()=>{try{process.defaultApp&&process.platform==="win32"?D.setAsDefaultProtocolClient(pe,process.execPath,[process.argv[1]]):D.setAsDefaultProtocolClient(pe)}catch{}let n=p.resolve(D.getAppPath(),".."),t=p.join(n,"cache");_e.registerFileProtocol("r5v",(e,o)=>{try{let a=new URL(e.url),s=decodeURIComponent(a.pathname).replace(/^\//,""),i=p.normalize(p.join(t,s));o({path:i})}catch{o({error:-6})}});let r=p.join(X,"..","dist");_e.interceptFileProtocol("file",(e,o)=>{try{let a=new URL(e.url),s=decodeURIComponent(a.pathname),i=s.replace(/\\/g,"/"),f=i.indexOf("/_astro/");if(f!==-1){let c=i.substring(f+8),u=p.join(r,"_astro",c);return o({path:u})}if(i.endsWith("/favicon.svg")||/\/favicon\.svg$/i.test(i)){let c=p.join(r,"favicon.svg");return o({path:c})}if(i.startsWith("/")){let c=i.replace(/^\/+/,""),u=p.join(r,c);try{return y.accessSync(u),o({path:u})}catch{}}return o({path:s})}catch{return o({error:-6})}}),Me();try{Ve(process.argv).forEach(e=>se.push(e))}catch{}try{S?.webContents?.once("did-finish-load",rt)}catch{}try{V.autoDownload=!1;try{V.logger=Te,Te.transports.file.level="info"}catch{}V.on("error",e=>{try{S?.webContents.send("update:error",{message:String(e?.stack||e?.message||e)})}catch{}}),V.on("update-available",e=>{try{S?.webContents.send("update:available",e)}catch{}}),V.on("update-not-available",e=>{try{S?.webContents.send("update:not-available",e)}catch{}}),V.on("download-progress",e=>{try{S?.webContents.send("update:download-progress",e)}catch{}}),V.on("update-downloaded",e=>{try{S?.webContents.send("update:downloaded",e)}catch{}})}catch{}D.on("activate",()=>{Ne.getAllWindows().length===0&&Me()})});x.handle("update:check",async()=>{try{return{ok:!0,result:(await V.checkForUpdates())?.updateInfo||null}}catch(n){return{ok:!1,error:String(n?.message||n)}}});x.handle("update:download",async()=>{try{return await V.downloadUpdate(),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});x.handle("update:quitAndInstall",async()=>{try{return setImmediate(()=>V.quitAndInstall(!1,!0)),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});x.handle("app:getVersion",async()=>{try{return D.getVersion()}catch{return"0.0.0"}});x.handle("app:getBaseDir",async()=>{try{return p.resolve(D.getAppPath(),"..")}catch{return""}});x.handle("app:getLauncherInstallRoot",async()=>{try{let n=process.env.LOCALAPPDATA||p.join(D.getPath("home"),"AppData","Local");return p.join(n,"Programs","r5vlauncher")}catch{return""}});function ot(n){try{let t=p.join(n,"mods.vdf"),r=y.readFileSync(t,"utf-8"),e={},o=/"([^"]+)"\s*"([01])"/g,a;for(;a=o.exec(r);){let s=a[1];s&&s!=="ModList"&&(e[s]=a[2]==="1")}return e}catch{return{}}}function we(n){try{let t=p.join(n,"mods.vdf"),r=y.readFileSync(t,"utf-8"),e={},o=[],a=/"([^"]+)"\s*"([01])"/g,s;for(;s=a.exec(r);){let i=s[1];!i||i==="ModList"||(i in e||o.push(i),e[i]=s[2]==="1")}return{map:e,order:o}}catch{return{map:{},order:[]}}}function me(n){try{let t=y.readFileSync(n,"utf-8"),r=t.match(/"id"\s*"([^"]+)"/i),e=t.match(/"name"\s*"([^"]+)"/i),o=r?r[1]:null,a=e?e[1]:null;return{id:o,name:a}}catch{return{id:null,name:null}}}function st(n,t){let r=['"ModList"',"{"];for(let[e,o]of Object.entries(t))r.push(`	"${e}"		"${o?"1":"0"}"`);r.push("}"),y.mkdirSync(n,{recursive:!0}),y.writeFileSync(p.join(n,"mods.vdf"),r.join(`
`),"utf-8")}function Ie(n,t,r){let e=new Set,o=['"ModList"',"{"],a=s=>{o.push(`	"${s}"		"${r[s]?"1":"0"}"`),e.add(s)};for(let s of Array.isArray(t)?t:[])Object.prototype.hasOwnProperty.call(r,s)&&!e.has(s)&&a(s);for(let s of Object.keys(r))e.has(s)||a(s);o.push("}"),y.mkdirSync(n,{recursive:!0}),y.writeFileSync(p.join(n,"mods.vdf"),o.join(`
`),"utf-8")}x.handle("mods:listInstalled",async(n,{installDir:t})=>{try{let r=p.join(t,"mods"),{map:e,order:o}=we(r),a=[],s=y.existsSync(r)?y.readdirSync(r,{withFileTypes:!0}):[];for(let f of s){if(!f.isDirectory())continue;let c=p.join(r,f.name),u=p.join(c,"manifest.json"),d=p.join(c,"mod.vdf"),l=p.join(c,"icon.png"),g=null;try{g=JSON.parse(y.readFileSync(u,"utf-8"))}catch{}let v=me(d),h=v.id||g?.name||f.name,k=null;try{k=`data:image/png;base64,${y.readFileSync(l).toString("base64")}`}catch{}a.push({id:h,name:g?.name||v.name||f.name,folder:f.name,version:g?.version_number||null,description:g?.description||"",enabled:h?!!e[h]:!1,hasManifest:y.existsSync(u),iconDataUrl:k})}let i=new Map(o.map((f,c)=>[f,c]));return a.sort((f,c)=>{let u=f.id!=null&&i.has(f.id)?i.get(f.id):Number.MAX_SAFE_INTEGER,d=c.id!=null&&i.has(c.id)?i.get(c.id):Number.MAX_SAFE_INTEGER;return u!==d?u-d:String(f.name||"").localeCompare(String(c.name||""))}),{ok:!0,mods:a}}catch(r){return{ok:!1,error:String(r?.message||r)}}});x.handle("mods:setEnabled",async(n,{installDir:t,name:r,enabled:e})=>{try{let o=p.join(t,"mods"),{map:a}=we(o);return a[r]=!!e,Ie(o,void 0,a),{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}});x.handle("mods:reorder",async(n,{installDir:t,orderIds:r})=>{try{let e=p.join(t,"mods"),{map:o,order:a}=we(e),s=Array.isArray(r)?r.filter(u=>typeof u=="string"&&u&&Object.prototype.hasOwnProperty.call(o,u)):[],i=new Set(s),f=a.filter(u=>Object.prototype.hasOwnProperty.call(o,u)&&!i.has(u)),c=[...s,...f];return Ie(e,c,o),{ok:!0}}catch(e){return{ok:!1,error:String(e?.message||e)}}});x.handle("mods:uninstall",async(n,{installDir:t,folder:r})=>{try{let e=p.join(t,"mods"),o=p.join(e,r);return y.rmSync(o,{recursive:!0,force:!0}),{ok:!0}}catch(e){return{ok:!1,error:String(e?.message||e)}}});x.handle("mods:fetchAll",async(n,{query:t})=>{let r="https://thunderstore.io/c/r5valkyrie/api/v1/package-listing-index/",e=a=>new Promise((s,i)=>{Z.get(a,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"*/*"}},c=>{if(c.statusCode&&c.statusCode>=300&&c.statusCode<400&&c.headers.location){c.resume();let d=c.headers.location.startsWith("http")?c.headers.location:new URL(c.headers.location,a).toString();return s(e(d))}if(c.statusCode!==200)return c.resume(),i(new Error(`HTTP ${c.statusCode}`));let u=[];c.on("data",d=>u.push(Buffer.isBuffer(d)?d:Buffer.from(d))),c.on("end",()=>s(Buffer.concat(u)))}).on("error",i)}),o=a=>{try{return Ze.gunzipSync(a)}catch{return a}};try{let a=await e(r),s=JSON.parse(o(a).toString("utf8")),i=Array.isArray(s)?s:[],f=6,c=[],u=0;await Promise.all(Array.from({length:f}).map(async()=>{for(;u<i.length;){let l=u++,g=i[l];try{let v=await e(g),h=o(v).toString("utf8"),k=JSON.parse(h);Array.isArray(k)&&c.push(...k)}catch{}}}));let d=c;if(t&&String(t).trim()){let l=String(t).toLowerCase();d=d.filter(g=>String(g?.name||"").toLowerCase().includes(l)||String(g?.full_name||"").toLowerCase().includes(l))}return{ok:!0,mods:d}}catch(a){try{let i=await e("https://thunderstore.io/c/r5valkyrie/api/v1/package/"),f=JSON.parse(i.toString("utf8")),c=Array.isArray(f)?f:[];if(t&&String(t).trim()){let u=String(t).toLowerCase();c=c.filter(d=>String(d?.name||"").toLowerCase().includes(u)||String(d?.full_name||"").toLowerCase().includes(u))}return{ok:!0,mods:c}}catch(s){return{ok:!1,error:String(s?.message||a?.message||s||a)}}}});x.handle("mods:install",async(n,{installDir:t,name:r,downloadUrl:e})=>{if(!e.startsWith("https://thunderstore.io"))return{ok:!1,error:"Download URL does not point to Thunderstore"};try{let o=String(r||"").trim();if(!o)return{ok:!1,error:"Invalid mod name"};if(fe.has(o))return{ok:!0};fe.add(o);let a=p.join(t,"mods");y.mkdirSync(a,{recursive:!0});let s=p.join(a,`.__mod_${Date.now()}.zip`),i=(d,l=0)=>new Promise((g,v)=>{if(l>5)return v(new Error("Too many redirects"));let h=y.createWriteStream(s);Z.get(d,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"application/octet-stream,*/*;q=0.8",Referer:"https://thunderstore.io/",Connection:"keep-alive"}},w=>{if(w.statusCode&&w.statusCode>=300&&w.statusCode<400&&w.headers.location){w.resume(),h.close(()=>{});try{y.unlinkSync(s)}catch{}let $=w.headers.location.startsWith("http")?w.headers.location:new URL(w.headers.location,d).toString();return g(i($,l+1))}if(w.statusCode!==200){h.close(()=>{});try{y.unlinkSync(s)}catch{}return w.resume(),v(new Error(`HTTP ${w.statusCode}`))}let E=Number(w.headers["content-length"]||0),m=0,C=Date.now(),A=$=>{try{n?.sender?.send("mods:progress",{key:r,phase:$,received:m,total:E})}catch{}};w.on("data",$=>{m+=Buffer.isBuffer($)?$.length:Buffer.byteLength(String($));let M=Date.now();M-C>150&&(C=M,A("downloading"))}),w.pipe(h),h.on("finish",()=>{A("downloading"),h.close(g)})}).on("error",w=>{try{y.unlinkSync(s)}catch{}v(w)})});await i(e);try{n?.sender?.send("mods:progress",{key:r,phase:"extracting"})}catch{}let f=p.join(a,r);try{y.rmSync(f,{recursive:!0,force:!0})}catch{}y.mkdirSync(f,{recursive:!0}),await new Promise((d,l)=>{let g=Q("powershell.exe",["-NoProfile","-NonInteractive","-Command",`Expand-Archive -LiteralPath "${s}" -DestinationPath "${f}" -Force`],{stdio:"ignore"});g.on("exit",v=>v===0?d():l(new Error(`Expand-Archive failed ${v}`))),g.on("error",l)});try{y.unlinkSync(s)}catch{}let c=null;try{let d=p.join(f,"mod.vdf");if(y.existsSync(d))c=me(d).id;else{let l=y.readdirSync(f,{withFileTypes:!0});for(let g of l)if(g.isDirectory()){let v=p.join(f,g.name,"mod.vdf");if(y.existsSync(v)&&(c=me(v).id,c))break}}}catch{}let u=ot(a);u[c||r]=!0,st(a,u);try{n?.sender?.send("mods:progress",{key:r,phase:"done"})}catch{}return{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}finally{try{fe.delete(String(r||""))}catch{}}});x.handle("mods:watch",async(n,{installDir:t})=>{try{let r=p.join(t,"mods");if(!y.existsSync(r))return{ok:!0};let e=r;if(ne.has(e))return{ok:!0};let o=y.watch(r,{persistent:!0},(a,s)=>{let i=e;clearTimeout(oe.get(i));let f=setTimeout(()=>{try{S?.webContents?.send("mods:changed",{installDir:t})}catch{}},300);oe.set(i,f)});return ne.set(e,o),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});x.handle("mods:unwatch",async(n,{installDir:t})=>{try{let e=p.join(t,"mods"),o=ne.get(e);if(o){try{o.close()}catch{}ne.delete(e)}let a=oe.get(e);return a&&(clearTimeout(a),oe.delete(e)),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});x.handle("mods:iconDataUrl",async(n,{installDir:t,folder:r})=>{try{let e=p.join(t,"mods",r,"icon.png");return await y.promises.access(e),{ok:!0,dataUrl:`data:image/png;base64,${(await y.promises.readFile(e)).toString("base64")}`}}catch(e){return{ok:!1,error:String(e?.message||e)}}});x.handle("select-directory",async()=>{let n=await ye.showOpenDialog({properties:["openDirectory","createDirectory"]});return n.canceled||n.filePaths.length===0?null:n.filePaths[0]});x.handle("settings:get",()=>ue());x.handle("settings:set",(n,{key:t,value:r})=>re(t,r));x.handle("download:checksums",async(n,{baseUrl:t})=>be(t));x.handle("download:all",async(n,{baseUrl:t,checksums:r,installDir:e,includeOptional:o,concurrency:a,partConcurrency:s,channelName:i,mode:f})=>{let c=(u,d)=>n.sender.send(u,d);try{if(!(String(f||"install").toLowerCase()==="install")){let d=p.join(e,"mods","mods.vdf");if(y.existsSync(d)){let g=(Array.isArray(r?.files)?r.files:[]).filter(v=>{try{return String(v?.path||v?.name||"").replace(/\\/g,"/").toLowerCase()!=="mods/mods.vdf"}catch{return!0}});r={...r||{},files:g}}}}catch{}q=Ae(),Y=!1;try{await De(t,r,e,c,!!o,Number(a)||4,Number(s)||4,q,()=>Y);try{let u=he("channels",{})||{};u[String(i||"default")]={installDir:e,gameVersion:r?.game_version||null,gameBaseUrl:t,lastUpdatedAt:Date.now()},re("channels",u)}catch(u){console.error("Failed to persist channel info",u)}}finally{q=null}return!0});x.handle("default-install-dir",(n,{channelName:t})=>{let r="";if(process.platform==="win32"){let e=process.env.LOCALAPPDATA||p.join(D.getPath("home"),"AppData","Local");r=p.join(e,"Programs","R5VLibrary")}else if(process.platform==="linux"){let e=p.join(D.getPath("home"),"Games");r=p.join(e,"R5VLibrary")}return t?p.join(r,t):r});x.handle("launcher:config",async(n,{url:t})=>(e=>new Promise((o,a)=>{Z.get(e,s=>{if(s.statusCode!==200){a(new Error(`HTTP ${s.statusCode} for ${e}`)),s.resume();return}let i="";s.setEncoding("utf8"),s.on("data",f=>i+=f),s.on("end",()=>{try{o(JSON.parse(i))}catch(f){a(f)}})}).on("error",a)}))(t));x.handle("eula:get",async()=>{let n="https://playvalkyrie.org/api/eula",t=r=>new Promise((e,o)=>{Z.get(r,a=>{if(a.statusCode!==200){o(new Error(`HTTP ${a.statusCode}`)),a.resume();return}let s=[];a.on("data",i=>s.push(Buffer.isBuffer(i)?i:Buffer.from(i))),a.on("end",()=>{try{let i=Buffer.concat(s).toString("utf8");e(JSON.parse(i))}catch(i){o(i)}})}).on("error",o)});try{return{ok:!0,json:await t(n)}}catch(r){return{ok:!1,error:String(r?.message||r)}}});x.handle("video:cache",async(n,{filename:t})=>{try{let e=`https://blaze.playvalkyrie.org/video_backgrounds/${t}`,o=p.join(p.resolve(D.getAppPath(),".."),"cache"),a=p.join(o,"videos"),s=p.join(a,t),i=p.join(X,"..","dist"),f=p.join(i,t);await y.promises.mkdir(a,{recursive:!0});try{if((await y.promises.stat(s)).size>0){try{await y.promises.access(f)}catch{await y.promises.copyFile(s,f)}return`./${t}`}else await y.promises.unlink(s)}catch{}return await new Promise((c,u)=>{let d=y.createWriteStream(s),l=Z.get(e,g=>{if(g.statusCode!==200){d.close(()=>{}),y.unlink(s,()=>{}),u(new Error(`HTTP ${g.statusCode} for video ${t}`)),g.resume();return}g.pipe(d),d.on("finish",()=>d.close(c)),d.on("error",v=>{y.unlink(s,()=>u(v))})});l.on("error",g=>{d.close(()=>{}),y.unlink(s,()=>{}),u(g)}),l.setTimeout(3e4,()=>{l.destroy(),d.close(()=>{}),y.unlink(s,()=>{}),u(new Error(`Video download timeout for ${t}`))})}),await y.promises.copyFile(s,f),`./${t}`}catch(r){throw console.error(`Video cache error for ${t}:`,r),r}});x.handle("fs:is-installed-in-dir",async(n,{path:t})=>{let r=!1,e=!1;try{await y.promises.access(p.join(t,"r5apex.exe")),r=!0}catch{}try{await y.promises.access(p.join(t,"r5apex_ds.exe")),e=!0}catch{}return r||e});var Y=!1;x.handle("download:pause",async()=>{Y=!0;try{S?.webContents.send("progress:paused",{})}catch{}return!0});x.handle("download:resume",async()=>{Y=!1;try{S?.webContents.send("progress:resumed",{})}catch{}return!0});x.handle("download:cancel",async()=>{try{ce(q)}catch{}q=null,Y=!1;try{S?.webContents.send("progress:cancelled",{})}catch{}return!0});x.handle("select-file",async(n,{filters:t})=>{let r=await ye.showOpenDialog({properties:["openFile"],filters:Array.isArray(t)?t:void 0});return r.canceled||r.filePaths.length===0?null:r.filePaths[0]});x.handle("game:launch",async(n,{channelName:t,installDir:r,mode:e,argsString:o,winePrefix:a})=>{try{if(!r)throw new Error("Missing installDir");let s=String(e).toUpperCase()==="SERVER"?"r5apex_ds.exe":"r5apex.exe",i=p.join(r,s);await y.promises.access(i).catch(()=>{throw new Error(`Executable not found: ${i}`)});let c=(d=>!d||typeof d!="string"?[]:(d.match(/(?:[^\s\"]+|\"[^\"]*\")+/g)||[]).map(g=>g.replace(/^\"|\"$/g,"")))(o),u;if(process.platform==="win32")u=Q(i,c,{cwd:r,detached:!0,stdio:"ignore",env:{...process.env}});else if(process.platform==="linux"){let d=a||p.join(D.getPath("home"),"Games","R5VLibrary","wineprefix");c.unshift(i);let l=p.join(D.getPath("home"),".local","share","Steam"),g=p.join(d,"drive_c","Program Files (x86)","Steam");y.mkdirSync(g,{recursive:!0}),["GameOverlayRenderer64.dll","steamclient64.dll","steamclient.dll"].forEach(h=>{let k=p.join(l,h),w=p.join(g,h);if(!y.existsSync(k))throw new Error(`Steam is not installed correctly!
Source file not found: ${k}`);y.existsSync(w)?console.log(`Skipped (exists): ${h}`):(y.copyFileSync(k,w),console.log(`Copied: ${h}`))}),u=Q("umu-run",c,{cwd:r,detached:!0,stdio:"ignore",env:{...process.env,WINEPREFIX:d}})}return u.unref(),{ok:!0}}catch(s){return{ok:!1,error:String(s?.message||s)}}});x.handle("fix-folder-permissions",async(n,{selectedChannel:t})=>{let r=[],e=ue().channels[t].installDir;try{if(!e)return{ok:!1,error:"No folder path provided"};let o=p.resolve(e).replace(/\//g,"\\");if(!o||o.length<3)return{ok:!1,error:`Invalid path format: ${e}`};let a=o.length>=3&&o[1]===":"?o.slice(3):o;if(/[<>:"|?*]/.test(a))return{ok:!1,error:`Path contains invalid characters: ${o}`};let f=et.userInfo().username,c=p.join(process.resourcesPath,"elevate.exe"),u=y.existsSync(c);try{y.mkdirSync(o,{recursive:!0})}catch{}let d=[{exe:"icacls",args:[o,"/grant",`${f}:F`,"/t","/q"],desc:`Grant permissions to current user (${f})`},{exe:"icacls",args:[o,"/grant","Everyone:F","/t","/q"],desc:"Grant Everyone full permissions"},{exe:"icacls",args:[o,"/grant","Users:F","/t","/q"],desc:"Grant Users full permissions"}];for(let l=0;l<d.length;l++){let{exe:g,args:v,desc:h}=d[l];try{let k=await new Promise((w,E)=>{let m,C,A;u?(C=[c,["-wait",g,...v]],A={stdio:["ignore","pipe","pipe"],windowsHide:!0}):(C=[g,v],A={stdio:["ignore","pipe","pipe"],windowsHide:!0});try{m=Q(C[0],C[1],A)}catch(_){console.error("[Permission Fix] Spawn failed:",_),E(_);return}let $="",M="";m.stdout&&m.stdout.on("data",_=>{$+=_.toString()}),m.stderr&&m.stderr.on("data",_=>{M+=_.toString()}),m.on("exit",(_,I)=>{w({code:_,stdout:$,stderr:M,signal:I})}),m.on("error",_=>{E(_)}),setTimeout(()=>{try{m.kill()}catch{}E(new Error("Command timeout"))},3e4)});if(k.code!==0){let w=k.stderr||k.stdout||"Unknown error";if(!(w.includes("duplicate")||w.includes("already")||k.code===1332)){let m=`${h} failed (code ${k.code}): ${w}`;r.push(m)}}}catch(k){let w=`${h} error: ${k.message}`;r.push(w)}}try{let l=p.join(o,"test_write.tmp");y.writeFileSync(l,"test"),y.unlinkSync(l)}catch(l){let g=`Write test failed: ${l.message}`;r.push(g);try{if(y.mkdirSync(o,{recursive:!0}),(await new Promise(h=>{let k=Q("cmd",["/c",`icacls "${o}" /grant "%USERNAME%":F /q`],{stdio:"ignore",windowsHide:!0});k.on("exit",w=>h({code:w})),k.on("error",()=>h({code:1})),setTimeout(()=>{try{k.kill()}catch{}h({code:1})},5e3)})).code===0){let h=p.join(o,"test_write2.tmp");return y.writeFileSync(h,"test"),y.unlinkSync(h),{ok:!0,warnings:r}}}catch{}return{ok:!1,error:g,details:r}}return r.length>0?{ok:!0,warnings:r}:{ok:!0}}catch(o){let a=`Unexpected error: ${o?.message||o}`;return r.push(a),{ok:!1,error:a,details:r}}});x.on("window:minimize",()=>{S?.minimize()});x.on("window:maximize",()=>{S&&(S.isMaximized()?S.unmaximize():S.maximize())});x.on("window:close",()=>{S?.close()});D.on("before-quit",()=>{if(q)try{ce(q)}catch{}});
