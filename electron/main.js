import{app as D,BrowserWindow as mt,ipcMain as E,dialog as nt,protocol as pt,shell as J}from"electron";import{createRequire as $t}from"node:module";import u from"node:path";import{fileURLToPath as bt,pathToFileURL as Zt}from"node:url";import O from"node:https";import S from"node:fs";import{spawn as wt}from"node:child_process";import Nt from"node:os";import C from"node:fs";import q from"node:path";import Et from"node:crypto";import{pipeline as vt}from"node:stream";import{promisify as kt}from"node:util";import Y from"node:https";var Pt=kt(vt);function K(n){return String(n||"").replace(/\\/g,"/").replace(/^\/+/,"")}function at(n){return String(n||"").replace(/\\/g,"/").toLowerCase()}var W=new Map,Ct=new Y.Agent({keepAlive:!0,maxSockets:32,maxFreeSockets:16,keepAliveMsecs:3e4});function H(n){return new Promise((t,a)=>{let e=Et.createHash("sha256"),r=C.createReadStream(n);r.on("error",a),r.on("end",()=>t(e.digest("hex"))),r.on("data",o=>e.update(o))})}function ot(n){C.mkdirSync(n,{recursive:!0})}function xt(n){return new Promise((t,a)=>{Y.get(n,e=>{if(e.statusCode!==200){a(new Error(`HTTP ${e.statusCode} for ${n}`)),e.resume();return}let r="";e.setEncoding("utf8"),e.on("data",o=>r+=o),e.on("end",()=>{try{t(JSON.parse(r))}catch(o){a(o)}})}).on("error",a)})}function M(n){return new Promise(t=>setTimeout(t,n))}function st(){return{cancelled:!1,requests:new Set}}function Z(n){if(n){n.cancelled=!0;for(let t of n.requests)try{t.destroy(new Error("cancelled"))}catch{}n.requests.clear()}}var At=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE"]);async function z(n,t,a,e=1,r,o=0,s=0){return new Promise((c,f)=>{ot(q.dirname(t));let h=C.createWriteStream(t,{flags:o>0?"a":"w"});if(r?.cancelled)return h.close(()=>{}),f(new Error("cancelled"));let l={agent:Ct};o>0&&(l.headers={Range:`bytes=${o}-`});let y=Y.get(n,l,d=>{if(d.statusCode!==200&&!(o>0&&d.statusCode===206)){if(h.close(()=>{}),o>0&&d.statusCode===200){try{C.unlinkSync(t)}catch{}let v=Math.min(2e3*e,1e4);d.resume();try{y.destroy(new Error("restart:range-ignored"))}catch{}return M(v).then(()=>c(z(n,t,a,e+1,r,0,s)))}if(C.unlink(t,()=>{}),d.statusCode&&[429,500,502,503,504].includes(d.statusCode)&&e<5){let v=Math.min(2e3*e,1e4);return d.resume(),M(v).then(()=>c(z(n,t,a,e+1,r,o,s)))}f(new Error(`HTTP ${d.statusCode} for ${n}`)),d.resume();return}let k=Number(d.headers["content-length"]||0),P=s>0?s:o>0?o+k:k,x=0,i=Date.now(),p=e<=2?6e4:9e4,g=setInterval(()=>{if(!r?.cancelled&&Date.now()-i>p)try{let v=new Error("stalled");v.code="ETIMEDOUT",y.destroy(v)}catch{}},1e4);d.on("data",v=>{x+=v.length,i=Date.now(),a&&a(Math.min(o+x,P||o+x),P||0)}),d.on("aborted",async()=>{let v=new Promise(m=>h.close(()=>m()));try{clearInterval(g)}catch{}try{await v}catch{}if(e<5){let m=Math.min(2e3*e,1e4);return M(m).then(()=>c(z(n,t,a,e+1,r,o+x,s)))}f(new Error("response aborted"))}),Pt(d,h).then(()=>{try{clearInterval(g)}catch{}c()}).catch(v=>{try{clearInterval(g)}catch{}f(v)})});if(r?.requests.add(y),y.on("socket",d=>{try{d.setKeepAlive(!0,6e4),d.setNoDelay(!0)}catch{}}),y.on("close",()=>r?.requests.delete(y)),y.setTimeout(45e3,()=>{try{let d=new Error("Request timeout");d.code="ETIMEDOUT",y.destroy(d)}catch{}}),r?.cancelled)try{y.destroy(new Error("cancelled"))}catch{}y.on("error",async d=>{let k=d?.code,P=e<5&&k&&At.has(String(k)),x=new Promise(i=>{try{h.close(()=>i())}catch{i()}});try{await x}catch{}if(P){let i=Math.min(2e3*e,1e4),p=o;try{p=C.statSync(t).size}catch{}return M(i).then(()=>c(z(n,t,a,e+1,r,p,s)))}f(d)})})}async function Rt(n,t,a){try{let e=C.statSync(n);return a&&Number(a)>0&&e.size!==Number(a)?!1:(await H(n)).toLowerCase()===String(t).toLowerCase()}catch{return!1}}async function ct(n){let t=`${n.replace(/\/$/,"")}/checksums.json`;return xt(t)}async function Dt(n,t,a,e,r=4,o){let s=K(t.path).split("/").join(q.sep),c=q.join(a,s);if(ot(q.dirname(c)),await Rt(c,t.checksum,t.size)){e("progress:skip",{path:t.path});return}if(o?.cancelled)throw new Error("cancelled");if(Array.isArray(t.parts)&&t.parts.length>0){let h=t.parts.length,l=new Array(h),y=0,d=new Set;async function k(){for(;;){let i=y++;if(i>=h)return;if(d.has(i))continue;d.add(i);let p=t.parts[i],g=K(p.path),v=`${n.replace(/\/$/,"")}/${g}`,m=`${c}.part${i}`;try{if(C.existsSync(m))if((await H(m)).toLowerCase()===String(p.checksum).toLowerCase()){e("progress:part",{path:t.path,part:i,totalParts:h,received:Number(p.size||0),total:Number(p.size||0)}),l[i]=m;continue}else try{C.unlinkSync(m)}catch{}}catch{}let A=0;for(;;){if(o?.cancelled)throw new Error("cancelled");A+=1;let R=0,U=0;try{let L=0;try{L=C.statSync(m).size}catch{}let T=Number(p.size||0);if(T>0&&L>T)try{C.unlinkSync(m),L=0}catch{}await z(v,m,($,V)=>{let N=Math.max(0,$-U);U=$;try{N>0&&e("progress:bytes",{delta:N})}catch{}R+=N;let G=T||V||0;e("progress:part",{path:t.path,part:i,totalParts:h,received:Math.min($,G||$),total:G})},1,o,L,T)}catch{try{C.unlinkSync(m)}catch{}try{R>0&&e("progress:bytes",{delta:-R})}catch{}try{e("progress:part:reset",{path:t.path,part:i,totalParts:h})}catch{}let T=Math.min(2e3*A,1e4);await M(T);continue}if((await H(m)).toLowerCase()===String(p.checksum).toLowerCase())break;try{C.unlinkSync(m)}catch{}try{R>0&&e("progress:bytes",{delta:-R})}catch{}try{e("progress:part:reset",{path:t.path,part:i,totalParts:h})}catch{}let F=Math.min(2e3*A,1e4);await M(F)}l[i]=m}}let P=Array.from({length:Math.max(1,r)},()=>k());await Promise.all(P),e("progress:merge:start",{path:t.path,parts:l.length});let x=C.createWriteStream(c);for(let i=0;i<l.length;i++){let p=l[i];e("progress:merge:part",{path:t.path,part:i,totalParts:l.length}),await new Promise((g,v)=>{let m=C.createReadStream(p);m.on("error",v),x.on("error",v),m.on("end",()=>{try{C.unlinkSync(p)}catch{}g()}),m.pipe(x,{end:!1})})}await new Promise((i,p)=>{x.on("error",p),x.on("finish",i),x.end()});try{e("progress:merge:done",{path:t.path})}catch{}}else{let h=K(t.path),l=`${n.replace(/\/$/,"")}/${h}`,y=0;for(;;){y+=1;let d=0,k=0,P=`${c}.download`,x=0;try{x=C.statSync(P).size}catch{}let i=Number(t.size||0);if(i>0&&x>i)try{C.unlinkSync(P),x=0}catch{}if(await z(l,P,(g,v)=>{let m=Math.max(0,g-k);k=g;try{m>0&&e("progress:bytes",{delta:m})}catch{}d+=m;let A=i||v||0;e("progress:file",{path:t.path,received:Math.min(g,A||g),total:A})},1,o,x,i),(await H(P)).toLowerCase()===String(t.checksum).toLowerCase())break;try{C.unlinkSync(P)}catch{}try{d>0&&e("progress:bytes",{delta:-d})}catch{}if(y>=2)throw new Error(`Checksum mismatch for ${t.path}`)}try{C.unlinkSync(c)}catch{}C.renameSync(`${c}.download`,c)}if(e("progress:verify",{path:t.path}),(await H(c)).toLowerCase()!==String(t.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${t.path}`)}async function it(n,t,a,e,r=!1,o=4,s=4,c){let f=new Set,h=[];for(let p of t.files||[]){if(!(r||!p.optional))continue;let g=at(p.path);g&&(f.has(g)||(f.add(g),h.push(p)))}let l=h.filter(p=>!(Array.isArray(p.parts)&&p.parts.length>0)),y=h.filter(p=>Array.isArray(p.parts)&&p.parts.length>0),d=l.concat(y),k=d.length,P=0,x=d.reduce((p,g)=>{let v=Number(g.size||0);return v>0?p+v:Array.isArray(g.parts)&&g.parts.length?p+g.parts.reduce((m,A)=>m+Number(A.size||0),0):p},0);try{e("progress:bytes:total",{totalBytes:x})}catch{}async function i(p,g,v){let m=0;async function A(){for(;;){let U=m++;if(U>=p.length)return;let b=p[U],F=g+U,L=at(b.path),T=async()=>Dt(n,b,a,e,s,c),$=!1,V=W.get(L);V?$=!0:(e("progress:start",{index:F,total:k,path:b.path,completed:P}),V=(async()=>{try{await T()}catch(N){if(String(N?.message||N||"error").includes("cancelled"))throw N;try{let B=q.join(a,b.path.replace(/\\/g,q.sep));try{C.unlinkSync(B)}catch{}await T()}catch(B){try{e("progress:error",{path:b.path,message:String(B?.message||B)})}catch{}}}})(),W.set(L,V));try{await V}finally{$||W.delete(L)}P+=1,e("progress:done",{index:F,total:k,path:b.path,completed:P}),await M(10)}}let R=Array.from({length:Math.max(1,v)},()=>A());await Promise.all(R)}if(await i(l,0,Math.max(1,o)),W.size>0)try{await Promise.all([...W.values()])}catch{}await i(y,l.length,1)}import Q from"node:fs";import _t from"node:path";import{app as Lt}from"electron";var lt=Lt.getPath("userData"),dt=_t.join(lt,"settings.json");function X(){try{let n=Q.readFileSync(dt,"utf-8");return JSON.parse(n)}catch{return{}}}function Tt(n){Q.mkdirSync(lt,{recursive:!0}),Q.writeFileSync(dt,JSON.stringify(n,null,2),"utf-8")}function ht(n,t=void 0){return X()[n]??t}function tt(n,t){let a=X();a[n]=t,Tt(a)}function ut(){return X()}var gt=$t(import.meta.url),{autoUpdater:_}=gt("electron-updater"),ft=gt("electron-log"),Mt=bt(import.meta.url),j=u.dirname(Mt);var w,I=null;async function yt(){w=new mt({width:1150,height:800,minWidth:1150,minHeight:800,frame:!1,titleBarStyle:"hidden",webPreferences:{preload:u.join(j,"preload.cjs"),contextIsolation:!0,nodeIntegration:!1},show:!1,icon:u.join(j,"..","public","icon.png")});let n=process.env.VITE_DEV_SERVER_URL;if(n)await w.loadURL(n);else{let r=u.join(j,"..","dist","index.html");await w.loadFile(r)}w.webContents.setWindowOpenHandler(({url:r})=>{try{J.openExternal(r)}catch{}return{action:"deny"}}),w.webContents.on("will-navigate",(r,o)=>{let s=o.startsWith("file:"),c=!!process.env.VITE_DEV_SERVER_URL&&o.startsWith(String(process.env.VITE_DEV_SERVER_URL));if(!s&&!c){r.preventDefault();try{J.openExternal(o)}catch{}}});let t=()=>{w&&(w.isVisible()||w.show(),w.isFocused()||w.focus())};w.once("ready-to-show",t),w.webContents.once("did-finish-load",t);let a=setTimeout(t,1e3);w.on("show",()=>clearTimeout(a)),(!!process.env.VITE_DEV_SERVER_URL||process.env.NODE_ENV==="development")&&w.webContents.openDevTools({mode:"detach"}),w.webContents.on("did-fail-load",(r,o,s,c)=>{console.error("Load failed",{errorCode:o,errorDesc:s,validatedURL:c}),nt.showErrorBox("Load failed",`${s} (code ${o})
URL: ${c}`),w.show()})}D.on("window-all-closed",()=>{process.platform!=="darwin"&&D.quit()});D.whenReady().then(()=>{let n=u.resolve(D.getAppPath(),".."),t=u.join(n,"cache");pt.registerFileProtocol("r5v",(e,r)=>{try{let o=new URL(e.url),s=decodeURIComponent(o.pathname).replace(/^\//,""),c=u.normalize(u.join(t,s));r({path:c})}catch{r({error:-6})}});let a=u.join(j,"..","dist");pt.interceptFileProtocol("file",(e,r)=>{try{let o=new URL(e.url),s=decodeURIComponent(o.pathname),c=s.replace(/\\/g,"/"),f=c.indexOf("/_astro/");if(f!==-1){let h=c.substring(f+8),l=u.join(a,"_astro",h);return r({path:l})}if(c.endsWith("/favicon.svg")||/\/favicon\.svg$/i.test(c)){let h=u.join(a,"favicon.svg");return r({path:h})}if(c.startsWith("/")){let h=c.replace(/^\/+/,""),l=u.join(a,h);try{return S.accessSync(l),r({path:l})}catch{}}return r({path:s})}catch{return r({error:-6})}}),yt();try{_.autoDownload=!1;try{_.logger=ft,ft.transports.file.level="info"}catch{}_.on("error",e=>{try{w?.webContents.send("update:error",{message:String(e?.stack||e?.message||e)})}catch{}}),_.on("update-available",e=>{try{w?.webContents.send("update:available",e)}catch{}}),_.on("update-not-available",e=>{try{w?.webContents.send("update:not-available",e)}catch{}}),_.on("download-progress",e=>{try{w?.webContents.send("update:download-progress",e)}catch{}}),_.on("update-downloaded",e=>{try{w?.webContents.send("update:downloaded",e)}catch{}})}catch{}D.on("activate",()=>{mt.getAllWindows().length===0&&yt()})});E.handle("update:check",async()=>{try{return{ok:!0,result:(await _.checkForUpdates())?.updateInfo||null}}catch(n){return{ok:!1,error:String(n?.message||n)}}});E.handle("update:download",async()=>{try{return await _.downloadUpdate(),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});E.handle("update:quitAndInstall",async()=>{try{return setImmediate(()=>_.quitAndInstall(!1,!0)),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});E.handle("app:getVersion",async()=>{try{return D.getVersion()}catch{return"0.0.0"}});E.handle("app:getBaseDir",async()=>{try{return u.resolve(D.getAppPath(),"..")}catch{return""}});E.handle("app:getLauncherInstallRoot",async()=>{try{let n=process.env.LOCALAPPDATA||u.join(D.getPath("home"),"AppData","Local");return u.join(n,"Programs","r5vlauncher")}catch{return""}});function rt(n){try{let t=u.join(n,"mods.vdf"),a=S.readFileSync(t,"utf-8"),e={},r=/"([^"]+)"\s*"([01])"/g,o;for(;o=r.exec(a);){let s=o[1];s&&s!=="ModList"&&(e[s]=o[2]==="1")}return e}catch{return{}}}function et(n){try{let t=S.readFileSync(n,"utf-8"),a=t.match(/"id"\s*"([^"]+)"/i),e=t.match(/"name"\s*"([^"]+)"/i),r=a?a[1]:null,o=e?e[1]:null;return{id:r,name:o}}catch{return{id:null,name:null}}}function St(n,t){let a=['"ModList"',"{"];for(let[e,r]of Object.entries(t))a.push(`	"${e}"		"${r?"1":"0"}"`);a.push("}"),S.mkdirSync(n,{recursive:!0}),S.writeFileSync(u.join(n,"mods.vdf"),a.join(`
`),"utf-8")}E.handle("mods:listInstalled",async(n,{installDir:t})=>{try{let a=u.join(t,"mods"),e=rt(a),r=[],o=S.existsSync(a)?S.readdirSync(a,{withFileTypes:!0}):[];for(let s of o){if(!s.isDirectory())continue;let c=u.join(a,s.name),f=u.join(c,"manifest.json"),h=u.join(c,"mod.vdf"),l=null;try{l=JSON.parse(S.readFileSync(f,"utf-8"))}catch{}let y=et(h),d=y.id||l?.name||s.name;r.push({id:d,name:l?.name||y.name||s.name,folder:s.name,version:l?.version_number||null,description:l?.description||"",enabled:d?!!e[d]:!1,hasManifest:S.existsSync(f)})}return{ok:!0,mods:r}}catch(a){return{ok:!1,error:String(a?.message||a)}}});E.handle("mods:setEnabled",async(n,{installDir:t,name:a,enabled:e})=>{try{let r=u.join(t,"mods"),o=rt(r);return o[a]=!!e,St(r,o),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});E.handle("mods:uninstall",async(n,{installDir:t,folder:a})=>{try{let e=u.join(t,"mods"),r=u.join(e,a);return S.rmSync(r,{recursive:!0,force:!0}),{ok:!0}}catch(e){return{ok:!1,error:String(e?.message||e)}}});E.handle("mods:fetchAll",async(n,{query:t})=>{let a="https://thunderstore.io/c/r5valkyrie/api/v1/package/";return new Promise(e=>{O.get(a,r=>{if(r.statusCode!==200)return r.resume(),e({ok:!1,error:`HTTP ${r.statusCode}`});let o="";r.setEncoding("utf8"),r.on("data",s=>o+=s),r.on("end",()=>{try{let s=JSON.parse(o),c=Array.isArray(s)?s:[];if(t&&String(t).trim()){let f=String(t).toLowerCase();c=c.filter(h=>String(h?.name||"").toLowerCase().includes(f)||String(h?.full_name||"").toLowerCase().includes(f))}e({ok:!0,mods:c})}catch(s){e({ok:!1,error:String(s?.message||s)})}})}).on("error",r=>e({ok:!1,error:String(r?.message||r)}))})});E.handle("mods:install",async(n,{installDir:t,name:a,downloadUrl:e})=>{try{let r=u.join(t,"mods");S.mkdirSync(r,{recursive:!0});let o=u.join(Nt.tmpdir(),`mod_${Date.now()}.zip`),s=(l,y=0)=>new Promise((d,k)=>{if(y>5)return k(new Error("Too many redirects"));let P=S.createWriteStream(o);O.get(l,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"application/octet-stream,*/*;q=0.8",Referer:"https://thunderstore.io/",Connection:"keep-alive"}},i=>{if(i.statusCode&&i.statusCode>=300&&i.statusCode<400&&i.headers.location){i.resume(),P.close(()=>{});try{S.unlinkSync(o)}catch{}let A=i.headers.location.startsWith("http")?i.headers.location:new URL(i.headers.location,l).toString();return d(s(A,y+1))}if(i.statusCode!==200){P.close(()=>{});try{S.unlinkSync(o)}catch{}return i.resume(),k(new Error(`HTTP ${i.statusCode}`))}let p=Number(i.headers["content-length"]||0),g=0,v=Date.now(),m=A=>{try{n?.sender?.send("mods:progress",{key:a,phase:A,received:g,total:p})}catch{}};i.on("data",A=>{g+=Buffer.isBuffer(A)?A.length:Buffer.byteLength(String(A));let R=Date.now();R-v>150&&(v=R,m("downloading"))}),i.pipe(P),P.on("finish",()=>{m("downloading"),P.close(d)})}).on("error",i=>{try{S.unlinkSync(o)}catch{}k(i)})});await s(e);try{n?.sender?.send("mods:progress",{key:a,phase:"extracting"})}catch{}let c=u.join(r,a);try{S.rmSync(c,{recursive:!0,force:!0})}catch{}S.mkdirSync(c,{recursive:!0}),await new Promise((l,y)=>{let d=wt("powershell.exe",["-NoProfile","-NonInteractive","-Command",`Expand-Archive -LiteralPath "${o}" -DestinationPath "${c}" -Force`],{stdio:"ignore"});d.on("exit",k=>k===0?l():y(new Error(`Expand-Archive failed ${k}`))),d.on("error",y)});try{S.unlinkSync(o)}catch{}let f=null;try{let l=u.join(c,"mod.vdf");if(S.existsSync(l))f=et(l).id;else{let y=S.readdirSync(c,{withFileTypes:!0});for(let d of y)if(d.isDirectory()){let k=u.join(c,d.name,"mod.vdf");if(S.existsSync(k)&&(f=et(k).id,f))break}}}catch{}let h=rt(r);h[f||a]=!0,St(r,h);try{n?.sender?.send("mods:progress",{key:a,phase:"done"})}catch{}return{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});E.handle("select-directory",async()=>{let n=await nt.showOpenDialog({properties:["openDirectory","createDirectory"]});return n.canceled||n.filePaths.length===0?null:n.filePaths[0]});E.handle("settings:get",()=>ut());E.handle("settings:set",(n,{key:t,value:a})=>tt(t,a));E.handle("download:checksums",async(n,{baseUrl:t})=>ct(t));E.handle("download:all",async(n,{baseUrl:t,checksums:a,installDir:e,includeOptional:r,concurrency:o,partConcurrency:s,channelName:c})=>{let f=(h,l)=>n.sender.send(h,l);I=st();try{await it(t,a,e,f,!!r,Number(o)||4,Number(s)||4,I);try{let h=ht("channels",{})||{};h[String(c||"default")]={installDir:e,gameVersion:a?.game_version||null,gameBaseUrl:t,lastUpdatedAt:Date.now()},tt("channels",h)}catch(h){console.error("Failed to persist channel info",h)}}finally{I=null}return!0});E.handle("default-install-dir",(n,{channelName:t})=>{let a=process.env.LOCALAPPDATA||u.join(D.getPath("home"),"AppData","Local"),e=u.join(a,"Programs","R5VLibrary");return t?u.join(e,t):e});E.handle("launcher:config",async(n,{url:t})=>(e=>new Promise((r,o)=>{O.get(e,s=>{if(s.statusCode!==200){o(new Error(`HTTP ${s.statusCode} for ${e}`)),s.resume();return}let c="";s.setEncoding("utf8"),s.on("data",f=>c+=f),s.on("end",()=>{try{r(JSON.parse(c))}catch(f){o(f)}})}).on("error",o)}))(t));E.handle("video:cache",async(n,{filename:t})=>{let e=`https://blaze.playvalkyrie.org/video_backgrounds/${t}`,r=u.join(u.resolve(D.getAppPath(),".."),"cache"),o=u.join(r,"videos"),s=u.join(o,t);await S.promises.mkdir(o,{recursive:!0});try{return await S.promises.access(s),`r5v://videos/${t}`}catch{}return await new Promise((c,f)=>{let h=S.createWriteStream(s);O.get(e,l=>{if(l.statusCode!==200){h.close(()=>{}),S.unlink(s,()=>{}),f(new Error(`HTTP ${l.statusCode} video`)),l.resume();return}l.pipe(h),h.on("finish",()=>h.close(c))}).on("error",l=>{S.unlink(s,()=>f(l))})}),`r5v://videos/${t}`});E.handle("fs:exists",async(n,{path:t})=>{try{return await S.promises.access(t),!0}catch{return!1}});E.handle("path:open",async(n,{path:t})=>{try{return await J.openPath(t),!0}catch{return!1}});E.handle("open-external",async(n,{url:t})=>{try{return await J.openExternal(t),!0}catch{return!1}});E.handle("download:cancel",async()=>{try{Z(I)}catch{}I=null;try{w?.webContents.send("progress:cancelled",{})}catch{}return!0});E.handle("select-file",async(n,{filters:t})=>{let a=await nt.showOpenDialog({properties:["openFile"],filters:Array.isArray(t)?t:void 0});return a.canceled||a.filePaths.length===0?null:a.filePaths[0]});E.handle("game:launch",async(n,{channelName:t,installDir:a,mode:e,argsString:r})=>{try{if(!a)throw new Error("Missing installDir");let o=String(e).toUpperCase()==="SERVER"?"r5apex_ds.exe":"r5apex.exe",s=u.join(a,o);await S.promises.access(s).catch(()=>{throw new Error(`Executable not found: ${s}`)});let f=(l=>!l||typeof l!="string"?[]:(l.match(/(?:[^\s\"]+|\"[^\"]*\")+/g)||[]).map(d=>d.replace(/^\"|\"$/g,"")))(r);return wt(s,f,{cwd:a,detached:!0,stdio:"ignore",env:{...process.env}}).unref(),{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}});E.on("window:minimize",()=>{w?.minimize()});E.on("window:maximize",()=>{w&&(w.isMaximized()?w.unmaximize():w.maximize())});E.on("window:close",()=>{w?.close()});D.on("before-quit",()=>{if(I)try{Z(I)}catch{}});
