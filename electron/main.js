import{app as b,BrowserWindow as mt,ipcMain as w,dialog as nt,protocol as pt,shell as J}from"electron";import{createRequire as Tt}from"node:module";import u from"node:path";import{fileURLToPath as $t,pathToFileURL as Zt}from"node:url";import O from"node:https";import m from"node:fs";import{spawn as wt}from"node:child_process";import Nt from"node:os";import C from"node:fs";import q from"node:path";import Et from"node:crypto";import{pipeline as vt}from"node:stream";import{promisify as kt}from"node:util";import Y from"node:https";var Pt=kt(vt);function K(n){return String(n||"").replace(/\\/g,"/").replace(/^\/+/,"")}function at(n){return String(n||"").replace(/\\/g,"/").toLowerCase()}var F=new Map,Ct=new Y.Agent({keepAlive:!0,maxSockets:32,maxFreeSockets:16,keepAliveMsecs:3e4});function W(n){return new Promise((t,a)=>{let e=Et.createHash("sha256"),r=C.createReadStream(n);r.on("error",a),r.on("end",()=>t(e.digest("hex"))),r.on("data",o=>e.update(o))})}function ot(n){C.mkdirSync(n,{recursive:!0})}function xt(n){return new Promise((t,a)=>{Y.get(n,e=>{if(e.statusCode!==200){a(new Error(`HTTP ${e.statusCode} for ${n}`)),e.resume();return}let r="";e.setEncoding("utf8"),e.on("data",o=>r+=o),e.on("end",()=>{try{t(JSON.parse(r))}catch(o){a(o)}})}).on("error",a)})}function M(n){return new Promise(t=>setTimeout(t,n))}function st(){return{cancelled:!1,requests:new Set}}function Z(n){if(n){n.cancelled=!0;for(let t of n.requests)try{t.destroy(new Error("cancelled"))}catch{}n.requests.clear()}}var At=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE"]);async function z(n,t,a,e=1,r,o=0,s=0){return new Promise((c,f)=>{ot(q.dirname(t));let d=C.createWriteStream(t,{flags:o>0?"a":"w"});if(r?.cancelled)return d.close(()=>{}),f(new Error("cancelled"));let h={agent:Ct};o>0&&(h.headers={Range:`bytes=${o}-`});let y=Y.get(n,h,l=>{if(l.statusCode!==200&&!(o>0&&l.statusCode===206)){if(d.close(()=>{}),o>0&&l.statusCode===200){try{C.unlinkSync(t)}catch{}let k=Math.min(2e3*e,1e4);l.resume();try{y.destroy(new Error("restart:range-ignored"))}catch{}return M(k).then(()=>c(z(n,t,a,e+1,r,0,s)))}if(C.unlink(t,()=>{}),l.statusCode&&[429,500,502,503,504].includes(l.statusCode)&&e<5){let k=Math.min(2e3*e,1e4);return l.resume(),M(k).then(()=>c(z(n,t,a,e+1,r,o,s)))}f(new Error(`HTTP ${l.statusCode} for ${n}`)),l.resume();return}let v=Number(l.headers["content-length"]||0),P=s>0?s:o>0?o+v:v,x=0,i=Date.now(),p=e<=2?6e4:9e4,S=setInterval(()=>{if(!r?.cancelled&&Date.now()-i>p)try{let k=new Error("stalled");k.code="ETIMEDOUT",y.destroy(k)}catch{}},1e4);l.on("data",k=>{x+=k.length,i=Date.now(),a&&a(Math.min(o+x,P||o+x),P||0)}),l.on("aborted",async()=>{let k=new Promise(g=>d.close(()=>g()));try{clearInterval(S)}catch{}try{await k}catch{}if(e<5){let g=Math.min(2e3*e,1e4);return M(g).then(()=>c(z(n,t,a,e+1,r,o+x,s)))}f(new Error("response aborted"))}),Pt(l,d).then(()=>{try{clearInterval(S)}catch{}c()}).catch(k=>{try{clearInterval(S)}catch{}f(k)})});if(r?.requests.add(y),y.on("socket",l=>{try{l.setKeepAlive(!0,6e4),l.setNoDelay(!0)}catch{}}),y.on("close",()=>r?.requests.delete(y)),y.setTimeout(45e3,()=>{try{let l=new Error("Request timeout");l.code="ETIMEDOUT",y.destroy(l)}catch{}}),r?.cancelled)try{y.destroy(new Error("cancelled"))}catch{}y.on("error",async l=>{let v=l?.code,P=e<5&&v&&At.has(String(v)),x=new Promise(i=>{try{d.close(()=>i())}catch{i()}});try{await x}catch{}if(P){let i=Math.min(2e3*e,1e4),p=o;try{p=C.statSync(t).size}catch{}return M(i).then(()=>c(z(n,t,a,e+1,r,p,s)))}f(l)})})}async function Rt(n,t,a){try{let e=C.statSync(n);return a&&Number(a)>0&&e.size!==Number(a)?!1:(await W(n)).toLowerCase()===String(t).toLowerCase()}catch{return!1}}async function ct(n){let t=`${n.replace(/\/$/,"")}/checksums.json`;return xt(t)}async function bt(n,t,a,e,r=4,o){let s=K(t.path).split("/").join(q.sep),c=q.join(a,s);if(ot(q.dirname(c)),await Rt(c,t.checksum,t.size)){e("progress:skip",{path:t.path});return}if(o?.cancelled)throw new Error("cancelled");if(Array.isArray(t.parts)&&t.parts.length>0){let d=t.parts.length,h=new Array(d),y=0,l=new Set;async function v(){for(;;){let i=y++;if(i>=d)return;if(l.has(i))continue;l.add(i);let p=t.parts[i],S=K(p.path),k=`${n.replace(/\/$/,"")}/${S}`,g=`${c}.part${i}`;try{if(C.existsSync(g))if((await W(g)).toLowerCase()===String(p.checksum).toLowerCase()){e("progress:part",{path:t.path,part:i,totalParts:d,received:Number(p.size||0),total:Number(p.size||0)}),h[i]=g;continue}else try{C.unlinkSync(g)}catch{}}catch{}let A=0;for(;;){if(o?.cancelled)throw new Error("cancelled");A+=1;let R=0,I=0;try{let _=0;try{_=C.statSync(g).size}catch{}let L=Number(p.size||0);if(L>0&&_>L)try{C.unlinkSync(g),_=0}catch{}await z(k,g,(T,V)=>{let N=Math.max(0,T-I);I=T;try{N>0&&e("progress:bytes",{delta:N})}catch{}R+=N;let G=L||V||0;e("progress:part",{path:t.path,part:i,totalParts:d,received:Math.min(T,G||T),total:G})},1,o,_,L)}catch{try{C.unlinkSync(g)}catch{}try{R>0&&e("progress:bytes",{delta:-R})}catch{}try{e("progress:part:reset",{path:t.path,part:i,totalParts:d})}catch{}let L=Math.min(2e3*A,1e4);await M(L);continue}if((await W(g)).toLowerCase()===String(p.checksum).toLowerCase())break;try{C.unlinkSync(g)}catch{}try{R>0&&e("progress:bytes",{delta:-R})}catch{}try{e("progress:part:reset",{path:t.path,part:i,totalParts:d})}catch{}let H=Math.min(2e3*A,1e4);await M(H)}h[i]=g}}let P=Array.from({length:Math.max(1,r)},()=>v());await Promise.all(P),e("progress:merge:start",{path:t.path,parts:h.length});let x=C.createWriteStream(c);for(let i=0;i<h.length;i++){let p=h[i];e("progress:merge:part",{path:t.path,part:i,totalParts:h.length}),await new Promise((S,k)=>{let g=C.createReadStream(p);g.on("error",k),x.on("error",k),g.on("end",()=>{try{C.unlinkSync(p)}catch{}S()}),g.pipe(x,{end:!1})})}await new Promise((i,p)=>{x.on("error",p),x.on("finish",i),x.end()});try{e("progress:merge:done",{path:t.path})}catch{}}else{let d=K(t.path),h=`${n.replace(/\/$/,"")}/${d}`,y=0;for(;;){y+=1;let l=0,v=0,P=`${c}.download`,x=0;try{x=C.statSync(P).size}catch{}let i=Number(t.size||0);if(i>0&&x>i)try{C.unlinkSync(P),x=0}catch{}if(await z(h,P,(S,k)=>{let g=Math.max(0,S-v);v=S;try{g>0&&e("progress:bytes",{delta:g})}catch{}l+=g;let A=i||k||0;e("progress:file",{path:t.path,received:Math.min(S,A||S),total:A})},1,o,x,i),(await W(P)).toLowerCase()===String(t.checksum).toLowerCase())break;try{C.unlinkSync(P)}catch{}try{l>0&&e("progress:bytes",{delta:-l})}catch{}if(y>=2)throw new Error(`Checksum mismatch for ${t.path}`)}try{C.unlinkSync(c)}catch{}C.renameSync(`${c}.download`,c)}if(e("progress:verify",{path:t.path}),(await W(c)).toLowerCase()!==String(t.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${t.path}`)}async function it(n,t,a,e,r=!1,o=4,s=4,c){let f=new Set,d=[];for(let p of t.files||[]){if(!(r||!p.optional))continue;let S=at(p.path);S&&(f.has(S)||(f.add(S),d.push(p)))}let h=d.filter(p=>!(Array.isArray(p.parts)&&p.parts.length>0)),y=d.filter(p=>Array.isArray(p.parts)&&p.parts.length>0),l=h.concat(y),v=l.length,P=0,x=l.reduce((p,S)=>{let k=Number(S.size||0);return k>0?p+k:Array.isArray(S.parts)&&S.parts.length?p+S.parts.reduce((g,A)=>g+Number(A.size||0),0):p},0);try{e("progress:bytes:total",{totalBytes:x})}catch{}async function i(p,S,k){let g=0;async function A(){for(;;){let I=g++;if(I>=p.length)return;let $=p[I],H=S+I,_=at($.path),L=async()=>bt(n,$,a,e,s,c),T=!1,V=F.get(_);V?T=!0:(e("progress:start",{index:H,total:v,path:$.path,completed:P}),V=(async()=>{try{await L()}catch(N){if(String(N?.message||N||"error").includes("cancelled"))throw N;try{let B=q.join(a,$.path.replace(/\\/g,q.sep));try{C.unlinkSync(B)}catch{}await L()}catch(B){try{e("progress:error",{path:$.path,message:String(B?.message||B)})}catch{}}}})(),F.set(_,V));try{await V}finally{T||F.delete(_)}P+=1,e("progress:done",{index:H,total:v,path:$.path,completed:P}),await M(10)}}let R=Array.from({length:Math.max(1,k)},()=>A());await Promise.all(R)}if(await i(h,0,Math.max(1,o)),F.size>0)try{await Promise.all([...F.values()])}catch{}await i(y,h.length,1)}import Q from"node:fs";import Dt from"node:path";import{app as _t}from"electron";var lt=_t.getPath("userData"),dt=Dt.join(lt,"settings.json");function X(){try{let n=Q.readFileSync(dt,"utf-8");return JSON.parse(n)}catch{return{}}}function Lt(n){Q.mkdirSync(lt,{recursive:!0}),Q.writeFileSync(dt,JSON.stringify(n,null,2),"utf-8")}function ht(n,t=void 0){return X()[n]??t}function tt(n,t){let a=X();a[n]=t,Lt(a)}function ut(){return X()}var gt=Tt(import.meta.url),{autoUpdater:D}=gt("electron-updater"),ft=gt("electron-log"),Mt=$t(import.meta.url),j=u.dirname(Mt);var E,U=null;async function yt(){E=new mt({width:1150,height:800,minWidth:1150,minHeight:800,frame:!1,titleBarStyle:"hidden",webPreferences:{preload:u.join(j,"preload.cjs"),contextIsolation:!0,nodeIntegration:!1},show:!1,icon:u.join(j,"..","public","icon.png")});let n=process.env.VITE_DEV_SERVER_URL;if(n)await E.loadURL(n);else{let r=u.join(j,"..","dist","index.html");await E.loadFile(r)}E.webContents.setWindowOpenHandler(({url:r})=>{try{J.openExternal(r)}catch{}return{action:"deny"}}),E.webContents.on("will-navigate",(r,o)=>{let s=o.startsWith("file:"),c=!!process.env.VITE_DEV_SERVER_URL&&o.startsWith(String(process.env.VITE_DEV_SERVER_URL));if(!s&&!c){r.preventDefault();try{J.openExternal(o)}catch{}}});let t=()=>{E&&(E.isVisible()||E.show(),E.isFocused()||E.focus())};E.once("ready-to-show",t),E.webContents.once("did-finish-load",t);let a=setTimeout(t,1e3);E.on("show",()=>clearTimeout(a)),(!!process.env.VITE_DEV_SERVER_URL||process.env.NODE_ENV==="development")&&E.webContents.openDevTools({mode:"detach"}),E.webContents.on("did-fail-load",(r,o,s,c)=>{console.error("Load failed",{errorCode:o,errorDesc:s,validatedURL:c}),nt.showErrorBox("Load failed",`${s} (code ${o})
URL: ${c}`),E.show()})}b.on("window-all-closed",()=>{process.platform!=="darwin"&&b.quit()});b.whenReady().then(()=>{let n=u.resolve(b.getAppPath(),".."),t=u.join(n,"cache");pt.registerFileProtocol("r5v",(e,r)=>{try{let o=new URL(e.url),s=decodeURIComponent(o.pathname).replace(/^\//,""),c=u.normalize(u.join(t,s));r({path:c})}catch{r({error:-6})}});let a=u.join(j,"..","dist");pt.interceptFileProtocol("file",(e,r)=>{try{let o=new URL(e.url),s=decodeURIComponent(o.pathname),c=s.replace(/\\/g,"/"),f=c.indexOf("/_astro/");if(f!==-1){let d=c.substring(f+8),h=u.join(a,"_astro",d);return r({path:h})}if(c.endsWith("/favicon.svg")||/\/favicon\.svg$/i.test(c)){let d=u.join(a,"favicon.svg");return r({path:d})}if(c.startsWith("/")){let d=c.replace(/^\/+/,""),h=u.join(a,d);try{return m.accessSync(h),r({path:h})}catch{}}return r({path:s})}catch{return r({error:-6})}}),yt();try{D.autoDownload=!1;try{D.logger=ft,ft.transports.file.level="info"}catch{}D.on("error",e=>{try{E?.webContents.send("update:error",{message:String(e?.stack||e?.message||e)})}catch{}}),D.on("update-available",e=>{try{E?.webContents.send("update:available",e)}catch{}}),D.on("update-not-available",e=>{try{E?.webContents.send("update:not-available",e)}catch{}}),D.on("download-progress",e=>{try{E?.webContents.send("update:download-progress",e)}catch{}}),D.on("update-downloaded",e=>{try{E?.webContents.send("update:downloaded",e)}catch{}})}catch{}b.on("activate",()=>{mt.getAllWindows().length===0&&yt()})});w.handle("update:check",async()=>{try{return{ok:!0,result:(await D.checkForUpdates())?.updateInfo||null}}catch(n){return{ok:!1,error:String(n?.message||n)}}});w.handle("update:download",async()=>{try{return await D.downloadUpdate(),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});w.handle("update:quitAndInstall",async()=>{try{return setImmediate(()=>D.quitAndInstall(!1,!0)),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});w.handle("app:getVersion",async()=>{try{return b.getVersion()}catch{return"0.0.0"}});w.handle("app:getBaseDir",async()=>{try{return u.resolve(b.getAppPath(),"..")}catch{return""}});w.handle("app:getLauncherInstallRoot",async()=>{try{let n=process.env.LOCALAPPDATA||u.join(b.getPath("home"),"AppData","Local");return u.join(n,"Programs","r5vlauncher")}catch{return""}});function rt(n){try{let t=u.join(n,"mods.vdf"),a=m.readFileSync(t,"utf-8"),e={},r=/"([^"]+)"\s*"([01])"/g,o;for(;o=r.exec(a);){let s=o[1];s&&s!=="ModList"&&(e[s]=o[2]==="1")}return e}catch{return{}}}function et(n){try{let t=m.readFileSync(n,"utf-8"),a=t.match(/"id"\s*"([^"]+)"/i),e=t.match(/"name"\s*"([^"]+)"/i),r=a?a[1]:null,o=e?e[1]:null;return{id:r,name:o}}catch{return{id:null,name:null}}}function St(n,t){let a=['"ModList"',"{"];for(let[e,r]of Object.entries(t))a.push(`	"${e}"		"${r?"1":"0"}"`);a.push("}"),m.mkdirSync(n,{recursive:!0}),m.writeFileSync(u.join(n,"mods.vdf"),a.join(`
`),"utf-8")}w.handle("mods:listInstalled",async(n,{installDir:t})=>{try{let a=u.join(t,"mods"),e=rt(a),r=[],o=m.existsSync(a)?m.readdirSync(a,{withFileTypes:!0}):[];for(let s of o){if(!s.isDirectory())continue;let c=u.join(a,s.name),f=u.join(c,"manifest.json"),d=u.join(c,"mod.vdf"),h=u.join(c,"icon.png"),y=null;try{y=JSON.parse(m.readFileSync(f,"utf-8"))}catch{}let l=et(d),v=l.id||y?.name||s.name,P=null;try{P=`data:image/png;base64,${m.readFileSync(h).toString("base64")}`}catch{}r.push({id:v,name:y?.name||l.name||s.name,folder:s.name,version:y?.version_number||null,description:y?.description||"",enabled:v?!!e[v]:!1,hasManifest:m.existsSync(f),iconDataUrl:P})}return{ok:!0,mods:r}}catch(a){return{ok:!1,error:String(a?.message||a)}}});w.handle("mods:setEnabled",async(n,{installDir:t,name:a,enabled:e})=>{try{let r=u.join(t,"mods"),o=rt(r);return o[a]=!!e,St(r,o),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});w.handle("mods:uninstall",async(n,{installDir:t,folder:a})=>{try{let e=u.join(t,"mods"),r=u.join(e,a);return m.rmSync(r,{recursive:!0,force:!0}),{ok:!0}}catch(e){return{ok:!1,error:String(e?.message||e)}}});w.handle("mods:fetchAll",async(n,{query:t})=>{let a="https://thunderstore.io/c/r5valkyrie/api/v1/package/";return new Promise(e=>{O.get(a,r=>{if(r.statusCode!==200)return r.resume(),e({ok:!1,error:`HTTP ${r.statusCode}`});let o="";r.setEncoding("utf8"),r.on("data",s=>o+=s),r.on("end",()=>{try{let s=JSON.parse(o),c=Array.isArray(s)?s:[];if(t&&String(t).trim()){let f=String(t).toLowerCase();c=c.filter(d=>String(d?.name||"").toLowerCase().includes(f)||String(d?.full_name||"").toLowerCase().includes(f))}e({ok:!0,mods:c})}catch(s){e({ok:!1,error:String(s?.message||s)})}})}).on("error",r=>e({ok:!1,error:String(r?.message||r)}))})});w.handle("mods:install",async(n,{installDir:t,name:a,downloadUrl:e})=>{try{let r=u.join(t,"mods");m.mkdirSync(r,{recursive:!0});let o=u.join(Nt.tmpdir(),`mod_${Date.now()}.zip`),s=(h,y=0)=>new Promise((l,v)=>{if(y>5)return v(new Error("Too many redirects"));let P=m.createWriteStream(o);O.get(h,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"application/octet-stream,*/*;q=0.8",Referer:"https://thunderstore.io/",Connection:"keep-alive"}},i=>{if(i.statusCode&&i.statusCode>=300&&i.statusCode<400&&i.headers.location){i.resume(),P.close(()=>{});try{m.unlinkSync(o)}catch{}let A=i.headers.location.startsWith("http")?i.headers.location:new URL(i.headers.location,h).toString();return l(s(A,y+1))}if(i.statusCode!==200){P.close(()=>{});try{m.unlinkSync(o)}catch{}return i.resume(),v(new Error(`HTTP ${i.statusCode}`))}let p=Number(i.headers["content-length"]||0),S=0,k=Date.now(),g=A=>{try{n?.sender?.send("mods:progress",{key:a,phase:A,received:S,total:p})}catch{}};i.on("data",A=>{S+=Buffer.isBuffer(A)?A.length:Buffer.byteLength(String(A));let R=Date.now();R-k>150&&(k=R,g("downloading"))}),i.pipe(P),P.on("finish",()=>{g("downloading"),P.close(l)})}).on("error",i=>{try{m.unlinkSync(o)}catch{}v(i)})});await s(e);try{n?.sender?.send("mods:progress",{key:a,phase:"extracting"})}catch{}let c=u.join(r,a);try{m.rmSync(c,{recursive:!0,force:!0})}catch{}m.mkdirSync(c,{recursive:!0}),await new Promise((h,y)=>{let l=wt("powershell.exe",["-NoProfile","-NonInteractive","-Command",`Expand-Archive -LiteralPath "${o}" -DestinationPath "${c}" -Force`],{stdio:"ignore"});l.on("exit",v=>v===0?h():y(new Error(`Expand-Archive failed ${v}`))),l.on("error",y)});try{m.unlinkSync(o)}catch{}let f=null;try{let h=u.join(c,"mod.vdf");if(m.existsSync(h))f=et(h).id;else{let y=m.readdirSync(c,{withFileTypes:!0});for(let l of y)if(l.isDirectory()){let v=u.join(c,l.name,"mod.vdf");if(m.existsSync(v)&&(f=et(v).id,f))break}}}catch{}let d=rt(r);d[f||a]=!0,St(r,d);try{n?.sender?.send("mods:progress",{key:a,phase:"done"})}catch{}return{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});w.handle("mods:iconDataUrl",async(n,{installDir:t,folder:a})=>{try{let e=u.join(t,"mods",a,"icon.png");return await m.promises.access(e),{ok:!0,dataUrl:`data:image/png;base64,${(await m.promises.readFile(e)).toString("base64")}`}}catch(e){return{ok:!1,error:String(e?.message||e)}}});w.handle("select-directory",async()=>{let n=await nt.showOpenDialog({properties:["openDirectory","createDirectory"]});return n.canceled||n.filePaths.length===0?null:n.filePaths[0]});w.handle("settings:get",()=>ut());w.handle("settings:set",(n,{key:t,value:a})=>tt(t,a));w.handle("download:checksums",async(n,{baseUrl:t})=>ct(t));w.handle("download:all",async(n,{baseUrl:t,checksums:a,installDir:e,includeOptional:r,concurrency:o,partConcurrency:s,channelName:c})=>{let f=(d,h)=>n.sender.send(d,h);U=st();try{await it(t,a,e,f,!!r,Number(o)||4,Number(s)||4,U);try{let d=ht("channels",{})||{};d[String(c||"default")]={installDir:e,gameVersion:a?.game_version||null,gameBaseUrl:t,lastUpdatedAt:Date.now()},tt("channels",d)}catch(d){console.error("Failed to persist channel info",d)}}finally{U=null}return!0});w.handle("default-install-dir",(n,{channelName:t})=>{let a=process.env.LOCALAPPDATA||u.join(b.getPath("home"),"AppData","Local"),e=u.join(a,"Programs","R5VLibrary");return t?u.join(e,t):e});w.handle("launcher:config",async(n,{url:t})=>(e=>new Promise((r,o)=>{O.get(e,s=>{if(s.statusCode!==200){o(new Error(`HTTP ${s.statusCode} for ${e}`)),s.resume();return}let c="";s.setEncoding("utf8"),s.on("data",f=>c+=f),s.on("end",()=>{try{r(JSON.parse(c))}catch(f){o(f)}})}).on("error",o)}))(t));w.handle("video:cache",async(n,{filename:t})=>{let e=`https://blaze.playvalkyrie.org/video_backgrounds/${t}`,r=u.join(u.resolve(b.getAppPath(),".."),"cache"),o=u.join(r,"videos"),s=u.join(o,t);await m.promises.mkdir(o,{recursive:!0});try{return await m.promises.access(s),`r5v://videos/${t}`}catch{}return await new Promise((c,f)=>{let d=m.createWriteStream(s);O.get(e,h=>{if(h.statusCode!==200){d.close(()=>{}),m.unlink(s,()=>{}),f(new Error(`HTTP ${h.statusCode} video`)),h.resume();return}h.pipe(d),d.on("finish",()=>d.close(c))}).on("error",h=>{m.unlink(s,()=>f(h))})}),`r5v://videos/${t}`});w.handle("fs:exists",async(n,{path:t})=>{try{return await m.promises.access(t),!0}catch{return!1}});w.handle("path:open",async(n,{path:t})=>{try{return await J.openPath(t),!0}catch{return!1}});w.handle("open-external",async(n,{url:t})=>{try{return await J.openExternal(t),!0}catch{return!1}});w.handle("download:cancel",async()=>{try{Z(U)}catch{}U=null;try{E?.webContents.send("progress:cancelled",{})}catch{}return!0});w.handle("select-file",async(n,{filters:t})=>{let a=await nt.showOpenDialog({properties:["openFile"],filters:Array.isArray(t)?t:void 0});return a.canceled||a.filePaths.length===0?null:a.filePaths[0]});w.handle("game:launch",async(n,{channelName:t,installDir:a,mode:e,argsString:r})=>{try{if(!a)throw new Error("Missing installDir");let o=String(e).toUpperCase()==="SERVER"?"r5apex_ds.exe":"r5apex.exe",s=u.join(a,o);await m.promises.access(s).catch(()=>{throw new Error(`Executable not found: ${s}`)});let f=(h=>!h||typeof h!="string"?[]:(h.match(/(?:[^\s\"]+|\"[^\"]*\")+/g)||[]).map(l=>l.replace(/^\"|\"$/g,"")))(r);return wt(s,f,{cwd:a,detached:!0,stdio:"ignore",env:{...process.env}}).unref(),{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}});w.on("window:minimize",()=>{E?.minimize()});w.on("window:maximize",()=>{E&&(E.isMaximized()?E.unmaximize():E.maximize())});w.on("window:close",()=>{E?.close()});b.on("before-quit",()=>{if(U)try{Z(U)}catch{}});
