import{app as b,BrowserWindow as St,ipcMain as k,dialog as at,protocol as mt,shell as J}from"electron";import{createRequire as Mt}from"node:module";import p from"node:path";import{fileURLToPath as It,pathToFileURL as ae}from"node:url";import G from"node:https";import w from"node:fs";import Vt from"node:zlib";import{spawn as kt}from"node:child_process";import zt from"node:os";import P from"node:fs";import B from"node:path";import At from"node:crypto";import{pipeline as Pt}from"node:stream";import{promisify as xt}from"node:util";import Y from"node:https";var bt=xt(Pt);function Q(n){return String(n||"").replace(/\\/g,"/").replace(/^\/+/,"")}function ct(n){return String(n||"").replace(/\\/g,"/").toLowerCase()}var q=new Map,Lt=new Y.Agent({keepAlive:!0,maxSockets:32,maxFreeSockets:16,keepAliveMsecs:3e4});function W(n){return new Promise((t,r)=>{let e=At.createHash("sha256"),o=P.createReadStream(n);o.on("error",r),o.on("end",()=>t(e.digest("hex"))),o.on("data",a=>e.update(a))})}function it(n){P.mkdirSync(n,{recursive:!0})}function Rt(n){return new Promise((t,r)=>{Y.get(n,e=>{if(e.statusCode!==200){r(new Error(`HTTP ${e.statusCode} for ${n}`)),e.resume();return}let o="";e.setEncoding("utf8"),e.on("data",a=>o+=a),e.on("end",()=>{try{t(JSON.parse(o))}catch(a){r(a)}})}).on("error",r)})}function N(n){return new Promise(t=>setTimeout(t,n))}function lt(){return{cancelled:!1,requests:new Set}}function Z(n){if(n){n.cancelled=!0;for(let t of n.requests)try{t.destroy(new Error("cancelled"))}catch{}n.requests.clear()}}var Dt=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE"]);async function z(n,t,r,e=1,o,a=0,s=0){return new Promise((c,f)=>{it(B.dirname(t));let i=P.createWriteStream(t,{flags:a>0?"a":"w"});if(o?.cancelled)return i.close(()=>{}),f(new Error("cancelled"));let l={agent:Lt};a>0&&(l.headers={Range:`bytes=${a}-`});let u=Y.get(n,l,h=>{if(h.statusCode!==200&&!(a>0&&h.statusCode===206)){if(i.close(()=>{}),a>0&&h.statusCode===200){try{P.unlinkSync(t)}catch{}let C=Math.min(2e3*e,1e4);h.resume();try{u.destroy(new Error("restart:range-ignored"))}catch{}return N(C).then(()=>c(z(n,t,r,e+1,o,0,s)))}if(P.unlink(t,()=>{}),h.statusCode&&[429,500,502,503,504].includes(h.statusCode)&&e<5){let C=Math.min(2e3*e,1e4);return h.resume(),N(C).then(()=>c(z(n,t,r,e+1,o,a,s)))}f(new Error(`HTTP ${h.statusCode} for ${n}`)),h.resume();return}let g=Number(h.headers["content-length"]||0),S=s>0?s:a>0?a+g:g,A=0,d=Date.now(),m=e<=2?6e4:9e4,E=setInterval(()=>{if(!o?.cancelled&&Date.now()-d>m)try{let C=new Error("stalled");C.code="ETIMEDOUT",u.destroy(C)}catch{}},1e4);h.on("data",C=>{A+=C.length,d=Date.now(),r&&r(Math.min(a+A,S||a+A),S||0)}),h.on("aborted",async()=>{let C=new Promise(v=>i.close(()=>v()));try{clearInterval(E)}catch{}try{await C}catch{}if(e<5){let v=Math.min(2e3*e,1e4);return N(v).then(()=>c(z(n,t,r,e+1,o,a+A,s)))}f(new Error("response aborted"))}),bt(h,i).then(()=>{try{clearInterval(E)}catch{}c()}).catch(C=>{try{clearInterval(E)}catch{}f(C)})});if(o?.requests.add(u),u.on("socket",h=>{try{h.setKeepAlive(!0,6e4),h.setNoDelay(!0)}catch{}}),u.on("close",()=>o?.requests.delete(u)),u.setTimeout(45e3,()=>{try{let h=new Error("Request timeout");h.code="ETIMEDOUT",u.destroy(h)}catch{}}),o?.cancelled)try{u.destroy(new Error("cancelled"))}catch{}u.on("error",async h=>{let g=h?.code,S=e<5&&g&&Dt.has(String(g)),A=new Promise(d=>{try{i.close(()=>d())}catch{d()}});try{await A}catch{}if(S){let d=Math.min(2e3*e,1e4),m=a;try{m=P.statSync(t).size}catch{}return N(d).then(()=>c(z(n,t,r,e+1,o,m,s)))}f(h)})})}async function _t(n,t,r){try{let e=P.statSync(n);return r&&Number(r)>0&&e.size!==Number(r)?!1:(await W(n)).toLowerCase()===String(t).toLowerCase()}catch{return!1}}async function dt(n){let t=`${n.replace(/\/$/,"")}/checksums.json`;return Rt(t)}async function Tt(n,t,r,e,o=4,a){let s=Q(t.path).split("/").join(B.sep),c=B.join(r,s);if(it(B.dirname(c)),await _t(c,t.checksum,t.size)){e("progress:skip",{path:t.path});return}if(a?.cancelled)throw new Error("cancelled");if(Array.isArray(t.parts)&&t.parts.length>0){let i=t.parts.length,l=new Array(i),u=0,h=new Set;async function g(){for(;;){let d=u++;if(d>=i)return;if(h.has(d))continue;h.add(d);let m=t.parts[d],E=Q(m.path),C=`${n.replace(/\/$/,"")}/${E}`,v=`${c}.part${d}`;try{if(P.existsSync(v))if((await W(v)).toLowerCase()===String(m.checksum).toLowerCase()){e("progress:part",{path:t.path,part:d,totalParts:i,received:Number(m.size||0),total:Number(m.size||0)}),l[d]=v;continue}else try{P.unlinkSync(v)}catch{}}catch{}let x=0;for(;;){if(a?.cancelled)throw new Error("cancelled");x+=1;let L=0,I=0;try{let D=0;try{D=P.statSync(v).size}catch{}let _=Number(m.size||0);if(_>0&&D>_)try{P.unlinkSync(v),D=0}catch{}await z(C,v,(T,V)=>{let U=Math.max(0,T-I);I=T;try{U>0&&e("progress:bytes",{delta:U})}catch{}L+=U;let K=_||V||0;e("progress:part",{path:t.path,part:d,totalParts:i,received:Math.min(T,K||T),total:K})},1,a,D,_)}catch{try{P.unlinkSync(v)}catch{}try{L>0&&e("progress:bytes",{delta:-L})}catch{}try{e("progress:part:reset",{path:t.path,part:d,totalParts:i})}catch{}let _=Math.min(2e3*x,1e4);await N(_);continue}if((await W(v)).toLowerCase()===String(m.checksum).toLowerCase())break;try{P.unlinkSync(v)}catch{}try{L>0&&e("progress:bytes",{delta:-L})}catch{}try{e("progress:part:reset",{path:t.path,part:d,totalParts:i})}catch{}let F=Math.min(2e3*x,1e4);await N(F)}l[d]=v}}let S=Array.from({length:Math.max(1,o)},()=>g());await Promise.all(S),e("progress:merge:start",{path:t.path,parts:l.length});let A=P.createWriteStream(c);for(let d=0;d<l.length;d++){let m=l[d];e("progress:merge:part",{path:t.path,part:d,totalParts:l.length}),await new Promise((E,C)=>{let v=P.createReadStream(m);v.on("error",C),A.on("error",C),v.on("end",()=>{try{P.unlinkSync(m)}catch{}E()}),v.pipe(A,{end:!1})})}await new Promise((d,m)=>{A.on("error",m),A.on("finish",d),A.end()});try{e("progress:merge:done",{path:t.path})}catch{}}else{let i=Q(t.path),l=`${n.replace(/\/$/,"")}/${i}`,u=0;for(;;){u+=1;let h=0,g=0,S=`${c}.download`,A=0;try{A=P.statSync(S).size}catch{}let d=Number(t.size||0);if(d>0&&A>d)try{P.unlinkSync(S),A=0}catch{}if(await z(l,S,(E,C)=>{let v=Math.max(0,E-g);g=E;try{v>0&&e("progress:bytes",{delta:v})}catch{}h+=v;let x=d||C||0;e("progress:file",{path:t.path,received:Math.min(E,x||E),total:x})},1,a,A,d),(await W(S)).toLowerCase()===String(t.checksum).toLowerCase())break;try{P.unlinkSync(S)}catch{}try{h>0&&e("progress:bytes",{delta:-h})}catch{}if(u>=2)throw new Error(`Checksum mismatch for ${t.path}`)}try{P.unlinkSync(c)}catch{}P.renameSync(`${c}.download`,c)}if(e("progress:verify",{path:t.path}),(await W(c)).toLowerCase()!==String(t.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${t.path}`)}async function ht(n,t,r,e,o=!1,a=4,s=4,c){let f=new Set,i=[];for(let m of t.files||[]){if(!(o||!m.optional))continue;let E=ct(m.path);E&&(f.has(E)||(f.add(E),i.push(m)))}let l=i.filter(m=>!(Array.isArray(m.parts)&&m.parts.length>0)),u=i.filter(m=>Array.isArray(m.parts)&&m.parts.length>0),h=l.concat(u),g=h.length,S=0,A=h.reduce((m,E)=>{let C=Number(E.size||0);return C>0?m+C:Array.isArray(E.parts)&&E.parts.length?m+E.parts.reduce((v,x)=>v+Number(x.size||0),0):m},0);try{e("progress:bytes:total",{totalBytes:A})}catch{}async function d(m,E,C){let v=0;async function x(){for(;;){let I=v++;if(I>=m.length)return;let $=m[I],F=E+I,D=ct($.path),_=async()=>Tt(n,$,r,e,s,c),T=!1,V=q.get(D);V?T=!0:(e("progress:start",{index:F,total:g,path:$.path,completed:S}),V=(async()=>{try{await _()}catch(U){if(String(U?.message||U||"error").includes("cancelled"))throw U;try{let H=B.join(r,$.path.replace(/\\/g,B.sep));try{P.unlinkSync(H)}catch{}await _()}catch(H){try{e("progress:error",{path:$.path,message:String(H?.message||H)})}catch{}}}})(),q.set(D,V));try{await V}finally{T||q.delete(D)}S+=1,e("progress:done",{index:F,total:g,path:$.path,completed:S}),await N(10)}}let L=Array.from({length:Math.max(1,C)},()=>x());await Promise.all(L)}if(await d(l,0,Math.max(1,a)),q.size>0)try{await Promise.all([...q.values()])}catch{}await d(u,l.length,1)}import X from"node:fs";import $t from"node:path";import{app as Ut}from"electron";var ut=Ut.getPath("userData"),pt=$t.join(ut,"settings.json");function tt(){try{let n=X.readFileSync(pt,"utf-8");return JSON.parse(n)}catch{return{}}}function Nt(n){X.mkdirSync(ut,{recursive:!0}),X.writeFileSync(pt,JSON.stringify(n,null,2),"utf-8")}function ft(n,t=void 0){return tt()[n]??t}function et(n,t){let r=tt();r[n]=t,Nt(r)}function yt(){return tt()}var vt=Mt(import.meta.url),{autoUpdater:R}=vt("electron-updater"),gt=vt("electron-log"),Bt=It(import.meta.url),j=p.dirname(Bt);var y,M=null,nt="r5v",O=[];function Et(n){try{return(n||[]).filter(t=>typeof t=="string"&&t.startsWith(`${nt}://`))}catch{return[]}}function ot(n){try{let t=new URL(n);if(t.hostname==="mod"&&t.pathname==="/install"){let r=t.searchParams.get("name")||"",e=t.searchParams.get("version")||"",o=t.searchParams.get("downloadUrl")||"";if(y&&y.webContents&&!y.webContents.isLoading())try{y.webContents.send("deeplink:mod-install",{url:n,name:r,version:e,downloadUrl:o})}catch{}else O.push(n)}}catch{}}function qt(){for(;O.length;){let n=O.shift();ot(n)}}var Wt=b.requestSingleInstanceLock();Wt?b.on("second-instance",(n,t)=>{try{Et(t).forEach(e=>ot(e)),y&&(y.isMinimized()&&y.restore(),y.focus())}catch{}}):b.quit();b.on("open-url",(n,t)=>{n.preventDefault(),ot(t)});async function wt(){y=new St({width:1150,height:800,minWidth:1150,minHeight:800,frame:!1,titleBarStyle:"hidden",webPreferences:{preload:p.join(j,"preload.cjs"),contextIsolation:!0,nodeIntegration:!1},show:!1,icon:p.join(j,"..","public","icon.png")});let n=process.env.VITE_DEV_SERVER_URL;if(n)await y.loadURL(n);else{let o=p.join(j,"..","dist","index.html");await y.loadFile(o)}y.webContents.setWindowOpenHandler(({url:o})=>{try{J.openExternal(o)}catch{}return{action:"deny"}}),y.webContents.on("will-navigate",(o,a)=>{let s=a.startsWith("file:"),c=!!process.env.VITE_DEV_SERVER_URL&&a.startsWith(String(process.env.VITE_DEV_SERVER_URL));if(!s&&!c){o.preventDefault();try{J.openExternal(a)}catch{}}});let t=()=>{y&&(y.isVisible()||y.show(),y.isFocused()||y.focus())};y.once("ready-to-show",t),y.webContents.once("did-finish-load",t);let r=setTimeout(t,1e3);y.on("show",()=>clearTimeout(r)),(!!process.env.VITE_DEV_SERVER_URL||process.env.NODE_ENV==="development")&&y.webContents.openDevTools({mode:"detach"}),y.webContents.on("did-fail-load",(o,a,s,c)=>{console.error("Load failed",{errorCode:a,errorDesc:s,validatedURL:c}),at.showErrorBox("Load failed",`${s} (code ${a})
URL: ${c}`),y.show()})}b.on("window-all-closed",()=>{process.platform!=="darwin"&&b.quit()});b.whenReady().then(()=>{try{process.defaultApp&&process.platform==="win32"?b.setAsDefaultProtocolClient(nt,process.execPath,[process.argv[1]]):b.setAsDefaultProtocolClient(nt)}catch{}let n=p.resolve(b.getAppPath(),".."),t=p.join(n,"cache");mt.registerFileProtocol("r5v",(e,o)=>{try{let a=new URL(e.url),s=decodeURIComponent(a.pathname).replace(/^\//,""),c=p.normalize(p.join(t,s));o({path:c})}catch{o({error:-6})}});let r=p.join(j,"..","dist");mt.interceptFileProtocol("file",(e,o)=>{try{let a=new URL(e.url),s=decodeURIComponent(a.pathname),c=s.replace(/\\/g,"/"),f=c.indexOf("/_astro/");if(f!==-1){let i=c.substring(f+8),l=p.join(r,"_astro",i);return o({path:l})}if(c.endsWith("/favicon.svg")||/\/favicon\.svg$/i.test(c)){let i=p.join(r,"favicon.svg");return o({path:i})}if(c.startsWith("/")){let i=c.replace(/^\/+/,""),l=p.join(r,i);try{return w.accessSync(l),o({path:l})}catch{}}return o({path:s})}catch{return o({error:-6})}}),wt();try{Et(process.argv).forEach(e=>O.push(e))}catch{}try{y?.webContents?.once("did-finish-load",qt)}catch{}try{R.autoDownload=!1;try{R.logger=gt,gt.transports.file.level="info"}catch{}R.on("error",e=>{try{y?.webContents.send("update:error",{message:String(e?.stack||e?.message||e)})}catch{}}),R.on("update-available",e=>{try{y?.webContents.send("update:available",e)}catch{}}),R.on("update-not-available",e=>{try{y?.webContents.send("update:not-available",e)}catch{}}),R.on("download-progress",e=>{try{y?.webContents.send("update:download-progress",e)}catch{}}),R.on("update-downloaded",e=>{try{y?.webContents.send("update:downloaded",e)}catch{}})}catch{}b.on("activate",()=>{St.getAllWindows().length===0&&wt()})});k.handle("update:check",async()=>{try{return{ok:!0,result:(await R.checkForUpdates())?.updateInfo||null}}catch(n){return{ok:!1,error:String(n?.message||n)}}});k.handle("update:download",async()=>{try{return await R.downloadUpdate(),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});k.handle("update:quitAndInstall",async()=>{try{return setImmediate(()=>R.quitAndInstall(!1,!0)),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});k.handle("app:getVersion",async()=>{try{return b.getVersion()}catch{return"0.0.0"}});k.handle("app:getBaseDir",async()=>{try{return p.resolve(b.getAppPath(),"..")}catch{return""}});k.handle("app:getLauncherInstallRoot",async()=>{try{let n=process.env.LOCALAPPDATA||p.join(b.getPath("home"),"AppData","Local");return p.join(n,"Programs","r5vlauncher")}catch{return""}});function st(n){try{let t=p.join(n,"mods.vdf"),r=w.readFileSync(t,"utf-8"),e={},o=/"([^"]+)"\s*"([01])"/g,a;for(;a=o.exec(r);){let s=a[1];s&&s!=="ModList"&&(e[s]=a[2]==="1")}return e}catch{return{}}}function rt(n){try{let t=w.readFileSync(n,"utf-8"),r=t.match(/"id"\s*"([^"]+)"/i),e=t.match(/"name"\s*"([^"]+)"/i),o=r?r[1]:null,a=e?e[1]:null;return{id:o,name:a}}catch{return{id:null,name:null}}}function Ct(n,t){let r=['"ModList"',"{"];for(let[e,o]of Object.entries(t))r.push(`	"${e}"		"${o?"1":"0"}"`);r.push("}"),w.mkdirSync(n,{recursive:!0}),w.writeFileSync(p.join(n,"mods.vdf"),r.join(`
`),"utf-8")}k.handle("mods:listInstalled",async(n,{installDir:t})=>{try{let r=p.join(t,"mods"),e=st(r),o=[],a=w.existsSync(r)?w.readdirSync(r,{withFileTypes:!0}):[];for(let s of a){if(!s.isDirectory())continue;let c=p.join(r,s.name),f=p.join(c,"manifest.json"),i=p.join(c,"mod.vdf"),l=p.join(c,"icon.png"),u=null;try{u=JSON.parse(w.readFileSync(f,"utf-8"))}catch{}let h=rt(i),g=h.id||u?.name||s.name,S=null;try{S=`data:image/png;base64,${w.readFileSync(l).toString("base64")}`}catch{}o.push({id:g,name:u?.name||h.name||s.name,folder:s.name,version:u?.version_number||null,description:u?.description||"",enabled:g?!!e[g]:!1,hasManifest:w.existsSync(f),iconDataUrl:S})}return{ok:!0,mods:o}}catch(r){return{ok:!1,error:String(r?.message||r)}}});k.handle("mods:setEnabled",async(n,{installDir:t,name:r,enabled:e})=>{try{let o=p.join(t,"mods"),a=st(o);return a[r]=!!e,Ct(o,a),{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}});k.handle("mods:uninstall",async(n,{installDir:t,folder:r})=>{try{let e=p.join(t,"mods"),o=p.join(e,r);return w.rmSync(o,{recursive:!0,force:!0}),{ok:!0}}catch(e){return{ok:!1,error:String(e?.message||e)}}});k.handle("mods:fetchAll",async(n,{query:t})=>{let r="https://thunderstore.io/c/r5valkyrie/api/v1/package-listing-index/",e=a=>new Promise((s,c)=>{G.get(a,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"*/*"}},i=>{if(i.statusCode&&i.statusCode>=300&&i.statusCode<400&&i.headers.location){i.resume();let u=i.headers.location.startsWith("http")?i.headers.location:new URL(i.headers.location,a).toString();return s(e(u))}if(i.statusCode!==200)return i.resume(),c(new Error(`HTTP ${i.statusCode}`));let l=[];i.on("data",u=>l.push(Buffer.isBuffer(u)?u:Buffer.from(u))),i.on("end",()=>s(Buffer.concat(l)))}).on("error",c)}),o=a=>{try{return Vt.gunzipSync(a)}catch{return a}};try{let a=await e(r),s=JSON.parse(o(a).toString("utf8")),c=Array.isArray(s)?s:[],f=6,i=[],l=0;await Promise.all(Array.from({length:f}).map(async()=>{for(;l<c.length;){let h=l++,g=c[h];try{let S=await e(g),A=o(S).toString("utf8"),d=JSON.parse(A);Array.isArray(d)&&i.push(...d)}catch{}}}));let u=i;if(t&&String(t).trim()){let h=String(t).toLowerCase();u=u.filter(g=>String(g?.name||"").toLowerCase().includes(h)||String(g?.full_name||"").toLowerCase().includes(h))}return{ok:!0,mods:u}}catch(a){try{let c=await e("https://thunderstore.io/c/r5valkyrie/api/v1/package/"),f=JSON.parse(c.toString("utf8")),i=Array.isArray(f)?f:[];if(t&&String(t).trim()){let l=String(t).toLowerCase();i=i.filter(u=>String(u?.name||"").toLowerCase().includes(l)||String(u?.full_name||"").toLowerCase().includes(l))}return{ok:!0,mods:i}}catch(s){return{ok:!1,error:String(s?.message||a?.message||s||a)}}}});k.handle("mods:install",async(n,{installDir:t,name:r,downloadUrl:e})=>{try{let o=p.join(t,"mods");w.mkdirSync(o,{recursive:!0});let a=p.join(zt.tmpdir(),`mod_${Date.now()}.zip`),s=(l,u=0)=>new Promise((h,g)=>{if(u>5)return g(new Error("Too many redirects"));let S=w.createWriteStream(a);G.get(l,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"application/octet-stream,*/*;q=0.8",Referer:"https://thunderstore.io/",Connection:"keep-alive"}},d=>{if(d.statusCode&&d.statusCode>=300&&d.statusCode<400&&d.headers.location){d.resume(),S.close(()=>{});try{w.unlinkSync(a)}catch{}let x=d.headers.location.startsWith("http")?d.headers.location:new URL(d.headers.location,l).toString();return h(s(x,u+1))}if(d.statusCode!==200){S.close(()=>{});try{w.unlinkSync(a)}catch{}return d.resume(),g(new Error(`HTTP ${d.statusCode}`))}let m=Number(d.headers["content-length"]||0),E=0,C=Date.now(),v=x=>{try{n?.sender?.send("mods:progress",{key:r,phase:x,received:E,total:m})}catch{}};d.on("data",x=>{E+=Buffer.isBuffer(x)?x.length:Buffer.byteLength(String(x));let L=Date.now();L-C>150&&(C=L,v("downloading"))}),d.pipe(S),S.on("finish",()=>{v("downloading"),S.close(h)})}).on("error",d=>{try{w.unlinkSync(a)}catch{}g(d)})});await s(e);try{n?.sender?.send("mods:progress",{key:r,phase:"extracting"})}catch{}let c=p.join(o,r);try{w.rmSync(c,{recursive:!0,force:!0})}catch{}w.mkdirSync(c,{recursive:!0}),await new Promise((l,u)=>{let h=kt("powershell.exe",["-NoProfile","-NonInteractive","-Command",`Expand-Archive -LiteralPath "${a}" -DestinationPath "${c}" -Force`],{stdio:"ignore"});h.on("exit",g=>g===0?l():u(new Error(`Expand-Archive failed ${g}`))),h.on("error",u)});try{w.unlinkSync(a)}catch{}let f=null;try{let l=p.join(c,"mod.vdf");if(w.existsSync(l))f=rt(l).id;else{let u=w.readdirSync(c,{withFileTypes:!0});for(let h of u)if(h.isDirectory()){let g=p.join(c,h.name,"mod.vdf");if(w.existsSync(g)&&(f=rt(g).id,f))break}}}catch{}let i=st(o);i[f||r]=!0,Ct(o,i);try{n?.sender?.send("mods:progress",{key:r,phase:"done"})}catch{}return{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}});k.handle("mods:iconDataUrl",async(n,{installDir:t,folder:r})=>{try{let e=p.join(t,"mods",r,"icon.png");return await w.promises.access(e),{ok:!0,dataUrl:`data:image/png;base64,${(await w.promises.readFile(e)).toString("base64")}`}}catch(e){return{ok:!1,error:String(e?.message||e)}}});k.handle("select-directory",async()=>{let n=await at.showOpenDialog({properties:["openDirectory","createDirectory"]});return n.canceled||n.filePaths.length===0?null:n.filePaths[0]});k.handle("settings:get",()=>yt());k.handle("settings:set",(n,{key:t,value:r})=>et(t,r));k.handle("download:checksums",async(n,{baseUrl:t})=>dt(t));k.handle("download:all",async(n,{baseUrl:t,checksums:r,installDir:e,includeOptional:o,concurrency:a,partConcurrency:s,channelName:c,mode:f})=>{let i=(l,u)=>n.sender.send(l,u);try{if(!(String(f||"install").toLowerCase()==="install")){let u=p.join(e,"mods","mods.vdf");if(w.existsSync(u)){let g=(Array.isArray(r?.files)?r.files:[]).filter(S=>{try{return String(S?.path||S?.name||"").replace(/\\/g,"/").toLowerCase()!=="mods/mods.vdf"}catch{return!0}});r={...r||{},files:g}}}}catch{}M=lt();try{await ht(t,r,e,i,!!o,Number(a)||4,Number(s)||4,M);try{let l=ft("channels",{})||{};l[String(c||"default")]={installDir:e,gameVersion:r?.game_version||null,gameBaseUrl:t,lastUpdatedAt:Date.now()},et("channels",l)}catch(l){console.error("Failed to persist channel info",l)}}finally{M=null}return!0});k.handle("default-install-dir",(n,{channelName:t})=>{let r=process.env.LOCALAPPDATA||p.join(b.getPath("home"),"AppData","Local"),e=p.join(r,"Programs","R5VLibrary");return t?p.join(e,t):e});k.handle("launcher:config",async(n,{url:t})=>(e=>new Promise((o,a)=>{G.get(e,s=>{if(s.statusCode!==200){a(new Error(`HTTP ${s.statusCode} for ${e}`)),s.resume();return}let c="";s.setEncoding("utf8"),s.on("data",f=>c+=f),s.on("end",()=>{try{o(JSON.parse(c))}catch(f){a(f)}})}).on("error",a)}))(t));k.handle("video:cache",async(n,{filename:t})=>{let e=`https://blaze.playvalkyrie.org/video_backgrounds/${t}`,o=p.join(p.resolve(b.getAppPath(),".."),"cache"),a=p.join(o,"videos"),s=p.join(a,t);await w.promises.mkdir(a,{recursive:!0});try{return await w.promises.access(s),`r5v://videos/${t}`}catch{}return await new Promise((c,f)=>{let i=w.createWriteStream(s);G.get(e,l=>{if(l.statusCode!==200){i.close(()=>{}),w.unlink(s,()=>{}),f(new Error(`HTTP ${l.statusCode} video`)),l.resume();return}l.pipe(i),i.on("finish",()=>i.close(c))}).on("error",l=>{w.unlink(s,()=>f(l))})}),`r5v://videos/${t}`});k.handle("fs:exists",async(n,{path:t})=>{try{return await w.promises.access(t),!0}catch{return!1}});k.handle("path:open",async(n,{path:t})=>{try{return await J.openPath(t),!0}catch{return!1}});k.handle("open-external",async(n,{url:t})=>{try{return await J.openExternal(t),!0}catch{return!1}});k.handle("download:cancel",async()=>{try{Z(M)}catch{}M=null;try{y?.webContents.send("progress:cancelled",{})}catch{}return!0});k.handle("select-file",async(n,{filters:t})=>{let r=await at.showOpenDialog({properties:["openFile"],filters:Array.isArray(t)?t:void 0});return r.canceled||r.filePaths.length===0?null:r.filePaths[0]});k.handle("game:launch",async(n,{channelName:t,installDir:r,mode:e,argsString:o})=>{try{if(!r)throw new Error("Missing installDir");let a=String(e).toUpperCase()==="SERVER"?"r5apex_ds.exe":"r5apex.exe",s=p.join(r,a);await w.promises.access(s).catch(()=>{throw new Error(`Executable not found: ${s}`)});let f=(l=>!l||typeof l!="string"?[]:(l.match(/(?:[^\s\"]+|\"[^\"]*\")+/g)||[]).map(h=>h.replace(/^\"|\"$/g,"")))(o);return kt(s,f,{cwd:r,detached:!0,stdio:"ignore",env:{...process.env}}).unref(),{ok:!0}}catch(a){return{ok:!1,error:String(a?.message||a)}}});k.on("window:minimize",()=>{y?.minimize()});k.on("window:maximize",()=>{y&&(y.isMaximized()?y.unmaximize():y.maximize())});k.on("window:close",()=>{y?.close()});b.on("before-quit",()=>{if(M)try{Z(M)}catch{}});
